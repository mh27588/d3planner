!function(){function t(t,e,i){var s=t[0],o=t[1],a=t[2];if(Math.abs(s)>Math.abs(o)){var c=1/Math.sqrt(s*s+a*a);i[0]=a*c,i[1]=0,i[2]=-s*c,e[0]=o*i[2],e[1]=a*i[0]-s*i[2],e[2]=-o*i[0]}else{var c=1/Math.sqrt(o*o+a*a);i[0]=0,i[1]=-a*c,i[2]=o*c,e[0]=o*i[2]-a*i[1],e[1]=-s*i[2],e[2]=s*i[1]}}function e(t,e,i){var s=t[0],o=t[1],a=t[2],c=t[3],r=e[0]*i*.5,n=e[1]*i*.5,h=e[2]*i*.5;t[0]+=c*r+a*n-o*h,t[1]+=s*h+c*n-a*r,t[2]+=o*r-s*n+c*h,t[3]-=s*r+o*n+a*h,quat.normalize(t,t)}function i(t,e,i){var s=e[0]-i[12],o=e[1]-i[13],a=e[2]-i[14];return t[0]=i[0]*s+i[1]*o+i[2]*a,t[1]=i[4]*s+i[5]*o+i[6]*a,t[2]=i[8]*s+i[9]*o+i[10]*a,t}function s(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],t[4]+=e[4],t[5]+=e[5],t[6]+=e[6],t[7]+=e[7],t[8]+=e[8]}function o(t,e){this.normal=t,this.offset=e,this.friction=1}function a(t,e,i){this.body=t,this.localCenter=e,this.radius=i,this.center=vec3.clone(e),this.friction=1}function c(t,e,i,s){this.body=t,this.localStart=e,this.localEnd=i,this.radius=s,this.start=vec3.clone(e),this.end=vec3.clone(i),this.friction=1}function r(e,i){if(this.name=e.name,e.capsule){this.center=vec3.lerp(vec3.create(),e.capsule.start,e.capsule.end,.5);var s=e.capsule.radius,o=vec3.distance(e.capsule.start,e.capsule.end),a=Math.PI*o*s,r=2*Math.PI*s*e.capsule.radius/3,n=s*a*.5,h=.5*n+a*o*o/12,v=h,l=r*s*.4;n+=2*l;var d=.5*o,u=l+r*(d*d+3*o*e.capsule.radius/8);h+=2*u,v+=2*u,this.mass=a+2*r;var y=mat3.create(),m=y.subarray(0,3),f=y.subarray(3,6),p=y.subarray(6,9);vec3.subtract(f,e.capsule.end,e.capsule.start),vec3.scale(f,f,1/o),t(f,m,p),this.localInvInertia=mat3.clone(y);var b=1/h,A=1/n,g=1/v,M=this.localInvInertia;M[0]*=b,M[1]*=b,M[2]*=b,M[3]*=A,M[4]*=A,M[5]*=A,M[6]*=g,M[7]*=g,M[8]*=g,mat3.multiply(M,M,mat3.transpose(y,y)),this.shape=new c(this,e.capsule.start,e.capsule.end,e.capsule.radius)}else this.center=vec3.create(),this.mass=1,this.localInvInertia=mat3.create();this.moves=i,this.moves||this.localInvInertia.set([0,0,0,0,0,0,0,0,0]),this.invMass=i?1/this.mass:0,this.transform=e.localTransform,this.moves||(this.prevTransform=mat4.clone(this.transform)),this.position=vec3.transformMat4(vec3.create(),this.center,this.transform),this.orientation=quat.fromMat3(quat.create(),mat3.fromMat4(mat3.create(),this.transform)),quat.normalize(this.orientation,this.orientation),this.velocity=vec3.create(),this.angMomentum=vec3.create(),this.angVelocity=vec3.create(),this.invInertia=mat3.create(),this.acceleration=vec3.create(),this.forceAccum=vec3.create(),this.torqueAccum=vec3.create(),this.gravity=vec3.fromValues(0,0,-25),this.linDamping=.25,this.angDamping=.2}function n(t,e,i,s,o,a,c){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.normal=o,this.restitution=a||0,this.friction=c||0,this.velocity=vec3.create(),this.calculateVelocity(),this.calculatePenetration()}function h(t,e,i,s){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.velocity=vec3.create(),this.normal=vec3.create(),this.calculateVelocity(),this.calculatePenetration()}function v(t){function e(t,e,i,s){vec3.subtract(n,e,t.position),vec3.cross(n,s,n),vec3.add(e,e,i),vec3.add(e,e,n)}for(var i=Math.max(2*t.length,10);i--;){for(var s=null,o=1e-4,a=0;a<t.length;++a)t[a].deltaVelocity>o&&(s=t[a],o=s.deltaVelocity);if(!s)break;s.resolveVelocity();for(var a=0;a<t.length;++a){var c=t[a];(c.body1==s.body1||c.body1==s.body2||c.body2==s.body1||c.body2==s.body1)&&c.calculateVelocity()}}for(var r={pos1:vec3.create(),pos2:vec3.create(),rot1:vec3.create(),rot2:vec3.create()},n=vec3.create(),i=Math.max(2*t.length,10);i--;){for(var s=null,h=1e-4,a=0;a<t.length;++a)t[a].penetration>h&&(s=t[a],h=s.penetration);if(!s)break;if(s.resolvePosition(r)!==!1){for(var a=0;a<t.length;++a){var c=t[a];(c.body1==s.body1||c.body2==s.body1)&&(e(s.body1,c.body1==s.body1?c.pos1:c.pos2,r.pos1,r.rot1),c.calculatePenetration()),!s.body2||c.body1!=s.body2&&c.body2!=s.body2||(e(s.body2,c.body1==s.body2?c.pos1:c.pos2,r.pos2,r.rot2),c.calculatePenetration())}s.body1.move(r.pos1,r.rot1),s.body2&&s.body2.move(r.pos2,r.rot2)}}}function l(t,e,i,s,o,a,c,r){var h=p(i,s,a,c),v=vec3.subtract(vec3.create(),h[0],h[1]),l=vec3.length(v);return l>o+r+1e-4?void 0:(l>1e-4?vec3.scale(v,v,1/l):vec3.set(v,1,0,0),new n(t,e,vec3.scaleAndAdd(vec3.create(),h[0],v,-o),vec3.scaleAndAdd(vec3.create(),h[1],v,r),v))}function d(t,e,i){for(var s=0;s<t.length;++s)for(var r=s+1;r<t.length;++r){var h=t[s],v=t[r];if((h.body&&v.body.moves||v.body||v.body.moves)&&h.body!==v.body&&!(h.body&&v.body&&(h.body.parent===v.body||v.body.parent===h.body)||h.body&&v.body&&h.body.parent===v.body.parent)){if(v instanceof o){var d=h;h=v,v=d}var u=void 0;if(h instanceof o){if(v instanceof a){var y=vec3.dot(h.normal,v.center)-h.offset;y<v.radius+1e-4&&(u=new n(v.body,h.body,vec3.scaleAndAdd(vec3.create(),v.center,h.normal,-v.radius),vec3.scaleAndAdd(vec3.create(),v.center,h.normal,-y),h.normal))}else if(v instanceof c){var m=vec3.dot(h.normal,v.start)-h.offset,f=vec3.dot(h.normal,v.end)-h.offset;m<v.radius+i&&(u=new n(v.body,h.body,vec3.scaleAndAdd(vec3.create(),v.start,h.normal,-v.radius),vec3.scaleAndAdd(vec3.create(),v.start,h.normal,-m),h.normal),u.friction=(h.friction||1)*(v.friction||1),u.restitution=.3,e.push(u)),f<v.radius+i&&(u=new n(v.body,h.body,vec3.scaleAndAdd(vec3.create(),v.end,h.normal,-v.radius),vec3.scaleAndAdd(vec3.create(),v.end,h.normal,-f),h.normal),u.friction=(h.friction||1)*(v.friction||1),u.restitution=.3,e.push(u)),u=void 0}}else{if(v instanceof c){var d=h;h=v,v=d}h instanceof c?v instanceof c?u=l(h.body,v.body,h.start,h.end,h.radius,v.start,v.end,v.radius):v instanceof a&&(u=l(h.body,v.body,h.start,h.end,h.radius,v.center,v.center,v.radius)):h instanceof a&&v instanceof a&&(u=l(h.body,v.body,h.center,h.center,h.radius,v.center,v.center,v.radius))}u&&(u.friction=(h.friction||1)*(v.friction||1),u.restitution=.3,e.push(u))}}}function u(t,e,i,s,o,a){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.restLength=o,this.stiffness=a}function y(t,e,i,s){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.contact=new h(this.body1,this.body2,vec3.create(),vec3.create())}function m(t){this.gl=t}var f=DiabloCalc,p=function(){function t(t,e,i){if(e>-1e-6)return 0;if(1e-6>i)return 1;var s=-e/t;return s>1&&(s=.5),s}var e=vec3.create(),i=vec3.create(),s=vec3.create(),o=[vec3.create(),vec3.create()];return function(a,c,r,n){var h,v,l,d,u,y,m,f,p,b,A,g,M,I,V,T,w,F,q,P,L,D,W,x,z,S,C,k,E,Q;return vec3.subtract(e,c,a),vec3.subtract(i,n,r),vec3.subtract(s,a,r),h=vec3.dot(e,e),v=vec3.dot(e,i),l=vec3.dot(i,i),d=vec3.dot(e,s),u=vec3.dot(i,s),y=d,m=y+h,f=y-v,p=m-v,b=-u,A=b-v,g=b+l,M=A+l,h>1e-6&&l>1e-6?(T=t(h,y,m),w=t(h,f,p),F=1e-6>T?-1:T>1-1e-6?1:0,q=1e-6>w?-1:w>1-1e-6?1:0,-1==F&&-1==q?(I=0,V=t(l,b,g)):1==F&&1==q?(I=1,V=t(l,A,M)):(0>F?(P=0,D=0,W=y/v,(0>W||W>1)&&(W=.5)):0==F?(P=2,D=T,W=0):(P=1,D=1,W=m/v,(0>W||W>1)&&(W=.5)),0>q?(L=0,x=0,z=y/v,(0>z||z>1)&&(z=.5)):0==q?(L=3,x=w,z=1):(L=1,x=1,z=m/v,(0>z||z>1)&&(z=.5)),S=z-W,C=S*(l*W-v*D-u),C>-1e-6?0==P?(I=0,V=t(l,b,g)):1==P?(I=1,V=t(l,A,M)):(I=D,V=W):(k=S*(l*z-v*x-u),1e-6>k?0==L?(I=0,V=t(l,b,g)):1==L?(I=1,V=t(l,A,M)):(I=x,V=z):(E=Math.min(Math.max(C/(C-k),0),1),Q=1-E,I=Q*D+E*x,V=Q*W+E*z)))):h>1e-6?(I=t(h,y,m),V=0):l>1e-6?(I=0,V=t(l,b,g)):(I=0,V=0),vec3.lerp(o[0],a,c,I),vec3.lerp(o[1],r,n,V),o}}();o.prototype.update=function(){},a.prototype.update=function(){this.body&&vec3.transformMat4(this.center,this.localCenter,this.body.transform)},c.prototype.update=function(){this.body&&(vec3.transformMat4(this.start,this.localStart,this.body.transform),vec3.transformMat4(this.end,this.localEnd,this.body.transform))},r.prototype={setTransform:function(t,e){e>1e-6&&(mat4.copy(this.prevTransform,this.transform),this.invTime=1/e),mat4.copy(this.transform,t),this.position=vec3.transformMat4(vec3.create(),this.center,t),this.orientation=quat.fromMat3(quat.create(),mat3.fromMat4(mat3.create(),t)),quat.normalize(this.orientation,this.orientation),this.calculateInertia()},getShapes:function(t){this.shape&&(this.shape.update(),t.push(this.shape))},addForce:function(t){vec3.add(this.forceAccum,this.forceAccum,t)},addForceAt:function(){var t=vec3.create();return function(e,i){var s=vec3.subtract(t,i,this.position);vec3.cross(s,s,e),vec3.add(this.forceAccum,this.forceAccum,e),vec3.add(this.torqueAccum,this.torqueAccum,s)}}(),addImpulse:function(t){vec3.scaleAndAdd(this.velocity,this.velocity,t,this.invMass)},addImpulseAt:function(){var t=vec3.create();return function(e,i){var s=vec3.subtract(t,i,this.position);vec3.cross(s,s,e),vec3.scaleAndAdd(this.velocity,this.velocity,e,this.invMass),vec3.add(this.angMomentum,this.angMomentum,s),vec3.transformMat3(this.angVelocity,this.angMomentum,this.invInertia)}}(),localToWorld:function(t,e){return vec3.transformMat4(t,e,this.transform)},addForceAtLocal:function(t,e){this.addForceAt(t,this.localToWorld(vec3.create(),e))},addImpulseAtLocal:function(t,e){this.addImpulseAt(t,this.localToWorld(vec3.create(),e))},velocityAt:function(t,e){if(this.moves){var s=vec3.subtract(t,e,this.position);return vec3.cross(s,this.angVelocity,s),vec3.add(s,s,this.velocity)}if(this.invTime){var o=i(t,e,this.transform);vec3.transformMat4(o,o,this.prevTransform),vec3.subtract(o,e,o),vec3.scale(o,o,this.invTime);var a=vec3.length(o);return a>2&&vec3.scale(o,o,2/a),o}return vec3.set(t,0,0,0)},move:function(t,i){this.moves&&(vec3.add(this.position,this.position,t),e(this.orientation,i,1))},startFrame:function(t){vec3.scaleAndAdd(this.forceAccum,this.forceAccum,this.gravity,this.mass),vec3.scale(this.acceleration,this.forceAccum,this.invMass*t),vec3.add(this.velocity,this.velocity,this.acceleration),vec3.scale(this.velocity,this.velocity,Math.pow(this.linDamping,t)),vec3.scaleAndAdd(this.angMomentum,this.angMomentum,this.torqueAccum,t),vec3.scale(this.angMomentum,this.angMomentum,Math.pow(this.angDamping,t)),vec3.transformMat3(this.angVelocity,this.angMomentum,this.invInertia),vec3.set(this.forceAccum,0,0,0),vec3.set(this.torqueAccum,0,0,0)},calculateInertia:function(){mat3.fromQuat(this.invInertia,this.orientation);var t=mat3.transpose(mat3.create(),this.invInertia);mat3.multiply(this.invInertia,this.invInertia,this.localInvInertia),mat3.multiply(this.invInertia,this.invInertia,t)},calculateDerived:function(){if(this.moves){mat4.fromQuat(this.transform,this.orientation);var t=vec3.transformMat4(vec3.create(),this.center,this.transform);vec3.subtract(t,this.position,t),this.transform[12]=t[0],this.transform[13]=t[1],this.transform[14]=t[2],this.calculateInertia()}},integrate:function(t){this.moves&&(vec3.scaleAndAdd(this.position,this.position,this.velocity,t),e(this.orientation,this.angVelocity,t),this.calculateDerived())}},h.prototype.reset=function(){this.calculateVelocity(),this.calculatePenetration()},function(){function t(t,e,i){var s=e.invInertia,o=e.invMass,a=i[0]-e.position[0],c=i[1]-e.position[1],r=i[2]-e.position[2],n=s[0],h=s[1],v=s[2],l=s[3],d=s[4],u=s[5],y=s[6],m=s[7],f=s[8],p=r*l-c*y,b=r*d-c*m,A=r*u-c*f,g=a*y-r*n,M=a*m-r*h,I=a*f-r*v,V=c*n-a*l,T=c*h-a*d,w=c*v-a*u;t[0]=b*r-A*c+o,t[1]=A*a-p*r,t[2]=p*c-b*a,t[3]=M*r-I*c,t[4]=I*a-g*r+o,t[5]=g*c-M*a,t[6]=T*r-w*c,t[7]=w*a-V*r,t[8]=V*c-T*a+o}function e(t,e,s,o,a,c,r,n,h){var v=a*r,l=c*r;vec3.scaleAndAdd(i,e,s,-vec3.dot(e,s));var d=.2*vec3.length(i);-d>l?(v+=l+d,l=-d):l>d&&(v+=l-d,l=d),vec3.scale(n,s,v),c>1e-4?vec3.scale(h,o,l/c):vec3.set(h,0,0,0)}var i=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3),c=new Float32Array(3),r=new Float32Array(3),v=new Float32Array(3),l=new Float32Array(9),d=new Float32Array(9);n.prototype.calculateVelocity=function(){this.body1.velocityAt(this.velocity,this.pos1),this.body2&&vec3.subtract(this.velocity,this.velocity,this.body2.velocityAt(i,this.pos2));var t=vec3.dot(this.body1.acceleration,this.normal);this.body2&&(t-=vec3.dot(this.body2.acceleration,this.normal)),this.deltaVelocity=-vec3.dot(this.velocity,this.normal)*(this.restitution+1),this.fromAccel<0&&(this.deltaVelocity+=t*this.restitution)},h.prototype.calculateVelocity=function(){this.body1.velocityAt(this.velocity,this.pos1),vec3.subtract(this.velocity,this.velocity,this.body2.velocityAt(i,this.pos2)),this.deltaVelocity=vec3.length(this.velocity)},n.prototype.calculatePenetration=function(){this.penetration=vec3.dot(this.normal,vec3.subtract(i,this.pos2,this.pos1))},h.prototype.calculatePenetration=function(){this.penetration=vec3.length(vec3.subtract(this.normal,this.pos2,this.pos1)),this.penetration>1e-6&&vec3.scale(this.normal,this.normal,1/this.penetration)},n.prototype.resolveVelocity=function(){if(this.friction){t(l,this.body1,this.pos1),this.body2&&(t(d,this.body2,this.pos2),s(l,d)),mat3.invert(d,l),vec3.negate(r,this.velocity),vec3.scaleAndAdd(r,r,this.normal,vec3.dot(this.normal,this.velocity)),vec3.scaleAndAdd(i,r,this.normal,this.deltaVelocity),vec3.transformMat3(i,i,d);var e=vec3.dot(i,this.normal);vec3.scaleAndAdd(o,i,this.normal,-e);var n=vec3.length(o);if(n>e*this.friction){vec3.normalize(r,r),vec3.scaleAndAdd(i,this.normal,r,this.friction),vec3.transformMat3(o,i,l);var h=vec3.dot(o,this.normal);if(Math.abs(h)<1e-4)return;vec3.scale(i,i,this.deltaVelocity/h)}}else{vec3.subtract(a,this.pos1,this.body1.position),vec3.cross(i,a,this.normal),vec3.transformMat3(r,i,this.body1.invInertia);var u=vec3.dot(i,r)+this.body1.invMass;this.body2&&(vec3.subtract(c,this.pos2,this.body2.position),vec3.cross(i,c,this.normal),vec3.transformMat3(v,i,this.body2.invInertia),u+=vec3.dot(i,v)+this.body2.invMass),u=1/u,vec3.scale(i,this.normal,this.deltaVelocity*u)}this.body1.addImpulseAt(i,this.pos1),this.body2&&(vec3.negate(i,i),this.body2.addImpulseAt(i,this.pos2))},h.prototype.resolveVelocity=function(){t(l,this.body1,this.pos1),t(d,this.body2,this.pos2),s(l,d),mat3.invert(l,l),vec3.transformMat3(i,this.velocity,l),this.body2.addImpulseAt(i,this.pos2),vec3.negate(i,i),this.body1.addImpulseAt(i,this.pos1)},n.prototype.resolvePosition=function(t){vec3.subtract(a,this.pos1,this.body1.position),vec3.cross(i,a,this.normal),vec3.transformMat3(r,i,this.body1.invInertia);var s=vec3.dot(i,r),o=this.body1.invMass,n=0,h=0;this.body2&&(vec3.subtract(c,this.pos2,this.body2.position),vec3.cross(i,c,this.normal),vec3.transformMat3(v,i,this.body2.invInertia),n=vec3.dot(i,v),h=this.body2.invMass);var l=s+o+n+h;return 1e-4>l?!1:(l=this.penetration/l,e(this.body1,a,this.normal,r,s,o,l,t.pos1,t.rot1),void(this.body2&&e(this.body2,c,this.normal,v,n,h,-l,t.pos2,t.rot2)))},h.prototype.resolvePosition=n.prototype.resolvePosition}(),function(){var t=vec3.create(),e=vec3.create(),i=vec3.create();u.prototype.resolve=function(){var s=this.body1.localToWorld(t,this.pos1),o=this.body2.localToWorld(e,this.pos2),a=vec3.subtract(i,o,s),c=vec3.length(a);c>1e-4?vec3.scale(a,a,(this.restLength-c)*this.stiffness/c):vec3.set(a,(this.restLength-c)*this.stiffness,0,0),this.body2.addForceAt(a,o),vec3.negate(a,a),this.body1.addForceAt(a,s)}}(),y.prototype.resolve=function(t,e){this.body1.localToWorld(this.contact.pos1,this.pos1),this.body2.localToWorld(this.contact.pos2,this.pos2);var i=vec3.squaredDistance(this.contact.pos1,this.contact.pos2);1e-7>i||(this.contact.reset(),e.push(this.contact))},m.prototype.init=function(t,e){if(t.boneList){if(!t.animated){for(var i=0;i<t.boneList.length;++i){var s=t.boneList[i];mat4.multiply(s.localTransform,e,s.localTransform)}t.animated=!0}this.bodies=[],this.constraints=[];for(var i=0;i<t.boneList.length;++i){var s=t.boneList[i];s.body=new r(s,!!s.parent),s.parent&&(s.body.parent=s.parent.body),this.bodies.push(s.body),s.parent&&s.constraint&&this.constraints.push(new y(s.parent.body,s.body,s.constraint.parent.translate,s.constraint.local.translate))}}},m.prototype.update=function(t,e,i){if(this.bodies||this.init(t,i),this.bodies){void 0===this.time&&(this.time=e);var s=vec3.create();vec3.transformMat4(s,s,f.d3gl.mvMatrix);var a=new o(vec3.fromValues(0,0,1),s[2]);a.friction=3,this.bodies[0].setTransform(i,e-this.time);{Math.min(e-this.time,.5)}this.time<e-.5&&(this.time=e-.5);for(var c=1/60;this.time<e-c;){this.time+=c;for(var r=[a],n=[],h=0;h<this.bodies.length;++h)this.bodies[h].startFrame(c),this.bodies[h].getShapes(r);d(r,n,.1);for(var h=0;h<this.constraints.length;++h)this.constraints[h].resolve(c,n);v(n);for(var h=0;h<this.bodies.length;++h)this.bodies[h].integrate(c)}for(var h=0;h<t.boneList.length;++h){var l=t.boneList[h];mat4.multiply(l.transform,l.localTransform,l.invTransform)}}},f.D3Ragdoll=m}();