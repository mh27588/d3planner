!function(){function t(t){var e=[];if(t.max){var s=t.min,i=t.max;"min"===t.best&&(s=t.max,i=t.min);(a=Math.round((s+(i-s)*p.Optimizer.perfection)/(t.step||1))*(t.step||1))<t.min&&(a=t.min),a>t.max&&(a=t.max),e.push(a)}if(t.max2){var a=Math.round(t.min2+(t.max2-t.min2)*p.Optimizer.perfection);a<t.min2&&(a=t.min2),a>t.max2&&(a=t.max2),e.push(a)}if(t.args<0)for(var o in p.passives[p.charClass]){e.push(o);break}return e}function e(t,e,s){if(!t.affixes.all[e])return!1;var i=p.stats[e];if(!i)return!1;if(i.secondary&&t.state.secondary>=t.affixes.secondary)return!1;if(!i.secondary&&t.state.primary>=t.affixes.primary)return!1;if(t.state.groups[i.group||e])return!1;i.secondary?t.state.secondary+=1:t.state.primary+=1,t.state.groups[i.group||e]=!0;var a=s||t.affixes.all[e];if(t.imported&&t.imported.stats&&t.imported.stats[e]){for(var o=!1,n=0;n<a.length;++n)a[n]>t.imported.stats[e][n]&&(o=!0);o||(a=$.extend([],t.imported.stats[e]))}if(t.stats[e])if(i.dr)for(n=0;n<a.length;++n)t.stats[e][n]=100-(100-(t.stats[e][n]||0))*(100-a[n])/100;else for(n=0;n<a.length;++n)t.stats[e][n]=(t.stats[e][n]||0)+a[n];else t.stats[e]=a;return!0}function s(s){function i(e,s){var i={};for(var a in e){var n=p.stats[n];n&&o&&n.classes&&n.classes.indexOf(o)<0||(s&&s[a]?i[a]=s[a]:i[a]="sockets"===a?[e[a].max]:t(e[a]))}return i}var a=p.getSlot(s);if(a){(a=$.extend(!0,{},a)).info=p.itemById[a.id];var o=p.itemTypes[a.info.type].class;!o&&a.info.set&&(o=p.itemSets[a.info.set].class);var n=p.getStatCount(a.id);a.affixes={primary:n[0],secondary:n[1],all:i(p.getItemAffixesById(a.id,a.ancient,!1))},a.state={primary:0,secondary:0,groups:{}};for(var r=p.getItemPreset(a.id),l=0;l<r.length;++l)r[l]=p.smartListStats(r[l],a.affixes.all,o);a.affixes.preset=r;var c=p.getItemAffixesById(a.id,a.ancient,"only"),f=a.stats;a.stats=i(c,f);for(var d in c){(h=p.stats[d])&&(h.secondary?a.state.secondary+=1:h.base||(a.state.primary+=1),c[d].noblock||(a.state.groups[h.group||d]=!0))}if(p.Optimizer.unlock&&(delete a.enchant,delete a.imported),a.affixes.all.sockets){a.gems=[];if("onehand"===(s=p.itemTypes[a.info.type].slot)||"twohand"===s){var m=p.Optimizer.useGift;if(!m&&a.imported&&f.sockets){var u=0;for(var d in f)!p.stats[d]||p.stats[d].secondary||p.stats[d].caldesanns||p.stats[d].base||(u+=1);u>a.affixes.primary&&(m=!0)}m&&(a.stats.sockets=a.affixes.all.sockets,a.state.groups.sockets=!0)}}a.imported&&(a.enchant?a.affixes.preset=[[a.enchant]]:a.affixes.preset=[]);for(var d in f){var h=p.stats[d];h&&(h.caldesanns?a.stats[d]=f[d]:!a.imported||h.base||c[d]||"sockets"===d&&a.stats.sockets||(a.enchant&&a.enchant!==d?e(a,d,f[d]):a.enchant||a.affixes.preset.push([d])))}return a}}function i(t,e){var s=p.getSlot(t);if(s){if(s=$.extend(!0,{},s),s.stats={},Object.keys(e.stats).sort(function(t,e){return(p.stats[t]&&p.stats[t].prio||0)-(p.stats[e]&&p.stats[e].prio||0)}).forEach(function(t){s.stats[t]=e.stats[t]}),s.gems&&s.stats.sockets&&s.stats.sockets[0]){e.gems||(e.gems=[]);for(var i=0;i<s.gems.length&&e.gems.length<s.stats.sockets[0];++i)s.gems[i]&&p.legendaryGems[s.gems[i][0]]&&e.gems.push(s.gems[i])}if(s.gems=e.gems,s.imported=e.imported,s.imported){for(var a in s.stats)if(e.affixes.all[a]&&(!p.stats[a]||!p.stats[a].caldesanns)){if(!(a in s.imported.stats)){s.enchant=a;break}if(s.imported.stats[a].length>=1&&s.stats[a][0]!==s.imported.stats[a][0]){s.enchant=a;break}if(s.imported.stats[a].length>=2&&s.stats[a][1]!==s.imported.stats[a][1]){s.enchant=a;break}}s.enchant||(s.enchant=s.imported.enchant)}else delete s.enchant;p.setSlot(t,s)}}function a(t){return t=$.extend({},t),t.stats=$.extend(!0,{},t.stats),t.state=$.extend(!0,{},t.state),t.gems&&(t.gems=$.extend(!0,[],t.gems)),t}function o(t){t=a(t);for(var s=0,i=0;i<t.affixes.preset.length;++i){var o=t.affixes.preset[i];if(o.length){for(var n=!1,r=void 0,l=0;l<o.length;++l){if(t.stats[o[l]]){if(t.imported&&t.imported.stats&&t.imported.stats[o[l]]){n=!0;for(var c=0;c<t.stats[o[l]].length;++c)t.stats[o[l]][c]!==t.imported.stats[o[l]][c]&&(n=!1)}else n=!0;if(n)break}r||p.stats[o[l]].classes&&!(p.stats[o[l]].classes.indexOf(p.charClass)>=0)||(r=o[l])}if(!n&&!e(t,r||o[0],t.imported&&t.imported.stats&&t.imported.stats[r||o[0]])&&++s>1)return!1}}return t}function n(t){return t.finishLoad(),p.addSkillBonuses&&p.addSkillBonuses(t),t.finalize(),t}function r(t,s,i,r,l){function c(t,i,l){if(t=a(t),e(t,i,l)&&o(t)){var p=u.clone();p.addItem(s,t),n(p);return(l=d.value(r,p))>k&&(k=l,y=t),t}}var d=f[i],m=t[s],u=new p.Stats(p.charClass);u.startLoad();for(var h in t)h!==s&&u.addItem(h,t[h]);if(l)d.stats(r,m).forEach(function(t){var s=a(m);e(s,t)&&(m=s)}),t[s]=m;else{for(var v=d.stats(r,m).filter(function(t){return e(a(m),t)}),g={0:m},k=0,y=m,x=1;x<1<<v.length;++x){var b=-1;if(m.imported&&!m.enchant)for(j=0;j<v.length;++j)x&1<<j&&!m.imported.stats[v[j]]&&(b=j);if(b<0)for(b=0;!(x&1<<b);)++b;var S=x-(1<<b);if(g[S])if(m.imported&&!m.enchant&&m.imported.stats[v[b]]){g[x]=c(g[S],v[b],m.imported.stats[v[b]]);for(j=0;j<v.length;++j)x&1<<j&&g[S=x-(1<<j)]&&c(g[S],v[j])}else{var z=c(g[S],v[b]);m.imported&&!m.enchant||(g[x]=z)}}m=t[s]=y}if(m.stats.sockets&&m.gems.length<m.stats.sockets[0]){var $=p.itemTypes[m.info.type].slot,C=$&&(p.itemSlots[$]||p.metaSlots[$])||{};if("jewelry"!==C.socketType){var O="weapon"===C.socketType||"head"===C.socketType?C.socketType:"other",_=m.gems.length,I=m.stats.sockets[0],T=void 0;for(var w in p.gemColors){for(j=_;j<I;++j)m.gems[j]=[p.gemColors[w][O].amount.length-1,w];var E=u.clone();E.addItem(s,m),n(E);var B=d.value(r,E);B>k&&(k=B,T=w)}if(T)for(var j=_;j<I;++j)m.gems[j]=[p.gemColors[T][O].amount.length-1,T];else m.gems.length=_}}return m}function l(t,s,i,n){var r=t[s],l=a(t[s]);if(e(l,i)&&o(l)&&(r=t[s]=l),r.stats.sockets&&r.gems.length<r.stats.sockets[0]){var c=p.itemTypes[r.info.type].slot,f=c&&(p.itemSlots[c]||p.metaSlots[c])||{};if("jewelry"!==f.socketType){var d="weapon"===f.socketType||"head"===f.socketType?f.socketType:"other",m=void 0;for(var u in p.gemColors)if(p.gemColors[u][d].stat===i){m=u;break}if(m)for(;r.gems.length<r.stats.sockets[0];)r.gems.push([p.gemColors[m][d].amount.length-1,m])}}return r}var p=DiabloCalc,c=DiabloCalc.locale("ui-equipment.js","ui-skills.js","skilldata");p.Optimizer={perfection:1,useGift:!0,unlock:!1};var f={dps:{name:c("Damage"),options:{speed:{type:"checkbox",name:c("Attack speed")},elem:{type:"select",options:function(){var t={"":c("No Element")};for(var e in{phy:1,fir:1,col:1,psn:1,arc:1,lit:1,hol:1})(!p.stats["dmg"+e].classes||p.stats["dmg"+e].classes.indexOf(p.charClass)>=0)&&(t["dmg"+e]=p.elements[e]);return t}},skill:{type:"select",options:function(){var t={"":c("No Skill")},e=p.extendStats([],"skill_"+p.charClass);for(var s in p.skills[p.charClass])e.indexOf("skill_"+p.charClass+"_"+s)>=0&&(t["skill_"+p.charClass+"_"+s]=p.skills[p.charClass][s].name);return t}},elite:{type:"checkbox",name:c("vs Elites")}},stats:function(t,e){var s=["wpnphy","damage","chc","chd",p.classes[p.charClass].primary];if(t.elem&&s.push(t.elem),t.skill&&s.push(t.skill),e){for(var i=void 0,a=0;a<e.affixes.preset.length&&!i;++a)for(var o=0;o<e.affixes.preset[a].length;++o){var n=e.affixes.preset[a][o];if(p.stats[n]&&p.stats[n].damage){i=n;break}}i&&(s[0]=i)}var r=e&&p.itemTypes[e.info.type].slot;return t.speed&&s.push("onehand"===r||"twohand"===r?"weaponias":"ias"),t.elite&&s.push("edmg"),s},value:function(t,e){var s=t.speed?e.info.dps:e.info.dph;return t.elem&&(s*=1+.01*(e[t.elem]||0)),t.elite&&(s*=1+.01*(e.edmg||0)),t.skill&&(s*=(1+.01*((e.damage||0)+(e[t.skill]||0)))/(1+.01*(e.damage||0))),s}},toughness:{name:c("Toughness"),options:{},stats:function(t,e){return["vit","life","resall","armor","resphy","resfir","rescol","respsn","resarc","reslit","edef","meleedef","rangedef"]},value:function(t,e){return e.info.toughnessmin}},healing:{name:c("Healing"),options:{},stats:function(t,e){var s=e&&p.itemTypes[e.info.type].slot,i=["regen","lph","laek","healbonus"];return t.speed&&i.push("onehand"===s||"twohand"===s?"weaponias":"ias"),i},value:function(t,e){return e.info.recoverymin}}},d=$.extend({},f);p.Optimizer.priority=[{stat:"sockets",options:{}},{stat:"dps",options:{}},{stat:"toughness",options:{}}],p.Optimizer.getOptions=function(t){for(var e=0;e<this.priority.length;++e)if(this.priority[e].stat===t)return this.priority[e].options},p.Optimizer.optimizeAll=function(){p.importStart();var t={};for(var e in p.itemSlots){var a=s(e);a&&(t[e]=a)}p.Optimizer.priority.forEach(function(e){s=$.extend({},t);if(f[e.stat]){for(var s=$.extend({},t),i=0;i<2;++i)for(var a in t)s[a]=t[a],r(s,a,e.stat,e.options,0==i);t=s}else for(var a in t)"sockets"===e.stat&&"offhand"===p.itemTypes[t[a].info.type].slot||l(t,a,e.stat,e.options)});for(var n in t)t[n]=o(t[n])||t[n];for(var n in t)i(n,t[n]);DiabloCalc.importEnd("global")},p.Optimizer.dialog=function(){function t(){p.Optimizer.priority=[],a.find(".optimize-priority-item").each(function(){p.Optimizer.priority.push($(this).data("item"))}),p.trigger("updateStatPriority")}function e(t,e){t.empty();var s="";$.each(d,function(t,e){s+='<option value="'+t+'">'+e.name+"</option>"}),t.append('<optgroup label="'+c("Composite Stats")+'">'+s+"</optgroup>"),p.getSkills&&(s="",p.getSkills().skills.forEach(function(t){if(t){var e="skillinfo_"+p.charClass+"_"+t[0];f[e]||(f[e]=function(t,e){function s(t){var s={stats:t,skill:[e,t.skills[e]||"x"],affix:i.affixid,params:i.params,getCurInfo_:p.SkillBox.skill.prototype.getCurInfo_,notip:!0},a=p.SkillBox.skill.prototype.getCurInfo.call(s,i,t),o=p.skill_processInfo(a,s),n={};for(var r in o)(!a[r]||"object"==typeof a[r]&&void 0===a[r].cooldown&&void 0===a[r].duration&&void 0===a[r].cost&&void 0===a[r].value)&&void 0!==o[r].value&&(n[r]=o[r].value);return n}var i=p.skills[t][e];return{name:i.name,options:{value:{type:"select",options:function(){var t=s(p.getStats()),e={};for(var i in t)e[i]=c(i);return e}}},stats:function(s,a){function o(t){d.indexOf(t)<0&&d.push(t)}function n(s){if(s&&"object"==typeof s)if(s.sum)for(var i in s)n(c[i]);else o("skill_"+t+"_"+(s&&s.skill||e)),s&&s.elem&&o("max"===s.elem?"dmg"+(r.info.maxelem||"fir"):"dmg"+s.elem)}if(!a)return[];var r=p.getStats(),l={skill:[e,r.skills[e]||"x"],affix:i.affixid,params:i.params,getCurInfo_:p.SkillBox.skill.prototype.getCurInfo_,notip:!0},c=p.SkillBox.skill.prototype.getCurInfo.call(l,i,r),d=f.dps.stats({speed:!0,elite:!0},a);return n(c[s.value]),d.push("cdr","rcr"),d},value:function(t,e){return s(e)[t.value]||0}}}(p.charClass,t[0])),s+='<option value="'+e+'">'+f[e].name+"</option>"}}),s.length&&t.append('<optgroup label="'+c("Skill Values")+'">'+s+"</optgroup>"));var i=p.options.limitStats?p.charClass:null;$.each(p.statList,function(s,a){$.each(a,function(a,o){"secondary"===s&&(a+=c(" (Secondary)"));var n="";p.extendStats([],o).forEach(function(t){p.stats[t].caldesanns||i&&p.stats[t].classes&&p.stats[t].classes.indexOf(i)<0&&t!==e||(n+='<option value="'+t+'">'+p.stats[t].name+"</option>")}),n&&t.append('<optgroup label="'+a+'">'+n+"</optgroup>")})}),t.val(e)}function s(t){var s=$('<li class="optimize-priority-item"></li>');s.data("item",t),a.find(".optimize-priority-list").append(s),s.append('<div class="header"><span class="btn-remove"></span><select class="optimize-stat"></select></div>');var i=$("<div></div>");s.append(i);var o=s.find("select");return e(o,t.stat),o.change(function(){t.stat=$(this).val(),i.empty(),f[t.stat]&&$.each(f[t.stat].options,function(e,s){if("checkbox"===s.type){(a=$('<label class="option-box"><input type="checkbox"></input>'+s.name+"</label>")).find("input").prop("checked",!!t.options[e]).click(function(){t.options[e]=!!$(this).prop("checked"),p.trigger("updateStatPriority")}),i.append(a)}else{var a=$('<select class="option-drop"></select>'),o=s.options();$.each(o,function(t,e){a.append('<option value="'+t+'">'+e+"</option>")}),(t.options[e]||"")in o||(t.options[e]=Object.keys(o)[0]||""),a.val(t.options[e]).change(function(){t.options[e]=$(this).val(),p.trigger("updateStatPriority")}),i.append(a)}})}).change().change(function(){p.trigger("updateStatPriority")}),o.chosen({width:"300px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:c("Choose Stat")}),s.on("mouseenter",".optimize-stat",function(){if(p.tooltip&&f[t.stat]){var e=f[t.stat].stats(t.options);if(e.length){var s=f[t.stat].name,i='<span class="d3-color-gold">'+c("Optimize {0} based on the following stats:").format(s)+"</span>";e.forEach(function(t){i+='<br/><span class="tooltip-icon-bullet"></span>'+p.stats[t].name}),p.tooltip.showHtml(this,i)}}}).on("mouseleave",".optimize-stat",function(){p.tooltip&&p.tooltip.hide()}),o}var i=$('<div class="optimize-dialog"><p><i>'+c("For best results, assign paragon, Caldesanns enchants and skills/passives before using the optimizer.")+"</i></p></div>");i.append('<div><label class="option-box"><input type="checkbox" class="option-unlock"></input>'+c("Unlock imported items")+"</label></div>"),i.find(".option-unlock").prop("checked",!!p.Optimizer.unlock).click(function(){p.Optimizer.unlock=!!$(this).prop("checked")}),i.append('<div><label class="option-box"><input type="checkbox" class="option-gift"></input>'+c("Use Ramaladni's Gift")+"</label></div>"),i.find(".option-gift").prop("checked",!!p.Optimizer.useGift).click(function(){p.Optimizer.useGift=!!$(this).prop("checked")}),i.append("<div>"+c("Set stat values to {0}%").format('<input class="option-perfection" type="number" min="0" max="100"></input>')+"</label></div>"),i.find(".option-perfection").val(Math.round(100*p.Optimizer.perfection)).change(function(){var t=parseInt($(this).val())||0;t<0&&(t=0),t>100&&(t=100),$(this).val(t),p.Optimizer.perfection=.01*t});var a=$('<div class="optimize-priority"><ul class="optimize-priority-list"></ul></div>');a.append('<div class="btn-add">'+c("Add stat")+"</div>"),i.append(a);var o=!1;return p.register("updateSkills",function(){a.find(".header select").each(function(){var t=$(this);e(t,t.val()),t.trigger("chosen:updated")})}),p.register("updateSlotItem",function(){o=!1;for(var t in p.itemSlots){var s=p.getSlot(t);s&&(s.imported&&(o=!0))}$(".option-unlock").closest("div").toggle(o),a.find(".header select").each(function(){var t=$(this);e(t,t.val()),t.trigger("chosen:updated")})}),a.find(".btn-add").click(function(){var e=s({stat:"",options:{}});t(),setTimeout(function(){e.trigger("chosen:open")},0)}),a.on("click",".btn-remove",function(){$(this).closest("li").remove(),t()}),a.find(".optimize-priority-list").sortable({handle:".header",distance:4,axis:"y",placeholder:"drop-ph",forcePlaceholderSize:!0,start:function(){a.find("select").trigger("chosen:close")},stop:function(e,s){s.item.css({position:"",left:"",top:""}),setTimeout(t,0)}}),p.Optimizer.updatePriority=function(){a.find(".optimize-priority-list").empty(),p.Optimizer.priority.forEach(s)},i}}();