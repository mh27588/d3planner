!function(){function t(t){t.hover(function(){var s=t.attr("min"),e=t.attr("max");if(s&&e&&f.tooltip){for(var i=parseFloat(t.attr("step")||1)||1,a=0;a<2&&Math.floor(i-1e-6)==Math.floor(i+1e-6);)a+=1,i*=10;var o='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-green">'+f.formatNumber(parseFloat(s),a,1e3)+'</span>-<span class="d3-color-green">'+f.formatNumber(parseFloat(e),a,1e3)+"</span></p><div>";f.tooltip.showHtml(t[0],o)}},function(){f.tooltip.hide()})}function s(t,s,e,i,a){void 0!==s?(t.attr("min",s),"min"===a&&t.val(s)):t.removeAttr("min"),void 0!==e?(t.attr("max",e),a&&"min"!==a&&t.val(e)):t.removeAttr("max"),t.prop("disabled",s===e&&void 0!==s),t.attr("step",i||1)}function e(t){var s=parseFloat(t.attr("min")),e=parseFloat(t.attr("max"));return!isNaN(s)&&!isNaN(e)&&s===e}function i(t,s,e){var i=f.extendStats([],t);if(0==i.length)return i;for(var a=[],o=0;o<i.length;++o)f.stats[i[o]]&&e&&f.stats[i[o]].classes&&!(f.stats[i[o]].classes.indexOf(e)>=0)||s&&!s[i[o]]||a.push(i[o]);return 0==a.length&&a.push(i[0]),a}function a(t,s,e){if(e)for(var i in e){var a=e[i];"string"==typeof a&&(a=s[a]),$.each(f.extendStats([],i),function(s,e){t[e]=a})}return t}function o(t,s,e,i){return i?"only"===i?a(t,s,e.required):(a(t,s,e.affixes),a(t,s,e.required)):a(t,s,e.affixes)}function n(t,s,e){if(s)for(var i=0;i<s.length;++i){for(var a=s[i];f.statGroups[a];)a=f.statGroups[a][0];e[a=f.stats[a]&&f.stats[a].group||a]||(t[s[i]]=!0,e[a]=!0)}}function r(t){var s=t.type.val();return f.legendaryGems[s]?(t.level.show(),t.colorSpan.hide(),t.level):f.gemQualities[s]?(t.level.hide(),t.colorSpan.show(),t.color):(t.level.hide(),void t.colorSpan.hide())}function l(t,s){var e=f.statLimits.legendary;return t&&f.itemById[t]?("rare"===f.itemById[t].quality&&(e=f.statLimits.rare),f.qualities[f.itemById[t].quality].ancient&&s&&(e=f.statLimits.ancient)):e=f.statLimits.rare,e}function p(t){if(!t||!f.itemById[t])return[];var s=f.itemById[t].type,e=f.itemTypes[s].slot,i={},a={};return n(i,f.itemById[t].preset,a),n(i,f.itemTypes[s].preset,a),f.metaSlots[e]?n(i,f.metaSlots[e].preset,a):n(i,f.itemSlots[e].preset,a),Object.keys(i)}function h(t,s,e){if(!t||!f.itemById[t])return{};var i=f.itemById[t].type,n=f.itemTypes[i].slot,r=l(t,s),p={};if(f.metaSlots[n]?o(p,r,f.metaSlots[n],e):o(p,r,f.itemSlots[n],e),o(p,r,f.itemTypes[i],e),o(p,r,f.itemById[t],e),"primal"===s)for(var h in p)(p[h].max&&p[h].min<p[h].max||p[h].max2&&p[h].min2<p[h].max2)&&(p[h]=$.extend({},p[h]),"min"===p[h].best?(p[h].max&&(p[h].max=p[h].min),p[h].max2&&(p[h].max2=p[h].min2)):(p[h].max&&(p[h].min=p[h].max),p[h].max2&&(p[h].min2=p[h].max2)));return s&&"only"!==e&&a(p,r,{caldesanns:{step:5,min:5,max:1e3}}),p}function d(t,s,e){var i=t.data("chosen");if(i){var a=i.result_add_option;i.result_add_option=function(t){var i=s.call(e||this,t.value);return i&&((t=$.extend({},t)).search_text='<div class="icon-wrap">'+i+"</div>"+t.search_text),a.call(this,t)}}}function m(t,s,e){var i=t.data("chosen");if(i){var a=i.search_string_match;i.search_string_match=function(t,o,n){return s.call(e||this,n,function(t){return a.call(i,t,o)})}}}function c(s,e,i,a){this.box=s,this.type=e,this.required=i,this.line=$("<li></li>"),this.inner=$("<div></div>"),this.remove=$('<span class="item-info-stat-remove" title="'+v("Remove stat")+'"></span>'),this.list=$('<select class="item-info-stat-list"></select>'),this.value=$('<input class="item-info-stat-value" type="number"></input>').hide(),this.value2=$('<input class="item-info-stat-value" type="number"></input>').hide(),this.inner.append($('<span style="position: absolute"></span>').append(this.remove,'<span class="item-info-stat-enchanted" title="'+v("Enchanted")+'"></span>')),this.inner.append(this.list,this.value,this.value2),this.line.append(this.inner),s.statsDiv.append(this.line),s.stats.push(this);var o=this;this.remove.click(function(){o.onRemove()}),i&&this.remove.hide(),t(this.value),t(this.value2),this.updateList(a),this.list.chosen({disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:v("Select a Stat"),populate_func:function(){o.generateList()}}).change(function(){var t=!!o.sockets;o.onChangeStat(),o.value.is(":visible")&&o.value.focus().select(),t||o.sockets||o.box.slot&&f.itemSlots[o.box.slot].flourish?o.box.updateItem(!0):o.box.updateStats(!0)}),f.chosenTips(this.list,function(t){if(f.tooltip){var s=o.conflicts&&o.conflicts[t];if(s&&s!==t&&f.stats[s]){e='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Conflicts with:")+"</span>";e+='</br><span class="tooltip-icon-bullet"></span>'+f.stats[s].name+"</p></div>",f.tooltip.showHtml(this,e)}else if(s===t){e='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Already present on the item.")+"</span></p></div>";f.tooltip.showHtml(this,e)}else if("_resall"===s){var e='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Conflicts with preset stat:")+'</span></br><span class="tooltip-icon-bullet"></span>'+f.stats.resall.name+"</p></div>";f.tooltip.showHtml(this,e)}}}),this.value.blur(f.validateNumber),this.value2.blur(f.validateNumber),this.value.on("input",function(){var t=!!o.sockets;o.onChangeValue(),t||o.sockets?o.box.updateItem(!0):o.box.updateStats(!0)}),this.value2.on("input",function(){o.box.updateStats(!0)}),this.onChangeStat()}function u(t,s){var e=t.list.val(),i=s.list.val(),a=f.stats[e]?"sockets"===e?4:f.stats[e].secondary?2:0:"secondary"===t.type?3:"socket"===t.type?5:1,o=f.stats[i]?"sockets"===i?4:f.stats[i].secondary?2:0:"secondary"===s.type?3:"socket"===s.type?5:1;return a!=o?a-o:f.stats[e]&&f.stats[i]?f.stats[e].prio-f.stats[i].prio:0}var v=DiabloCalc.locale("ui-equipment.js"),f=DiabloCalc;f.getStatCount=function(t){var s=f.itemById[t],e=4,i=2;return void 0!==s.primary?e=s.primary:["quiver","source","mojo","phylactery"].indexOf(s.type)>=0&&(e=5),void 0!==s.secondary&&(i=s.secondary),[e,i]},f.smartListStats=i,f.getItemPreset=p,f.getItemAffixesById=function(t,s,e){function i(s,e){return f.stats[t]&&f.stats[t].dr?100-(100-s)*(100-e)/100:s+e}if(!e||"only"===e)return h(t,s,e);var a=h(t,s,!1),o=h(t,s,"only"),n={};for(var t in o)t in a&&o[t].noblock?(n[t]=$.extend({},o[t]),a[t].max&&(n[t].max=i(n[t].max,a[t].max)),a[t].max2&&(n[t].max2=i(n[t].max2,a[t].max2))):n[t]=o[t];for(var t in a)t in o||(n[t]=a[t]);return n},f.makeItem=function(t,s,e){function a(t,s){if(!s[t])return[0];var e=[];return s[t].max&&e.push(s[t].max),s[t].max2&&e.push(s[t].max2),s[t].args<0&&e.push("powerhungry"),e}var o={id:t,stats:{},ancient:e||!1},n=p(t),r=f.getItemAffixesById(t,o.ancient,!1),l=f.getItemAffixesById(t,o.ancient,"only");for(var h in l)o.stats[h]="custom"===h&&s||a(h,l);for(var d=0;d<n.length;++d){var m=i(n[d],r,f.charClass);m.length&&!o.stats[m[0]]&&(o.stats[m[0]]=a(m[0],r))}return o.stats.sockets&&(o.gems=[]),o},f.getOffhandTypes=function(t){var s=!f.classes[f.charClass].dualwield,e=!1;if("crusader"!==f.charClass&&(t||f.itemSlots.mainhand.item&&f.itemById[f.itemSlots.mainhand.item.id])){var i=t||f.itemById[f.itemSlots.mainhand.item.id].type;f.itemTypes[i]&&"twohand"==f.itemTypes[i].slot&&(e=!0)}var a=f.itemSlots.offhand.types,o={},n=!1;for(var r in a){var l=a[r];e&&"quiver"!==r||(s&&"onehand"===l.slot&&"handcrossbow"!==r||(o[r]=l,l.classes&&l.classes.indexOf(f.charClass)<0||"customwpn"!==r&&l.weapon&&(n=!0)))}return n||delete o.customwpn,o},f.isItemAllowed=function(t,s,e){if(!s||!f.itemById[s]||f.itemSlots[t].drop.inactive)return!1;var i=f.itemById[s],a=i.type;f.itemTypes[a].slot;if(i.classes&&i.classes.indexOf(f.charClass)<0)return!1;var o=f.itemSlots[t].types;return"offhand"===t&&(o=f.getOffhandTypes(e)),!(!o[a]||o[a].classes&&o[a].classes.indexOf(f.charClass)<0)},f.trimStats=function(t){var s=f.getItemAffixesById(t.id,t.ancient,!0);for(var e in t.stats)if(s[e]){var i=t.stats[e];i.length>=1&&(s[e].min&&(i[0]=Math.max(i[0],s[e].min)),s[e].max&&(i[0]=Math.min(i[0],s[e].max))),i.length>=2&&(s[e].min2&&(i[1]=Math.max(i[1],s[e].min2)),s[e].max2&&(i[1]=Math.min(i[1],s[e].max2))),t.stats[e]=i}else delete t.stats[e]},f.trimItem=function(t,s,e){if(s&&f.itemById[s.id]&&!f.itemSlots[t].drop.inactive){var i=f.itemById[s.id].type,a=f.itemTypes[i].generic;if(f.isItemAllowed(t,a,e)){var o={id:a,stats:$.extend(!0,{},s.stats)};if(f.trimStats(o),s.gems&&o.stats.sockets){o.gems=[];for(var n=0;n<s.gems.length&&n<o.stats.sockets[0];++n)o.gems.push(s.gems[n])}return o}}},DiabloCalc.chosen_addIcons=d,DiabloCalc.chosen_fixSearch=m,c.prototype.enable=function(t){this.list.prop("disabled",!t||!!this.required),this.list.trigger("chosen:updated"),this.value.prop("disabled",!!e(this.value)||!t),this.value2.prop("disabled",!!e(this.value2)||!t)},c.prototype.updateList=function(t){if(this.required){this.list.prop("disabled",!0),this.list.empty();var s='<option value="'+this.required+'">';if("custom"==this.required){var e=this.box.getItemAffixes(!0);e.custom&&(s+=e.custom.name)}else s+=f.stats[this.required].name;this.list.append(s+"</option>")}else{this.list.prop("disabled",!1);var i=t||this.list.val();f.noChosen?this.fillList(t):(this.list.empty(),this.list.append("<option></option>"),f.stats[i]&&this.list.append('<option value="'+i+'" selected="selected">'+f.stats[i].name+"</option>"))}},c.prototype.fillList=function(t){var s=this.box.getItemAffixes(),e=t||this.list.val(),i=f.options.limitStats?this.box.charClass:null;if(!i){(l=this.box.getId())&&!(i=f.itemTypes[f.itemById[l].type].class)&&f.itemById[l].set&&(i=f.itemSets[f.itemById[l].set].class)}if(this.list.empty(),this.list.append('<option value="">'+(f.noChosen?v("Select a Stat"):"")+"</option>"),"socket"!==this.type)if("caldesanns"!==this.type){for(var a in f.statList)if(!("primary"===this.type&&"primary"!==a||"secondary"===this.type&&"secondary"!==a))for(var o in f.statList[a]){var n=o;"secondary"===a&&"secondary"!==this.type&&(n+=v(" (Secondary)"));f.statList[a][o];var r="";$.each(f.extendStats([],f.statList[a][o]),function(a,o){i&&f.stats[o].classes&&f.stats[o].classes.indexOf(i)<0&&o!==t||s.hasOwnProperty(o)&&(r+='<option value="'+o+(o==e?'" selected="selected':"")+'">'+f.stats[o].name+"</option>")}),r&&this.list.append('<optgroup label="'+n+'">'+r+"</optgroup>")}}else for(var l in f.stats)f.stats[l].caldesanns&&s.hasOwnProperty(l)&&this.list.append('<option value="'+l+'"'+(e===l?' selected="selected"':"")+">"+f.stats[l].name+"</option>");else s.sockets&&this.list.append('<option value="sockets"'+("sockets"===e?' selected="selected"':"")+">"+f.stats.sockets.name+"</option>")},c.prototype.generateList=function(){var t=this.box.getId();if(t&&!this.required){for(var s=this.box.getItemAffixes(!0),e={},i=0;i<this.box.stats.length;++i){o=this.box.stats[i].list.val();f.stats[o]&&(s[o]&&s[o].noblock||(e[f.stats[o].group||o]=o))}if(p(t).indexOf("resall")>=0)for(var a=f.extendStats([],"resist"),i=0;i<a.length;++i)e[a[i]]||(e[a[i]]="_resall");var o=this.list.val();this.fillList(o),f.stats[o]&&(o=f.stats[o].group||o),this.conflicts={};var n=this;this.list.find("option").each(function(){var t=$(this).val();if(f.stats[t]){var s=t;t=f.stats[t].group||t,"_resall"===e[s]?($(this).prop("disabled",!0),n.conflicts[s]="_resall"):t==o||!e[t]&&!e[s]?$(this).removeAttr("disabled"):($(this).prop("disabled",!0),n.conflicts[s]=e[t]||e[s])}})}},c.prototype.onRemove=function(){if(!this.required){var t=this.line.index();this.box.removeStat(t,this.merged)}},c.prototype.generatePassives=function(t,s){var e;t&&(e=this.passiveBox.val()),this.passiveBox.empty();var i=f.options.limitStats?this.box.charClass:null;if(i){r=f.passives[i];for(var a in r)this.passiveBox.append('<option value="'+a+(a===e?'" selected="selected':"")+'">'+r[a].name+"</option>"),a===e&&(e=void 0)}else for(var o in f.classes)if(f.passives[o]){var n='<optgroup label="'+f.classes[o].name+'">',r=f.passives[o];for(var a in r)n+='<option value="'+a+(a===e?'" selected="selected':"")+'">'+r[a].name+"</option>",a===e&&(e=void 0);this.passiveBox.append(n+"</optgroup>")}s&&e&&f.allPassives[e]&&this.passiveBox.append('<option value="'+e+'" selected="selected">'+f.allPassives[e].name+"</option>")},c.prototype.onChangeValue=function(){if("sockets"==this.list.val()){this.socketList||(this.socketList=$('<ul class="item-info-gemlist"></ul>'),this.sockets=[],this.line.append(this.socketList));var t=parseInt(this.value.val());for(t=Math.max(t,1),t=Math.min(t,3);this.sockets.length>t;)this.sockets.pop().line.remove();for(;this.sockets.length<t;)!function(t,s){var e={line:$("<li></li>"),type:$('<select class="item-info-gem-type"></select>'),colorSpan:$("<span></span>"),color:$('<select class="item-info-gem-color"></select>'),level:$('<input class="item-info-gem-level" type="number" min="0" max="200"></input>')};e.type.append('<option value="">'+(f.noChosen?v("Empty Socket"):"")+"</option>");var i=s.box.type.val();i=f.itemTypes[i]?f.itemTypes[i].slot:null;var a=0;for(var o in f.legendaryGems)f.legendaryGems[o].types&&f.legendaryGems[o].types.indexOf(i)>=0&&++a;if(a){var n='<optgroup label="'+v("Legendary Gems")+'">';for(var o in f.legendaryGems)f.legendaryGems[o].types&&f.legendaryGems[o].types.indexOf(i)>=0&&(n+='<option class="quality-legendary" value="'+o+'">'+f.legendaryGems[o].name+"</option>");n+='</optgroup><optgroup label="'+v("Normal Gems")+'">';for(l=f.gemQualities.length-1;l>=0;--l)n+='<option value="'+l+'">'+f.gemQualities[l]+"</option>";e.type.append(n+"</optgroup>")}else for(var l=f.gemQualities.length-1;l>=0;--l)e.type.append('<option value="'+l+'">'+f.gemQualities[l]+"</option>");for(var o in f.gemColors)e.color.append('<option value="'+o+'">'+f.gemColors[o].name+"</option>");e.line.append(e.type).append(e.colorSpan.append(e.color)).append(e.level),s.socketList.append(e.line),e.type.chosen({disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,allow_single_deselect:!0,placeholder_text_single:v("Empty Socket")}).change(function(){var t=r(e);t===e.level?t.focus().select():t==e.color&&setTimeout(function(){t.trigger("chosen:open")},0)}).change(function(){s.box.updateItem(!0)}),f.chosenTips(e.type,function(t){f.tooltip&&f.legendaryGems[t]&&f.tooltip.showGem(this,t)}),d(e.type,function(t){if(isNaN(t)){var s=f.legendaryGems[t];if(s&&s.id in f.itemIcons)return'<span style="background: url(css/items/gemleg.png) 0 -'+24*f.itemIcons[s.id][0]+'px no-repeat"></span>'}else if((t=parseInt(t))>=0&&t<f.gemQualities.length)return'<span style="background: url(css/items/gems.png) -'+24*t+'px -120px no-repeat"></span>'}),e.color.chosen({disable_search:!0,inherit_select_classes:!0}).change(function(){if(0===t){for(var e=!0,i=1;i<s.sockets.length;++i)s.sockets[i].type.val()&&(e=!1);if(e)for(var a=s.sockets[0].type.val(),o=$(this).val(),i=1;i<s.sockets.length;++i)s.sockets[i].type.val(a),s.sockets[i].type.trigger("chosen:updated"),r(s.sockets[i]),s.sockets[i].color.val(o),s.sockets[i].color.trigger("chosen:updated")}s.box.updateItem(!0)}),f.chosenTips(e.color,function(t){if(f.tooltip&&f.gemColors[t]){var s=i&&(f.itemSlots[i]||f.metaSlots[i])||{};f.tooltip.showGem(this,[parseInt(e.type.val()),t],void 0,s.socketType||"other")}}),d(e.color,function(t){var s=f.gemColors[t];if(s&&s.id in f.itemIcons){return'<span style="background: url(css/items/gems.png) -'+24*parseInt(e.type.val())+"px -"+24*f.itemIcons[s.id][0]+'px no-repeat"></span>'}}),r(e),e.level.blur(f.validateNumber).blur().on("input",function(){s.box.updateStats(!0)}),s.sockets.push(e)}(this.sockets.length,this)}else this.socketList&&(this.socketList.remove(),delete this.socketList,delete this.sockets);this.box.updateEnchant()},c.prototype.updateLimits=function(t){var e=this.list.val(),i=this,a=this.box.getItemAffixes(!!this.required),o=a[e];if("string"==typeof o){o=(r=this.box.getLimits())[o]}if(this.merged){var n=this.box.getItemAffixes("only")[e];if("string"==typeof n){var r=this.box.getLimits();n=r[n]}o=$.extend({},o),f.stats[e]&&f.stats[e].dr?(o.min=100-.01*(100-(o.min||0))*(100-(n.min||0)),o.max=100-.01*(100-(o.max||0))*(100-(n.max||0)),o.step="any"):(o.min=(o.min||0)+(n.min||0),o.max=(o.max||0)+(n.max||0))}var l=0;"custom"===this.required?l=void 0===a.custom.args?1:a.custom.args:f.stats[e]&&(l=f.stats[e].args);var p=!this.prevStat||!o;this.prevStat&&o&&(this.prevStat.min!==o.min&&(p=!0),this.prevStat.max!==o.max&&(p=!0),this.prevStat.step!==o.step&&(p=!0)),l>=1?(this.value.show(),s(this.value,o?o.min:void 0,o?o.max:void 0,o?o.step:1,p&&!t&&(o&&o.best||"max")),this.value.blur()):this.value.hide(),l>=2?(this.value2.show(),s(this.value2,o?o.min2:void 0,o?o.max2:void 0,o?o.step2:1,p&&!t&&(o&&o.best||"max")),this.value2.blur()):this.value2.hide(),l<0?(this.passive||(this.passiveBox=$('<select class="item-info-stat-passive"><option value=""></option></select>'),f.noChosen&&this.passiveBox.find("option").text(v("Select a Passive Skill")),this.passive=$("<span></span>"),this.passive.append(this.passiveBox),this.inner.append(this.passive),this.passiveBox.chosen({inherit_select_classes:!0,search_contains:!0,placeholder_text_single:v("Select a Passive Skill"),populate_func:function(){i.generatePassives(!0)}}).change(function(){i.box.updateStats(!0)}),f.chosenTips(this.passiveBox,function(t){f.tooltip&&f.passives[f.charClass][t]&&f.tooltip.showSkill(this,f.charClass,t)}),d(this.passiveBox,function(t){var s=f.passives[f.charClass][t];if(s)return'<span style="background: url(css/images/class-'+f.charClass+"-passive.png) "+-20*s.index+'px 0 / auto 40px no-repeat"></div>'})),this.generatePassives(this.prevStat===o,!0),this.passiveBox.trigger("chosen:updated"),this.passive.show()):this.passive&&this.passive.hide(),this.prevStat=o,this.onChangeValue()},c.prototype.onChangeStat=function(t){this.box.getId();var s=this.list.val(),e="";f.stats[s]?"sockets"===s?(e="stat-socket",this.type||(this.type="primary")):f.stats[s].secondary?(e="stat-secondary",this.type||(this.type="secondary")):(e="stat-primary",this.type||(this.type="primary")):("primary"===this.type&&(e="stat-primary"),"secondary"===this.type&&(e="stat-secondary"),"socket"===this.type&&(e="stat-socket")),this.line.attr("class",e);var i=this.box.getItemAffixes("only");if(!this.required&&i[s]){this.merged=s;for(var a=0;a<this.box.stats.length;++a)this.box.stats[a].required===s&&(this.box.stats[a].line.remove(),this.box.stats.splice(a--,1))}else if(this.merged){if(i[this.merged]){this.box.onAddStat(this.merged,this.merged).list.val(this.merged)}delete this.merged}this.box.reorderStats(this.box.stats.indexOf(this)),this.box.updateStatCounts(),this.updateLimits()},f.ItemBox=function(t,s){var e=this;this.doUpdate=function(){delete e.upd_timeout,e.onUpdate(e.upd_itemChanged,e.upd_reason),delete e.upd_itemChanged,delete e.upd_reason},$.extend(this,s),this.type=$('<select class="item-info-type"></select>'),this.item=$('<select class="item-info-item"></select>'),this.transmogs=$('<select class="item-info-item"></select>'),this.dyes=$('<select class="item-info-item item-info-dye"></select>'),this.equipSet=$('<span class="item-info-equipset">'+v("Equip full set")+"</span>").hide(),this.ancientSel=$('<select class="item-info-ancient"><option value="false">'+v("Normal")+'</option><option value="true">'+v("Ancient")+'</option><option value="primal">'+v("Primal Ancient")+"</option></select>"),Object.defineProperty(this,"ancient",{get:function(){var t=this.ancientSel.val();return"primal"===t?t:"true"===t},set:function(t){t="primal"===t?"primal":t?"true":"false",this.ancientSel.val(t)}}),this.statsDiv=$('<ul class="item-info-statlist chosen-noframe"></ul>'),this.typeSpan=$('<span style="display: inline-block; vertical-align: top"></span>'),this.itemSpan=$('<span style="display: inline-block; vertical-align: top"></span>'),this.itemMod=$('<div class="item-mod chosen-noframe"></div>'),this.importDiv=$('<div class="item-info-imported">'+v("Imported item ({0}, {1})").format('<span class="link-like item-imported-reset">'+v("reset")+"</span>",'<span class="link-like item-imported-unlock">'+v("unlock")+"</span>")+"</div>"),this.unimportDiv=$('<div class="item-info-unimport"><span class="link-like item-imported-lock">'+v("Lock item")+"</span></div>"),this.stats=[],this.importReset=this.importDiv.find(".item-imported-reset"),this.importUnlock=this.importDiv.find(".item-imported-unlock"),this.importLock=this.unimportDiv.find(".item-imported-lock"),this.importReset.click(function(){var t=e.getData();t.imported&&(t.enchant=t.imported.enchant,t.stats=$.extend(!0,{},t.imported.stats)),e.setItem(t)}),this.importReset.hover(function(){var t=e.getData();t.imported&&(t.enchant=t.imported.enchant,t.stats=t.imported.stats),f.tooltip.showItem(this,t)},function(){f.tooltip.hide()}),this.importUnlock.click(function(){var t=e.getData();delete t.imported,delete t.enchant,e.setItem(t)}),this.importLock.click(function(){e.lockItem()}),this.div=$('<div class="item-info"></div>'),this.slot&&this.div.append("<h3>"+f.itemSlots[this.slot].name+"</h3>"),this.div.append($("<div></div>").append(this.typeSpan.append(this.type)).append(this.itemSpan.append(this.item))),this.typeSpan.append(this.equipSet),this.itemSpan.append(this.ancientSel),this.div.append(this.importDiv,this.statsDiv),this.equipSet.click(function(){e.onEquipSet()}),f.register("updateSlotItem",function(){e.updateEquipSet()}),f.register("importEnd",function(){e.updateEquipSet()}),t.append(this.div),this.add=$('<div class="item-info-add-stat">'+v("Add stat")+"</div>").click(function(){var t=e.onAddStat();e.updateStats(),setTimeout(function(){t.list.trigger("chosen:open")},0)}),this.div.append(this.add),this.badstats=$('<span class="item-info-badstats"></span>').hide(),this.div.append(this.badstats),this.div.append(this.itemMod.append(this.transmogs,this.dyes)),this.div.append(this.unimportDiv),this.ancientSel.change(function(){e.updateItem(),e.updateLimits()}),this.type.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>"),this.type.change(function(){e.type.val()?(e.onChangeType(),setTimeout(function(){e.item.trigger("chosen:open")},0)):(e.item.val(""),e.onChangeType())}),this.type.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,placeholder_text_single:v("Empty Slot")}),this.item.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>"),this.item.change(function(){e.onChangeItem()}),this.item.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,search_contains:!0,placeholder_text_single:v("Empty Slot"),populate_func:function(){e.populateItems()}}),this.transmogs.append('<option value="">'+(f.noChosen?v("Transmogrification"):"")+"</option>"),this.transmogs.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,search_contains:!0,placeholder_text_single:v("Transmogrification"),populate_func:function(){e.fillTransmogs()}}),this.transmogs.change(function(){e.onUpdate(!0)}),this.dyes.append('<option value="">'+(f.noChosen?v("Dye"):"")+"</option>");for(var i in f.webglDyes)this.dyes.append('<option value="'+i+'" class="item-info-icon">'+f.webglDyes[i].name+"</option>");this.dyes.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,search_contains:!0,placeholder_text_single:v("Dye")}),this.dyes.change(function(){e.onUpdate(!0)}),d(this.item,function(t){var s=this.type.val()||f.itemById[t]&&f.itemById[t].type,e=f.itemIcons[t];if(("custom"===s||"customwpn"==s)&&this.slot){var i=f.getOffhandTypes&&"offhand"===this.slot?f.getOffhandTypes():f.itemSlots[this.slot].types;for(var a in i)if(!(i[a].classes&&i[a].classes.indexOf(f.charClass)<0)){s=a,e=f.itemIcons[f.itemTypes[s].generic];break}}if(void 0!==e)return'<span style="background: url(css/items/'+s+".png) 0 -"+24*e[0]+'px no-repeat"></span>'},this),m(this.item,function(t,s){var e=f.itemById[t];if(e)return!!s(e.name)||(!!(e.required&&e.required.custom&&s(e.required.custom.format))||void 0)},this),d(this.transmogs,function(t){var s=f.itemIcons[t],e=f.itemById[t]||f.webglItems[t];if(void 0!==s&&e&&e.type)return'<span style="background: url(css/items/'+e.type+".png) 0 -"+24*s[0]+'px no-repeat"></span>'},this),d(this.dyes,function(t){var s=f.itemIcons[t];if(void 0!==s)return'<span style="background: url(css/items/dyes.png) 0 -'+24*s[0]+'px no-repeat"></span>'},this),f.chosenTips(this.item,function(t){f.tooltip&&f.itemById[t]&&f.tooltip.showItem(this,t,e.slot)}),f.chosenTips(this.transmogs,function(t){f.tooltip&&f.itemById[t]&&"rare"!==f.itemById[t].quality?f.tooltip.showItem(this,t):f.tooltip&&f.webglItems[t]&&f.tooltip.showExtraItem(this,t)}),f.chosenTips(this.dyes,function(t){f.tooltip&&f.webglDyes[t]&&f.tooltip.showExtraItem(this,t)})},f.ItemBox.prototype.removeStat=function(t,s){var e=this.stats[t].list.val();if(this.stats[t].line.remove(),this.stats.splice(t,1),s){this.onAddStat(s,s).list.val(s)}f.stats[e]?this.updateStatCounts():this.updateWarning(),this.updateItem(!0)},f.ItemBox.prototype.updateItem=function(t){this.suppress||(f.importActive?this.onUpdate(!0,t):(this.upd_itemChanged=this.upd_itemChanged||!0,this.upd_reason=t,this.upd_timeout||(this.upd_timeout=setTimeout(this.doUpdate,0))))},f.ItemBox.prototype.updateStats=function(t){this.suppress||(f.importActive?this.onUpdate(!1,t):(this.upd_itemChanged=this.upd_itemChanged||!1,this.upd_reason=t,this.upd_timeout||(this.upd_timeout=setTimeout(this.doUpdate,0))))},f.ItemBox.prototype.onUpdate=function(t,s){this.slot&&f.trigger(t?"updateSlotItem":"updateSlotStats",this.slot,s)},f.ItemBox.prototype.getLimits=function(){return l(this.item.val(),this.ancient)},f.ItemBox.prototype.getItemAffixes=function(t){return f.getItemAffixesById(this.item.val(),this.ancient,t)},f.ItemBox.prototype.updateStatCounts=function(){if(!this.nonRecursive){this.nonRecursive=!0;var t=this.item.val();if(t&&f.itemById[t]){var s=f.getStatCount(t);if("Unique_Ring_021_x1"===t)for(p=0;p<this.stats.length;++p){"spiritregen"!==(h=this.stats[p].list.val())&&"wrathregen"!==h||(++s[0],--s[1])}for(var e=0,i=0,a=0,o=[],n=[],r=[],l=!1,p=0;p<this.stats.length;++p){var h=this.stats[p].list.val();if(!f.stats[h]||!f.stats[h].base){var d=1;this.stats[p].merged&&++d,f.stats[h]&&f.stats[h].caldesanns&&(d=0,l=!0),(f.stats[h]?f.stats[h].secondary:"secondary"===this.stats[p].type)?i+=d:(f.stats[h]||"socket"!==this.stats[p].type)&&(e+=d),f.stats[h]||("secondary"===this.stats[p].type?n.push(this.stats[p]):"socket"===this.stats[p].type?r.push(this.stats[p]):"primary"===this.stats[p].type&&o.push(this.stats[p])),"sockets"===h&&++a}}var m=this.type.val();if("onehand"===(m=f.itemTypes[m]?f.itemTypes[m].slot:null)||"twohand"===m)a||0!==r.length?e-=a:this.onAddStat("socket");else if(r.length){(c=this.stats.indexOf(r[0]))>=0&&(this.stats[c].line.remove(),this.stats.splice(c,1))}for(this.imported&&this.ancient&&!l&&this.onAddStat("caldesanns");e<s[0];)this.onAddStat("primary"),++e;for(;e>s[0]&&o.length;){(c=this.stats.indexOf(o.pop()))>=0&&(this.stats[c].line.remove(),this.stats.splice(c,1)),--e}for(;i<s[1];)this.onAddStat("secondary"),++i;for(;i>s[0]&&n.length;){var c=this.stats.indexOf(n.pop());c>=0&&(this.stats[c].line.remove(),this.stats.splice(c,1)),--i}this.updateWarning(),this.updateEnchant(),delete this.nonRecursive}}},f.ItemBox.prototype.updateEnchant=function(){if(delete this.enchant,this.imported){for(s=0;s<this.stats.length;++s){e=this.stats[s].list.val();if(!this.stats[s].required&&(!f.stats[e]||!f.stats[e].caldesanns)){if(!(e in this.imported.stats)){this.enchant=e;break}if(this.imported.stats[e].length>=1&&parseFloat(this.stats[s].value.val())!==this.imported.stats[e][0]){this.enchant=e;break}if(this.imported.stats[e].length>=2&&parseFloat(this.stats[s].value2.val())!==this.imported.stats[e][1]){this.enchant=e;break}}}this.enchant||(this.enchant=this.imported.enchant)}var t=!1;"source"!==this.type.val()&&"mojo"!==this.type.val()||!this.ancient||(t="wpnphy");for(var s=0;s<this.stats.length;++s){var e=this.stats[s].list.val();this.stats[s].line.toggleClass("stat-enchanted",e===this.enchant),this.stats[s].line.toggleClass("stat-caldesanns","caldesanns"===this.stats[s].type),this.stats[s].enable(!this.stats[s].required&&e===this.enchant||!this.enchant||this.stats[s].required===t||"caldesanns"===this.stats[s].type)}},f.ItemBox.prototype.updateWarning=function(){var t=this.item.val();if(t&&f.itemById[t]){for(var s=this.getItemAffixes(!0),e=p(t),a=f.getStatCount(t),o={},n=0,r=0,l=0,h=0,d=0;d<this.stats.length;++d){var m=this.stats[d].list.val();if(m?o[m]=!0:h+=1,f.stats[m]&&!f.stats[m].base){var c=1;this.stats[d].merged&&++c,f.stats[m].caldesanns&&(c=0),f.stats[m].secondary?r+=c:n+=c,"sockets"==m&&(l=1)}}var u=this.type.val();"onehand"!=(u=f.itemTypes[u]?f.itemTypes[u].slot:null)&&"twohand"!=u&&(l=0),f.options.moreWarnings&&(h=0);var y="";n+h<a[0]?y+='</br><span class="tooltip-icon-bullet"></span>'+v("Add more primary stats"):n-l>a[0]&&(y+='</br><span class="tooltip-icon-bullet"></span>'+v("Too many primary stats")),r>a[1]?y+='</br><span class="tooltip-icon-bullet"></span>'+v("Too many secondary stats"):f.options.moreWarnings&&r<a[1]&&(y+='</br><span class="tooltip-icon-bullet"></span>'+v("Add more secondary stats"));for(var g=[],d=0;d<e.length;++d){var x=i(e[d],s);if(x.length){for(var b=!1,I=0;I<x.length;++I)if(o[x[I]]){b=!0;break}b||g.push(e[d])}}if(g.length>1){y+='<br/><span class="tooltip-icon-bullet"></span>'+v("More than one preset stat is missing");for(d=0;d<e.length;++d){var S=e[d];f.stats[e[d]]?S=f.stats[e[d]].name:f.statGroupNames[e[d]]?S=f.statGroupNames[e[d]]:0==e[d].indexOf("skill_")&&(S=v("Skill Damage")),y+='<br/><span class="tooltip-icon-nobullet"></span><span class="d3-color-white">',g.indexOf(e[d])>=0?y+="<s>"+S+"</s>":y+=S,y+="</span>"}}y?(y='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Impossible stat combination")+"</span>"+y+"</p></div>",this.badstats.hover(function(){f.tooltip.showHtml(this,y)},function(){f.tooltip.hide()}),this.badstats.show()):this.badstats.hide()}else this.badstats.hide()},f.ItemBox.prototype.reorderStats=function(t){for(var s=t,e=this.stats[t];s<this.stats.length&&u(e,this.stats[s])>=0;)s++;for(;s>0&&u(e,this.stats[s-1])<=0;)s--;t!=s&&t+1!=s&&(s==this.stats.length?this.statsDiv.append(e.line):this.stats[s].line.before(e.line),this.stats.splice(t,1),s>t&&(s-=1),this.stats.splice(s,0,e))},f.ItemBox.prototype.updateLimits=function(){for(var t=this.ancient,s=0;s<this.stats.length;++s){var e=this.stats[s].list.val();!t&&f.stats[e]&&f.stats[e].caldesanns?this.removeStat(s--):this.stats[s].updateLimits()}this.updateStatCounts()},f.ItemBox.prototype.onAddStat=function(t,s,e){if("primary"!==t&&"secondary"!==t&&"socket"!==t&&"caldesanns"!==t&&(s||e)){e=s,s=t,t=void 0;var i=s||e;if(f.stats[i]){var a=this.type.val();t="onehand"!==(a=f.itemTypes[a]?f.itemTypes[a].slot:null)&&"twohand"!==a||"sockets"!==i?f.stats[i].secondary?"secondary":this.imported&&f.stats[i].caldesanns?"caldesanns":"primary":"socket"}}return new c(this,t,s,e)},f.ItemBox.prototype.onEquipSet=function(t){l=this.item.val();if(!l||!f.itemById[l]||!f.itemById[l].set)return!1;var s,e=f.itemById[l],i=f.itemSets[e.set],a={},o={};if(f.itemSlots.mainhand&&f.itemSlots.mainhand.item){var n=f.itemSlots.mainhand.item.id;n&&f.itemById[n]&&(s=f.itemById[n].type)}for(var r in f.itemSlots){var l;(l=f.getSlotId(r))&&(o[l]=r)}for(var p=0;p<i.items.length;++p){var h=i.items[p];if(!o[h.id]){var d=h.type,m=[r=f.itemTypes[d].slot];f.metaSlots[r]&&(m=f.metaSlots[r].slots);for(var c=0;c<m.length;++c)if(!a[m[c]]&&!f.getSlotId(m[c])&&f.isItemAllowed(m[c],h.id,s)){a[m[c]]=h.id;break}}}if($.isEmptyObject(a))return!1;if(t)return!0;var u=this.ancient;for(var r in a)f.setSlot(r,f.makeItem(a[r],void 0,u));return!0},f.ItemBox.prototype.updateEquipSet=function(){this.equipSet.toggle(this.onEquipSet(!0))},f.ItemBox.prototype.onChangeItem=function(){delete this.enchant,delete this.imported,this.div.removeClass("item-imported");var t=this.item.val(),s=f.itemById[t];if(s&&s.type!==this.type.val())return this.type.val(s.type),this.type.trigger("chosen:updated"),void this.onChangeType();t?(this.itemSpan.show(),this.statsDiv.show(),this.add.show(),this.unimportDiv.show()):(this.itemSpan.show(),this.statsDiv.hide(),this.add.hide(),this.unimportDiv.hide());var e=this;if("mainhand"===this.slot&&f.itemSlots.offhand.item&&f.itemById[f.itemSlots.offhand.item.id]){var a=this.type.val(),o=f.itemById[f.itemSlots.offhand.item.id].type;f.itemTypes[a]&&"twohand"==f.itemTypes[a].slot&&"crusader"!=f.charClass&&o&&"quiver"!=o&&f.trigger("updateSlotItem","offhand","twohand")}if(this.updateItem(),this.updateMods(),this.updateEquipSet(),!t)return this.statsDiv.empty(),this.stats=[],this.badstats.hide(),void this.ancientSel.hide();this.nonRecursive=!0;this.getItemAffixes(!1);var n=this.getItemAffixes("only"),r=this.getItemAffixes(!0),l=[];$.each(p(t),function(t,s){l.push({list:i(s,r,e.charClass)})});for(var h in n)l.push({list:[h],required:h});var d=f.getStatCount(t);f.qualities[f.itemById[t].quality].ancient?this.ancientSel.show():this.ancientSel.hide();for(var m=[],c=0;c<this.stats.length;++c){var u=!1,h=this.stats[c].required||this.stats[c].list.val();if(r[h]){for(b=0;b<l.length;++b)if(l[b].list.indexOf(h)>=0){l[b].required?(this.stats[c].required=l[b].required,this.stats[c].remove.hide()):(delete this.stats[c].required,this.stats[c].remove.show()),this.stats[c].updateList(),this.stats[c].list.trigger("chosen:updated"),l.splice(b,1),u=!0;break}u||(this.stats[c].required?r[this.stats[c].required]?(delete this.stats[c].required,this.stats[c].remove.show(),m.push(this.stats[c])):(this.stats[c].line.remove(),this.stats.splice(c--,1)):m.push(this.stats[c]))}else this.stats[c].line.remove(),this.stats.splice(c--,1)}for(var v=0,c=0;c<this.stats.length;++c){h=this.stats[c].required||this.stats[c].list.val();f.stats[h]&&f.stats[h].secondary?d[1]--:f.stats[h]&&f.stats[h].base||d[0]--,"socket"===h&&++v}var y=this.type.val();"onehand"!=(y=f.itemTypes[y]?f.itemTypes[y].slot:null)&&"twohand"!=y&&(d[0]+=v),m.sort(function(t,s){return(t.list.val()||"").length-(s.list.val()||"").length});for(c=0;c<l.length;++c)if(0!=l[c].list.length){var g=h=l[c].list[0];r[I]&&r[I].noblock||(g=f.stats[h].group||h);for(b=0;b<m.length;++b){if((I=m[b].list.val())===g||f.stats[I]&&f.stats[I].group===g){S=this.stats.indexOf(m[b]);m[b].line.remove(),m.splice(b--,1),S>=0&&this.stats.splice(S,1)}}if(f.stats[h]){var x=void 0;if(f.stats[h].secondary?--d[1]<0&&(x=!0):f.stats[h].base||--d[0]<0&&(x=!1),void 0!==x)for(var b=0;b<m.length;++b){var I=m[b].list.val();if(!f.stats[I]||!f.stats[I].base){if(!(!f.stats[I]||!f.stats[I].secondary)===x){var S=this.stats.indexOf(m[b]);m[b].line.remove(),m.splice(b--,1),S>=0&&this.stats.splice(S,1);break}}}}this.onAddStat(l[c].required,h).list.val(h)}for(c=0;c<m.length;++c)m[c].updateList(),m[c].list.trigger("chosen:updated");m=this.stats.slice();for(c=0;c<m.length;++c)m[c].onChangeStat();delete this.nonRecursive,this.updateStatCounts()},f.ItemBox.prototype.setItem=function(t){if(this.updateItem(),this.div.removeClass("item-imported"),!t||!f.itemById[t.id])return this.type.val(""),this.item.val(""),this.type.trigger("chosen:updated"),this.onChangeType(),!1;var s=f.itemById[t.id];if(this.type.val(s.type),this.type.val()!==s.type)return!1;if(this.type.trigger("chosen:updated"),this.onChangeType(t.id),this.item.val(t.id),this.item.val()!==t.id)return!1;this.ancient=t.ancient,f.qualities[s.quality].ancient?this.ancientSel.show():this.ancientSel.hide(),this.item.trigger("chosen:updated"),this.statsDiv.empty(),this.stats=[];var e=this.getItemAffixes(!1),i=this.getItemAffixes(!0),a=this.getItemAffixes("only");a.basearmor&&!t.stats.basearmor&&(t.stats.basearmor=[a.basearmor.max]),a.baseblock&&!t.stats.baseblock&&(t.stats.baseblock=[a.baseblock.max]),a.blockamount&&!t.stats.blockamount&&(t.stats.blockamount=[a.blockamount.max,a.blockamount.max2]),this.nonRecursive=!0;t.empty;this.enchant=t.enchant,this.imported=t.imported;for(var o in t.stats)if(i[o]){var n=a[o]?o:void 0;n&&a[o].noblock&&e[o]&&t.stats[o].length>=1&&"string"!=typeof t.stats[o][0]&&a[o].max&&t.stats[o][0]>a[o].max&&(n=!1);var l=this.onAddStat(n,o);l.list.val(o);f.stats[o];if(t.stats[o].length>=1&&"string"!=typeof t.stats[o][0]&&l.value.val(t.stats[o][0]),t.stats[o].length>=2&&l.value2.val(t.stats[o][1]),l.onChangeStat(!0),t.stats[o].length>=1&&"string"==typeof t.stats[o][0]&&l.passive&&(l.passiveBox.val(t.stats[o][0]),l.passiveBox.trigger("chosen:updated")),"sockets"===o&&t.gems&&l.sockets)for(var p=0;p<t.gems.length&&p<l.sockets.length;++p)l.sockets[p].type.val(t.gems[p][0]),l.sockets[p].type.trigger("chosen:updated"),r(l.sockets[p]),f.legendaryGems[t.gems[p][0]]?l.sockets[p].level.val(t.gems[p][1]):(l.sockets[p].color.val(t.gems[p][1]),l.sockets[p].color.trigger("chosen:updated"))}else 0;return delete this.nonRecursive,this.imported?this.div.addClass("item-imported"):delete this.enchant,this.updateStatCounts(),this.updateMods(t.transmog,t.dye),this.updateEquipSet(),!0},f.ItemBox.prototype.getId=function(){if(f.itemTypes[this.type.val()]){var t=this.item.val();return f.itemById[t]?t:void 0}},f.ItemBox.prototype.getData=function(){if(f.itemTypes[this.type.val()]){var t=this.item.val(),s=f.itemById[t],e=0;if(s){var i={id:t,stats:{}};f.qualities[s.quality].ancient&&(i.ancient=this.ancient);for(var a=0;a<this.stats.length;++a){var o=this.stats[a].list.val();if(o){if(f.stats[o]){i.stats[o]=[];var n=f.stats[o].args;if("custom"==o&&s.required&&s.required.custom&&(n=void 0===s.required.custom.args?1:s.required.custom.args),n>=1&&i.stats[o].push(parseFloat(this.stats[a].value.val())||0),n>=2&&i.stats[o].push(parseFloat(this.stats[a].value2.val())||0),n<0&&this.stats[a].passive&&i.stats[o].push(this.stats[a].passiveBox.val()),"sockets"===o&&this.stats[a].sockets){i.gems=[];for(var r=0;r<this.stats[a].sockets.length;++r){var l=this.stats[a].sockets[r],p=[l.type.val(),0];f.legendaryGems[p[0]]?p[1]=parseInt(l.level.val()):f.gemQualities[p[0]]?(p[0]=parseInt(p[0]),p[1]=l.color.val()):p=null,p&&i.gems.push(p)}}}}else++e}this.enchant&&i.stats[this.enchant]&&(i.enchant=this.enchant),i.imported=this.imported;var h=this.getMods();return h[0]&&this.transmogs.val()&&(i.transmog=this.transmogs.val()),h[1]&&this.dyes.val()&&(i.dye=this.dyes.val()),e&&(i.empty=e),i}}},f.ItemBox.prototype.updateTypes=function(t){var s=this.type.val();this.type.empty(),this.type.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>");var e=this.slot?f.itemSlots[this.slot].types:f.itemTypes;"offhand"===this.slot&&(e=f.getOffhandTypes());var i={};for(var a in e){var o=e[a];this.charClass&&o.classes&&o.classes.indexOf(this.charClass)<0||(i[e[a].slot]||(i[e[a].slot]=[]),i[e[a].slot].push(a))}for(var n in i){var r=this.type;Object.keys(i).length>1&&i[n].length>1&&(r=$("<optgroup></optgroup>"),f.metaSlots[n]?r.attr("label",f.metaSlots[n].name):r.attr("label",f.itemSlots[n].name),this.type.append(r));for(var l=0;l<i[n].length;++l){var p='<option value="'+(a=i[n][l])+(s==a?'" selected="selected':"")+'">'+f.GenderString(e[a].name)+"</option>";r.append(p)}}this.type.children().length>1?this.type.removeAttr("disabled"):this.type.prop("disabled",!0),this.type.trigger("chosen:updated"),!t&&this.type.val()===s&&s||this.onChangeType()},f.ItemBox.prototype.getMods=function(){var t=!1,s=!1,e=this.item.val(),i=(e=e&&f.itemById[e])&&f.itemTypes[e.type];return e&&i&&("head"!==i.slot&&"shoulders"!==i.slot&&"torso"!==i.slot&&"legs"!==i.slot&&"hands"!==i.slot&&"feet"!==i.slot||(t=!0,s=!0),"mainhand"!==i.slot&&"offhand"!==i.slot&&"twohand"!==i.slot&&"onehand"!==i.slot||"quiver"!==e.type&&(t=!0)),[t,s]},f.ItemBox.prototype.updateMods=function(t,s){var e=this.getMods();this.itemMod.toggle(!(!e[0]&&!e[1]));var i=this.transmogs;f.noChosen||(i=i.next()),i.toggle(e[0]);var a=this.dyes;if(f.noChosen||(a=a.next()),a.toggle(e[1]),e[0])if(f.noChosen)this.fillTransmogs(t);else{this.transmogs.empty();var o=t&&(f.itemById[t]||f.webglItems[t]);this.transmogs.append('<option value="'+(t||"")+'" selected="selected">'+(o&&o.name||"")+"</option>"),this.transmogs.trigger("chosen:updated")}e[1]&&(this.dyes.val(s),this.dyes.trigger("chosen:updated"))},f.ItemBox.prototype.fillTransmogs=function(){function t(t,s){if(s.name&&(!s.id||"rare"!==s.quality)){var i=f.itemTypes[s.type];if(i&&!(i.classes&&i.classes.indexOf(f.charClass)<0||s.classes&&s.classes.indexOf(f.charClass)<0||i.slot!=a.slot)){if("offhand"===i.slot&&i!==a){if(i!==f.itemTypes.shield&&i!==f.itemTypes.crusadershield)return;if(a!==f.itemTypes.shield&&a!==f.itemTypes.crusadershield)return}if(!i.weapon||!a.weapon||i.weapon.type===a.weapon.type){if(s.actor){if("object"==typeof(p=s.actor)&&(p=p[l]),r[p]&&e!==t)return;r[p]=!0}if(s.armortype){var p=s.armortype+"_"+s.look;if(r[p]&&e!==t)return;r[p]=!0}(s.promo?n:o).append('<option value="'+(s.id||t)+'" class="item-info-icon quality-'+(s.quality||(s.promo?"legendary":"normal"))+(e==(s.id||t)?'" selected="selected':"")+'">'+s.name+(s.suffix?" ("+s.suffix+")":"")+"</option>")}}}}var s=this.transmogs,e=s.val();arguments.length>0&&(e=arguments[0]),s.empty(),s.append('<option value="">'+(f.noChosen?v("Transmogrification"):"")+"</option>");var i=this.item.val();if(i=i&&f.itemById[i]){var a=f.itemTypes[i.type],o=$('<optgroup label="'+v("Normal Items")+'"></optgroup>'),n=$('<optgroup label="'+v("Promotion Items")+'"></optgroup>');s.append(o);var r={},l=(f.webglClasses[f.charClass]||{})[f.gender||"female"]||0;$.each(f.webglItems,t),o=$('<optgroup label="'+v("Legendary Items")+'"></optgroup>'),s.append(o),$.each(f.items,t),s.append(n)}},f.ItemBox.prototype.addItemToList=function(t,s){if(!(this.charClass&&t.classes&&t.classes.indexOf(this.charClass)<0)){if(!s){if(f.options.hideLegacy&&t.suffix===v("Legacy"))return;if(f.options.hideCrossClass&&this.charClass&&f.itemPowerClasses&&t.required&&t.required.custom&&f.itemPowerClasses[t.required.custom.id]&&f.itemPowerClasses[t.required.custom.id]!==this.charClass)return;if(f.options.hideCrossClass&&this.charClass&&t.set){var e=f.itemSets[t.set];if(e&&e.tclass&&e.tclass!==this.charClass)return}}var i='<option value="'+t.id+'" class="item-info-icon quality-'+(t.quality||"rare")+(s?'" selected="selected':"")+'">'+t.name+(t.suffix?" ("+t.suffix+")":"")+"</option>";this.item.append(i)}},f.ItemBox.prototype.populateItems=function(t){var s=this.type.val(),e=t||this.item.val();if(this.item.empty(),this.item.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>"),s&&f.itemTypes[s])for(r=0;r<f.itemTypes[s].items.length;++r){var i=f.itemTypes[s].items[r];this.addItemToList(i,i.id===e)}else{var a=this.slot?f.itemSlots[this.slot].types:f.itemTypes;"offhand"===this.slot&&(a=f.getOffhandTypes());var o=[];for(var s in a){var n=a[s];if("custom"!==s&&"customwpn"!==s&&!(this.charClass&&n.classes&&n.classes.indexOf(this.charClass)<0))for(r=0;r<n.items.length;++r)o.push(n.items[r])}o.sort(function(t,s){var e="rare"===t.quality?"":t.quality,i="rare"===s.quality?"":s.quality;if(e!=i)return e.localeCompare(i);var a=t.name.toLowerCase().replace(/^(?:the|a) /,""),o=s.name.toLowerCase().replace(/^(?:the|a) /,"");return a.localeCompare(o)});for(var r=0;r<o.length;++r)this.addItemToList(o[r],o[r].id===e)}},f.ItemBox.prototype.refreshItems=function(t){this.populateItems(t)},f.ItemBox.prototype.onChangeType=function(t){var s=this.type.val();this.refreshItems(t),this.item.trigger("chosen:updated"),this.onChangeItem(),"mainhand"===this.slot&&f.itemSlots.offhand.drop.updateTypes(void 0,s)},f.ItemBox.prototype.setClass=function(t,s){this.charClass=t,void 0!==s&&(this.slot=s),this.updateTypes(!0)},f.ItemBox.prototype.accept=function(t){if(!t||!f.itemById[t])return!1;var s=f.itemById[t].type,e=(this.slot?f.itemSlots[this.slot].types:f.itemTypes)[s];if(!e)return!1;var i=!1,a="offhand"===this.slot&&this.charClass&&!f.classes[this.charClass].dualwield;if("offhand"===this.slot&&"crusader"!==this.charClass&&f.itemSlots.mainhand.item&&f.itemById[f.itemSlots.mainhand.item.id]){var o=f.itemById[f.itemSlots.mainhand.item.id].type;f.itemTypes[o]&&"twohand"==f.itemTypes[o].slot&&(i=!0)}return(!i||"quiver"==s)&&((!a||"onehand"!=e.slot||"handcrossbow"==s)&&!(this.charClass&&e.classes&&e.classes.indexOf(this.charClass)<0))},f.ItemBox.prototype.lockItem=function(){var t=this,s=this.getData(),e=$('<div class="optimize-dialog"><p><i>'+v("Locking an item allows only one stat to be enchanted, which can be useful for optimizing your gear when you can't import it from your profile.")+"</i></p></div>");e.append("<div>"+v("Enchant: {0}").format("<select></select>")+"</div>");var i=e.find("select");i.append('<option value="">'+v("Not enchanted")+"</option>");var a=f.getItemAffixesById(s.id,s.ancient,!1),o=f.getItemAffixesById(s.id,s.ancient,"only");for(var n in s.stats)!f.stats[n]||f.stats[n].base||f.stats[n].caldesanns||!a[n]||a[n].args<0||o[n]&&(o[n].args<=0||s.stats[n][0]<=o[n].max)||i.append('<option value="'+n+'">'+f.stats[n].name+"</option>");var r=[{text:v("Lock"),click:function(){var e=i.val();e||(e=void 0),s.imported={enchant:e,stats:$.extend(!0,{},s.stats)},s.enchant=e,t.setItem(s),$(this).dialog("close")}}];e.dialog({resizable:!1,title:v("Lock item"),height:"auto",width:350,modal:!0,buttons:r,close:function(){e.remove()},open:function(){e.parent().css("overflow","visible")}})}}();