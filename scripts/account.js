!function(){function e(e){e.signin=void 0,e.signout=void 0,e.register=void 0,e.options=void 0,$.cookie("user_name")?(e.signout=$("<span>"+t("sign&nbsp;out")+"</span>"),e.signout.click(function(){$.ajax({url:"account",data:{action:"signout"},type:"POST",dataType:"json",success:function(e){s()},error:function(e){s()}})}),e.options=$("<span>"+t("settings")+"</span>"),e.options.click(function(){i.open("options")}),e.div.empty().append(t("Welcome, {0}").format($.cookie("user_name"))+" (",e.signout,", ",e.options,")"),e.updater&&e.updater.call(e.div,!0)):(e.signin=$("<span>"+t("Sign in")+"</span>"),e.signin.click(function(){i.open("signin")}),e.register=$("<span>"+t("register")+"</span>"),e.register.click(function(){i.open("register")}),e.div.empty().append(e.signin,t(" or "),e.register,(e.suffix||"")+"."),e.updater&&e.updater.call(e.div,!1))}function s(){$("body").toggleClass("logged-in",!!$.cookie("user_name")),$.cookie("user_name")&&(DiabloCalc.session.signedin=!0);for(var s=0;s<a.length;++s)e(a[s])}var t=DiabloCalc.locale("account.js"),i=new function(){this.div=$('<div class="signin-dialog"></div>'),this.tip=$('<p class="tip"></p>'),this.name=$('<input type="text" name="user_name" class="text"></input>'),this.email=$('<input type="text" name="user_email" class="text"></input>'),this.reset_code=$('<input type="text" name="user_reset_code" class="text"></input>'),this.password=$('<input type="password" name="user_password" class="text"></input>'),this.password_old=$('<input type="password" name="user_password_old" class="text"></input>'),this.password_repeat=$('<input type="password" name="user_password_repeat" class="text"></input>'),this.remember=$('<input type="checkbox" name="user_remember" class="checkbox"></input>'),this.div.append(this.tip),this.fieldset=$("<fieldset></fieldset>"),this.form=$("<form></form>").append(this.fieldset),this.div.append(this.form);var e=DiabloCalc.localeTable.account,i=this;this.reset_fields=function(e){this.name.val(""),this.email.val("options"===this.mode?$.cookie("user_email")||"":""),this.reset_code.val("reset"===this.mode?e:""),this.password.val(""),this.password_old.val(""),this.password_repeat.val("")},this.open=function(s,t){this.mode=s,this.reset_fields(t),this.fieldset.empty();var a=210;for(var n in e[s].fields){var o=$("<label>"+e[s].fields[n]+"</label>");"checkbox"===this[n].attr("type")?(o.prepend(this[n]),a+=5):(o.append(this[n]),a+=55),this.fieldset.append(o)}this.fieldset.append('<input type="submit" tabindex="-1" style="position:absolute; top:-1000px"></input>'),this.tip.text(e[s].tip);var r={};for(var d in e[s].buttons)r[e[s].buttons[d]]=function(e){return function(){i.handlers[e].call(i)}}(d);this.div.dialog({height:a,title:e[s].title,buttons:r}).dialog("open")},this.all_fields=$([]).add(this.name).add(this.email).add(this.reset_code).add(this.password).add(this.password_repeat).add(this.password_old),this.all_fields.focus(function(){$(this).removeClass("error")}),this.set_tip=function(e){this.tip.text(e).addClass("highlight"),setTimeout(function(){i.tip.removeClass("highlight",1500)},500)},this.check_length=function(e,s,i,a){return!(e.val().length<i||e.val().length>a)||(e.addClass("error"),this.set_tip(t("Length of {0} must be between {1} and {2}.").format(s,i,a)),!1)},this.check_regexp=function(e,s,t){return!!t.test(e.val())||(e.addClass("error"),this.set_tip(s),!1)},this.validate=function(){var s=!0;this.all_fields.removeClass("error");var i=e[this.mode].fields;if(i.name&&(s=(s=s&&this.check_length(this.name,"username",2,16))&&this.check_regexp(this.name,t("Username may only consist of a-z and 0-9."),/^[a-z0-9._]+$/i)),i.reset_code&&(s=s&&this.check_regexp(this.reset_code,t("Invalid reset code"),/^[0-9a-f]{32}$/)),i.email&&(this.email.val()||"recover"===this.mode)&&(s=(s=s&&this.check_length(this.email,"e-mail",4,128))&&this.check_regexp(this.email,t("Specify a valid e-mail address"),/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/)),i.password&&(this.password.val()||"options"!==this.mode)&&(s=s&&this.check_length(this.password,"password",6,64),i.password_repeat&&s&&this.password.val()!==this.password_repeat.val()&&(this.password_repeat.addClass("error"),this.set_tip(t("Passwords do not match.")),s=!1)),i.password_old&&(s=s&&this.check_length(this.password_old,"password",6,64)),s){var a={action:this.mode};return i.name&&(a.user_name=this.name.val()),i.email&&this.email.val()&&(a.user_email=this.email.val()),i.reset_code&&(a.reset_code=this.reset_code.val()),i.password&&(this.password.val()||"options"!==this.mode)&&(a.password_hash=MD5("SmartSalt"+this.password.val())),i.password_old&&(a.password_old_hash=MD5("SmartSalt"+this.password_old.val())),i.remember&&this.remember.prop("checked")&&(a.user_remember=!0),i.password_old&&(a.user_name=$.cookie("user_name")),a}},this.hostname="",this.handlers={},this.default_handler=function(){var e=this.validate();e&&$.ajax({url:"account",data:e,type:"POST",dataType:"json",success:function(e){"OK"===e.code?(s(),"options"===i.mode||"recover"===i.mode?("recover"===i.mode?i.set_tip(t("Password reset link sent.")):i.set_tip(t("Settings updated.")),i.reset_fields()):i.div.dialog("close")):e.errors&&e.errors.length?i.set_tip(e.errors[0]):i.set_tip(t("Unknown error."))},error:function(e){i.set_tip(t("Unknown error."))}})},this.handlers.register=this.default_handler,this.handlers.signin=this.default_handler,this.handlers.cancel=function(){this.div.dialog("close")},this.handlers.lostpassword=function(){setTimeout(function(){i.open("recover")},0)},this.handlers.already=function(){setTimeout(function(){i.open("reset")},0)},this.handlers.recover=this.default_handler,this.handlers.reset=this.default_handler,this.handlers.update=this.default_handler,this.form.on("submit",function(e){e.preventDefault(),i.default_handler()}),this.div.dialog({autoOpen:!1,height:400,width:400,modal:!0,close:function(){i.form[0].reset(),i.all_fields.removeClass("error")}})},a=[];DiabloCalc.account={makeLine:function(s,t){var i={div:$('<div class="signin-line"></div>'),suffix:s,updater:t};return e(i),a.push(i),i.div},reset:function(e){i.open("reset",e)},userName:function(){return $.cookie("user_name")}}}();