!function(){function t(t){b.setSlot(t),DiabloCalc.tooltip.hide(),setTimeout(function(){var t=b.slot;if(DiabloCalc.itemSlots[t].item)b.itemBox.type.trigger("chosen:activate");else{var e,i="offhand"===t?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[t].types,a=0;for(var l in i)i[l].classes&&i[l].classes.indexOf(DiabloCalc.charClass)<0||"custom"!==l&&(a+=1,e=l);1===a?(b.itemBox.type.val(e),b.itemBox.type.trigger("chosen:updated"),b.itemBox.onChangeType(),setTimeout(function(){b.itemBox.item.trigger("chosen:open")},0)):b.itemBox.type.trigger("chosen:open")}},0)}function e(e){var i=this;this.slot=e,this.slotData=DiabloCalc.itemSlots[e],this.accept=function(t){if(!t||!DiabloCalc.itemById[t])return!1;if(this.inactive)return!1;var e=DiabloCalc.itemById[t].type,i=(this.slot?DiabloCalc.itemSlots[this.slot].types:DiabloCalc.itemTypes)[e];if(!i)return!1;var a=!1,l="offhand"===this.slot&&!DiabloCalc.classes[DiabloCalc.charClass].dualwield;if("offhand"===this.slot&&"crusader"!==DiabloCalc.charClass&&DiabloCalc.itemSlots.mainhand.item){var o=DiabloCalc.itemById[DiabloCalc.itemSlots.mainhand.item.id],s=o&&o.type;DiabloCalc.itemTypes[s]&&"twohand"==DiabloCalc.itemTypes[s].slot&&(a=!0)}return(!a||"quiver"==e)&&((!l||"onehand"!=i.slot||"handcrossbow"==e)&&!(i.classes&&i.classes.indexOf(DiabloCalc.charClass)<0))},this.setItem=function(t,e){if(!this.inactive){if("mainhand"===this.slot&&t&&DiabloCalc.itemById[t.id]&&DiabloCalc.itemSlots.offhand.item&&DiabloCalc.itemById[DiabloCalc.itemSlots.offhand.item.id]){var i=DiabloCalc.itemById[t.id].type,a=DiabloCalc.itemById[DiabloCalc.itemSlots.offhand.item.id].type;if(DiabloCalc.itemTypes[i]&&"twohand"==DiabloCalc.itemTypes[i].slot&&"crusader"!=DiabloCalc.charClass&&a&&"quiver"!=a&&("mainhand"!==b.slot&&DiabloCalc.trigger("updateSlotItem","offhand","twohand"),"stash"===e)){var l=s(DiabloCalc.itemSlots.offhand.item);l&&l.setItem(DiabloCalc.itemSlots.offhand.item)}}b.slot===this.slot?b.setItem(t):(this.slotData.item=t,"mainhand"===this.slot&&DiabloCalc.itemSlots.offhand.drop.updateTypes(),DiabloCalc.trigger("updateSlotItem",this.slot))}},this.getId=function(){return this.slotData.item?this.slotData.item.id:void 0},this.getData=function(){return this.slotData.item},this.updateTypes=function(t,e){this.inactive||(b.slot===this.slot?b.itemBox.updateTypes(t):DiabloCalc.itemSlots[this.slot].item&&!DiabloCalc.isItemAllowed(this.slot,DiabloCalc.itemSlots[this.slot].item.id,e)&&this.setItem(DiabloCalc.trimItem(this.slot,DiabloCalc.itemSlots[this.slot].item,e)))};var a="clone";"neck"===e&&(a=function(){return $('<img style="width: 52px; height: 52px;"></img>').attr("src",DiabloCalc.itemSlots.neck.dollImage.attr("src")).toggleClass("ancient",!(!DiabloCalc.itemSlots.neck.item||!DiabloCalc.itemSlots.neck.item.ancient))}),this.slotData.dollImage.data("slot",this),this.reverting=!1,this.slotData.dollImage.draggable({zIndex:100,cursor:"-webkit-grabbing",appendTo:"body",distance:4,helper:a,start:function(t,e){if(!i.slotData.item||0!=$(".editframe").tabs("option","active"))return setTimeout(function(){$("body").css("cursor","")}),!1;u=i.slotData.dollImage,t.shiftKey||(i.slotData.dollImage.hide(),i.slotData.dollSockets&&i.slotData.dollSockets.hide()),DiabloCalc.tooltip&&DiabloCalc.tooltip.disable()},revert:function(t){if(u=void 0,DiabloCalc.tooltip&&DiabloCalc.tooltip.enable(),!t){if(!window.event)return!0;i.reverting=!0,DiabloCalc.popupMenu(window.event,c.fixkey({Delete:function(){var t=i.slotData.dollImage.draggable("instance");i.reverting=!1,t&&!1!==t._trigger("stop",event)&&t._clear(),i.setItem()}}),function(){var t=i.slotData.dollImage.draggable("instance");i.reverting=!1,t&&$(t.helper).animate(t.originalPosition,parseInt(t.options.revertDuration,10),function(){!1!==t._trigger("stop",event)&&t._clear()})})}return!1},stop:function(){if(i.reverting)return!1;setTimeout(function(){i.slotData.item&&(i.slotData.dollImage.show(),i.slotData.dollSockets&&i.slotData.dollSockets.show())},0)}}).draggable("instance")._adjustOffsetFromHelper=function(){this.offset.click.left=this.margins.left+this.helper.width()/2,this.offset.click.top=this.margins.top+this.helper.height()/2},i.slotData.dollFrame.droppable({hoverClass:"highlight",accept:function(t){var e=t.data("slot");if(!e||e===i)return!1;var a=e.getId();if(!i.accept(a))return!1;if(DiabloCalc.shiftKey)return!0;var l=i.getId();return!l||e.accept(l)},drop:function(t,e){if(!i.inactive){var a=e.draggable.data("slot");if(a&&a!==i){var l=a.getData();if(l&&i.accept(l.id)){var o=i.getId();if(t.shiftKey)o?DiabloCalc.popupMenu(t,c.fixkey({Replace:function(){i.setItem(l,"stash")},Cancel:function(){}})):i.setItem(l,"stash");else{if(o){if(!a.accept(o))return;a.setItem(i.getData(),"stash")}else a.setItem();i.setItem(l,"stash")}}}}}}),i.slotData.dollFrame.click(function(){$(".editframe").tabs("option","active",0),d.animate({scrollTop:0},"fast"),t(e)}),i.slotData.dollFrame.contextmenu(function(t){if(0==$(".editframe").tabs("option","active")){if(i.slotData.item){var e={};s()&&(e[c("Unequip")]=function(){var t=s();i.slotData.item&&t&&(t.setItem(i.slotData.item),i.setItem())}),e[c("Delete")]=function(){i.setItem()},DiabloCalc.tooltip.hide(),DiabloCalc.popupMenu(t,e)}return!1}}),DiabloCalc.enableTouch(i.slotData.dollFrame)}function i(t){this.setItem=function(t,i){if(this.box.removeClass().addClass("stash-slot").addClass("ui-droppable"),k.slot===this&&this.box.addClass("edit"),this.dollSlot||"loading"===i||f||(x.hide(),f=setTimeout(a,5e3)),"editing"!==i&&k.slot===e&&k.setItem(t,i),!t||!t.id)return this.item=void 0,void this.box.addClass("empty-slot");var l=DiabloCalc.itemById[t.id]||DiabloCalc.itemById.custom,s=l.type,n=DiabloCalc.itemTypes[s].slot,c=l.id;if("custom"===n&&this.dollSlot){var d="offhand"===this.dollSlot?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[this.dollSlot].types;for(var r in d)if(!(d[r].classes&&d[r].classes.indexOf(DiabloCalc.charClass)<0)){n=DiabloCalc.itemTypes[r].slot,c=DiabloCalc.itemTypes[r].generic;break}}this.item=t,this.box.addClass("quality-"+l.quality),this.icon.removeClass().addClass("stash-icon").addClass("slot-"+n),this.icon.css("background-image","url("+DiabloCalc.getItemIcon(c)+")").show(),this.icon.toggleClass("ancient",!!t.ancient),DiabloCalc.tooltip&&DiabloCalc.tooltip.getNode()==this.box[0]&&DiabloCalc.tooltip.showItem(this.box[0],this.item),this.dollSlot||function(){if(100==B.length)return;for(var t=0,e=0;e<B.length;++e)B[e].item||++t;t<3&&o(5*(Math.floor(B.length/5)+1))}()},this.accept=function(t){return this.dollSlot?DiabloCalc.itemSlots[this.dollSlot].drop&&DiabloCalc.itemSlots[this.dollSlot].drop.accept(t):!!t},this.getId=function(){return this.item&&this.item.id},this.getData=function(){return this.item};var e=this;this.box=$('<div class="stash-slot empty-slot"></div>'),this.icon=$('<div class="stash-icon"></div>'),this.box.append('<div class="item-gradient"><div class="item-glow"></div></div><div class="hover-glow"></div>').append(this.icon),this.box.append('<div class="edit-border"><div class="edit-gradient"></div></div>'),this.box.droppable({hoverClass:"slot-hover",accept:function(t){var i=t.data("slot");return!(!i||i===e)&&(!!DiabloCalc.shiftKey||(!e.item||i.accept(e.item.id)))},drop:function(t,i){var a=i.draggable.data("slot");if(a&&a!==e){var l=a.getData();if(l&&e.accept(l.id))if(t.shiftKey)e.item?DiabloCalc.popupMenu(t,c.fixkey({Replace:function(){e.setItem(l,"stash")},Cancel:function(){}})):e.setItem(l,"stash");else{if(e.item){if(!a.accept(e.item.id))return;a.setItem(e.item,"stash")}else a.setItem();e.setItem(l,"stash")}}}}),this.box.hover(function(){if(e.dollSlot)DiabloCalc.tooltip.showItem(this,e.dollSlot);else if(e.item&&DiabloCalc.tooltip)if(DiabloCalc.itemById[e.item.id])DiabloCalc.tooltip.showItem(this,e.item);else{var t='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+c("Unknown Item")+'</span><br/><span class="d3-color-gray">'+e.item.id+"</span></p></div>";DiabloCalc.tooltip.showHtml(this,t)}},function(){DiabloCalc.tooltip&&DiabloCalc.tooltip.hide()}).click(function(){e.dollSlot||k.setSlot(k.slot===e?void 0:e)}).contextmenu(function(t){DiabloCalc.tooltip.hide();var i={};return e.dollSlot||k.slot===e||e.item&&!DiabloCalc.itemById[e.item]||(i[c("Edit")]=function(){k.setSlot(e)}),e.item&&(e.dollSlot?s()&&(i[c("Unequip")]=function(){var t=s();e.item&&t&&(t.setItem(e.item),e.setItem())}):$.each(DiabloCalc.itemSlots,function(t,a){a.drop.accept(e.item.id)&&(i[c("Equip {0}").format(a.name)]=function(){if(a.drop.accept(e.item.id)){var t=a.drop.getData();a.drop.setItem(e.item,"stash"),e.setItem(t,"stash")}})}),i[c("Delete")]=function(){e.setItem()}),DiabloCalc.popupMenu(t,i),!1}),this.icon.data("slot",this),this.reverting=!1,this.icon.draggable({zIndex:100,appendTo:"body",cursor:"-webkit-grabbing",distance:4,cursorAt:{},helper:function(){var t=$("<img></img>").attr("src",e.item?DiabloCalc.getItemIcon(e.item.id):"");return t.toggleClass("ancient",!(!e.item||!e.item.ancient)),e.item&&DiabloCalc.itemById[e.item.id]&&"amulet"===DiabloCalc.itemById[e.item.id].type&&t.css("width",52).css("height",52),t},start:function(){if(!e.item)return setTimeout(function(){$("body").css("cursor","")}),!1;u=e.icon,DiabloCalc.shiftKey||e.icon.hide(),DiabloCalc.tooltip&&DiabloCalc.tooltip.disable()},revert:function(t){if(u=void 0,DiabloCalc.tooltip&&DiabloCalc.tooltip.enable(),!t){if(!window.event)return!0;e.reverting=!0,DiabloCalc.popupMenu(window.event,c.fixkey({Delete:function(){var t=e.icon.draggable("instance");e.reverting=!1,t&&!1!==t._trigger("stop",event)&&t._clear(),e.setItem()}}),function(){var t=e.icon.draggable("instance");e.reverting=!1,t&&$(t.helper).animate(t.originalPosition,parseInt(t.options.revertDuration,10),function(){!1!==t._trigger("stop",event)&&t._clear()})})}return!1},stop:function(){if(e.reverting)return!1;setTimeout(function(){e.icon.show()},0)}}).draggable("instance")._adjustOffsetFromHelper=function(){var t=40-this.helper.width()/2,e=40-this.helper.height()/2;this.originalPosition.left+=t,this.originalPosition.top+=e,this.position.left+=t,this.position.top+=e,this.offset.click.left-=t,this.offset.click.top-=e},DiabloCalc.enableTouch(this.icon),this.line=t,t.append(this.box)}function a(){if(DiabloCalc.activity("stash"),clearTimeout(f),f=void 0,DiabloCalc.account.userName()){x.addClass("loading").text(c("Saving...")).show();for(var t=[],e=0;e<B.length;++e)t.push(B[e].item||null);$.ajax({url:"savestash",data:JSON.stringify(t),type:"POST",global:!1,processData:!1,contentType:"application/json",dataType:"json",success:function(t){"OK"===t.code?x.removeClass("loading").text(c("Saved.")):t.errors&&t.errors.length?x.removeClass("loading").text(t.errors[0]):x.removeClass("loading").text(c("Failed to save!"))},error:function(t){x.removeClass("loading").text(c("Failed to save!"))}})}}function l(){var t=!1;for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.getSlot(e);if(i&&i.imported){t=!0;break}}D.toggle(t)}function o(t){for(;B.length<50&&B.length<t;)B.length%5||(w.push($('<div class="stash-row"></div>')),d.append(w[w.length-1])),B.push(new i(w[w.length-1]))}function s(t){for(var e=0;e<B.length;++e)if(!B[e].item)return B[e]}function n(){var t;$.each(DiabloCalc.itemSlots,function(e,i){i.classes&&i.classes.indexOf(DiabloCalc.charClass)<0?(i.drop.inactive=!0,i.item&&(i.item=void 0,DiabloCalc.trigger("updateSlotItem",e))):(i.drop.inactive=!1,t||(t=e))}),!b.slot||DiabloCalc.itemSlots[b.slot].drop.inactive?b.setSlot(t):b.setSlot(b.slot);for(var e in DiabloCalc.itemSlots)DiabloCalc.itemSlots[e].drop.inactive||e===b.slot||DiabloCalc.itemSlots[e].drop.updateTypes(!0)}var c=DiabloCalc.locale("ui-equipment.js"),d=$("#tab-equipment");d=DiabloCalc.addScroll(d,"y");var r=$("<input></input>").attr("type","checkbox").prop("checked",!1).change(function(){b.itemBox.updateWarning(),k.itemBox.updateWarning()});DiabloCalc.addOption("moreWarnings",function(){return r.prop("checked")},function(t){r.prop("checked",t),b.itemBox.updateWarning(),k.itemBox.updateWarning()});var m=$("<input></input>").attr("type","checkbox").prop("checked",!0);DiabloCalc.addOption("limitStats",function(){return m.prop("checked")},function(t){m.prop("checked",t)});var p=$("<input></input>").attr("type","checkbox").prop("checked",!0);DiabloCalc.addOption("hideCrossClass",function(){return p.prop("checked")},function(t){p.prop("checked",t),b.itemBox.populateItems(),k.itemBox.populateItems()});var h=$("<input></input>").attr("type","checkbox").prop("checked",!0);DiabloCalc.addOption("hideLegacy",function(){return h.prop("checked")},function(t){h.prop("checked",t),b.itemBox.populateItems(),k.itemBox.populateItems()}),d.append($('<label class="option-box top-options"></label>').append(r).append(c("Show all warnings"))),d.append($('<label class="option-box top-options"></label>').append(p).append(c("Hide items for other classes"))),d.append($('<label class="option-box top-options"></label>').append(m).append(c("Only list class-specific stats"))),d.append($('<label class="option-box top-options"></label>').append(h).append(c("Hide legacy items"))),DiabloCalc.addTip(r,c("Show warnings for incomplete items and missing secondary stats.")),DiabloCalc.addTip(p,c("Do not list items with affixes that do not apply to your class.")),DiabloCalc.addTip(m,c("Only list stats useful to your class.")),DiabloCalc.addTip(h,c("Do not list legacy items."));var u;$("body").keydown(function(t){16==t.which&&u&&u.show()}).keyup(function(t){16==t.which&&u&&u.hide()});var b=new function(){this.div=$('<div class="current-slot"></div>'),d.append(this.div),this.slotBox=new i(this.div),this.prevSlot=$('<span class="left"></span>'),this.nextSlot=$('<span class="right"></span>'),this.slotName=$('<span class="current-slot chosen-noframe"></span>'),this.slotDrop=$('<select class="current-slot-name"></select>'),this.slotItem=$("<span></span>"),this.div.append($('<div class="current-header"><span class="current-tip">'+c("Click on a paperdoll slot to edit items.")+"</span></div>").append(this.slotName,"<br/>",this.slotItem));var e=this;this.slotName.append(this.prevSlot,this.slotDrop,this.nextSlot),this.listSlots=function(t){this.slotDrop.empty();for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.itemSlots[e];i.drop&&i.drop.inactive||this.slotDrop.append('<option value="'+e+(e===t?'" selected="selected':"")+'">'+i.name+"</option>")}},this.listSlots(),this.slotDrop.chosen({disable_search:!0,inherit_select_classes:!0}).change(function(){e.doSetSlot($(this).val())}),this.slotBox.veryOldSetItem=this.slotBox.setItem,this.slotBox.oldSetItem=function(t,i){if(e.slotItem.removeClass(),t&&DiabloCalc.itemById[t.id]){var a=DiabloCalc.itemById[t.id];e.slotItem.addClass("quality-"+a.quality).text(a.name)}else e.slotItem.addClass("empty-slot").text(c("Empty Slot"));this.veryOldSetItem(t,i)},this.slotBox.setItem=function(t,i){"editing"!==i&&(e.itemBox.suppress=!0,e.itemBox.setItem(t),e.itemBox.suppress=!1),e.slotBox.oldSetItem(t,i),DiabloCalc.itemSlots[e.slot].item=t,DiabloCalc.trigger("updateSlotItem",e.slot)},this.setItem=function(t,e){this.slotBox.setItem(t,e)},this.itemBox=new DiabloCalc.ItemBox(d,{onUpdate:function(t,i){if(!DiabloCalc.itemSlots[e.slot].drop.inactive){var a=e.itemBox.getData();e.slotBox.oldSetItem(a,"editing"),DiabloCalc.itemSlots[e.slot].item=a,DiabloCalc.trigger(t?"updateSlotItem":"updateSlotStats",e.slot,i)}}}),this.getPrevSlot=function(){var t=void 0;for(var e in DiabloCalc.itemSlots)if(!DiabloCalc.itemSlots[e].drop.inactive){if(e===this.slot)break;t=e}return t},this.getNextSlot=function(){var t=!1;for(var e in DiabloCalc.itemSlots)if(!DiabloCalc.itemSlots[e].drop.inactive)if(e===this.slot)t=!0;else if(t)return e},$(".editframe").on("tabsactivate",function(){e.slot&&(0!=$(".editframe").tabs("option","active")?DiabloCalc.itemSlots[e.slot].dollFrame.removeClass("editing"):DiabloCalc.itemSlots[e.slot].dollFrame.addClass("editing"))}),this.prevSlot.click(function(){var i=e.getPrevSlot();i&&t(i)}),this.nextSlot.click(function(){var i=e.getNextSlot();i&&t(i)}),this.setSlot=function(t){this.listSlots(t),this.slotDrop.trigger("chosen:updated"),this.doSetSlot(t)},this.doSetSlot=function(t){this.slot&&DiabloCalc.itemSlots[this.slot].dollFrame.removeClass("editing"),this.slot=t,this.slot&&0==$(".editframe").tabs("option","active")&&DiabloCalc.itemSlots[this.slot].dollFrame.addClass("editing"),this.slotBox.dollSlot=t,this.getPrevSlot()?this.prevSlot.removeClass("disabled"):this.prevSlot.addClass("disabled"),this.getNextSlot()?this.nextSlot.removeClass("disabled"):this.nextSlot.addClass("disabled"),this.itemBox.suppress=!0;var i=DiabloCalc.itemSlots[t].item;this.itemBox.setClass(DiabloCalc.charClass,t),this.itemBox.setItem(i),this.itemBox.suppress=!1,i=this.itemBox.getData(),this.slotBox.oldSetItem(i,"editing"),DiabloCalc.itemSlots[e.slot].item=i,DiabloCalc.trigger("updateSlotItem",e.slot)},this.updateIcon=function(){this.slotBox.oldSetItem(this.itemBox.getData(),"editing")}};DiabloCalc.onHighlight=function(t){b.slot&&0==$(".editframe").tabs("option","active")&&DiabloCalc.itemSlots[b.slot].dollFrame.toggleClass("editing",!t)};var f;window.onbeforeunload=function(t){f&&a()},d.append('<h3 class="skill-category collapse-header collapsed">'+c("Global equipment modifications")+"</h3>");var C=$("<ul></ul>");d.append(C);var v='<select class="eqmod-ancient-type">';v+='<option value="false">'+c("Normal")+"</option>",v+='<option value="true">'+c("Ancient")+"</option>",v+='<option value="primal">'+c("Primal Ancient")+"</option>",v+="</select>";var D=$('<li><span class="link-like eqmod-unlock">'+c("Unlock imported items")+"</span></li>");C.append(D),C.append('<li><span class="link-like eqmod-ancient">'+c("Make all items {0}").format(v)+"</span></li>"),C.append('<li><span class="link-like eqmod-maxstat">'+c("Change all stats to {0}%").format('<input class="eqmod-maxstat-value" type="number" min="0" max="100" value="100"/>')+"</span></li>");var g='<select class="eqmod-enchant-type">';for(var S in{str:!0,dex:!0,int:!0,vit:!0})g+='<option value="'+S+'">'+DiabloCalc.stats[S].name+"</option>";g+="</select>",C.append('<li><span class="link-like eqmod-enchant">'+c("Add level {0} {1} Caldessan's Despair").format('<input class="eqmod-enchant-level" type="number" min="0" max="200" value="100"/>',g)+"</span></li>"),DiabloCalc.register("changeClass",function(){$(".eqmod-enchant-type").val(DiabloCalc.classes[DiabloCalc.charClass].primary)}),$(".eqmod-enchant-type").val(DiabloCalc.classes[DiabloCalc.charClass].primary),d.append('<h3 class="skill-category collapse-header collapsed second">'+c("Stat priority")+"</h3>");var y=DiabloCalc.Optimizer.dialog();d.append(y),DiabloCalc.Optimizer.updatePriority(),y.append('<div><span class="link-like eqmod-optimize">'+c("Optimize stats")+"</span></div>"),$(".collapse-header").click(function(){$(this).toggleClass("collapsed"),$(this).hasClass("collapsed")?$(this).next().slideUp():$(this).next().slideDown()}).next().hide(),DiabloCalc.register("updateSlotItem",l),DiabloCalc.register("importEnd",l),$(".eqmod-unlock").click(function(){DiabloCalc.activity("modunlock"),DiabloCalc.importStart();for(var t in DiabloCalc.itemSlots){var e=DiabloCalc.getSlot(t);e&&(e.imported&&(delete(e=$.extend(!0,{},e)).enchant,delete e.imported,DiabloCalc.setSlot(t,e)))}DiabloCalc.importEnd("global")}),$(".eqmod-ancient").click(function(){DiabloCalc.activity("modancient"),DiabloCalc.importStart();var t=$(".eqmod-ancient-type").val();"true"===t?t=!0:"primal"!==t&&(t=!1);for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.getSlot(e);i&&((i.ancient||!1)!==t&&((i=$.extend(!0,{},i)).ancient=t,delete i.enchant,delete i.imported,DiabloCalc.trimStats(i),DiabloCalc.setSlot(e,i)))}DiabloCalc.importEnd("global")}),$(".eqmod-maxstat").click(function(t){function e(t){DiabloCalc.importStart();var e=.01*(parseInt($(".eqmod-maxstat-value").val())||0);for(var i in DiabloCalc.itemSlots){var a=DiabloCalc.getSlot(i);if(a){a=$.extend(!0,{},a),t&&(delete a.enchant,delete a.imported);var l=DiabloCalc.getItemAffixesById(a.id,a.ancient,!0);for(var o in a.stats)if(l[o]&&!(a.imported&&a.enchant!==o||DiabloCalc.stats[o]&&DiabloCalc.stats[o].caldesanns)){if(a.stats[o].length>=1){var s=l[o].best||"max",n="max"===s?"min":"max";if(l[o].min&&l[o].max&&(a.stats[o][0]=l[o][n]+(l[o][s]-l[o][n])*e,"any"!==l[o].step)){c=l[o].step||1;a.stats[o][0]=Math.round(a.stats[o][0]/c)*c}}if(a.stats[o].length>=2&&l[o].min2&&l[o].max2&&(a.stats[o][1]=l[o].min2+(l[o].max2-l[o].min2)*e,"any"!==l[o].step2)){var c=l[o].step2||1;a.stats[o][1]=Math.round(a.stats[o][1]/c)*c}}DiabloCalc.setSlot(i,a)}}DiabloCalc.importEnd("global")}DiabloCalc.activity("modmaxstat");var i=!1;for(var a in DiabloCalc.itemSlots){var l=DiabloCalc.getSlot(a);if(l&&l.imported){i=!0;break}}i?DiabloCalc.simpleDialog({title:c("Modify equipment"),text:c("Profile contains imported items. Only enchanted stats will be modified."),buttons:[c("Ok"),c("Unlock"),c("Cancel")],callback:function(t){0!==t&&1!==t||e(t>0)}}):e(!0)}),$(".eqmod-enchant").click(function(){DiabloCalc.activity("modenchant"),DiabloCalc.importStart();var t=5*(parseInt($(".eqmod-enchant-level").val())||1),e="caldesanns_"+$(".eqmod-enchant-type").val();for(var i in DiabloCalc.itemSlots){var a=DiabloCalc.getSlot(i);a&&(t?a.stats[e]&&a.stats[e][0]===t||(delete(a=$.extend(!0,{},a)).stats.caldesanns_str,delete a.stats.caldesanns_dex,delete a.stats.caldesanns_int,delete a.stats.caldesanns_vit,a.stats[e]=[t],DiabloCalc.setSlot(i,a)):(a.stats.caldesanns_str||a.stats.caldesanns_dex||a.stats.caldesanns_int||a.stats.caldesanns_vit)&&(delete(a=$.extend(!0,{},a)).stats.caldesanns_str,delete a.stats.caldesanns_dex,delete a.stats.caldesanns_int,delete a.stats.caldesanns_vit,a.stats[e]=[t],DiabloCalc.setSlot(i,a)))}DiabloCalc.importEnd("global")}),$(".eqmod-optimize").click(function(){DiabloCalc.activity("modoptimize"),DiabloCalc.Optimizer.optimizeAll()}),$(".eqmod-ancient-type, .eqmod-maxstat-value, .eqmod-enchant-level, .eqmod-enchant-type").click(function(t){t.stopPropagation()}),$(".eqmod-ancient-type").change(function(){$(".eqmod-ancient").click()}),$(".eqmod-maxstat-value").change(function(){var t=!1;for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.getSlot(e);if(i&&i.imported){t=!0;break}}t||$(".eqmod-maxstat").click()});var x=$('<span class="status"></span>').hide(),I=$('<div class="stash-header">'+c("Drag items between paperdoll and stash.<br/>Hold shift to clone items.")+"</div>");DiabloCalc.stashHeader=I,d.append(I.prepend(x)),I.append(DiabloCalc.account.makeLine(c(" to access your personal stash"),function(t){t?(x.addClass("loading").text(c("Loading...")).show(),$.ajax({url:"loadstash",data:{},type:"POST",dataType:"json",success:function(t){for(x.hide();t.length&&!t[t.length-1];)t.pop();o(t.length);for(var e=0;e<t.length&&e<B.length;++e)t[e]&&DiabloCalc.itemById[t[e].id]&&(t[e].id=DiabloCalc.itemById[t[e].id].id),B[e].setItem(t[e],"loading")},error:function(t){x.removeClass("loading").text(c("Failed to load!"))}}),this.hide()):this.show()}));var k={};k.line=$('<div class="stash-edit"><div class="top-left"></div><div class="top-right"></div><div class="bottom"></div></div>').hide(),k.line.append('<div class="left"></div><div class="right"></div>'),k.save=$("<button>"+c("Save")+"</button>").button({icons:{primary:"ui-icon-check"}}),k.del=$("<button>"+c("Delete")+"</button>").button({icons:{primary:"ui-icon-trash"}}),k.line.append(k.save).append(k.del),d.append(k.line),k.updateItem=function(t,e){var i=k.itemBox.getData();k.slot&&k.slot.setItem(i,"editing"),k.line.removeClass().addClass("stash-edit"),i&&i.id&&DiabloCalc.itemById[i.id]&&k.line.addClass("quality-"+DiabloCalc.itemById[i.id].quality)},k.itemBox=new DiabloCalc.ItemBox(k.line,{onUpdate:k.updateItem}),k.itemBox.setClass(),k.setItem=function(t,e){this.itemBox.setItem(t,e),this.line.removeClass().addClass("stash-edit"),t&&t.id&&DiabloCalc.itemById[t.id]&&this.line.addClass("quality-"+DiabloCalc.itemById[t.id].quality)},k.setSlot=function(t){if(t&&t.item&&!DiabloCalc.itemById[t.item.id]&&(t=void 0),this.slot&&this.slot.box.removeClass("edit"),t&&t.box.addClass("edit"),this.slot=t,!t)return this.setItem(),this.line.hide(),void DiabloCalc.hidePopup(this);this.setItem(t.item),t.line.after(this.line);var e=t.box.index();this.line.find(".top-left").css("width",21+84*e),this.line.find(".top-right").css("left",122+84*e),this.line.show(),DiabloCalc.showPopup(this)},k.hide=function(){this.setSlot()},k.contains=function(t){return!(!this.slot.box.is(t)&&!this.slot.box.has(t).length)||!(!this.line.is(t)&&!this.line.has(t).length)},k.save.click(function(){var t=k.itemBox.getData();k.slot&&k.slot.setItem(t,"editing"),k.setSlot(),a()}),k.del.click(function(t){DiabloCalc.popupMenu(t,c.fixkey({"Confirm delete?":function(){k.slot&&k.slot.setItem(void 0,"editing"),k.setSlot()}}))});var B=[],w=[];o(25);for(var q in DiabloCalc.itemSlots)DiabloCalc.itemSlots[q].drop=new e(q);DiabloCalc.getItemAffixes=function(t,e){var i=DiabloCalc.itemSlots[t].item;return i?DiabloCalc.getItemAffixesById(i.id,i.ancient,e):{}},DiabloCalc.setSlot=function(t,e){if(e)if(DiabloCalc.itemById[e.id]){if(e.id=DiabloCalc.itemById[e.id].id,e.gems&&e.gems.length){for(var i=0;i<e.gems.length;++i)"number"==typeof e.gems[i][0]&&e.gems[i][0]>=DiabloCalc.gemQualities.length&&(e.gems[i][0]=DiabloCalc.oldGemQualities[e.gems[i][0]]);(!e.stats.sockets||e.stats.sockets[0]<e.gems.length)&&(e.stats.sockets=[e.gems.length])}}else e=void 0;DiabloCalc.itemSlots[t].drop.setItem(e)},DiabloCalc.getSlotId=function(t){var e=DiabloCalc.itemSlots[t].item;return e?e.id:void 0},DiabloCalc.getSlotData=function(t){return DiabloCalc.itemSlots[t].item},DiabloCalc.register("changeClass",n),DiabloCalc.register("changeGender",function(){b.updateIcon()}),n()}();