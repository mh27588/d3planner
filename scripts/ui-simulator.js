!function(){function s(s){if(s.classes&&s.classes.indexOf(x.charClass)<0)return!1;var t=x.itemTypes[s.type];return!(t.classes&&t.classes.indexOf(x.charClass)<0)}function t(t,e){var a=t.val();t.children().detach().remove();var i,n,l={},r=x.getStats();return $.each(x.simMapping.buffs,function(o,p){if(!(p.classes&&p.classes.indexOf(x.charClass)<0)){if(x.options.filterBuffs&&o!==a){var c=0,h=0;if(p.skill&&(++c,r.skills[p.skill[0]]&&(p.skill.length<2||p.skill[1].indexOf(r.skills[p.skill[0]])>=0)&&++h),p.skills){++c;for(d=0;d<p.skills.length;++d){if(r.skills[p.skills[d]]){++h;break}if(x.extraskills[x.charClass]&&x.extraskills[x.charClass][p.skills[d]]&&x.extraskills[x.charClass][p.skills[d]].required(r)){++h;break}}}if(p.passive&&(++c,r.passives[p.passive]&&++h),p.gem&&(++c,void 0!==r.gems[p.gem[0]]&&(p.gem.length<2||r.gems[p.gem[0]]>=p.gem[1])&&++h),p.set&&(++c,r["set_"+p.set[0]+"_"+p.set[1]+"pc"]&&++h),p.stat)if(++c,p.stat instanceof Array){for(var d=0;d<p.stat.length;++d)if(r[p.stat[d]]){++h;break}}else r[p.stat]&&++h;if(c&&h<(p.min||1))return}if(!(p.set&&(void 0===l[p.set[0]]&&(l[p.set[0]]=function(t){if((t=x.itemSets[t]).tclass&&t.tclass!==x.charClass)return 0;if(t.classes&&t.classes.indexOf(x.charClass)<0)return 0;for(var e=0,a=0;a<t.items.length;++a)s(t.items[a])&&++e;return e}(p.set[0])),l[p.set[0]]<p.set[1]))){if(p.category!==i&&(i=p.category,n=$('<optgroup label="'+i+'"></optgroup>'),t.append(n)),a||(a=o),e)return!1;n.append('<option value="'+o+(o===a?'" selected="selected':"")+'">'+p.name+"</option>")}}}),a}function e(s){var t=x.simMapping.buffs[s];if(t)if(t.skill)DiabloCalc.tooltip.showSkill(this,x.charClass,t.skill[0],t.skill[1]);else if(t.passive)DiabloCalc.tooltip.showSkill(this,x.charClass,t.passive);else if(t.gem)DiabloCalc.tooltip.showGem(this,t.gem[0],x.getStats().gems[t.gem[0]]);else if(t.set){var e="set_"+t.set[0]+"_"+t.set[1]+"pc",a=x.getStats().affixes[e];if(a&&a.slot)DiabloCalc.tooltip.showItem(this,a.slot);else{s=DiabloCalc.itemSets[t.set[0]].items[0].id;DiabloCalc.tooltip.showItem(this,s)}}}function a(s,t){var e=s.val();s.children().detach().remove();var a=function(){var s={};if(x.options.filterBuffs)for(var t=x.getSkills().skills,e=0;e<t.length;++e)t[e]&&x.skills[x.charClass][t[e][0]]&&(s[t[e][0]]=x.skills[x.charClass][t[e][0]]);else $.extend(s,x.skills[x.charClass]);if(x.extraskills&&x.extraskills[x.charClass]){var a=x.getStats();$.each(x.extraskills[x.charClass],function(t,e){x.options.filterBuffs&&e.required&&!e.required.call(e,a)||(e.category=x.skills[x.charClass][e.skill].name,s[t]=e)})}return s}();x.skills[x.charClass][e]&&!a[e]&&(a[e]=x.skills[x.charClass][e]);var i,n=s;return $.each(a,function(a,l){if(x.options.filterBuffs||l.category===i||(i=l.category,n=$('<optgroup label="'+(x.skillcat[x.charClass][i]||i)+'"></optgroup>'),s.append(n)),e||(e=a),t)return!1;n.append('<option value="'+a+(a===e?'" selected="selected':"")+'">'+l.name+"</option>")}),e}function i(s,t){t=t||x.charClass;var e=x.skills[t][s];if(e||(e=x.extraskills&&x.extraskills[t]&&x.extraskills[t][s]),e)return'<span style="background: url(css/images/class-'+t+".png) "+-24*e.col+"px "+-48*e.row+'px / 120px no-repeat"></span>'}function n(s){var t=x.skills[x.charClass][s];t||(t=x.extraskills&&x.extraskills[x.charClass]&&x.extraskills[x.charClass][s]),t&&DiabloCalc.tooltip.showSkill(this,x.charClass,s)}function l(s,t){var e=$('<select class="arg-skill"></select>'),l=x.extraskills&&x.extraskills[x.charClass]||{};t&&(x.skills[x.charClass][t]||l[t])||(t=a(e,!0)),!t||x.skills[x.charClass][t]||l[t]||(t=void 0),t&&(x.skills[x.charClass][t]||l[t])?e.append('<option value="'+t+'" selected="selected">'+(x.skills[x.charClass][t]||l[t]).name+"</option>"):e.prop("disabled",!0),s.append(e),x.noChosen?a(e):(e.chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:b("Choose Skill"),populate_func:function(){a(e)}}),x.chosenTips(e,n),function(s,t){var e=s.data("chosen");if(e){var a=e.result_add_option;e.result_add_option=function(s){var e=t.call(self,s.value);return e&&((s=$.extend({},s)).search_text='<div class="icon-wrap">'+e+"</div>"+s.search_text),a.call(this,s)}}}(e,i));var r=e;return x.noChosen||(r=r.next()),r.hover(function(){if(x.tooltip&&e.val()){var s=x.getStats().skills[e.val()];x.tooltip.showSkill(this,x.charClass,e.val(),s)}},function(){x.tooltip&&x.tooltip.hide()}),e.setval=function(s){if(x.noChosen)e.val(s);else{e.empty();var t=x.extraskills&&x.extraskills[x.charClass]||{};s&&(x.skills[x.charClass][s]||t[s])&&(e.removeAttr("disabled"),e.append('<option value="'+s+'" selected="selected">'+(x.skills[x.charClass][s]||t[s]).name+"</option>")),e.trigger("chosen:updated")}return this},e}function r(s){var t=s.val();s.children().detach().remove(),$.each(x.classes[x.charClass].resources,function(e,a){s.append('<option value="'+a+(a===t?'" selected="selected':"")+'">'+x.resources[a]+"</option>")})}function o(s,t,e){var a="";for(var i in t.opts)a+='<option value="'+i+(e===i?'" selected="selected':"")+'">'+t.opts[i]+"</option>";var n=$('<select class="'+t.class+'">'+a+"</select>");return s.append(n),n.chosen({disable_search:!0,inherit_select_classes:!0}),n.setval=function(s){return n.val(s),n.trigger("chosen:updated"),this},n}function p(s){this.parent=s,this.box=$('<li class="sim-condition"></li>'),this.box.data("condition",this),this.line=$('<div class="header chosen-noframe"></div>'),this.remove=$('<span class="btn-remove"></span>'),s.list.append(this.box.append(this.line.append(this.remove))),this.type=o(this.line,D);var t=this;this.type.change(function(){t.onChangeType(),t.lhs&&setTimeout(function(){t.lhs.trigger("chosen:open")},0)}),this.remove.click(function(){t.box.remove()}),this.vardiv=$('<div class="arg-params"></div>'),this.line.append(this.vardiv),this.onChangeType()}function c(s){this.list=$('<ul class="sim-condition-list"></ul>'),this.add=$('<div class="btn-add">'+b("Add condition")+"</div>"),s.append(this.list,this.add);var t=this;this.add.click(function(){var s=new p(t);setTimeout(function(){s.type.trigger("chosen:open")},0)}),this.list.sortable({handle:".header",distance:4,placeholder:"drop-ph",forcePlaceholderSize:!0,connectWith:".sim-condition-list",start:function(){t.list.find("select").trigger("chosen:close")},end:function(){x.trigger("updatePriority")}})}function h(s){this.parent=s,this.box=$('<li class="sim-priority-line"></li>'),this.box.data("priority",this),this.line=$('<div class="header prio-header"></div>'),this.remove=$('<span class="btn-remove"></span>'),s.list.append(this.box.append(this.line.append(this.remove))),this.skill=l(this.line);var t=this;x.noChosen||(this.icon=$('<span class="drop-skill-icon"></span>'),this.skill.next().find("span").before(this.icon),this.skill.change(function(){var s=$(this).val(),e=x.skills[x.charClass][s];e||(e=x.extraskills&&x.extraskills[x.charClass]&&x.extraskills[x.charClass][s]),e?(t.icon.css("background","url(css/images/class-"+x.charClass+".png) "+-24*e.col+"px "+-48*e.row+"px / 120px no-repeat"),t.icon.show()):t.icon.hide()}).change()),this.conditions=new c(this.box),this.remove.click(function(){t.box.remove()})}function d(s){this.box=$('<div class="sim-priority"></div>'),this.list=$('<ul class="sim-priority-list"></ul>'),this.add=$('<div class="btn-add">'+b("Add skill")+"</div>"),this.box.append(this.list,this.add),s.append(this.box);var t=this;this.add.click(function(){var s=new h(t);setTimeout(function(){s.skill.trigger("chosen:open")},0)}),this.list.sortable({handle:".prio-header",distance:4,axis:"y",placeholder:"drop-ph",forcePlaceholderSize:!0,start:function(){t.list.find("select").trigger("chosen:close")},stop:function(){ui.item.css({position:"",left:"",top:""}),x.trigger("updatePriority")}}),this.box.on("click",".btn-remove, .btn-add",function(){x.trigger("updatePriority")}),this.box.on("change",function(){x.trigger("updatePriority")}),x.register("updateSkills",function(){t.list.find("select.arg-skill").each(function(){!function(s){var t=s.val(),e=x.extraskills&&x.extraskills[x.charClass]||{};t&&(x.skills[x.charClass][t]||e[t])||(t=a(s,!0)),!t||x.skills[x.charClass][t]||e[t]||(t=void 0),s.empty(),t&&(x.skills[x.charClass][t]||e[t])?(s.removeAttr("disabled"),s.append('<option value="'+t+'" selected="selected">'+(x.skills[x.charClass][t]||e[t]).name+"</option>")):s.prop("disabled",!0),x.noChosen?a(s):s.trigger("chosen:updated").change()}($(this))})})}function u(s,t){var e={name:s,class:x.charClass,data:x.priority.getData()};t&&(e.id=t),$.ajax({url:"priority",data:JSON.stringify(e),type:"POST",processData:!1,contentType:"application/json",dataType:"json",success:function(s){s.id?(I.slideUp(),v()):s.errors&&s.errors.length?(I.val(s.errors[0]),I.slideDown()):(I.val(b("Failed to save priority list.")),I.slideDown())},error:function(s){I.text(b("Failed to save priority list.")),I.slideDown()}})}function f(s){$.ajax({url:"priority",data:{load:s},type:"GET",dataType:"json",success:function(s){s instanceof Array&&x.priority.setData(s)},error:function(s){}})}function v(){M.toggle(!!x.account.userName()),T.search({class:x.charClass})}function m(){G.empty(),$.each(x.itemSlots,function(s,t){var e=x.getSlotId(s);if(e&&x.simMapping.nyi[e]){var a=$("<li>"+x.itemById[e].name+"</li>");a.addClass("quality-"+x.itemById[e].quality),a.hover(function(){x.tooltip.showItem(this,s)},function(){x.tooltip.hide()}),G.append(a)}}),q.toggle(!!G.children().length)}function g(){z.empty();for(var s=x.priority.getData(),t={},e={},a=0;a<6;++a){var i=x.getSkill(a);i&&(e[i[0]]=i[1])}var n=x.options.targetDistance-x.options.targetRadius-x.options.targetSize;$.each(s,function(s,a){var i=a.skill;if(i&&!t[i]){t[i]=!0;var l=x.skills[x.charClass][i]||x.extraskills[x.charClass]&&x.extraskills[x.charClass][i];if(l&&l.range){var r="object"==typeof l.range?l.range[e[i]||"x"]:l.range;if("function"==typeof r&&(r=r(e[i]||"x",x.getStats())),r&&n>r){var o=$("<li>"+l.name+"</li>");o.hover(function(){x.tooltip.showSkill(this,x.charClass,i,e[i])},function(){x.tooltip.hide()}),z.append(o)}}}}),H.toggle(!!z.children().length)}function k(s){for(var t=(s%60).toFixed(0);t.length<2;)t="0"+t;return Math.floor(s/60)+":"+t}var b=DiabloCalc.locale("ui-simulator.js"),x=DiabloCalc,y=$("#tab-simulator"),C={opts:{eq:"=",ne:"&#x2260;",lt:"<",le:"&#x2264;",gt:">",ge:"&#x2265;"},class:"arg-op"},D={opts:x.simMapping.opts,width:"150px",class:"arg-type"},w={buff:"buff",buffmin:"buff",buffmax:"buff",bufftgt:"buff",ticks:"buff",resource:"resource",resourcepct:"resource",cooldown:"skill",charges:"skill",channeled:"skill",interval:"skill",health:"none",any:"sub",all:"sub",count:"subcount"};p.prototype.onChangeType=function(){var s=w[this.type.val()];if(this.typeval!==s){var a;switch(this.op&&(a=this.op.val(),x.noChosen||this.op.next().remove(),this.op.remove(),delete this.op),this.vardiv.children().detach(),this.typeval=s,this.lhs&&this.lhs.remove(),s){case"buff":this.lhs=function(s,a){var i=$('<select class="arg-buff"></select>');return a&&x.simMapping.buffs[a]||(a=t(i,!0)),a&&x.simMapping.buffs[a]&&i.append('<option value="'+a+'" selected="selected">'+x.simMapping.buffs[a].name+"</option>"),s.append(i),x.noChosen?t(i):(i.chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:b("Choose Buff"),populate_func:function(){t(i)}}),x.chosenTips(i,e)),x.addTip(i,function(){if(x.simMapping.buffs[this.val()])return x.simMapping.buffs[this.val()].name}),i.setval=function(s){return x.noChosen?i.val(s):(i.empty(),s&&x.simMapping.buffs[s]&&i.append('<option value="'+s+'" selected="selected">'+x.simMapping.buffs[s].name+"</option>"),i.trigger("chosen:updated")),this},i}(this.vardiv),this.vardiv.append('<span class="arg-ph"></span>');break;case"skill":this.lhs=l(this.vardiv),this.vardiv.append('<span class="arg-ph"></span>');break;case"resource":this.lhs=function(s,t){(!t||x.classes[x.charClass].resources.indexOf(t)<0)&&(t=x.classes[x.charClass].resources[0]);var e=$('<select class="arg-resource"></select>');return t&&x.resources[t]&&e.append('<option value="'+t+'" selected="selected">'+x.resources[t]+"</option>"),s.append(e),x.noChosen?r(e):e.chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:b("Choose Resource"),populate_func:function(){r(e)}}),e.setval=function(s){return x.noChosen?e.val(s):(e.empty(),s&&x.resources[s]&&e.append('<option value="'+s+'" selected="selected">'+x.resources[s]+"</option>"),e.trigger("chosen:updated")),this},e}(this.vardiv),this.vardiv.append('<span class="arg-ph"></span>')}"sub"!==s?(this.op=o(this.vardiv,C,a),this.rhs?this.vardiv.append(this.rhs):(this.rhs=$('<input class="arg-rhs" type="number" step="any"></input>'),this.vardiv.append(this.rhs))):(this.op&&this.op.remove(),this.rhs&&this.rhs.remove()),"sub"===s||"subcount"===s?this.clist||(this.clist=new c(this.box)):this.clist&&(this.clist.list.remove(),delete this.clist)}},p.prototype.getData=function(){var s={type:this.type.val()};return this.lhs&&(s.lhs=this.lhs.val()),this.op&&(s.op=this.op.val()),this.rhs&&(s.rhs=parseFloat(this.rhs.val())),this.clist&&(s.sub=this.clist.getData()),s},c.prototype.getData=function(){var s=[];return this.list.children("li").each(function(){var t=$(this).data("condition");t&&s.push(t.getData())}),s},h.prototype.getData=function(){return{skill:this.skill.val(),conditions:this.conditions.getData()}},d.prototype.getData=function(){var s=[];return this.list.children("li").each(function(){var t=$(this).data("priority");t&&s.push(t.getData())}),s},p.prototype.setData=function(s){this.type.val(s.type),this.type.trigger("chosen:updated"),this.onChangeType(),this.lhs&&this.lhs.setval(s.lhs),this.op&&this.op.setval(s.op),this.rhs&&this.rhs.val(s.rhs),this.clist&&this.clist.setData(s.sub)},c.prototype.setData=function(s){this.list.empty(),this.items=[];for(var t=0;t<s.length;++t){var e=new p(this);e.setData(s[t]),this.items.push(e)}},h.prototype.setData=function(s){this.skill.setval(s.skill).change(),this.conditions.setData(s.conditions)},d.prototype.setData=function(s){if(this.list.empty(),this.items=[],s)for(var t=x.extraskills&&x.extraskills[x.charClass]||{},e=0;e<s.length;++e)if(x.skills[x.charClass][s[e].skill]||t[s[e].skill]){var a=new h(this);a.setData(s[e]),this.items.push(a)}};var S=$("<div></div>");y.append("<h3>"+b("Skill Priority")+"</h3>",S),S.append("<p><i>"+b("The priority list is evaluated from top to bottom to determine the next skill to use. Skill availability checks (cooldown and resources) are implicit.")+"</i></p>");var _=$("<input></input>").attr("type","checkbox").prop("checked",!0).click(function(){x.trigger("updateSkills")});x.addOption("filterBuffs",function(){return _.prop("checked")},function(s){_.prop("checked",s),x.trigger("updateSkills")}),S.append($("<label></label>").addClass("option-box").append(_).append(b("Only show applicable buffs/skills."))),x.addTip(_,b("Only show buffs that can be activated with current skills and equipment.")),x.priority=new d(S);var T=new x.SearchResults("priority",function(s,t){var e=t.id,a=$("<li></li>");return a.append('<span class="class-icon class-'+t.class+'">&nbsp;</span>'),a.click(function(s){!function(s,t){s&&x.priority.getData().length?DiabloCalc.popupMenu(s,b.fixkey({"Discard current list?":function(){f(t)}})):f(t)}(s,e)}),a.append('<span class="profile-name'+(t.value?"":" unnamed")+'">'+(t.value||b("Unnamed list"))+"</span>"),parseInt(t.user)&&(a.append($('<span class="profile-overwrite" title="'+b("Update list")+'"></span>').click(function(s){s.stopPropagation(),x.popupMenu(s,b.fixkey({"Confirm overwrite":function(){u("",e)}}))})),a.append($('<span class="profile-delete" title="'+b("Delete list")+'"></span>').click(function(s){s.stopPropagation(),DiabloCalc.popupMenu(s,b.fixkey({"Confirm delete?":function(){$.ajax({url:"priority",data:{delete:e},type:"GET",dataType:"json",success:function(s){"OK"===s.code?(I.slideUp(),v()):s.errors&&s.errors.length?(I.val(s.errors[0]),I.slideDown()):(I.val(b("Failed to delete list.")),I.slideDown())},error:function(s){I.val(b("Failed to delete list.")),I.slideDown()}})}}))})),a.append('<span class="date-saved"><span>'+new Date(1e3*t.date).toLocaleString()+"</span></span>")),a},b("No preset lists found.")),M=$('<div class="prio-save"><div><input></input></div></div>'),P=$('<input type="button" value="'+b("Save")+'" disabled="disabled"></input>').click(function(){var s=M.find("div input").val();s&&u(s)});M.on("input","div input",function(){P.prop("disabled",!$(this).val())});var I=$("<div></div>");S.append(x.account.makeLine(b(" to save skill priorities"),function(s){v(),this.toggle(!s)})),S.append(M.append(P),I),S.append(T.div.css("margin-top",6)),y.append("<h3>"+b("Simulate")+"</h3>"),S=$("<div></div>"),y.append(S);var N=$("<select></select>");N.append('<option value="">'+b("Generic")+"</option>"),N.append('<option value="demons">'+b("Demon")+"</option>"),N.append('<option value="beasts">'+b("Beast")+"</option>"),N.append('<option value="humans">'+b("Human")+"</option>"),N.append('<option value="undead">'+b("Undead")+"</option>"),N.change(function(){x.options.targetType=$(this).val()}),x.register("updateStats",function(){N.val(x.options.targetType),N.trigger("chosen:updated")}),S.append($('<span class="option-box">'+b("Target: ")+"</span>").append(N));var A=$('<select class="target-status" multiple="multiple"></select>');for(var L in x.simMapping.status)A.append('<option value="'+L+'">'+x.simMapping.status[L]+"</option>");S.append(A),A.chosen({inherit_select_classes:!0,placeholder_text_multiple:b("Target status debuffs (from group)")}),x.addOption("targetStatus",function(){return A.val()},function(s){A.val(s),A.trigger("chosen:updated")});var F=x.simMapping.targetOptions,O=$("<div></div>");S.append(O),x.register("changeClass",function(){O.removeClass().addClass("table-"+x.charClass)});var B=$('<div class="target-options"></div>');B.css("margin-top",8),O.append(B);var U={},j=0;$.each(F,function(s,t){if(!t.hidden){var e=$('<div class="option-row"></div>');if(t.class&&e.addClass("option-"+t.class),t.category&&!U[t.category]){B=$('<div class="target-options"></div>'),O.append(B),U[t.category]=++j;var a=$('<span class="option-category">'+t.category+"</span>");a.click(function(){$(this).parent().toggleClass("collapsed")}),B.append($('<div class="option-row collapsed"></div>').append(a))}B.append(e),e.append('<span class="option-name">'+t.name+":</span>"),e.append('<span class="option-setting"><span class="option-subtable"></span></span>');var i=e.find(".option-subtable");if(t.health){var n=$('<span class="option-box"><label><input type="checkbox" checked="checked"></input>'+b("Adaptive")+"</label></span>");x.addTip(n.find("label"),b("Total health equals to 10 times the damage dealt in the first minute."));var l=$('<input type="text" class="option-health" value="1,000,000,000,000"></input>').hide(),r="1,000,000,000,000";l.on("input",function(){var s=$(this).val();if(s){var e=parseInt(s.replace(/,/g,""));isNaN(e)?$(this).val(r):($(this).val(r=x.formatNumber(e,0,1e4)),t.val=e)}else r=s}),x.addTip(l,t.tip),i.append(n,$('<span class="option-slider"></span>').append(l)),n.find("input").click(function(){l.toggle(!$(this).prop("checked")),$(this).prop("checked")?t.val=-1:t.val=parseInt(l.val().replace(/,/g,""))}),x.addOption(t.var,function(){return t.val},function(s){t.val=s,s<0?(n.find("input").prop("checked",!0),l.hide()):(n.find("input").prop("checked",!1),l.show().val(prevVal=x.formatNumber(s,0,1e4)))},t.profile)}else{var o=$('<span class="option-value">'+(t.val<0?b("Auto"):t.val)+"</span>");i.append(o);var p=$("<div></div>").slider({value:t.val,min:t.min,max:t.max,step:t.step||1,slide:function(s,e){if(t.resource){var a=!0===t.resource?x.classes[x.charClass].resources[0]:t.resource,i=x.getStats()["max"+a]||100;e.value>=i?t.val="max":t.val=e.value}else t.val=e.value;t.val=e.value,o.text(e.value<0?b("Auto"):e.value),g()}});x.addTip(p,t.tip),i.append($('<span class="option-slider"></span>').append(p)),x.addOption(t.var,function(){return t.val},function(s){if(t.resource){var e=!0===t.resource?x.classes[x.charClass].resources[0]:t.resource,a=x.getStats()["max"+e]||100;"max"===s||s>=a?(s=a,t.val="max"):t.val=s}else t.val=s;o.text(s<0?b("Auto"):s),p.slider("value",s)},t.profile),t.resource&&x.register("updateStats",function(){var s=!0===t.resource?x.classes[x.charClass].resources[0]:t.resource,e=x.getStats()["max"+s]||100,a={max:e};("max"===t.val||t.val>=e)&&(t.val="max",a.value=e,o.text(e<0?b("Auto"):e)),p.slider(a)})}}}),B.css("margin-bottom",8);var q=$('<div class="nyi-section"><p>'+b("The following equipped items are not implemented in the simulation:")+"</p></div>"),G=$('<ul class="nyi-list"></ul>');S.append(q.append(G)),q.hide();var H=$('<div class="nyi-section"><p>'+b("The character might not be in range to use the following skills:")+"</p></div>"),z=$('<ul class="nyi-list"></ul>');S.append(H.append(z)),H.hide();var E=$('<button class="button-start">'+b("Start")+"</button>").button({icons:{primary:"ui-icon-play"}});S.append(E);var R=x.formatDamage,V=new function(){this.dps=$('<span class="dps-meter">'+b("DPS: ")+"<span></span></span>").hide(),this.hps=$('<span class="dps-meter inactive">'+b("HPS: ")+"<span></span></span>").hide(),this.graph=$('<div class="sim-graph"></div>').hide(),this.section=$('<div class="sim-results statsframe"></div>').hide(),this.chartData=[],this.damageData=[],this.healingData=[],this.chartMode="dps",S.append(this.dps,this.hps,this.graph,this.section);s=this;this.dps.click(function(){if("dps"!==s.chartMode){s.chartMode="dps",s.dps.removeClass("inactive"),s.hps.addClass("inactive"),s.chartData.length=0,s.chart.render();for(var t=0;t<s.damageData.length;++t)s.chartData.push(s.damageData[t]);s.chart.render()}}),this.hps.click(function(){if("hps"!==s.chartMode){s.chartMode="hps",s.hps.removeClass("inactive"),s.dps.addClass("inactive"),s.chartData.length=0,s.chart.render();for(var t=0;t<s.healingData.length;++t)s.chartData.push(s.healingData[t]);s.chart.render()}}),this.sourceName=function(t){if(x.skills[this.charClass][t])return x.skills[this.charClass][t].name;if(x.extraskills&&x.extraskills[this.charClass]&&x.extraskills[this.charClass][t])return x.extraskills[this.charClass][t].name;if(x.passives[this.charClass][t])return x.passives[this.charClass][t].name;if(x.legendaryGems[t])return x.legendaryGems[t].name;if(!s.initData.stats.affixes[t])return x.stats[t]&&x.stats[t].name?x.stats[t].name:x.itemFromAffix[t]?x.itemFromAffix[t].name:t;var e=s.initData.stats.affixes[t];if(e.set)return"("+e.pieces+") "+x.itemSets[e.set].name;var a=x.getSlotId(e.slot);return a&&x.itemById[a]?x.itemById[a].name:void 0},this.sampleLines={},this.updateSample=function(){if(this.sectSample&&this.chart&&this.sampleData){var s=this.chart._chart.sessionVariables.axisX.internalMinimum,t=this.chart._chart.sessionVariables.axisX.internalMaximum;s||(s=0);var e=0,a=void 0,n=this;$.each(this.sampleData,function(l,r){var o=1e3*r[0]/60>=s;if(o||(e=l),!t&&l>e+50&&(o=!1),l>e+100&&(o=!1),t&&1e3*r[0]/60>t&&(o=!1),o){if(!n.sampleLines[l]){var p=x.skills[n.charClass][r[1]];if(p||(p=x.extraskills&&x.extraskills[n.charClass]&&x.extraskills[n.charClass][r[1]]),p){var c=Math.floor(r[0]/3600),h=r[0]/60-60*c,d=(c?c+":"+(h<10?"0":""):"")+h.toFixed(2),u=i(r[1],n.charClass),f=$("<li><span><span>"+d+"</span>"+u+"<span>"+p.name+"</span></span><span>"+r[2].toFixed(0)+"</span></li>");f.hover(function(){var s='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">';r[3]||!r[6]?(s+=b("Damage")+': <span class="d3-color-green">'+x.formatNumber(r[3],0,1e4)+"</span></span>",r[6]&&(s+='<br/><span class="tooltip-icon-bullet"></span>'+b("Healing")+': <span class="d3-color-green">'+x.formatNumber(r[6],0,1e4)+"</span>")):r[6]&&(s+=b("Healing")+': <span class="d3-color-green">'+x.formatNumber(r[6],0,1e4)+"</span></span>");for(var t in r[4]){(i=n.sourceName(t))&&(s+='<br/><span class="tooltip-icon-bullet"></span>'+i+': <span class="d3-color-green">'+x.formatNumber(r[4][t],0,1e4)+"</span>")}if(r.length>5&&!$.isEmptyObject(r[5])){s+='<br/><span class="tooltip-icon-bullet"></span>Buffs:';var e=[];for(var t in r[5])e.push([t,x.simMapping.buffs[t]&&x.simMapping.buffs[t].name||t]);e.sort(function(s,t){return s[1].localeCompare(t[1])});for(var a=0;a<e.length;++a){var t=e[a][0],i=x.simMapping.buffs[t]&&x.simMapping.buffs[t].name;s+='<br/><span class="tooltip-icon-nobullet"></span><span class="d3-color-'+(i?"gold":"gray")+'">'+(i||t)+'</span>: <span class="d3-color-white">'+r[5][t]+"</span>"}}s+="</p></div>",x.tooltip.showHtml(this,s)},function(){x.tooltip.hide()}),n.sampleLines[l]=f}a?a.after(n.sampleLines[l]):n.sectSample.prepend(n.sampleLines[l])}n.sampleLines[l]&&(a=n.sampleLines[l])}else n.sampleLines[l]&&(n.sampleLines[l].remove(),delete n.sampleLines[l])})}},this.chartInit=function(){this.graph.empty(),this.chart=new CanvasJS.Chart(this.graph[0],{backgroundColor:$("body").hasClass("theme-light")?"#fff":"#121212",height:200,axisY:{valueFormatString:" ",lineThickness:1,tickThickness:0,gridThickness:1},axisX:{lineThickness:1,gridThickness:1,tickThickness:1,labelFormatter:function(s){return k(s.value/1e3)}},data:[{type:"area",xValueType:"dateTime",dataPoints:this.chartData}],zoomEnabled:!0,toolTip:{contentFormatter:function(s){var t=s.entries[0].dataPoint;return"<b>"+k(t.x/1e3)+"</b> - "+R(t.y)}}}),this.graph.append('<div class="comment">'+b("Drag to zoom/pan (affects Sample output)")+"</div>");var s=this.chart._chart.render,t=this;this.chart._chart.render=function(){s.apply(this,arguments),t.updateSample()},this.chart.render()},this.chartInit();var s=this;x.register("changeTheme",function(){s.chartInit()}),this.sectCounters=$('<ul class="flex"></ul>'),this.sectUptimes=$('<ul class="flex"></ul>'),this.sectSample=$('<ul class="flex2 flex"></ul>');var t=$('<div class="column"></div>');t.append($("<div></div>").append("<h3>"+b("Breakdown")+"</h3>",this.sectCounters)),t.append($("<div></div>").append("<h3>"+b("Uptimes")+"</h3>",this.sectUptimes)),this.section.append(t),(t=$('<div class="column"></div>')).append($("<div></div>").append("<h3>"+b("Sample")+"</h3>",this.sectSample)),this.section.append(t),this.section.find(".column").sortable({connectWith:".sim-results .column",handle:"h3",distance:4,placeholder:"drop-ph",forcePlaceholderSize:!0,start:function(){s.section.find(".column").addClass("dragging")},stop:function(){s.section.find(".column").removeClass("dragging")}}),this.finish=function(s){function t(s,t){if(!t){if(!x.itemById[s])return"";t=x.itemById[s].type}var e=x.itemIcons[s];return'<div style="background: url(css/items/'+t+".png) 0 "+-24*(e&&e[0]||0)+'px no-repeat"></div>'}E.button({icons:{primary:"ui-icon-play"},label:b("Start")}),this.worker.terminate(),delete this.worker,x.recordDPS(this.results.damage/this.results.time*60);var e=this.initData.stats.charClass;this.charClass=e;var a=this,n=[];$.each(s.counters,function(s,t){var e=a.sourceName(s);e&&n.push([e,s,t])}),n.sort(function(s,t){return s[0].toLowerCase().localeCompare(t[0].toLowerCase())}),this.sectCounters.empty();var l=x.extraskills&&x.extraskills[e]||{};$.each(n,function(s,n){var r=n[0],o=n[1],p=n[2],c=$('<li class="bigger"><span>'+r+"</span></li>");if(x.skills[e][o]||l[o]){d=i(o,e).replace(/span/g,"div");c.prepend(d),c.hover(function(){x.tooltip.showSkill(this,e,o,a.initData.stats.skills[o])},function(){x.tooltip.hide()})}else if(x.passives[e][o]){var h=x.passives[e][o],d='<div style="background: url(css/images/class-'+e+"-passive.png) "+-24*h.index+'px 0 / auto 48px no-repeat"></div>';c.prepend(d),c.hover(function(){x.tooltip.showSkill(this,e,o)},function(){x.tooltip.hide()})}else if(x.legendaryGems[o]){d=t(x.legendaryGems[o].id,"gemleg");c.prepend(d),c.hover(function(){x.tooltip.showGem(this,o,a.initData.stats.gems[o])},function(){x.tooltip.hide()})}else if(a.initData.stats.affixes[o]){var u=a.initData.stats.affixes[o],f=x.getSlotId(u.slot);f&&c.prepend(t(f)),c.hover(function(){x.tooltip.showItem(this,u.slot)},function(){x.tooltip.hide()})}else x.isKnownStat(o)?c.hover(function(){x.showStatTip(this,o)},function(){x.tooltip.hide()}):x.itemFromAffix[o]&&(c.prepend(t(x.itemFromAffix[o].id)),c.hover(function(){var s=[],t=x.itemFromAffix[o].required.custom;1!==t.args&&void 0!==t.args||s.push(("min"===t.best?t.min:t.max)||0),x.tooltip.showItem(this,x.itemFromAffix[o].id,s)},function(){x.tooltip.hide()}));if(a.sectCounters.append(c),p.count){a.sectCounters.append("<li><span>"+b("Uses")+"</span><span>"+p.count+"</span></li>");var v=p.count/a.results.time*3600;v>60?a.sectCounters.append("<li><span>"+b("Uses/second")+"</span><span>"+x.formatNumber(v/60,2)+"</span></li>"):a.sectCounters.append("<li><span>"+b("Uses/minute")+"</span><span>"+x.formatNumber(v,2)+"</span></li>")}if(p.damage&&(a.sectCounters.append("<li><span>"+b("Damage")+"</span><span>"+R(p.damage)+"</span></li>"),a.sectCounters.append("<li><span>"+b("DPS")+"</span><span>"+R(p.damage/a.results.time*60)+"</span></li>"),a.sectCounters.append("<li><span>"+b("% Damage")+"</span><span>"+x.formatNumber(100*p.damage/a.results.damage,2)+"%</span></li>")),p.healing&&(a.sectCounters.append("<li><span>"+b("Healing")+"</span><span>"+R(p.healing)+"</span></li>"),a.sectCounters.append("<li><span>"+b("HPS")+"</span><span>"+R(p.healing/a.results.time*60)+"</span></li>"),a.sectCounters.append("<li><span>"+b("% Healing")+"</span><span>"+x.formatNumber(100*p.healing/a.results.healing,2)+"%</span></li>")),p.rc)for(var m in p.rc)x.resources[m]&&a.sectCounters.append("<li><span>"+b("Gained {0}").format(x.resources[m])+"</span><span>"+x.formatNumber(p.rc[m],0,1e4)+"</span></li>")});n=[];$.each(s.uptimes,function(s,t){var e=x.simMapping.buffs[s]&&x.simMapping.buffs[s].name||s;n.push([e,t])}),n.sort(function(s,t){return s[0].toLowerCase().localeCompare(t[0].toLowerCase())}),this.sectUptimes.empty();for(var r=0;r<n.length;++r){var o=x.formatNumber(100*n[r][1],2)+"%",p=$("<li><span>"+n[r][0]+"</span><span>"+o+"</span></li>"),c=n[r][0]+': <span class="d3-color-green">'+o+"</span>";n[r][1]>1&&(c+='</span><br/><span class="tooltip-icon-bullet"></span>Average stacks: <span class="d3-color-green">'+x.formatNumber(n[r][1],2)),x.addTip(p,c),this.sectUptimes.append(p)}this.sectSample.empty(),this.sampleLines={},this.sampleData=s.sample,this.updateSample(),this.section.show()},this.section.on("click","h3",function(){$(this).next().slideToggle()}),this.onMessage=function(s){this.results&&(this.results.time=s.time,"report"===s.type?(this.results.damage=s.damage,this.results.healing=s.healing,this.finish(s)):(this.results.damage+=s.damage,this.results.healing+=s.healing,this.damageData.push({x:1e3*s.time/60,y:s.damage/3}),this.healingData.push({x:1e3*s.time/60,y:s.healing/3}),"dps"===this.chartMode?this.chartData.push(this.damageData[this.damageData.length-1]):this.chartData.push(this.healingData[this.healingData.length-1]),this.chart.render()),this.dps.find("span").text(R(this.results.damage/this.results.time*60)),this.hps.find("span").text(R(this.results.healing/this.results.time*60)),this.hps.toggle(this.results.healing>0))},this.start=function(s){x.activity("simulate"),s.type="start",delete this.sampleData,this.initData=s,this.worker=new Worker("sim");var t=this;this.worker.onmessage=function(s){t.onMessage(s.data)},this.results={damage:0,healing:0,time:1},this.dps.show(),this.dps.find("span").text("0"),this.hps.hide(),this.section.hide(),this.chartData.length=0,this.damageData.length=0,this.healingData.length=0,this.graph.show(),this.dps.click(),this.chart.render(),this.worker.postMessage(s),E.button({icons:{primary:"ui-icon-stop"},label:b("Stop")})},this.abort=function(){this.dps.hide(),this.hps.hide(),this.section.hide(),this.graph.hide(),this.worker.terminate(),delete this.worker,delete this.results,delete this.sampleData,E.button({icons:{primary:"ui-icon-play"},label:b("Start")})},this.running=function(){return!!this.worker}};x.SimResults=V,x.exportStats=function(){var s=new x.Stats;s.loadItems(void 0,!0),x.addSkillList(s),x.addPartyBuffs(s);var t=A.val();if(t)for(var e=0;e<t.length;++e)s[t[e]]=1;return s.flatten(),s},x.exportProfile=function(){return{stats:x.exportStats(),params:x.getActive("global+"),priority:x.priority.getData()}},E.click(function(){V.running()?V.abort():V.start(x.exportProfile())});var W=location.pathname.match(/^\/e?([0-9]+)$/);y.accordion({active:W?1:0,collapsible:!0,heightStyle:"content",activate:function(s,t){t.newPanel.removeClass("sliding"),t.oldPanel.removeClass("sliding"),t.newPanel.is(S)&&g()},beforeActivate:function(s,t){t.newPanel.addClass("sliding"),t.oldPanel.addClass("sliding")}}),x.register("changeClass",function(){x.priority.setData(x.priority.getData()),v()}),x.register("updateSlotItem",m),x.register("importEnd",m)}();