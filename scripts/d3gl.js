$.ajaxTransport("+binary",function(t,e,r){if(window.FormData&&(t.dataType&&"binary"==t.dataType||t.data&&(window.ArrayBuffer&&t.data instanceof ArrayBuffer||window.Blob&&t.data instanceof Blob)))return{send:function(e,r){var a=new XMLHttpRequest,i=t.url,n=t.type,s=t.async||!0,o=t.responseType||"blob",h=t.data||null,l=t.username||null,u=t.password||null;a.addEventListener("load",function(){var e={};e[t.dataType]=a.response,r(a.status,a.statusText,e,a.getAllResponseHeaders())}),a.open(n,i,s,l,u);for(var c in e)a.setRequestHeader(c,e[c]);a.responseType=o,a.send(h)},abort:function(){r.abort()}}}),function(){function t(t,e,r){for(var a=[],i=0;i<r;++i){var n=t.getUint8(e+i);if(!n)break;a.push(n)}return String.fromCharCode.apply(null,a).toLowerCase()}function e(t,e){if(0===e)return null;if(e in U)return U[e].texture;var r={};return U[e]=r,r.texture=null,r.image=new Image,r.image.onload=function(){r.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,r.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r.image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null)},r.image.src="webgl/textures/"+e,r.texture}function r(t,e){if(!x[t]){r={callbacks:[]};x[t]=r,$.ajax({url:"webgl/"+t,type:"GET",dataType:"binary",responseType:"arraybuffer",processData:!1}).done(function(t){r.data=t;for(var e=0;e<r.callbacks.length;++e)r.callbacks[e](t);delete r.callbacks})}var r;(r=x[t]).data?e(r.data):r.callbacks&&r.callbacks.push(e)}function a(t,e){this.raw=t,this.gl=e}function i(t){var e=this;r("animations/"+t,function(t){e.load(t)})}function n(t,e){this.list=[],this.cache={},this.flagCallback=e,this.rigged=0;for(var r=0;r<t.length;++r)this.list.push(new i(t[r][0])),this.list[r].flag=t[r][1],this.list[r].weight=0==r?.95:.05/(t.length-1)}function s(t){var e=this;r("animsets/"+t,function(t){e.load(t)})}function o(t,e){this.material=t,this.gl=e,this.groups=[]}function h(t,e){this.gl=t,this.renderChain=[],this.subObjects=[];var a=this;r("models/"+e,function(t){a.load(t)})}function l(t,e){this.actor=e,this.model=new h(t,e),this.animset=new s(e),this.animations=[427776,426960,410112,410113,410115,410116,410117,410118,410119,86272,86273,86274,86275],this.data=y.webglCharacters[e]||{},this.slots={head:{},shoulders:{},torso:{},hands:{},legs:{},feet:{},mainhand:{},offhand:{}};var r=this;setTimeout(function(){r.data.beard&&r.model.enable(r.data.beard,0,10,!0);for(var t in y.itemSlots)T(t)},0)}function u(t,e){var r=t&&y.itemTypes[t]&&y.itemTypes[t].weapon&&y.itemTypes[t].weapon.type,a=e&&y.itemTypes[e]&&y.itemTypes[e].weapon&&y.itemTypes[e].weapon.type;if("source"===e||"mojo"===e||"phylactery"===e||"quiver"===e)switch(r){case void 0:return 11;case"swing":return 12;case"thrust":return 13;case"wand":return 19;default:return u(t,void 0)}if("shield"===e||"crusadershield"===e){if("flail2h"===t)return 27;switch(r){case"swing":return 20;case"thrust":return 21;case void 0:return 22;case"fist":return 16;case"swing2h":return 23;case"thrust2h":return 24;case"staff":return 25;default:return u(t,void 0)}}if(a)return"fist"===a?"fist"===r?15:14:10;if("flail2h"===t)return 26;if("axe2h"===t||"mace2h"===t)return 17;switch(r){case"swing":return 2;case"thrust":return 3;case"swing2h":return 4;case"thrust2h":return 5;case"staff":return 6;case"bow":return 7;case"crossbow":return 8;case"wand":return 9;case"fist":return 16;case"handcrossbow":return 18;default:return 1}}function c(t,e,r){var a=t.createShader(e);if(!a)return null;t.shaderSource(a,r),t.compileShader(a);if(!t.getShaderParameter(a,t.COMPILE_STATUS)){var i=t.getShaderInfoLog(a);return t.console.log("*** Error compiling shader: "+i),t.deleteShader(a),null}return a}function f(){var t=this.canvas.width,e=this.canvas.height,r=this.character&&this.character.data.fov||12;t===this.width&&e===this.height&&r==this.prevFov||(this.width=t,this.height=e,this.prevFov=r,this.viewport(0,0,t,e),this.perspectiveMatrix=mat4.perspective(mat4.create(),.7,t/e,1,50),mat4.multiply(this.perspectiveMatrix,this.perspectiveMatrix,[0,0,1,0,1,0,0,0,0,1,0,0,0,0,-r,1]),this.uniformMatrix4fv(this.u_projMatrixLoc,!1,this.perspectiveMatrix))}function d(t){var e=this;if(R&&!0!==document.hidden){e.reshape(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),mat4.fromZRotation(e.mvMatrix,e.viewAngle);var r=e.character&&e.character.model.center;if(r){var a=e.character&&e.character.data.y||.75;mat4.translate(e.mvMatrix,e.mvMatrix,vec3.fromValues(-r[0],-r[1],-r[2]+a))}e.ground&&e.ground.render(e.mvMatrix),e.character&&e.character.model.render(.001*t,e.mvMatrix),e.flush()}window.requestAnimationFrame(function(t){e.render(t)})}function p(t,e){if(e)return t.dragPos=[e.clientX,e.clientY],t.dragStart=[e.clientX,e.clientY],e.preventDefault(),!1}function m(t,e){if(e&&t.dragPos&&1&e.buttons)return t.viewAngle+=.005*(e.clientX-t.dragPos[0]),t.dragPos=[e.clientX,e.clientY],e.preventDefault(),!1}function g(t,e){if(t.dragPos)return Math.abs(t.dragPos[0]-t.dragStart[0])<2&&Math.abs(t.dragPos[1]-t.dragStart[1])<2&&t.character&&t.character.model&&t.character.model.animation&&t.character.model.animation.choose&&t.character.model.animation.choose(),delete t.dragPos,delete t.dragStart,e.preventDefault(),!1}function v(t){if(!(t.originalEvent.touches.length>1)){var e=$.extend({buttons:1,clientX:0,clientY:0},t.originalEvent.touches[0]);return e.preventDefault=function(){t.preventDefault()},e}}function b(){if(y.webglClasses[y.charClass]){var t=y.webglClasses[y.charClass][DiabloCalc.gender||"female"];y.d3gl.character=new l(y.d3gl,t)}else y.d3gl.character=void 0}function T(t){if(y.d3gl.character){var e=y.getSlot(t),r=e&&(e.transmog||e.rwbase&&(e.rwbase.transmog||e.rwbase.id)||e.id),a=e&&(e.rwbase&&e.rwbase.dye||e.dye);y.d3gl.character.equip(t,r,a)}}function _(){if(w[0]&&w[1]){_=function(){};var t=function(t){var e=t.getContext("webgl");return e?(e.canvas=t,e.consoleDiv=$("#console"),e.console={log:function(){console.log.apply(console,arguments)}},e.program=function(t,r){var a=c(e,e.VERTEX_SHADER,t),i=c(e,e.FRAGMENT_SHADER,r);if(!a||!i)return null;var n=e.createProgram();if(!n)return null;e.attachShader(n,a),e.attachShader(n,i);var s=["vPosition","vNormal","vTexture","vBoneIndex","vBoneWeight"];for(var o in s)e.bindAttribLocation(n,o,s[o]);if(e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS)){var h=e.getProgramInfoLog(n);return e.console.log("Error in program linking:"+h),e.deleteProgram(n),e.deleteShader(i),e.deleteShader(a),null}return n}(w[0],w[1]),e.program?(e.useProgram(e.program),e.clearColor(0,0,0,0),e.clearDepth(50),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.enable(e.CULL_FACE),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e):null):null}(E.find("canvas")[0]);if(!t)return void E.append('<div class="d3gl-error"><b>'+_L("Failed to load WebGL")+"</b><br/>"+_L("Visit {0} for more information.").format('<a target="_blank" href="http://get.webgl.org/">http://get.webgl.org/</a>')+"</div>");y.d3gl=t;var e=vec3.normalize(vec3.create(),vec3.fromValues(1,.4,.4));t.uniform3f(t.getUniformLocation(t.program,"lightDir"),e[0],e[1],e[2]),t.mvMatrix=mat4.create(),t.u_projMatrixLoc=t.getUniformLocation(t.program,"u_projMatrix"),t.BonesLoc=t.getUniformLocation(t.program,"Bones"),t.u_alphaLoc=t.getUniformLocation(t.program,"u_alpha"),t.uniform1f(t.u_alphaLoc,1),t.u_TintLoc=t.getUniformLocation(t.program,"u_Tint"),t.mvpMatrix=mat4.create(),t.reshape=f,t.render=d,t.viewAngle=0;var r=t.getUniformLocation(t.program,"sampler");t.uniform1i(r,0),r=t.getUniformLocation(t.program,"sampler_tint"),t.uniform1i(r,1),(r=t.getUniformLocation(t.program,"sampler_spec"))&&t.uniform1i(r,2),t.enabled=function(){return R},t.character=new l(t,6526),$(E).mousedown(function(e){p(t,e)}).on("touchstart",function(e){return p(t,v(e))}),$(window).mousemove(function(e){m(t,e)}).mouseup(function(e){g(t,e)}).on("touchmove",function(e){return m(t,v(e))}).on("touchend",function(e){return g(t,v(e))}),window.requestAnimationFrame(function(e){t.render(e)}),b(),DiabloCalc.register("changeClass",b),DiabloCalc.register("changeGender",b),DiabloCalc.register("updateSlotItem",T),DiabloCalc.register("importEnd",function(){for(var t in y.itemSlots)T(t)})}}var E,A,y=DiabloCalc,R=!1,w=new Array(2),U={},x={};a.prototype.diffuse=function(t){return e(this.gl,this.raw.getUint32(16*t,!0))},a.prototype.specular=function(t){return e(this.gl,this.raw.getUint32(16*t+4,!0))},a.prototype.tintbase=function(t){return e(this.gl,this.raw.getUint32(16*t+8,!0))},a.prototype.tintmask=function(t){return e(this.gl,this.raw.getUint32(16*t+12,!0))},i.prototype.loaded=function(){return!!this.bones},i.prototype.duration=function(){if(!this.bones)return 0;var t=(this.frames-1)/this.velocity/60;if(this.queued){var e=y.getStats();e.info.aps&&(t/=e.info.aps)}return t},i.prototype.load=function(e){var r=new DataView(e);this.frames=r.getUint32(0,!0),this.velocity=r.getFloat32(4,!0);var a=r.getUint32(8,!0),i=r.getUint32(12,!0);this.bones=[];for(var n=0;n<a;++n){var s=i+88*n,o={};o.name=t(r,s,64);var h=r.getUint32(s+64,!0),l=r.getUint32(s+68,!0),u=r.getUint32(s+72,!0),c=r.getUint32(s+76,!0),f=r.getUint32(s+80,!0),d=r.getUint32(s+84,!0);o.translations=[];for(p=0;p<h;++p){s=l+16*p;o.translations.push({frame:r.getUint32(s,!0),value:new Float32Array(e,s+4,3)})}o.rotations=[];for(p=0;p<u;++p){s=c+20*p;o.rotations.push({frame:r.getUint32(s,!0),value:new Float32Array(e,s+4,4)})}o.scales=[];for(var p=0;p<f;++p){s=d+8*p;o.scales.push({frame:r.getUint32(s,!0),value:r.getFloat32(s+4,!0)})}this.bones.push(o)}},function(){function t(t,e,r,a){mat4.translate(t,t,vec3.lerp(n,e,r,a))}function e(t,e,r,a){mat4.multiply(t,t,mat4.fromQuat(s,quat.slerp(o,e,r,a)))}function r(t,e,r,a){var i=e*(1-a)+r*a;mat4.scale(t,t,vec3.set(n,i,i,i))}function a(t,e,r,a){if(r.length){var i=function(t,e){for(var r=0,a=e.length;a-r>1;){var i=Math.floor((r+a)/2);e[i].frame<t?r=i:a=i}return r}(e,r);i<r.length-1?a(t,r[i].value,r[i+1].value,(e-r[i].frame)/(r[i+1].frame-r[i].frame)):a(t,r[i].value,r[i].value,0)}}var n=vec3.create(),s=mat4.create(),o=quat.create();i.prototype.update=function(i,n,s){if(this.bones){var o=60*n*this.velocity;if(this.queued){var h=y.getStats();h.info.aps&&(o*=h.info.aps)}o-=(this.frames-1)*Math.floor(o/(this.frames-1));for(u=0;u<i.boneList.length;++u)mat4.identity(i.boneList[u].localTransform);for(u=0;u<this.bones.length;++u){var l=this.bones[u];(c=i.bones[l.name])&&(a(c.localTransform,o,l.translations,t),a(c.localTransform,o,l.rotations,e),a(c.localTransform,o,l.scales,r))}for(var u=0;u<i.boneList.length;++u){var c=i.boneList[u];c.parent?mat4.multiply(c.localTransform,c.parent.localTransform,c.localTransform):mat4.multiply(c.localTransform,s,c.localTransform),mat4.multiply(c.transform,c.localTransform,c.invTransform)}i.animated=!0}}}(),n.prototype._fetch=function(t){return this.cache[t]?this.cache[t]:this.cache[t]=new i(t)},n.prototype.__choose=function(t){for(var e=0,r=t||0;r<this.list.length;++r)this.list[r].loaded()&&(e+=this.list[r].weight);if(e){e*=Math.random();for(r=t||0;r<this.list.length;++r)if(this.list[r].loaded()){if(e<this.list[r].weight)return this.list[r];e-=this.list[r].weight}for(r=t||0;r<this.list.length;++r)if(this.list[r].loaded())return this.list[r]}else if(t)return this._choose()},n.prototype._choose=function(t){if(this.queued&&this.queued.length&&this.queued[0].loaded())return this.rigged=5,this.queued.shift();if(this.rigged>0&&this.list[0].loaded())return this.rigged-=1,this.list[0];var e=this.__choose();return e!=this.list[0]&&(this.rigged=5),e},n.prototype.choose=function(){this.time=this.lastTime,this.current=this.__choose(1),this.rigged=5},n.prototype.update=function(t,e,r){for(void 0===this.time&&(this.time=e),this.current&&this.current.queued||!this.queued||!this.queued.length||!this.queued[0].loaded||(this.time=e,this.current=this._choose()),this.lastTime=e,this.current||(this.current=this._choose());this.current&&e>this.time+this.current.duration();)this.time+=this.current.duration(),this.current=this._choose();this.current&&(this.current.flag!==this.flag&&this.flagCallback(this.flag=this.current.flag),this.current.update(t,e-this.time,r))},n.prototype.queue=function(t){this.queued=[];for(var e=0;e<t.length;++e)this.queued.push(this._fetch(t[e][0])),this.queued[e].flag=t[e][1],this.queued[e].queued=!0},n.prototype.prepare=function(t){for(var e=0;e<t.length;++e)this._fetch(t[e][0])};var F=[-1,0,0,0,0,0,4,0,0,0,0,1,2,3,10,10,1,4,0,9,2,3,1,4,5,6,4,26,0];s.prototype.load=function(t){this.data=[];for(var e=new Int32Array(t),r=0,a=0;a<29;++a){for(var i={},n=e[r++];n--;){i[e[r++]]=e[r++]}this.data.push(i)}this.request&&(this.doGet(this.request.callback,this.request.id,this.request.type),delete this.request)},s.prototype._doGet=function(t,e){for(var r=e;e>=0;){if(t in this.data[e])return-1==this.data[e][t]?[this.data[0][t],!0]:[this.data[e][t],0===e];e=F[e]}return 427776===t?[void 0,!0]:this._doGet(427776,r)},s.prototype.doGet=function(t,e,r){if("object"==typeof e&&"length"in e){for(var a=[],i=0;i<e.length;++i)a.push(this._doGet(e[i],r));t(a)}else t(this._doGet(e,r))},s.prototype.get=function(t,e,r){this.data?this.doGet(t,e,r):this.request={callback:t,id:e,type:r}},o.prototype.addGroup=function(t,e,r){var a={},i=this.gl;a.bones=t,a.vertices=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,a.vertices),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),a.indices=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a.indices),i.bufferData(i.ELEMENT_ARRAY_BUFFER,r,i.STATIC_DRAW),a.numIndices=r.length,this.groups.push(a)},o.prototype.render=function(t,r,a,i,n){var s=this.gl;this.material&&(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.material.diffuse(r)),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,i&&this.material.tintmask(r)||e(s,0)),i&&s.uniform3f(s.u_TintLoc,i.r,i.g,i.b),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,this.material.specular(r))),s.enableVertexAttribArray(0),s.enableVertexAttribArray(1),s.enableVertexAttribArray(2),s.enableVertexAttribArray(3),s.enableVertexAttribArray(4);for(var o=0;o<this.groups.length;++o){var h=this.groups[o];if(a.length){for(var l=new Float32Array(16*h.bones.length),u=0;u<h.bones.length;++u)mat4.copy(l.subarray(16*u,16*u+16),a[h.bones[u]].transform);this.gl.uniformMatrix4fv(this.gl.BonesLoc,!1,l)}else this.gl.uniformMatrix4fv(this.gl.BonesLoc,!1,t);s.bindBuffer(s.ARRAY_BUFFER,h.vertices),s.vertexAttribPointer(0,3,s.FLOAT,!1,36,0),s.vertexAttribPointer(1,4,s.BYTE,!0,36,12),s.vertexAttribPointer(2,2,s.SHORT,!1,36,16),s.vertexAttribPointer(3,4,s.UNSIGNED_BYTE,!1,36,20),s.vertexAttribPointer(4,3,s.FLOAT,!1,36,24),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,h.indices),s.depthFunc(s.LESS),s.depthMask(!n),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),s.drawElements(s.TRIANGLES,h.numIndices,s.UNSIGNED_SHORT,0),s.depthFunc(s.GREATER),s.depthMask(!1),s.blendFuncSeparate(s.ONE_MINUS_DST_ALPHA,s.DST_ALPHA,s.ONE_MINUS_DST_ALPHA,s.ONE),s.drawElements(s.TRIANGLES,h.numIndices,s.UNSIGNED_SHORT,0)}s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),this.material&&(s.uniform1f(s.u_alphaLoc,1),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,null))},h.prototype.load=function(e){var r=new DataView(e),i=r.getUint32(0,!0),n=r.getUint32(4,!0),s=r.getUint32(8,!0),h=r.getUint32(12,!0),l=r.getUint32(16,!0),u=r.getUint32(20,!0),c=r.getUint32(24,!0),f=r.getUint32(28,!0),d=r.getUint32(32,!0);this.center=new Float32Array(e,36,3),this.boneList=[],this.bones={};for(E=0;E<i;++E){var p=n+108*E,m=r.getUint32(p+100,!0),g=r.getUint32(p+104,!0),v={};v.name=t(r,p,64);-1!=(_=r.getInt32(p+64,!0))&&(v.parent=this.boneList[_]),v.prsTransform={rotate:new Float32Array(e,p+68,4),translate:new Float32Array(e,p+84,3),scale:r.getFloat32(p+96,!0)};var b=v.prsTransform.scale;v.localTransform=mat4.fromRotationTranslationScale(mat4.create(),v.prsTransform.rotate,v.prsTransform.translate,vec3.fromValues(b,b,b)),v.invTransform=mat4.invert(mat4.create(),v.localTransform),v.transform=mat4.create(),m&&(v.capsule={start:new Float32Array(e,m,3),end:new Float32Array(e,m+12,3),radius:r.getFloat32(m+24,!0)}),g&&(v.constraint={parent:{rotate:new Float32Array(e,g,4),translate:new Float32Array(e,g+16,3)},local:{rotate:new Float32Array(e,g+28,4),translate:new Float32Array(e,g+44,3)},values:new Float32Array(e,g+56,5)}),this.boneList.push(v),this.bones[v.name]=v}this.hardpoints={};for(E=0;E<s;++E){var p=h+132*E,T={};T.name=t(r,p,64);var _=r.getInt32(p+64,!0);-1!=_&&(T.parent=this.boneList[_]),T.relTransform=new Float32Array(e,p+68,16),T.transform=mat4.clone(T.relTransform),this.hardpoints[T.name]=T}this.materials=[];for(E=0;E<c;++E){p=d+16*E*f;this.materials.push(new a(new DataView(e,p,16*f),this.gl))}this.objects=[];for(var E=0;E<l;++E){var p=u+12*E,A=r.getUint32(p,!0),y=new o(this.materials[A],this.gl);this.objects.push(y);for(var R=r.getUint32(p+4,!0),w=r.getUint32(p+8,!0),U=0;U<R;++U){var p=w+24*U,i=r.getUint32(p,!0),n=r.getUint32(p+4,!0),x=r.getUint32(p+8,!0),F=r.getUint32(p+12,!0),L=r.getUint32(p+16,!0),S=r.getUint32(p+20,!0);y.addGroup(new Uint32Array(e,n,i),new Uint8Array(e,F,36*x),new Uint16Array(e,S,L))}}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)},h.prototype.enable=function(t,e,r,a,i){if("object"==typeof t)for(var n=0;n<t.length;++n)this.enable(t[n],e,r,a,i);else this.renderChain.push({index:t,appearance:e,prio:r,nodepth:a,tint:i});return this},h.prototype.disable=function(t){if("object"==typeof t)for(e=0;e<t.length;++e)this.disable(t[e]);else for(var e=0;e<this.renderChain.length;++e)this.renderChain[e].index===t&&this.renderChain.splice(e--,1);return this},h.prototype.animate=function(t){return"number"==typeof t&&(t=new i(t)),this.animation=t},h.prototype.setRagdoll=function(t){this.animation=new y.D3Ragdoll(this.gl)},h.prototype.attach=function(t,e){"number"==typeof e&&(e=new h(this.gl,e));var r={hp:t,model:e};return this.subObjects.push(r),r},h.prototype.detach=function(t){var e=this.subObjects.indexOf(t);e>=0&&this.subObjects.splice(e,1)},h.prototype.update=function(t,e){if(this.objects&&this.animation){this.animation.update(this,t,e);for(var r in this.hardpoints){var a=this.hardpoints[r];a.parent?mat4.multiply(a.transform,a.parent.localTransform,a.relTransform):mat4.multiply(a.transform,e,a.relTransform)}}},h.prototype.render=function(t,e){if(this.objects){this.scale&&(e=mat4.scale(mat4.create(),e,[this.scale,this.scale,this.scale])),void 0!==t&&this.update(t,e),this.renderChain.sort(function(t,e){return(t.prio||0)-(e.prio||0)});for(i=0;i<this.renderChain.length;++i){(n=this.renderChain[i]).index>=this.objects.length||n.prio>=10||this.objects[n.index].render(e,n.appearance,this.boneList,n.tint,n.nodepth)}for(i=0;i<this.subObjects.length;++i){var r=this.subObjects[i],a=this.hardpoints[r.hp];a&&r.model.render(t,a.transform)}for(var i=0;i<this.renderChain.length;++i){var n=this.renderChain[i];n.index>=this.objects.length||n.prio<10||this.objects[n.index].render(e,n.appearance,this.boneList,n.tint,n.nodepth)}}},l.prototype.animType=function(){return u(this.slots.mainhand.item&&this.slots.mainhand.item.type,this.slots.offhand.item&&this.slots.offhand.item.type)},l.prototype._mhpoint=function(){return this.isNoneType?"hp_sheath_right_hip":"hp_rightweapon"},l.prototype._ohpoint=function(){var t=this.slots.offhand.item.type;return this.isNoneType?"shield"===t||"crusadershield"===t?"hp_sheath_shield":"quiver"===t?"hp_sheath_left_back":y.itemTypes[t]&&y.itemTypes[t].weapon?"hp_sheath_left_hip":"hp_none":"shield"===t||"crusadershield"===t?"hp_shield":"quiver"===t?"hp_sheath_left_back":"hp_leftweapon"},l.prototype.updateAnimation=function(){var t=this;this.animset.get(function(e){t.model.animate(new n(e,function(e){t.isNoneType=e,t.slots.mainhand.item&&t.slots.mainhand.att&&(t.slots.mainhand.att.hp=t._mhpoint()),t.slots.offhand.item&&t.slots.offhand.att&&(t.slots.offhand.att.hp=t._ohpoint())}))},this.animations,this.animType())},l.prototype.animate=function(t){var e=this;t instanceof Array||(t=[t]),this.animset.get(function(t){e.model.animation&&e.model.animation.queue(t)},t,this.animType())},l.prototype.prepare=function(t){var e=this;t instanceof Array||(t=[t]),this.animset.get(function(t){e.model.animation&&e.model.animation.prepare(t)},t,this.animType())},l.prototype._attach=function(t,e,r){if("object"==typeof e&&(e=e[this.actor]),e){var a=this.model.attach(t,e),i=y.webglActors[e];if(i){void 0!==i.hair&&this._enable("hair",i.hair,0,12,!0),i.animation&&a.model.animate(i.animation),i.physics&&a.model.setRagdoll(i.physics),i.scale&&(a.model.scale=i.scale);for(var n in i.enable)a.model.enable(n,i.enable[n],0,!1,r)}return a}},l.prototype._enable=function(t,e,r,a,i,n){var s=this.data[t];for(var o in s)this.model.disable(s[o]);e in s&&this.model.enable(s[e],r,a,i,n)};var L={legs:0,hands:1,torso:2,feet:3};l.prototype.equip=function(t,e,r){if(t in this.slots){(r=r&&y.webglDyes[r])&&21===r.type&&(e=void 0);var a=e&&(y.itemById[e]||y.webglItems[e]);if(a&&"quiver"===a.type&&(e=void 0,a=void 0),r=r&&r.color,"id"in this.slots[t]&&this.slots[t].id===e){if(this.slots[t].tint===r)return;if(this.slots[t].tint=r,this.slots[t].att)return $.each(this.slots[t].att.model.renderChain,function(t,e){e.tint=r}),void(this.slots[t].att_r&&$.each(this.slots[t].att_r.model.renderChain,function(t,e){e.tint=r}))}this.slots[t].id=e,this.slots[t].tint=r,this.slots[t].item=a;var i=e&&y.webglItems[e];if(this.slots[t].att&&(this.model.detach(this.slots[t].att),delete this.slots[t].att),this.slots[t].att_r&&(this.model.detach(this.slots[t].att_r),delete this.slots[t].att_r),a&&i)switch(t){case"head":this.slots.head.att=this._attach("hp_helm",i.actor,r);break;case"shoulders":this.slots.shoulders.att=this._attach("hp_left_shoulderpad",i.actor,r),this.slots.shoulders.att_r=this._attach("hp_right_shoulderpad",i.actor_r,r);break;case"mainhand":this.slots.mainhand.att=this._attach(this._mhpoint(),i.actor,r);break;case"offhand":this.slots.offhand.att=this._attach(this._ohpoint(),i.actor,r)}switch(t){case"head":a||this._enable("hair",-1,0,12,!0);break;case"feet":case"hands":case"legs":case"torso":this._enable(t,i&&i.armortype||-1,i&&this.data.looks[i.look]||0,L[t],!1,r)}this.updateAnimation()}},function(t,e){this.gl=t,this.vertices=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertices);var r=new ArrayBuffer(144),a=new Float32Array(r,0),i=new Int8Array(r,12),n=new Int16Array(r,16),s=(new Uint8Array(r,20),new Float32Array(r,24));a.set([e,e,0],0),i.set([0,0,127],0),n.set([512,512],0),a.set([-e,e,0],9),i.set([0,0,127],36),n.set([512,0],18),a.set([-e,-e,0],18),i.set([0,0,127],72),n.set([0,0],36),a.set([e,-e,0],27),i.set([0,0,127],108),n.set([0,512],54),s[0]=1,s[9]=1,s[18]=1,s[27]=1,t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),this.indices=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indices),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}.prototype.render=function(t){var r=this.gl;r.bindBuffer(r.ARRAY_BUFFER,this.vertices),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indices),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e(r,43673)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,null),r.enableVertexAttribArray(0),r.enableVertexAttribArray(1),r.enableVertexAttribArray(2),r.enableVertexAttribArray(3),r.enableVertexAttribArray(4),r.vertexAttribPointer(0,3,r.FLOAT,!1,36,0),r.vertexAttribPointer(1,4,r.BYTE,!0,36,12),r.vertexAttribPointer(2,2,r.SHORT,!1,36,16),r.vertexAttribPointer(3,4,r.UNSIGNED_BYTE,!1,36,20),r.vertexAttribPointer(4,3,r.FLOAT,!1,36,24),r.uniformMatrix4fv(r.BonesLoc,!1,t),r.depthFunc(r.LESS),r.depthMask(!0),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)};var S=$('<span class="d3gl-toggle"></span>').click(function(){function t(t,e){$.ajax({url:"webgl/"+t+"?"+Math.floor(1e6*Math.random()),type:"GET",dataType:"text"}).done(function(t){w[e]=t,_()})}if(DiabloCalc.activity("modelview"),!E)return E=$('<div class="d3gl-container"><canvas width="520" height="510"></canvas></div>'),A=$(".paperdoll-background"),S.after(E),A.hide(),t("shader.vsh",0),t("shader.psh",1),void(R=!0);R=!R,E.toggle(R),A.toggle(!R)});$(".paperdoll-container").prepend(S)}();