!function(){var t=DiabloCalc;t.popupMenu=function(t,s,e){if(!$.isEmptyObject(s)){var i=$('<ul class="popup-menu"></ul>').css("position","absolute");i.css("left",t.pageX+15),i.css("top",t.pageY-20),i.attr("tabIndex",-1),$("body").append(i);for(var a in s){var n=$("<li>"+a+"</li>");n.click(function(t){return function(s){i.remove(),t(s)}}(s[a])),i.append(n)}i.menu(),i.focus(),i.focusout(function(){e&&e(),i.remove()})}},t.addTip=function(s,e){var i=s;return"SELECT"!==s[0].tagName||s.is(":visible")||(s=s.next()),s.hover(function(){var s=e;if("function"==typeof e&&(s=e.call(i)),s){var a='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+s+"</span></p></div>";t.tooltip&&t.tooltip.showHtml(this,a)}},function(){t.tooltip&&t.tooltip.hide()}),s},t.chosenTips=function(s,e){var i=s.data("chosen");i&&i.search_results.on("mouseover","li",s.data("chosen"),function(s){var i=s.data,a=this.getAttribute("data-option-array-index");a&&i&&i.results_data&&i.results_data[a]&&t.tooltip&&e.call(this,i.results_data[a].value,this)}).on("mouseleave","li",function(s){t.tooltip&&t.tooltip.hide()})},$.widget("ui.custommouse",$.ui.mouse,{options:{},widgetEventPrefix:"custommouse",_init:function(){return this._mouseInit()},_create:function(){return this.element.addClass("ui-custommouse")},_destroy:function(){return this._mouseDestroy(),this.element.removeClass("ui-custommouse")},_mouseStart:function(){return!1}}),t.enableTouch=function(t){var s=void 0;t.draggable("instance")||t.custommouse(),t.on("touchstart",function(t){s=t.originalEvent.touches[0],setTimeout(function(){s=void 0},750)}),t.on("touchcancel",function(t){s=void 0,t.preventDefault()}),t.on("touchend",function(e){s&&((e=$.extend({},e)).type="click",s&&(e.pageX=s.pageX,e.pageY=s.pageY),s=void 0,setTimeout(function(){t.triggerHandler(e)},0)),e.preventDefault()})},t.simpleDialog=function(t){var s=$("<div><p>"+t.text+"</p></div>"),e=[];(t.buttons||[_L("Ok")]).forEach(function(s,i){e.push({text:s,click:function(){t.callback&&!1===t.callback(i)||$(this).dialog("close")}})}),s.dialog({resizable:!1,title:t.title,height:"auto",width:400,modal:!0,buttons:e,close:function(){s.remove()}})};var s,e;t.showPopup=function(t,i){s&&s!==t&&s.hide(),s=t,e=i},t.hidePopup=function(t){s===t&&(s=void 0)},t.shiftKey=!1,$(document).mouseup(function(t){s&&t.target&&$.contains(document.documentElement,t.target)&&!s.contains(t.target)&&!$(t.target).closest(".popup-menu").length&&s.hide()}).keydown(function(i){s&&e&&27===i.which&&s.hide(),16===i.which&&(t.shiftKey=!0)}).keyup(function(s){16===s.which&&(t.shiftKey=!1)}),t.formatNumber=function(t,s,e){if(void 0===e)return t.toFixed(s||0);var i=t.toFixed(s||0).split(".");return parseFloat(t)>=e&&(i[0]=i[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")),i.join(".")},t.formatDamage=function(s){return s>1e13?t.formatNumber(s/1e12,3,1e4)+" T":s>1e10?t.formatNumber(s/1e9,3,1e4)+" B":s>1e7?t.formatNumber(s/1e6,3,1e4)+" M":t.formatNumber(s,0,1e4)},t.validateNumber=function(){var t=parseFloat($(this).val());isNaN(t)&&(t=0);var s=parseFloat($(this).attr("step"));$(this).attr("min")&&(t=Math.max(t,$(this).attr("min"))),$(this).attr("max")&&(t=Math.min(t,$(this).attr("max"))),isNaN(s)||(t=Math.round(t/s)*s,t=parseFloat(t.toFixed(2))),$(this).val(t),$(this).trigger("input")},t.SearchResults=function(t,s,e){this.action=t,this.emptytip=e||_L("No results."),this.div=$("<div></div>"),this.message=$("<span></span>").hide(),this.results=$('<ul class="search-results"></ul>').hide(),this.navbar=$('<div class="search-navbar"></div>').hide(),this.navtip=$("<span></span>"),this.navfirst=$('<span class="search-navlink">&lt;&lt;</span>'),this.navprev=$('<span class="search-navlink">&lt;</span>'),this.navnext=$('<span class="search-navlink">&gt;</span>'),this.navlast=$('<span class="search-navlink">&gt;&gt;</span>'),this.navbox=$("<select></select>"),this.navbar.append(this.navtip).append($('<span class="search-navbuttons"></span>').append(this.navfirst).append(this.navprev).append(this.navbox).append(this.navnext).append(this.navlast)),this.div.append(this.message).append(this.results).append(this.navbar),this.makeResults=s;var i=this;this.navfirst.click(function(){i.query&&i.query.start>0&&i.search(i.query.term,0)}),this.navprev.click(function(){i.query&&i.query.start>0&&i.search(i.query.term,Math.max(0,i.query.start-10))}),this.navnext.click(function(){i.query&&i.query.start+10<i.query.count&&i.search(i.query.term,i.query.start+10)}),this.navlast.click(function(){i.query&&i.query.start+10<i.query.count&&i.search(i.query.term,10*Math.floor((i.query.count-1)/10))}),this.navbox.change(function(){i.query&&i.search(i.query.term,i.navbox.val())}),this.setError=function(t){this.query=void 0,this.message.text(t).show(),this.results.hide(),this.navbar.hide()},this.onSuccess=function(t){if(t.errors&&t.errors.length)this.setError(t.errors);else if(t.results&&(t.count||t.results.length)){this.message.hide(),this.results.empty();var s=this;$.each(t.results,function(e,i){var a=s.makeResults(t,i);s.results.append(a)}),this.query.start=t.start||0,this.query.count=t.count||t.results.length,this.navtip.text(_L("Showing {0} to {1} of {2}").format(this.query.start+1,this.query.start+t.results.length,this.query.count)),this.navfirst.toggleClass("disabled",this.query.start<=0),this.navprev.toggleClass("disabled",this.query.start<=0),this.navnext.toggleClass("disabled",this.query.start+t.results.length>=this.query.count),this.navlast.toggleClass("disabled",this.query.start+t.results.length>=this.query.count),this.navbox.prop("disabled",this.query.count<=10),this.navbox.empty();for(var e=0;10*e<this.query.count;++e)this.navbox.append('<option value="'+10*e+'">'+(e+1)+"</option>");this.navbox.val(this.query.start),this.navbar.find(".navbuttons").toggle(this.query.count>10),this.results.show(),this.navbar.show()}else 0===t.count?this.setError(this.emptytip):this.setError(_L("Query failed."))},this.onError=function(t){this.setError(_L("Query failed."))},this.search=function(t,s){this.query={term:t};var e=this;$.ajax({url:this.action,data:$.extend({start:s},t),type:"GET",dataType:"json",success:function(t){e.onSuccess(t)},error:function(t){e.onError(t)}})}}}();DiabloCalc.slotMap={mainHand:"mainhand",offHand:"offhand",leftFinger:"leftfinger",rightFinger:"rightfinger",bracers:"wrists",special:"follower"},DiabloCalc.typeMap={legs:"pants",ceremonialdagger:"ceremonialknife",flail1H:"flail",mightyweapon1h:"mightyweapon",combatstaff:"daibo",handxbow:"handcrossbow",genericbelt:"belt",belt_barbarian:"mightybelt",orb:"source"},DiabloCalc.classMap={"witch-doctor":"witchdoctor","demon-hunter":"demonhunter"},DiabloCalc.parseItemData=function(a,t){function e(a){var t=parseFloat(a.replace(/,/g,""));return isNaN(t)?0:t}function i(a){function t(t){if(t.base)return null;if(t.caldesanns)return null;t.regex||(t.regex=DiabloCalc.getStatRegex(t));var i=t.regex.exec(a);if(!i&&(t.altformat&&(t.altregex||(t.altregex=DiabloCalc.getStatRegex(t,t.altformat)),i=t.altregex.exec(a)),!i))return null;for(var r=[],s=0;s<t.args;s++)r.push(e(i[s+1]));if(t.args<0){var n=DiabloCalc.allPassives;for(var l in n)if(i[1]==n[l].origname){r.push(l);break}}return r}a=a.trim().replace(/\u2013|\u2014/g,"-");for(var i in DiabloCalc.stats){if(s=t(DiabloCalc.stats[i]))return r.stats[i]=s,i}if(n){var s=t(n);if(s)return r.stats.custom=s,"custom"}}if(a.type){var r={id:a.id,stats:{}};if(a.transmog&&(r.transmog=a.transmog.id),a.dye&&(r.dye=a.dye.id),!DiabloCalc.itemById[a.id]){var s=a.type.id.toLowerCase();s=(s=DiabloCalc.typeMap[s]||s).replace(/(generic|_.*)/g,""),s=DiabloCalc.typeMap[s]||s,DiabloCalc.itemTypes[s]&&(r.id=DiabloCalc.itemTypes[s].generic)}a.typeName.indexOf("Primal Ancient")>=0?r.ancient="primal":a.typeName.indexOf("Ancient")>=0&&(r.ancient=!0);var n,l={};if(DiabloCalc.itemById[r.id]&&(l=DiabloCalc.getItemAffixesById(r.id,r.ancient,"only")||{}).custom&&void 0===(n=$.extend({},l.custom)).args&&(n.args=1),a.attributes)for(var o in a.attributes)for(m=0;m<a.attributes[o].length;++m){var c=i(a.attributes[o][m]);a.attributesHtml&&a.attributesHtml[o]&&a.attributesHtml[o][m]&&a.attributesHtml[o][m].indexOf("tooltip-icon-enchant")>=0&&(r.enchant=c)}if(r.gems=[],a.gems){for(var m=0;m<a.gems.length;++m){var b=a.gems[m];if(b.isGem||b.isJewel){var g=DiabloCalc.gemById[b.item.id];g&&b.isJewel&&(g[1]=b.jewelRank),g&&r.gems.push(g)}}r.stats.sockets=[a.gems.length]}if(a.armor?r.stats.basearmor=[Math.floor(a.armor)]:l.basearmor&&(r.stats.basearmor=[l.basearmor.max]),a.blockChance){var d=a.blockChance.match(/\+([\d,\.]+)% Chance to Block\n([\d,]+)-([\d,]+) Block Amount/);d&&(r.stats.blockamount=[e(d[2]),e(d[3])],r.stats.baseblock=[e(d[1])],r.stats.block&&(r.stats.baseblock[0]-=r.stats.block[0]))}else l.blockamount&&l.baseblock&&(r.stats.blockamount=[l.blockamount.max,l.blockamount.max2],r.stats.blockamount=[l.baseblock.max]);if(a.augmentation){var f={caldesanns_vit:/\+(\d+) Vitality/,caldesanns_dex:/\+(\d+) Dexterity/,caldesanns_str:/\+(\d+) Strength/,caldesanns_int:/\+(\d+) Intelligence/};for(var o in f){var u=a.augmentation.match(f[o]);u&&(r.stats[o]=[e(u[1])])}}return r.imported={enchant:r.enchant,stats:$.extend(!0,{},r.stats)},r}};!function(){var a=DiabloCalc.locale("bnet-tooltips.js");DiabloCalc.itemPerfection=function(a){var t;if("string"==typeof a)t=a,a=DiabloCalc.getSlot(t);else if(a){var s=[];for(var e in DiabloCalc.itemSlots){if(DiabloCalc.itemSlots[e].item&&DiabloCalc.itemSlots[e].item.id===a.id){s=[e];break}DiabloCalc.isItemAllowed(e,a.id)&&s.push(e)}if(!s.length)return;t=s[0]}if(a){var l=DiabloCalc.getItemAffixesById(a.id,a.ancient,!1),i=DiabloCalc.getItemAffixesById(a.id,a.ancient,"only"),o={stats:{},total:0},n=$.extend(!0,{},a),c=$.extend(!0,{},a),r=0;for(var p in a.stats){var d=i[p];if(d||(d=l[p]),d&&void 0!==d.max&&d.min!==d.max){d.noblock&&l[p]&&a.stats[p][0]>d.max&&(d=$.extend({},d),DiabloCalc.stats[p]&&DiabloCalc.stats[p].dr?(d.min=100-.01*(100-d.min)*(100-l[p].min),d.max=100-.01*(100-d.max)*(100-l[p].max)):(d.min+=l[p].min,d.max+=l[p].max));var m=(a.stats[p][0]-d.min)/(d.max-d.min);"min"===d.best?(m=1-m,n.stats[p][0]=d.max,c.stats[p][0]=d.min):(n.stats[p][0]=d.min,c.stats[p][0]=d.max),void 0!==d.max2&&d.min2!==d.max2&&(m=.5*(m+((a.stats[p][1]||0)-d.min2)/(d.max2-d.min2)),n.stats[p][1]=d.min2,c.stats[p][2]=d.max2),o.stats[p]=m;var f=DiabloCalc.stats[p];f&&(f.base||f.secondary)&&"custom"!==p||(o.total+=m,++r)}}r?o.total/=r:o.total=1;var u=DiabloCalc.computeStats(function(s){return s===t?a:DiabloCalc.getSlot(s)}),b=DiabloCalc.computeStats(function(a){return a===t?n:DiabloCalc.getSlot(a)}),v=DiabloCalc.computeStats(function(a){return a===t?c:DiabloCalc.getSlot(a)});return o.dps=v.info.dps>b.info.dps+1?(u.info.dps-b.info.dps)/(v.info.dps-b.info.dps):1,o.dpsDelta=Math.max(0,v.info.dps-u.info.dps),o.toughness=v.info.toughness>b.info.toughness+1?(u.info.toughness-b.info.toughness)/(v.info.toughness-b.info.toughness):1,o.toughnessDelta=Math.max(0,v.info.toughness-u.info.toughness),o}},DiabloCalc.tooltip=new function(){function t(){m||(m=$('<div class="tooltip-body"></div>'),$("body").append(m)),p=$("<div></div>").addClass("d3-tooltip-wrapper").hide(),d=$("<div></div>"),$(m).append(p.append(d))}function s(){m||(m=$('<div class="tooltip-body"></div>'),$("body").append(m)),f=$("<div></div>").addClass("d3-tooltip-wrapper").hide(),u=$("<div></div>"),$(m).append(f.append(u))}function e(a){function t(a,t,s){return a<t&&(a=t,o=!0),a>s&&(a=s,o=!0),a}if(h&&D){var s=$(window),e={left:5,top:5,right:s.width()-5,bottom:s.height()-5},l=(h.left,h.top,h.right-h.left),i=h.bottom-h.top,o=!1;l>e.right-e.left&&(h.left=t(h.left+a.deltaX*a.deltaFactor,e.right-l,e.left),h.right=h.left+l),i>e.bottom-e.top&&(h.top=t(h.top+a.deltaY*a.deltaFactor,e.bottom-i,e.top),h.bottom=h.top+i),p.css({left:h.left,top:h.top,visibility:"visible"}),o||(a.preventDefault(),a.stopPropagation())}}function l(a,s,l,o){o||i(),b&&$(b).unmousewheel(e),b=a,clearTimeout(C),null==p&&t(),p.css({left:0,top:0,visibility:"hidden"}).show(),a=$(a);var n=$(window),c=a.offset(),r={left:c.left-n.scrollLeft(),top:c.top-n.scrollTop()};r.right=r.left+a.outerWidth(),r.bottom=r.top+a.outerHeight();var d={left:50,top:5,right:n.width()-50,bottom:n.height()-5},m=["right","left","top","bottom"];if("string"==typeof s){var f=m.indexOf(s);f>0&&(m[f]=m[0],m[0]=s),s=void 0}void 0!==s&&(r.left=r.right=r.left+s),void 0!==l&&(r.top=r.bottom=r.top+l),void 0===s&&void 0===l&&window.touchEvent&&window.touchEvent.touches.length&&(r.left=window.touchEvent.touches[0].pageX-n.scrollLeft()-30,r.top=window.touchEvent.touches[0].pageY-n.scrollTop()-20,r.right=r.left+60,r.bottom=r.top+40);var u=Math.max(5,20-(r.right-r.left)),v=p.outerWidth(),y=p.outerHeight();o&&(d.left+=v-40,d.right-=v-40);var w=Math.max(d.top,r.top-y),x=(r.left+r.right-v)/2;x=Math.min(x,d.right-v),x=Math.max(x,d.left);for(var k,S;0<m.length;++m)if("right"===m[0]){if(r.right+u+v<=d.right){k=r.right+u,S=w,g="right";break}}else if("left"===m[0]){if(r.left-u-v>=d.left){k=r.left-u-v,S=w,g="left";break}}else if("top"===m[0]){if(r.top-25-y>=d.top){k=x,S=r.top-25-y,g="top";break}}else if("bottom"===m[0]&&r.bottom+25+y<=d.bottom){k=x,S=r.bottom+25,g="bottom";break}void 0===k&&(d.right-r.right>r.left-d.left?(k=r.right+u,S=w,g="right"):(k=r.left-u-v,S=w,g="left")),h={left:k,top:S,right:k+v,bottom:S+y},function(a,t){if(D){$(window);p.css({left:a,top:t,visibility:"visible"})}}(k,S),y>d.bottom-d.top&&a.mousewheel(e)}function i(){f&&f.hide()}function o(){i(),b&&$(b).unmousewheel(e),b=void 0,v=void 0,h=void 0,clearTimeout(C),p&&p.hide()}function n(t,s,e,l){function i(a,t){if("number"==typeof a)return DiabloCalc.formatNumber(a,t,1e4);if(a&&a.min&&a.max){var s=DiabloCalc.formatNumber(a.min||0,t,1e4)+"&#x2013;"+DiabloCalc.formatNumber(a.max||0,t,1e4);return o&&(s="("+s+")"),s}return"0"}s instanceof Array||(tmp=s,s=[],tmp.min&&tmp.max&&s.push({min:tmp.min,max:tmp.max}),tmp.min2&&tmp.max2&&s.push({min:tmp.min2,max:tmp.max2})),s.length<=1&&(t=t.replace(/%d-%d/g,"%d"));var o=t.indexOf("%d-%d")>=0;e&&(t=(t=(t=(t=t.replace(/%d-%d/g,"%d&#x2013;%d")).replace(/\+?(?:%(?:\{[0-9]+\})?(?:d|\.[0-9]f))(?:%%)?/g,e>1?'<span class="d3-color-blue"><span class="value">$&</span></span>':'<span class="value">$&</span>')).replace(/[0-9]+(?:\.[0-9]+)?(?:-[0-9]+)?%%/g,'<span class="value">$&</span>')).replace(/\n\*|\r\n/g,'<br/><span class="tooltip-icon-bullet"/>'));var n=0;if(t=t.replace(/%(?:\{([0-9]+)\})?(d|p|\.[0-9]f|%)/g,function(a,t,e){if("%"==e)return"%";var l=(t=t?parseInt(t):n++)>=s.length?0:s[t];if("d"===e)return i(l,0);if("p"===e){var o=DiabloCalc.allPassives[l];return o&&o.name||"unknown"}return i(l,e[1])}).replace(/([0-9])-([0-9])/g,"$1&#x2013;$2"),e){var c;l&&DiabloCalc.stats[l]&&DiabloCalc.stats[l].class?c=DiabloCalc.stats[l].class:l&&DiabloCalc.itemPowerClasses[l]&&(c=DiabloCalc.itemPowerClasses[l]),c&&DiabloCalc.charClass!==c?t+=' <span class="d3-color-red">'+a("({0} Only)").format(DiabloCalc.classes[c].name)+"</span>":c&&DiabloCalc.stats[l]&&(t+=" "+a("({0} Only)").format(DiabloCalc.classes[c].name)),l&&DiabloCalc.stats[l]&&DiabloCalc.stats[l].caldesanns&&(t+=' <span class="d3-color-orange">'+a("(Caldesann's Despair Rank {0})").format((s[0]/5).toFixed(0))+"</span>")}return t}function c(a,t){var s=Math.round(255*(a>.5?2-2*a:1)),e=Math.round(255*(a>.5?1:2*a));s=Math.max(0,Math.min(255,s)),e=Math.max(0,Math.min(255,e));var l='<span style="color: '+("#"+("0"+s.toString(16)).slice(-2)+("0"+e.toString(16)).slice(-2)+"00")+'"';return(l+=t?' class="'+t+'"> (':">")+parseFloat((100*a).toFixed(1))+"%"+(t?")":"")+"</span>"}function r(e,i,o){var m,b,C=!1;if("string"==typeof i){if(DiabloCalc.itemSlots[i]){m=DiabloCalc.getSlot(i);N=DiabloCalc.getOffhandTypes&&"offhand"===i?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[i].types;for(var k in N)if(!(N[k].classes&&N[k].classes.indexOf(DiabloCalc.charClass)<0)){x.custom=x.customwpn=x[DiabloCalc.itemTypes[k].slot];break}b=DiabloCalc.itemPerfection(i)}else if(DiabloCalc.itemById[i]){if(m={id:i,template:!0},i=void 0,"string"==typeof o){i=o;N=DiabloCalc.getOffhandTypes&&"offhand"===i?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[i].types;for(var k in N)if(!(N[k].classes&&N[k].classes.indexOf(DiabloCalc.charClass)<0)){x.custom=x.customwpn=x[DiabloCalc.itemTypes[k].slot];break}}else m.custom=o,x.custom=x.customwpn="square";o=void 0}}else C=!o,m=i,i=void 0,x.custom=x.customwpn="square",b=DiabloCalc.itemPerfection(m);if(m&&DiabloCalc.itemById[m.id]){var S;if(C&&DiabloCalc.tipStatList){v=m;var q=[];for(var I in DiabloCalc.itemSlots){if(DiabloCalc.itemSlots[I].item&&DiabloCalc.itemSlots[I].item.id===m.id){q=[I];break}DiabloCalc.itemSlots[I].item&&DiabloCalc.isItemAllowed(I,m.id)&&q.push(I)}q.length?(S=q[0],q.length>1&&w&&(S=q[1])):C=void 0}else C=void 0;o&&!f&&s(),o||p||t();var A=o?u:d,T=o?f:p;A.empty(),T.css("max-width",""),A.removeClass().addClass("d3-tooltip-wrapper-inner");$(".char-class").val();var F=DiabloCalc.itemById[m.id],M=DiabloCalc.qualities[F.quality].color,O=DiabloCalc.getItemAffixesById(m.id,m.ancient,!0);if(m.template){m.stats={},m.varies=[];var P=DiabloCalc.getItemAffixesById(m.id,m.ancient,"only"),B=DiabloCalc.getStatCount(m.id);B=B[0]+B[1];for(var L in P)m.stats[L]=P[L],DiabloCalc.stats[L].base||--B;for(var E=DiabloCalc.getItemPreset(m.id),G=0;G<E.length;++G){1===(ba=DiabloCalc.smartListStats(E[G],O)).length?(m.stats[ba[0]]=O[ba[0]],--B):ba.length>1&&(m.varies.push(ba),--B)}m.stats.custom&&m.custom&&(m.stats.custom=m.custom),m.random=B}if(("custom"==($a=m.id)||"customwpn"==$a)&&i){var N=DiabloCalc.getOffhandTypes&&"offhand"===i?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[i].types;for(var k in N)if(!(N[k].classes&&N[k].classes.indexOf(DiabloCalc.charClass)<0)&&("customwpn"===$a||!DiabloCalc.itemTypes[k].weapon)&&("customwpn"!==$a||DiabloCalc.itemTypes[k].weapon)){$a=DiabloCalc.itemTypes[k].generic;break}}$a=DiabloCalc.getItemIcon($a);var R=DiabloCalc.itemTypes[F.type],j=null;for(var L in m.stats)if(DiabloCalc.stats[L].elemental){j=DiabloCalc.stats[L].elemental;break}var H="";j&&"square"!=x[R.slot]?H=" effect-bg effect-bg-"+j:m.stats.basearmor&&(H=" effect-bg effect-bg-armor","default"!=x[R.slot]&&(H+=" effect-bg-armor-"+x[R.slot]));var U=$('<div class="d3-tooltip d3-tooltip-item"></div>');A.append(U);var W="d3-tooltip-item-wrapper";"primal"===m.ancient?W+=" d3-tooltip-item-wrapper-PrimalAncientLegendary":m.ancient&&(W+=" d3-tooltip-item-wrapper-AncientLegendary");var Y=$('<div class="'+W+'"></div>');U.append(Y),(U=Y).append('<div class="d3-tooltip-item-border d3-tooltip-item-border-left"></div>'),U.append('<div class="d3-tooltip-item-border d3-tooltip-item-border-right"></div>'),U.append('<div class="d3-tooltip-item-border d3-tooltip-item-border-top"></div>'),U.append('<div class="d3-tooltip-item-border d3-tooltip-item-border-bottom"></div>'),U.append('<div class="d3-tooltip-item-border d3-tooltip-item-border-top-left"></div>'),U.append('<div class="d3-tooltip-item-border d3-tooltip-item-border-top-right"></div>'),U.append('<div class="d3-tooltip-item-border d3-tooltip-item-border-bottom-left"></div>'),U.append('<div class="d3-tooltip-item-border d3-tooltip-item-border-bottom-right"></div>'),U.append('<div class="tooltip-head tooltip-head-'+M+'"><h3 class="d3-color-'+M+'">'+F.name+"</h3></div>");var V=$('<div class="tooltip-body'+H+'"></div>');U.append(V),V.append('<span class="d3-icon d3-icon-item d3-icon-item-large d3-icon-item-'+M+'"><span class="icon-item-gradient"><span class="icon-item-inner icon-item-'+x[R.slot]+(m.ancient?" ancient":"")+'" style="background-image: url('+$a+');"></span></span></span>');var X=$('<div class="d3-item-properties"></div>');V.append(X);var _=DiabloCalc.metaSlots[R.slot]||DiabloCalc.itemSlots[R.slot],z="";(F.class||R.class)&&(z='<li class="item-class-specific d3-color-white">'+DiabloCalc.classes[F.class||R.class].name+"</li>"),X.append('<ul class="item-type-right"><li class="item-slot">'+_.name+"</li>"+z+"</ul>");var J=DiabloCalc.qualities[F.quality];if(X.append('<ul class="item-type"><li class="d3-color-'+M+'">'+DiabloCalc.GenderPair("primal"===m.ancient&&J.primal||m.ancient&&J.ancient||J.prefix,R.name)+"</li></ul>"),m.stats.basearmor){var K,Q;m.stats.basearmor instanceof Array?K=m.stats.basearmor[0]:(K=m.stats.basearmor.min||0,Q=m.stats.basearmor.max||0),m.stats.armor&&(m.stats.armor instanceof Array?K+=m.stats.armor[0]:(Q=(Q||K)+(m.stats.armor.max||0),K+=m.stats.armor.min||0)),Q&&(K+="&#x2013;"+Q),X.append('<ul class="item-armor-weapon item-armor-armor"><li class="big"><p><span class="value">'+K+"</span></p></li><li>"+a("Armor")+"</li></ul>")}if(R.weapon){var Z=R.weapon;F.weapon&&(Z=$.extend({},Z,F.weapon));var aa,ta,sa,ea=Z.speed,la=Z.min,ia=Z.max;if(m.gems)for(G=0;G<m.gems.length;++G)"ruby"===m.gems[G][1]&&(la+=DiabloCalc.gemColors.ruby.weapon.amount[m.gems[G][0]],ia+=DiabloCalc.gemColors.ruby.weapon.amount[m.gems[G][0]]);for(var L in m.stats)DiabloCalc.stats[L].damage&&(m.stats[L]instanceof Array?(la+=m.stats[L][0],ia+=m.stats[L][1]):(aa=(aa||la)+(m.stats[L].max||0),la+=m.stats[L].min||0,ta=(ta||ia)+(m.stats[L].max2||0),ia+=m.stats[L].min2||0));m.stats.damage&&(m.stats.damage instanceof Array?(la*=1+.01*m.stats.damage[0],ia*=1+.01*m.stats.damage[0]):(aa=(aa||la)*(1+.01*(m.stats.damage.max||0)),la*=1+.01*(m.stats.damage.min||0),ta=(ta||ia)*(1+.01*(m.stats.damage.max2||0)),ia*=1+.01*(m.stats.damage.min2||0))),m.stats.weaponias&&(m.stats.weaponias instanceof Array?ea*=1+.01*m.stats.weaponias[0]:(sa=(sa||ea)*(1+.01*(m.stats.weaponias.max||0)),ea*=1+.01*(m.stats.weaponias.min||0)));var oa=((la+ia)*ea/2).toFixed(1),na="big";(aa||ta||sa)&&(oa+="&#x2013;"+(((aa||la)+(ta||ia))*(sa||ea)/2).toFixed(1),na="med"),la=Math.round(la),ia=Math.round(ia),ea=ea.toFixed(2),aa&&(la="("+la+"&#x2013;"+Math.round(aa)+")"),ta&&(ia="("+ia+"&#x2013;"+Math.round(ta)+")"),sa&&(ea+="&#x2013;"+sa.toFixed(2)),X.append('<ul class="item-armor-weapon item-weapon-dps"><li class="'+na+'"><span class="value">'+oa+"</span></li><li>"+a("Damage Per Second")+"</li></ul>"),X.append('<ul class="item-armor-weapon item-weapon-damage"><li><p><span class="value">'+la+'</span>&#x2013;<span class="value">'+ia+'</span> <span class="d3-color-FF888888">'+a("Damage")+'</span></p></li><li><p><span class="value">'+ea+'</span> <span class="d3-color-FF888888">'+a("Attacks per Second")+"</span></p></li></ul>")}if(m.stats.baseblock&&m.stats.blockamount){var ca,ra;m.stats.baseblock instanceof Array?ca=m.stats.baseblock[0]:(ca=m.stats.baseblock.min||0,ra=m.stats.baseblock.max||0),m.stats.block&&(m.stats.block instanceof Array?ca+=m.stats.block[0]:(ra=(ra||ca)+(m.stats.block.max||0),ca+=m.stats.block.min||0)),ca=ca.toFixed(1),ra&&(ca+="&#x2013;"+ra.toFixed(1));var pa;m.stats.blockamount instanceof Array?pa=m.stats.blockamount[0].toFixed(0)+'</span>&#x2013;<span class="value">'+m.stats.blockamount[1].toFixed(0):(pa="("+(m.stats.blockamount.min||0).toFixed(0)+"&#x2013;"+(m.stats.blockamount.max||0).toFixed(0)+")",pa+='</span>&#x2013;<span class="value">',pa+="("+(m.stats.blockamount.min2||0).toFixed(0)+"&#x2013;"+(m.stats.blockamount.max2||0).toFixed(0)+")"),X.append('<ul class="item-armor-weapon item-armor-shield"><li><p><span class="value">+'+ca+'%</span> <span class="d3-color-FF888888">'+a("Chance to Block")+'</span></p></li><li><p><span class="value">'+pa+'</span> <span class="d3-color-FF888888">'+a("Block Amount")+"</span></p></li></ul>")}X.append('<div class="item-before-effects"></div>');var da=$('<ul class="item-effects"></ul>');X.append(da);for(var ma=0;ma<2;++ma){var fa=null,ua=Object.keys(m.stats).filter(function(a){return"sockets"!==a&&!DiabloCalc.stats[a].base&&((0!=ma||!DiabloCalc.stats[a].secondary)&&!(1==ma&&!DiabloCalc.stats[a].secondary))});ua.sort(function(a,t){return DiabloCalc.stats[a].prio-DiabloCalc.stats[t].prio}),ua.forEach(function(t){fa||(fa=$('<p class="item-property-category">'+a(0==ma?"Primary":"Secondary")+"</p>"),da.append(fa));var s="default";DiabloCalc.stats[t].utility&&(s="utility"),m.enchant===t&&(s="enchant");var e="custom"==t?"orange":"blue",l=DiabloCalc.stats[t].format;"custom"==t&&F.required&&F.required.custom&&(l=F.required.custom.format);var i="";if(!m.template&&O[t]&&O[t].min&&O[t].max){var o=O[t].min,r=O[t].max;O[t].max2&&DiabloCalc.stats[t].damage&&(r=O[t].max2);for(var p=o,d=r,f=0;f<2&&(Math.floor(p-1e-6)==Math.floor(p+1e-6)||Math.floor(d-1e-6)==Math.floor(d+1e-6));)p*=10,d*=10,f+=1;i='<span class="d3-color-gray d3-tooltip-range"> ['+DiabloCalc.formatNumber(o,f,1e4)+" - "+DiabloCalc.formatNumber(r,f,1e4)+"]"+(l.match(/%(d|\.[0-9]f)%%/g)?"%":"")+"</span>"}!C&&b&&void 0!==b.stats[t]&&(i+=c(b.stats[t],"d3-perfection-value")),l=n(l,m.stats[t],"custom"==t?2:1,"custom"==t?F.required&&F.required.custom&&F.required.custom.id:t),da.append('<li class="d3-color-'+e+" d3-item-property-"+s+'"><p>'+l+i+"</p></li>")})}if(m.varies||m.random){if(da.append("<br/>"),m.varies)for(G=0;G<m.varies.length;++G){var ba=m.varies[G],va=$('<li class="item-effects-choice"></li>');va.append('<span class="d3-color-blue">'+a("One of {0} Magic Properties (varies)").format('<span class="value">'+ba.length+"</span>")+"</span>");for(var ha=$("<ul></ul>"),ga=0;ga<ba.length;++ga){var Ca=n(DiabloCalc.stats[ba[ga]].format,O[ba[ga]],1,ba[ga]);ha.append('<li><span class="d3-color-blue"><p>'+Ca+"</p></span></li>")}va.append(ha),da.append(va)}m.random&&da.append('<li class="d3-color-blue"><span class="value">+'+m.random+"</span> "+a("Random Magic Properties")+"</li>")}if(m.transmog&&DiabloCalc.itemById[m.transmog]&&"rare"!==DiabloCalc.itemById[m.transmog].quality){da.append('<p class="item-property-category d3-color-blue">'+a("Transmogrification")+":</p>");Da=DiabloCalc.itemById[m.transmog];da.append('<li class="value d3-color-'+("set"===Da.quality?"green":"orange")+'">'+Da.name+"</li>")}else if(m.transmog&&DiabloCalc.webglItems[m.transmog]){da.append('<p class="item-property-category d3-color-blue">'+a("Transmogrification")+":</p>");var Da=DiabloCalc.webglItems[m.transmog];da.append('<li class="value d3-color-'+(Da.promo?"orange":"white")+'">'+(Da.name||m.transmog)+"</li>")}if(m.dye&&DiabloCalc.webglDyes&&DiabloCalc.webglDyes[m.dye]&&da.append('<p class="item-property-category">'+DiabloCalc.webglDyes[m.dye].name+"</p>"),m.stats.sockets){var ya=_.socketType;"weapon"!=ya&&"head"!=ya&&(ya="other");for(var wa=m.stats.sockets.max||m.stats.sockets[0],xa=0;xa<wa;++xa)if(m.gems&&xa<m.gems.length){var ka=m.gems[xa];if(DiabloCalc.legendaryGems[ka[0]]&&DiabloCalc.legendaryGems[ka[0]].effects){for(var Sa=DiabloCalc.legendaryGems[ka[0]],$a=DiabloCalc.getItemIcon(ka[0],"small"),qa=Sa.effects[0].value.slice(),G=0;G<qa.length;++G)qa[G]+=ka[1]*Sa.effects[0].delta[G];var Ia=n(Sa.effects[0].format||DiabloCalc.stats[Sa.effects[0].stat].format,qa,2,Sa.effects[0].stat),Aa=n(Sa.effects[1].format||DiabloCalc.stats[Sa.effects[1].stat].format,Sa.effects[1].value||[],ka[1]<25?1:2,Sa.effects[1].stat);ka[1]<25&&(Aa+=' <span class="d3-color-red">'+a("(Requires Rank {0})").format(25)+"</span>");var Ta=$('<li class="full-socket"></li>');Ta.append('<img class="gem" src="'+$a+'" />'),Ta.append('<span class="d3-color-orange">'+Sa.name+"</span>"),ka[1]&&Ta.append(' <span class="item-jewel-rank">&#x2013; '+a("Rank {0}").format(ka[1])+"</span>");(Ma=$("<ul></ul>")).append('<li class="jewel-effect d3-color-orange"><p>'+Ia+"</p></li>"),Ma.append('<li class="jewel-effect d3-color-'+(ka[1]<25?"gray":"orange")+'"><p>'+Aa+"</p></li>"),da.append(Ta.append(Ma))}else if(DiabloCalc.gemColors[ka[1]]){var Sa=DiabloCalc.gemColors[ka[1]],$a=DiabloCalc.getItemIcon(ka,"small"),Fa=n(DiabloCalc.stats[Sa[ya].stat].format,[Sa[ya].amount[ka[0]]],Sa[ya].stat);da.append('<li class="d3-color-white full-socket"><img class="gem" src="'+$a+'" /><span class="socket-effect">'+Fa+"</span></li>")}}else da.append('<li class="empty-socket d3-color-blue">'+a("Empty Socket")+"</li>")}if(F.set){var Ma=$('<ul class="item-itemset"></ul>');X.append(Ma);for(var Oa=DiabloCalc.itemSets[F.set],Pa={},Ba=[],La=0,G=0;G<Oa.items.length;++G)Pa[Oa.items[G].id]=G,Ba.push("gray");for(var Ea in DiabloCalc.itemSlots){var Ga=DiabloCalc.getSlotId(Ea);Ga&&void 0!==Pa[Ga]&&(Ba[Pa[Ga]]="white",La++)}La>1&&!!DiabloCalc.getStats().leg_ringofroyalgrandeur&&La++,Ma.append('<li class="item-itemset-name"><span class="d3-color-green">'+Oa.name+"</span></li>");for(G=0;G<Oa.items.length;++G){var k=DiabloCalc.itemTypes[Oa.items[G].type],i=DiabloCalc.itemSlots[k.slot]||DiabloCalc.metaSlots[k.slot];Ma.append('<li class="item-itemset-piece indent"><span class="d3-color-'+Ba[G]+'">'+Oa.items[G].name+" ("+i.name+")</span></li>")}for(var Na in Oa.bonuses){var Ra=parseInt(Na)<=La?"green":"gray";Ma.append('<li class="d3-color-'+Ra+' item-itemset-bonus-amount">'+a("({0}) Set:").format('<span class="value">'+Na+"</span>")+"</li>");for(G=0;G<Oa.bonuses[Na].length;++G){var ja=Oa.bonuses[Na][G],Fa=n(ja.stat?DiabloCalc.stats[ja.stat].format:ja.format,ja.value||[],1,ja.stat);Ma.append('<li class="d3-color-'+Ra+' item-itemset-bonus-desc indent">'+Fa+"</li>")}}}var Ha='<span class="item-unique-equipped">'+a("Unique Equipped")+"</span>";if(b&&void 0!==b.total&&(Ha='<span class="item-unique-equipped">'+a("Perfection: ")+c(b.total),C||o||(y||(Ha+=' <span class="d3-perfection-tip">'+a("(hold shift for details)")+"</span>"),Ha+='</span><span class="d3-perfection-section item-unique-equipped">',Ha+=a(b.dpsDelta?"Damage: {0} (max {1})":"Damage: {0}").format(c(b.dps),'<span class="d3-color-white">+'+DiabloCalc.formatNumber(b.dpsDelta,0,1e4)+"</span>"),Ha+='</span><span class="d3-perfection-section item-unique-equipped">',Ha+=a(b.toughnessDelta?"Toughness: {0} (max {1})":"Toughness: {0}").format(c(b.toughness),'<span class="d3-color-white">+'+DiabloCalc.formatNumber(b.toughnessDelta,0,1e4)+"</span>"),Ha+="</span>")),X.append('<ul class="item-extras"><li class="item-reqlevel"><span class="d3-color-gold">'+a("Required Level: ")+'</span><span class="value">70</span></li><li>'+a("Account Bound")+"</li></ul>"+Ha+'<span class="clear">\x3c!--   --\x3e</span>'),C&&S){var Ua=DiabloCalc.getStats();y&&DiabloCalc.itemSlots[S].item&&DiabloCalc.itemSlots[S].item.gems&&(Ua=DiabloCalc.computeStats(function(a){if(a===S){var t=$.extend({},DiabloCalc.itemSlots[S].item);return t.gems=[],t}return DiabloCalc.getSlot(a)}));var Wa=DiabloCalc.computeStats(function(a){if(a===S){if(y){var t=$.extend({},m);return t.gems=[],t}return m}return DiabloCalc.getSlot(a)}),Ya=[];for(var Va in DiabloCalc.tipStatList)if(DiabloCalc.tipStatList[Va].stat){var qa=Ua.getValue(DiabloCalc.tipStatList[Va].stat),Xa=Wa.getValue(DiabloCalc.tipStatList[Va].stat),_a=Xa-qa,za=qa<.01?1e5:100*_a/qa;Ya.push([za,'<li><span class="tooltip-icon-bullet"></span> <span class="d3-color-white">'+(DiabloCalc.tipStatList[Va].shortName||DiabloCalc.tipStatList[Va].name)+'</span>: <span class="d3-color-'+(0===_a?"gray":_a>0?"green":"red")+'">'+(qa>.01?DiabloCalc.formatNumber(za,2)+"%":"+&#8734;")+"</span></li>"])}Ya.sort(function(a,t){return t[0]-a[0]+.001*a[1].localeCompare(t[1])});for(var Ja='<div class="tooltip-extension"><ul class="item-type"><li><span class="d3-color-gold">'+a("Stat Changes if Equipped:")+"</span></li>",G=0;G<Ya.length;++G)Ja+=Ya[G][1];U.append(Ja+"</ul></div>")}F.flavor&&!C&&U.append('<div class="tooltip-extension"><div class="flavor">'+F.flavor+"</div></div>"),o?function(){null==f&&s(),f.css({left:0,top:0,visibility:"hidden"}).show();var a,t,e=$(window),l={left:50,top:5,right:e.width()-50,bottom:e.height()-5},i=f.outerWidth(),o=f.outerHeight(),n=Math.max(Math.min(h.top,l.bottom-o),l.top),c=l.right-h.right>h.left-l.left?h.right+2:h.left-i-2;"right"===g?(a=h.right+2,t=n):"left"===g?(a=h.left-i-2,t=n):"top"===g?(a=c,t=Math.max(h.bottom-o,l.top)):(a=c,t=vertY),D&&f.css({left:a,top:t,visibility:"visible"})}():(l(e,void 0,void 0,C),C&&r(e,S,!0))}}var p,d,m,f,u,b,v,h,g,C,D=!0,y=!1,w=!1,x={head:"default",shoulders:"default",neck:"square",torso:"big",waist:"square",hands:"default",wrists:"default",legs:"default",feet:"default",finger:"square",onehand:"default",twohand:"default",offhand:"default",follower:"square",custom:"square",customwpn:"square"};$(document).keydown(function(a){if(17==a.which&&p&&p.addClass("d3-tooltip-showrange"),16==a.which&&p&&p.addClass("d3-tooltip-perfection"),(16===a.which||18===a.which)&&(16===a.which&&(y=!0),18===a.which&&(w=!0),b&&v))return r(b,v),!1}).keyup(function(a){if(17==a.which&&p&&p.removeClass("d3-tooltip-showrange"),16==a.which&&p&&p.removeClass("d3-tooltip-perfection"),(16===a.which||18===a.which)&&(16===a.which&&(y=!1),18===a.which&&(w=!1),b&&v))return r(b,v),!1}),this.show=l,this.hide=o,this.showItem=r,this.showHtml=function(a,s,e,i){null==p&&t(),p.css("max-width","none"),d.removeClass().addClass("tooltip-content"),d.html(s),l(a,e,i)},this.showSkill=function(a,s,e,i,o){null==p&&t(),p.css("max-width",""),d.removeClass().addClass("d3-tooltip-wrapper-inner");var n,c=DiabloCalc.skilltips[s][e];if(c){i&&"x"!=i||(o=!1);var r=c.elements?c.elements[i||"x"]:"phy";if(n='<div class="d3-tooltip d3-tooltip-'+(o?"rune":"skill")+'">',n+='<div class="tooltip-skill-effect effect-'+r+'"><div class="tooltip-head"><h3>',o){n+=DiabloCalc.skills[s][e].runes[i]+"</h3></div></div>",n+='<div class="tooltip-body"><span class="d3-icon d3-icon-rune d3-icon-rune-medium"><span class="rune-'+i+'"></span></span>',n+='<div class="description">';var m=c[i],f=m.indexOf('<p class="subtle">');f>=0&&(m=m.slice(0,f)+'<p class="special">'+DiabloCalc.skills[s][e].name+"</p>"+m.slice(f)),n+=m,n+='</div><span class="clear">\x3c!--   --\x3e</span></div>'}else n+=DiabloCalc.skills[s][e].name+"</h3></div></div>",n+=c.x,i&&"x"!=i&&(n+='<div class="tooltip-extension rune-extension"><span class="d3-icon d3-icon-rune d3-icon-rune-large"><span class="rune-'+i+'"></span></span>',n+='<h3 class="header-3">'+DiabloCalc.skills[s][e].runes[i]+"</h3>",n+=c[i],n+="</div>");n+="</div>"}else DiabloCalc.passives[s][e]?(n='<div class="d3-tooltip d3-tooltip-trait"><div class="tooltip-head"><h3>'+DiabloCalc.passives[s][e].name+"</h3></div>",n+=DiabloCalc.passivetips[s][e],n+="</div>"):DiabloCalc.extraskills&&DiabloCalc.extraskills[s][e]&&(n='<div class="d3-tooltip d3-tooltip-skill">',n+='<div class="tooltip-head"><h3>'+(c=DiabloCalc.extraskills[s][e]).name+"</h3></div>"+c.tip+"</div>");d.html(n),l(a)},this.showCustomSkill=function(s,e){null==p&&t(),p.css("max-width",""),d.removeClass().addClass("d3-tooltip-wrapper-inner");var i='<div class="d3-tooltip d3-tooltip-skill">';if(i+='<div class="tooltip-head"><h3>'+e.name+"</h3></div>",i+='<div class="tooltip-body">',i+='<span class="d3-icon d3-icon-skill d3-icon-skill-64 miscbuffs-icon" style="background-position: -'+64*e.icon+'px 0; width: 64px; height: 64px"><span class="frame"></span></span>',i+='<div class="description">',e.desc instanceof Array)for(var o=0;o<e.desc.length;++o)i+="<p>"+e.desc[o].replace(/\+?[0-9]+(?:\.[0-9]+)?%?/g,'<span class="d3-color-green">$&</span>')+"</p>";else i+="<p>"+e.desc+"</p>";e.level&&(i+='<p class="subtle">'+a("Unlocked at level {0}.").format("<em>"+e.level+"</em>")+"</p>"),i+="</div></div></div>",d.html(i),l(s)},this.showGem=function(s,e,i,o){function c(a,t){var s=n(DiabloCalc.stats[a.stat].format,[a.amount[e[0]]]);return t||(s='<span class="d3-color-gray">'+s+"</span>"),s}var r=e instanceof Array?void 0:DiabloCalc.legendaryGems[e],m=e instanceof Array?DiabloCalc.gemColors[e[1]]:void 0;if(r||m){i=i||0,null==p&&t(),d.empty(),p.css("max-width",""),d.removeClass().addClass("d3-tooltip-wrapper-inner"),$(".char-class").val();var f=DiabloCalc.getItemIcon(e),u=$('<div class="d3-tooltip d3-tooltip-item"></div>');d.append(u);var b=r?"orange":"blue";u.append('<div class="tooltip-head tooltip-head-'+b+'"><h3 class="d3-color-'+b+'">'+(r?r.name:m.names[e[0]])+"</h3></div>");var v=$('<div class="tooltip-body"></div>');u.append(v),v.append('<span class="d3-icon d3-icon-item d3-icon-item-large d3-icon-item-'+b+'"><span class="icon-item-gradient"><span class="icon-item-inner icon-item-square" style="background-image: url('+f+');"></span></span></span>');var h=$('<div class="d3-item-properties"></div>');v.append(h),r?(i&&h.append('<ul class="item-type-right"><li class="item-jewel-rank">'+a("Rank {0}").format(i)+"</li></ul>"),h.append('<ul class="item-type"><li><span class="d3-color-orange">'+DiabloCalc.GenderPair(DiabloCalc.qualities.legendary.prefix,a("Gem"))+"</span></li></ul>"),h.append('<div class="item-description d3-color-white"><p></p></div>')):h.append('<ul class="item-type"><li><span class="d3-color-default">'+DiabloCalc.GenderString(a("Gem"))+"</span></li></ul>"),h.append('<div class="item-before-effects"></div>');var g=$('<ul class="item-effects"></ul>');if(h.append(g),r){for(var C=r.effects[0].value.slice(),D=0;D<C.length;++D)C[D]+=i*r.effects[0].delta[D];var y=n(r.effects[0].format||DiabloCalc.stats[r.effects[0].stat].format,C,2,r.effects[0].stat),w=n(r.effects[1].format||DiabloCalc.stats[r.effects[1].stat].format,r.effects[1].value||[],i<25?1:2,r.effects[1].stat);i<25&&(w+=' <span class="d3-color-red">'+a("(Requires Rank {0})").format(25)+"</span>"),g.append('<li class="d3-color-orange d3-item-property-default"><p>'+y+"</p></li>"),g.append('<li class="d3-color-'+(i<25?"gray":"orange")+' d3-item-property-default"><p>'+w+"</p></li>"),h.append('<ul class="item-extras"><li>'+a("Account Bound")+'</li></ul><span class="item-unique-equipped">'+a("Unique Equipped")+'</span><span class="clear">\x3c!--   --\x3e</span>')}else g.append('<li class="d3-color-white">'+a("Can be inserted into equipment with sockets.")+"</li>"),g.append('<li class="gem-effect"><span class="d3-color-gray">'+a("Helm:")+"</span> "+c(m.head,!o||"head"===o)+"</li>"),g.append('<li class="gem-effect"><span class="d3-color-gray">'+a("Weapon:")+"</span> "+c(m.weapon,!o||"weapon"===o)+"</li>"),g.append('<li class="gem-effect"><span class="d3-color-gray">'+a("Other:")+"</span> "+c(m.other,"head"!==o&&"weapon"!==o)+"</li>"),h.append('<ul class="item-extras"><li>'+a("Account Bound")+'</li></ul><span class="clear">\x3c!--   --\x3e</span>');r&&r.flavor&&u.append('<div class="tooltip-extension"><div class="flavor">'+r.flavor+"</div></div>"),l(s)}},this.showAttack=function(a,s){null==p&&t(),p.css("max-width",""),d.removeClass().addClass("d3-tooltip-wrapper-inner");var e='<div class="d3-tooltip d3-tooltip-skill">';e+='<div class="tooltip-skill-effect effect-phy"><div class="tooltip-head"><h3>'+s.name+"</h3></div></div>",e+='<div class="tooltip-body"><span class="d3-icon d3-icon-skill d3-icon-skill-64 skill-icon-attack '+s.id+'">',e+='<span class="frame"></span></span> <div class="description"><p>'+s.tip+"</p></div></div></div>",d.html(e),l(a)},this.showExtraItem=function(s,e){null==p&&t();var i=DiabloCalc.webglItems[e];if(i||(i=DiabloCalc.webglDyes[e]),i){p.css("max-width",""),d.removeClass().addClass("d3-tooltip-wrapper-inner");var o='<div class="d3-tooltip d3-tooltip-item"><div class="d3-tooltip-item-wrapper">';o+='<div class="tooltip-head tooltip-head-white"><h3 class="d3-color-white">'+(i.name||"Unknown item")+"</h3></div>";var n="square";if(i.type&&DiabloCalc.itemTypes[i.type]&&(n=x[DiabloCalc.itemTypes[i.type].slot]||"square"),o+='<div class="tooltip-body">',o+='<span class="d3-icon d3-icon-item d3-icon-item-large d3-icon-item-white">',o+='<span class="icon-item-gradient">',o+='<span class="icon-item-inner icon-item-'+n+'" style="background-image: url('+DiabloCalc.getItemIcon(e)+');"></span>',o+="</span>",o+="</span>",o+='<div class="d3-item-properties">',DiabloCalc.webglDyes[e])o+='<ul class="item-type"><li><span class="d3-color-default">'+a("Dye")+"</span></li></ul>",o+='<div class="item-description d3-color-white"><p>'+a("Changes the color of a single piece of armor. ")+"</p></div>",o+='<div class="item-before-effects"></div>';else if(i.type&&DiabloCalc.itemTypes[i.type]){var c=DiabloCalc.itemTypes[i.type],r=DiabloCalc.itemSlots[c.slot]||DiabloCalc.metaSlots[c.slot],m="";(i.class||c.class)&&(m='<li class="item-class-specific d3-color-white">'+DiabloCalc.classes[i.class||c.class].name+"</li>"),o+='<ul class="item-type-right"><li class="item-slot">'+r.name+"</li>"+m+"</ul>",o+='<ul class="item-type"><li class="d3-color-white">'+c.name+"</li></ul>"}o+='<span class="clear">\x3c!-- --\x3e</span>',o+="</div>",o+="</div>",i.flavor&&(o+='<div class="tooltip-extension"><div class="flavor">'+i.flavor+"</div></div>"),o+="</div></div>",d.html(o),l(s)}},this.getNode=function(){return b},this.enable=function(){D=!0},this.disable=function(){D=!1,o()}}}();!function(){function addStat(t,s,i,e,a){if(i){if(i.source)return addStat(t,s,i.value,e,i.source);var n=statInfo[s];if(e||(e=1),n&&n.special&&t.special&&a){if(t.special[s]||(t.special[s]={}),t.special[s][a]||(t.special[s][a]=[]),i instanceof Array)t.special[s][a].push({percent:i[0]*e}),i=i[0];else if("number"==typeof i)t.special[s][a].push({percent:i*e});else{if(i.list){for(f=0;f<i.list.length;++f)addStat(t,s,i.list[f],e,a);return}var h=$.extend({},i);h.percent*=e,t.special[s][a].push(h),i=void 0===i.elems&&void 0===i.pet&&void 0===i.skills?i.percent:void 0}i&&(n.mult?t[s]=(t[s]||1)*(1+.01*i*e):t[s]=(t[s]||0)+i*e)}else{if(a&&t.sources){var r=("number"==typeof i?i:i[0])*e;r&&(t.sources[s]||(t.sources[s]={}),t.sources[s][a]=(t.sources[s][a]||0)+r)}if(n&&0==n.args)t[s]=1;else if(n&&1!=n.args)if(-1==n.args)t[s]=i.length>0?i[0]:"";else{void 0===t[s]&&(t[s]={});var o=n.argnames||["min","max"];if(n&&n.dr){t[s][o[0]]=100-.01*(100-(t[s][o[0]]||0))*Math.max(0,100-(void 0!==i[0]?i[0]:i[o[0]])*e);for(f=1;f<n.args;++f)t[s][o[f]]=Math.max(t[s][o[f]]||0,(void 0!==i[f]?i[f]:i[o[f]])*e)}else for(var f=0;f<n.args;++f)t[s][o[f]]=(!n.nostack&&t[s][o[f]]||0)+(void 0!==i[f]?i[f]:i[o[f]])*e}else"number"!=typeof i&&(i=i[0]),void 0===t[s]||n&&n.nostack?t[s]=i*e:n&&n.dr?t[s]=100-.01*(100-t[s])*Math.max(0,100-i*e):t[s]+=i*e}}}function Stats(t){switch(this.info={level:parseInt($(".char-level").val()),gems:0,ancients:0},this.charClass=t||DC.charClass,this.primary=DC.classes[this.charClass].primary,this.str=7+this.info.level,this.dex=7+this.info.level,this.int=7+this.info.level,this.vit=7+2*this.info.level,this.chc=5,this.chd=50,this.ias=0,this.gems={},this.sources={},this.special={},this.skills={},this.passives={},this[this.primary]+=2*this.info.level,this.info.mainhand={speed:1,wpnphy:{min:2,max:3}},this.info.sets={},this.info.itemregen=0,this.affixes={},this.charClass){case"wizard":this.maxap=100,this.apregen=10;break;case"demonhunter":this.maxhatred=125,this.hatredregen=5,this.maxdisc=30,this.discregen=1;break;case"witchdoctor":this.maxmana=750,this.manaregen=50;break;case"barbarian":this.maxfury=100;break;case"monk":this.maxspirit=250;break;case"crusader":this.maxwrath=100,this.wrathregen=2.5;break;case"necromancer":this.maxessence=200}}function invalidate(){statCache=null,DC.trigger("updateStats")}function computeStats(t,s){var i=new Stats;return s&&(statCache=i),i.loadItems(t),DC.addSkillBonuses&&DC.addSkillBonuses(i),i.finalize(),finCache=i,i}var DC=DiabloCalc,statInfo=$.extend({},DC.stats);Stats.prototype.addAbsolute=function(t,s){if(this[s]){var i=statInfo[t];this.sources[s],this[s];if(this.sources[s]){this.sources[t]||(this.sources[t]={});for(var e in this.sources[s])this.sources[t][e]&&i&&i.dr?this.sources[t][e]=100-.01*(100-this.sources[t][e])*(100-this.sources[s][e]):this.sources[t][e]=(this.sources[t][e]||0)+this.sources[s][e]}this[t]&&i&&i.dr?this[t]=100-.01*(100-this[t])*(100-this[s]):this[t]=(this[t]||0)+this[s]}},Stats.prototype.addPercent=function(t,s,i){var e,a;if("string"==typeof s){if(!this[s])return;e=this.sources[s],a=this[s]}else{e={},a=0;for(var n=0;n<s.length;++n)if(this[s[n]]){a+=this[s[n]];var h=this.sources[s[n]];if(h)for(var r in h)e[r]=(e[r]||0)+h[r]}if(!a)return}if(void 0===i){if(!this[t])return;i=this[t]}if(e){this.sources[t]||(this.sources[t]={});for(var r in e)if("number"==typeof i){f=.01*i*e[r];this.sources[t][r]=(this.sources[t][r]||0)+f}else for(var o in i){var f=.01*i[o]*e[r];this.sources[t][r]=(this.sources[t][r]||0)+f;break}}if("number"==typeof i)this[t]=(this[t]||0)+.01*i*a;else{this[t]||(this[t]={});for(var o in i)this[t][o]=(this[t][o]||0)+.01*i[o]*a}},Stats.prototype.add=function(t,s,i,e){addStat(this,t,s,i,e)},Stats.prototype.getValue=function(t){for(var s=this,i=t.split(".");"object"==typeof s&&i.length;)s=s[i.shift()];return s||0},Stats.prototype.execString=function(expr){var self=this;return expr=expr.replace(/[a-z_][a-z0-9_]*(?:\.[a-z_][a-z0-9_]*)*/g,function(t){var s=self.getValue(t);return"number"!=typeof s?"("+JSON.stringify(s)+")":s}),eval(expr)},Stats.prototype.getAffixSource=function(t){var s=this.affixes[t];if(s)return s.set?s.set:s.slot?DC.getSlotId(s.slot):s.kanai?DC.getSkills().kanai[s.kanai]:void 0},Stats.prototype.getSpecial=function(t,s,i,e,a){if(!this.special[t])return{};var n=[];for(var h in this.special[t])for(var r=0;r<this.special[t][h].length;++r){var o=this.special[t][h][r];if(o.percent&&!(a&&a.indexOf(h)>=0||o.elems&&o.elems.indexOf(s)<0||void 0!==o.pet&&o.pet!=(i||!1)||o.skills&&o.skills.indexOf(e)<0)){var f;f=o.name?o.name:DC.sourceNames[h]||h,n.push([f,o.percent])}}return n},Stats.prototype.getTotalSpecial=function(t,s,i,e,a){var n=statInfo[t].mult?1:0;if(!this.special[t])return n;for(var h in this.special[t])for(var r=0;r<this.special[t][h].length;++r){var o=this.special[t][h][r];a&&a.indexOf(h)>=0||(o.elems&&o.elems.indexOf(s)<0||void 0!==o.pet&&o.pet!=(i||!1)||o.skills&&o.skills.indexOf(e)<0||(statInfo[t].mult?n*=1+.01*o.percent:n+=o.percent))}return n},Stats.prototype.startLoad=function(){this.extraFx={},DiabloCalc.addExtraAffixes&&DiabloCalc.addExtraAffixes(this.extraFx),this.setSlots={}},Stats.prototype.addItem=function(t,s,i){function e(t,s){var i,e;if(t.realvalue?(i=t.realvalue.slice(),e=t.realdelta):t.value&&(i=t.value.slice(),e=t.delta),!i)return[];if(e)for(var a=0;a<e.length;++a)i[a]+=e[a]*s;return i}if(s&&DC.itemById[s.id]){var a=DC.itemById[s.id],n=DC.itemTypes[a.type];if("offhand"===t&&(this.info.ohtype=a.type),s.ancient&&++this.info.ancients,n.weapon){var h=n.weapon;a.weapon&&(h=$.extend({},h,a.weapon)),this.info[t]={speed:h.speed*(1+.01*(s.stats.weaponias||[0])[0]),ias:(s.stats.weaponias||[0])[0],wpnphy:{min:h.min,max:h.max},damage:(s.stats.damage||[0])[0],type:a.type,slot:n.slot,weaponClass:h.type}}a.set&&(this.info.sets[a.set]=(this.info.sets[a.set]||0)+1,this.setSlots[a.set]||(this.setSlots[a.set]=t));for(var r in s.stats){var o=r;"custom"==r&&(o=a.required.custom.id,statInfo[o]=a.required.custom,statInfo[o].nostack=!0,void 0===statInfo[o].args&&(statInfo[o].args=1),this.affixes[o]={slot:t,value:s.stats[r]}),statInfo[o].damage&&n.weapon?("mainhand"===t&&(this.info.mhelement=DiabloCalc.stats[r].elem),addStat(this.info[t],"wpnphy",s.stats[r])):("damage"!=o&&"weaponias"!=o||!n.weapon)&&addStat(this,o,s.stats[r],1,t),"regen"==r&&(this.info.itemregen+=s.stats[r][0])}if(s.gems){var f=1;s.stats.custom&&"leg_leoricscrown"==a.required.custom.id&&(f=1+.01*s.stats.custom[0]),"head"===t&&this.extraFx.leg_leoricscrown&&(f=1+.01*this.extraFx.leg_leoricscrown);var d=(DC.metaSlots[n.slot]||DC.itemSlots[n.slot]).socketType;"weapon"!=d&&"head"!=d&&(d="other"),this.info.gems+=s.gems.length;for(var l=0;l<s.gems.length;++l)if(DC.legendaryGems[s.gems[l][0]]){var c=DC.legendaryGems[s.gems[l][0]];if(this.gems[s.gems[l][0]]=s.gems[l][1],!i){var p=DC.isGemActive&&DC.isGemActive(s.gems[l][0]);if(p&&c.buffs){m=c.buffs(s.gems[l][1],this);for(var r in m)this.add(r,m[r],1,s.gems[l][0])}else{if(p){(u=c.effects[0].stat)||(u="gem_"+s.gems[l][0],statInfo[u]=c.effects[0]),this.add(u,e(c.effects[0],s.gems[l][1]),1,s.gems[l][0])}else if(c.inactive){var m=c.inactive(s.gems[l][1],this);for(var r in m)this.add(r,m[r],1,s.gems[l][0])}if(s.gems[l][1]>=25&&(p||"powerful"==s.gems[l][0])){var u=c.effects[1].stat;u||(u="gem_"+s.gems[l][0]+"_25",statInfo[u]=c.effects[1]),this.add(u,e(c.effects[1],s.gems[l][1]),1,s.gems[l][0])}}}}else if(DC.gemColors[s.gems[l][1]]){var g=DC.gemColors[s.gems[l][1]][d],v=[g.amount[s.gems[l][0]]];"wpnphy"==g.stat&&v.push(v[0]),statInfo[g.stat].damage&&n.weapon?addStat(this.info[t],"wpnphy",v,f):this.add(g.stat,v,f,"gems")}}}},Stats.prototype.finishLoad=function(){for(var t in this.extraFx)this.add(t,this.extraFx[t]);delete this.extraFx;for(var s in this.info.sets){var i=DC.itemSets[s],e=this.info.sets[s];e>=2&&this.leg_ringofroyalgrandeur&&(e+=1);for(var a in i.bonuses)if(e>=parseInt(a)){statInfo[r="set_"+s+"_"+a+"pc"]={args:0},this.add(r,!0);for(var n=0;n<i.bonuses[a].length;++n)i.bonuses[a][n].stat&&this.add(i.bonuses[a][n].stat,i.bonuses[a][n].value,1,s);this.affixes[r]={slot:this.setSlots[s],set:s,pieces:a,value:[]}}}delete this.setSlots;var h=DC.getParagon();if(h)for(var r in h)this.add(r,h[r],1,"paragon"),"regen"===r&&(this.info.itemregen+=h[r][0]);this.info.offhand?"fist"===this.info.offhand.weaponClass?this.info.weaponClass="dualwield"+("fist"===this.info.mainhand.weaponClass?"_ff":"_sf"):this.info.weaponClass="dualwield":this.info.weaponClass=this.info.mainhand.weaponClass},Stats.prototype.loadItems=function(t,s){t||(t=DC.getSlot),this.startLoad(),DiabloCalc.options.seasonal&&(this.info.sets.nightmares=2,this.setSlots.nightmares="leftfinger");for(var i in DC.itemSlots)this.addItem(i,t(i),s);this.finishLoad()},Stats.prototype.finalize=function(t,s){if(this.chc=Math.min(75,this.chc),this.addAbsolute("chc","extrachc"),this.chc=Math.min(100,this.chc),this.expmul&&(this.expmul*=.1),this.addAbsolute("str","caldesanns_str"),this.addAbsolute("dex","caldesanns_dex"),this.addAbsolute("int","caldesanns_int"),this.addAbsolute("vit","caldesanns_vit"),this.addPercent("str","str_percent"),this.addPercent("dex","dex_percent"),this.addPercent("int","int_percent"),!t){addStat(this,"armor",this.str,1,"str"),addStat(this,"armor",this.dex,1,"dex"),addStat(this,"resall",this.int,.1,"int"),this.armor+=this.basearmor||0,this.addPercent("armor","armor_percent"),this.passives.holdyourground&&this.dodge&&(this.sources.dodge.holdyourground=-this.dodge,this.dodge=0),addStat(this,"blockamount",[0,0]),this.addPercent("blockamount","blockamount_percent"),addStat(this,"block",this.baseblock,1,"baseblock"),this.block=Math.min(75,this.block||0),this.addAbsolute("block","extra_block"),this.addPercent("block","block_percent"),this.block=Math.min(100,this.block),this.leg_justicelantern&&this.add("dmgred",this.block*this.leg_justicelantern*.01,1,"P4_Unique_Ring_03");var i=10;70==this.info.level?i=100:this.info.level>65?i=5*this.info.level-270:this.info.level>60?i=4*this.info.level-205:this.info.level>35&&(i=this.info.level-25),this.info.hppervit=i,this.info.hp=36+4*this.info.level+this.vit*i,this.info.hp*=1+.01*(this.life||0);for(var e=["resphy","resfir","rescol","reslit","respsn","resarc"],a=0;a<e.length;++a)addStat(this,e[a],this.resall);for(a=0;a<e.length;++a)this.addPercent(e[a],["resist_percent",e[a]+"_percent"]);this.info.resavg=0,this.info.resmin=0;for(a=0;a<e.length;++a)this.info.resmin+=(this[e[a]]<0?-1:1)*Math.sqrt(Math.abs(this[e[a]])),this.info.resavg+=this[e[a]];this.info.resavg/=6,this.info.resmin=(this.info.resmin<0?-1:1)*(this.info.resmin*this.info.resmin)/36,this.info.defavg=1-.01*((this.meleedef||0)+(this.rangedef||0))*.333333;var n=.01*(this.nonphys||0);this.info.defavg*=1-.01*(this.physdef||0)*.16663,this.info.defavg*=1-.16663*(1-(1-n)*(1-.01*(this.colddef||0))),this.info.defavg*=1-.16663*n,this.info.defavg*=1-.16663*n,this.info.defavg*=1-.16663*n,this.info.defavg*=1-.16663*(1-(1-n)*(1+.01*(this.firetaken||0))),this.info.defavg*=1-.01*(this.dmgred||0),this.info.armor_factor=1/(1+this.armor/(50*this.info.level)),this.info.res_factor=1/(1+this.info.resavg/(5*this.info.level)),this.info.resmin_factor=1/(1+this.info.resmin/(5*this.info.level)),this.info.defense_factor=this.info.armor_factor*this.info.res_factor*(1-.01*(this.edef||0)/2)*this.info.defavg,this.info.defensemin_factor=this.info.armor_factor*this.info.resmin_factor*(1-.01*(this.edef||0)/2)*this.info.defavg,this.info.toughness=this.info.hp/this.info.defense_factor/(1-.01*(this.dodge||0)),this.info.toughnessmin=this.info.hp/this.info.defensemin_factor/(1-.01*(this.dodge||0)),this.info.toughpervit=this.info.toughness/this.info.hp*100*i*(1+.01*(this.life||0)),this.info.toughperlife=.01*this.info.toughness/(1+.01*(this.life||0)),this.info.toughperarmor=100*this.info.toughness/(50*this.info.level)*this.info.armor_factor*(1+.01*(this.armor_percent||0));var h=1+.01*(this.resist_percent||0)+.01*((this.resphy_percent||0)+(this.resfir_percent||0)+(this.rescol_percent||0)+(this.reslit_percent||0)+(this.respsn_percent||0)+(this.resarc_percent||0))/6;this.info.toughperres=100*this.info.toughness/(5*this.info.level)*this.info.res_factor*h,this.info.toughper650vit=100*this.info.toughpervit*6.5/this.info.toughness,this.info.toughper15life=100*this.info.toughperlife*15/this.info.toughness,this.info.toughper775armor=100*this.info.toughperarmor*7.75/this.info.toughness,this.info.toughper130res=100*this.info.toughperres*1.3/this.info.toughness,this.info.resphy_factor=1/(1+this.resphy/(5*this.info.level)),this.info.resfir_factor=1/(1+this.resfir/(5*this.info.level)),this.info.rescol_factor=1/(1+this.rescol/(5*this.info.level)),this.info.reslit_factor=1/(1+this.reslit/(5*this.info.level)),this.info.respsn_factor=1/(1+this.respsn/(5*this.info.level)),this.info.resarc_factor=1/(1+this.resarc/(5*this.info.level))}this.addAbsolute("thorns","firethorns"),this.addPercent("thorns","vit_to_thorns",this.vit),this.addPercent("thorns","thorns_multiply"),this.addPercent("thorns","thorns_percent"),this.info.thorns=(this.thorns||0)*(1+this[this.primary]/100),this.calcWeapon=function(t){t.speed+=this.weaponaps||0,t.speed*=1+.01*(this.weaponaps_percent||0);var s=1+.01*(t.damage||0);t.wpnphy.min*=s,t.wpnphy.max*=s,this.wpnphy&&(t.wpnphy.min+=this.wpnphy.min,t.wpnphy.max+=this.wpnphy.max),t.wpnbase=$.extend({},t.wpnphy),s=(1+.01*this[this.primary])*(1+.01*(this.damage||0)),t.wpnphy.min*=s,t.wpnphy.max*=s,t.damage=.5*(t.wpnphy.min+t.wpnphy.max),t.speed*=1+.01*this.ias,t.speed=Math.min(5,t.speed),t.dps=t.damage*this.info.critfactor*t.speed,t.dph=t.damage*this.info.critfactor},this.info.offhand&&this.add("ias",15,1,"dualwield"),this.info.critfactor=1+.01*this.chc*(.01*this.chd),this.calcWeapon(this.info.mainhand),this.info.offhand?(this.calcWeapon(this.info.offhand),this.info.aps=2/(1/this.info.mainhand.speed+1/this.info.offhand.speed),this.info.dps=(this.info.mainhand.dph+this.info.offhand.dph)*this.info.aps/2):(this.info.dps=this.info.mainhand.dps,this.info.aps=this.info.mainhand.speed),this.info.maxelem="arc",this.info.elemental=this.dmgarc||0;for(var r in DC.elements){var o=this["dmg"+r]||0;o>this.info.elemental&&(this.info.maxelem=r,this.info.elemental=o)}t||(this.addAbsolute("regen","post_regen"),this.addPercent("regen","post_regen_bonus",this.info.itemregen),this.addPercent("regen","regen_bonus"),this.info.healing=(this.regen||0)+.01*(this.regen_percent||0)*this.info.hp+(this.lph||0)*this.info.aps+.16*(this.laek||0)+.08*(this.healbonus||0),this.info.recovery=this.info.healing*this.info.toughness/this.info.hp,this.info.recoverymin=this.info.healing*this.info.toughnessmin/this.info.hp),this.info.edps=this.info.dps*(1+.01*(this.edmg||0)),this.info.elementaldps=this.info.dps*(1+.01*this.info.elemental),this.info.dph=this.info.dps/this.info.aps,this.info.primary=this[this.primary];this.info.dmgmul=100*((this.dmgmul||1)-1),this.final={},this.final.addbase=1+.01*(this.damage||0)+.01*(this.dmgtaken||0),this.final.chc=this.chc+(this.chctaken||0),this.final.chc*=1+.01*(this.chctaken_percent||0);var f=(this.dmgmul||1)*this.final.addbase/(1+.01*(this.damage||0));if(f*=(1e4+this.final.chc*this.chd)/(1e4+this.chc*this.chd),this.final.dps=this.info.dps*f,this.final.dph=this.info.dph*f,this.final.elemdps=this.final.dps*(1+.01*this.info.elemental),this.final.elemdph=this.final.dph*(1+.01*this.info.elemental),this.final.elemedps=this.final.elemdps*(1+.01*(this.edmg||0)),this.final.elemedph=this.final.elemdph*(1+.01*(this.edmg||0)),!t){this.ms=Math.min(25,this.ms||0),this.addAbsolute("ms","extrams"),this.mf=Math.min(300,this.mf||0),this.info["dpsper"+this.primary]=this.info.elementaldps/(1+.01*this[this.primary]),this.info.dpsperchc=1e-4*this.info.elementaldps*this.chd/this.info.critfactor,this.info.dpsperchd=1e-4*this.info.elementaldps*this.chc/this.info.critfactor,this.info.dpsperias=.01*this.info.elementaldps/(1+.01*this.ias),this.info.dpsperelem=.01*this.info.elementaldps/(1+.01*this.info.elemental),this.info["dpsper650"+this.primary]=100*this.info["dpsper"+this.primary]*6.5/this.info.elementaldps,this.info.dpsper6chc=100*this.info.dpsperchc*6/this.info.elementaldps,this.info.dpsper50chd=100*this.info.dpsperchd*50/this.info.elementaldps,this.info.dpsper7ias=100*this.info.dpsperias*7/this.info.elementaldps,this.info.dpsper20elem=100*this.info.dpsperelem*20/this.info.elementaldps;var d=.5*(this.info.mainhand.wpnbase.min+this.info.mainhand.wpnbase.max);if(this.info.offhand){var l=this.info.mainhand.dph,c=this.info.offhand.dph,p=.5*(this.info.offhand.wpnbase.min+this.info.offhand.wpnbase.max);this.info.dpsperdmg=this.info.elementaldps*(l/d+c/p)/(l+c)}else this.info.dpsperdmg=this.info.elementaldps/d;this.info.dpsper105210dmg=100*this.info.dpsperdmg*315/2/this.info.elementaldps}switch(this.charClass){case"wizard":this.addPercent("apregen","resourcegen"),this.addAbsolute("rcr_ap","rcr");break;case"demonhunter":this.addPercent("hatredregen","resourcegen"),this.addPercent("discregen","resourcegen"),this.addAbsolute("rcr_hatred","rcr"),this.addAbsolute("rcr_disc","rcr");break;case"witchdoctor":this.addPercent("maxmana","maxmana_percent"),this.addPercent("manaregen","manaregen_percent",this.maxmana),this.addPercent("manaregen","resourcegen"),this.addAbsolute("rcr_mana","rcr");break;case"barbarian":this.addPercent("furyregen","resourcegen"),this.addPercent("lifefury","lpfs_percent"),this.addAbsolute("rcr_fury","rcr");break;case"monk":this.addPercent("spiritregen","resourcegen"),this.addAbsolute("rcr_spirit","rcr");break;case"crusader":this.addPercent("wrathregen","resourcegen"),this.addAbsolute("rcr_wrath","rcr");break;case"necromancer":this.addPercent("maxessence","maxessence_percent"),this.addPercent("essenceregen","resourcegen"),this.addAbsolute("rcr_essence","rcr")}},Stats.prototype.clone=function(){var t=new Stats(this.charClass);for(var s in this)if(this.hasOwnProperty(s)){var i=this[s];null==i||(i instanceof Array?t[s]=$.extend(!0,[],i):i instanceof Object?t[s]=$.extend(!0,{},i):void 0!==i&&(t[s]=i))}return t},Stats.prototype.flatten=function(){delete this.sources;var t={};for(var s in this.special){var i=[];for(var e in this.special[s])i=i.concat(this.special[s][e]);t[s]=i}this.special=t};var statCache=null,finCache=null;DC.getStats=function(t){return t&&finCache?finCache:statCache||(computeStats(void 0,!0),computeStats(void 0,!0),statCache)},DC.computeStats=computeStats,DC.register("updateSlotStats",invalidate),DC.register("updateParagon",invalidate),DC.register("updateSkills",invalidate),DC.register("importEnd",invalidate),DC.register("updateSlotItem",function(){statCache=null}),DC.Stats=Stats}();!function(){function t(t){t.hover(function(){var s=t.attr("min"),e=t.attr("max");if(s&&e&&f.tooltip){for(var i=parseFloat(t.attr("step")||1)||1,a=0;a<2&&Math.floor(i-1e-6)==Math.floor(i+1e-6);)a+=1,i*=10;var o='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-green">'+f.formatNumber(parseFloat(s),a,1e3)+'</span>-<span class="d3-color-green">'+f.formatNumber(parseFloat(e),a,1e3)+"</span></p><div>";f.tooltip.showHtml(t[0],o)}},function(){f.tooltip.hide()})}function s(t,s,e,i,a){void 0!==s?(t.attr("min",s),"min"===a&&t.val(s)):t.removeAttr("min"),void 0!==e?(t.attr("max",e),a&&"min"!==a&&t.val(e)):t.removeAttr("max"),t.prop("disabled",s===e&&void 0!==s),t.attr("step",i||1)}function e(t){var s=parseFloat(t.attr("min")),e=parseFloat(t.attr("max"));return!isNaN(s)&&!isNaN(e)&&s===e}function i(t,s,e){var i=f.extendStats([],t);if(0==i.length)return i;for(var a=[],o=0;o<i.length;++o)f.stats[i[o]]&&e&&f.stats[i[o]].classes&&!(f.stats[i[o]].classes.indexOf(e)>=0)||s&&!s[i[o]]||a.push(i[o]);return 0==a.length&&a.push(i[0]),a}function a(t,s,e){if(e)for(var i in e){var a=e[i];"string"==typeof a&&(a=s[a]),$.each(f.extendStats([],i),function(s,e){t[e]=a})}return t}function o(t,s,e,i){return i?"only"===i?a(t,s,e.required):(a(t,s,e.affixes),a(t,s,e.required)):a(t,s,e.affixes)}function n(t,s,e){if(s)for(var i=0;i<s.length;++i){for(var a=s[i];f.statGroups[a];)a=f.statGroups[a][0];e[a=f.stats[a]&&f.stats[a].group||a]||(t[s[i]]=!0,e[a]=!0)}}function r(t){var s=t.type.val();return f.legendaryGems[s]?(t.level.show(),t.colorSpan.hide(),t.level):f.gemQualities[s]?(t.level.hide(),t.colorSpan.show(),t.color):(t.level.hide(),void t.colorSpan.hide())}function l(t,s){var e=f.statLimits.legendary;return t&&f.itemById[t]?("rare"===f.itemById[t].quality&&(e=f.statLimits.rare),f.qualities[f.itemById[t].quality].ancient&&s&&(e=f.statLimits.ancient)):e=f.statLimits.rare,e}function p(t){if(!t||!f.itemById[t])return[];var s=f.itemById[t].type,e=f.itemTypes[s].slot,i={},a={};return n(i,f.itemById[t].preset,a),n(i,f.itemTypes[s].preset,a),f.metaSlots[e]?n(i,f.metaSlots[e].preset,a):n(i,f.itemSlots[e].preset,a),Object.keys(i)}function h(t,s,e){if(!t||!f.itemById[t])return{};var i=f.itemById[t].type,n=f.itemTypes[i].slot,r=l(t,s),p={};if(f.metaSlots[n]?o(p,r,f.metaSlots[n],e):o(p,r,f.itemSlots[n],e),o(p,r,f.itemTypes[i],e),o(p,r,f.itemById[t],e),"primal"===s)for(var h in p)(p[h].max&&p[h].min<p[h].max||p[h].max2&&p[h].min2<p[h].max2)&&(p[h]=$.extend({},p[h]),"min"===p[h].best?(p[h].max&&(p[h].max=p[h].min),p[h].max2&&(p[h].max2=p[h].min2)):(p[h].max&&(p[h].min=p[h].max),p[h].max2&&(p[h].min2=p[h].max2)));return s&&"only"!==e&&a(p,r,{caldesanns:{step:5,min:5,max:1e3}}),p}function d(t,s,e){var i=t.data("chosen");if(i){var a=i.result_add_option;i.result_add_option=function(t){var i=s.call(e||this,t.value);return i&&((t=$.extend({},t)).search_text='<div class="icon-wrap">'+i+"</div>"+t.search_text),a.call(this,t)}}}function m(t,s,e){var i=t.data("chosen");if(i){var a=i.search_string_match;i.search_string_match=function(t,o,n){return s.call(e||this,n,function(t){return a.call(i,t,o)})}}}function c(s,e,i,a){this.box=s,this.type=e,this.required=i,this.line=$("<li></li>"),this.inner=$("<div></div>"),this.remove=$('<span class="item-info-stat-remove" title="'+v("Remove stat")+'"></span>'),this.list=$('<select class="item-info-stat-list"></select>'),this.value=$('<input class="item-info-stat-value" type="number"></input>').hide(),this.value2=$('<input class="item-info-stat-value" type="number"></input>').hide(),this.inner.append($('<span style="position: absolute"></span>').append(this.remove,'<span class="item-info-stat-enchanted" title="'+v("Enchanted")+'"></span>')),this.inner.append(this.list,this.value,this.value2),this.line.append(this.inner),s.statsDiv.append(this.line),s.stats.push(this);var o=this;this.remove.click(function(){o.onRemove()}),i&&this.remove.hide(),t(this.value),t(this.value2),this.updateList(a),this.list.chosen({disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:v("Select a Stat"),populate_func:function(){o.generateList()}}).change(function(){var t=!!o.sockets;o.onChangeStat(),o.value.is(":visible")&&o.value.focus().select(),t||o.sockets||o.box.slot&&f.itemSlots[o.box.slot].flourish?o.box.updateItem(!0):o.box.updateStats(!0)}),f.chosenTips(this.list,function(t){if(f.tooltip){var s=o.conflicts&&o.conflicts[t];if(s&&s!==t&&f.stats[s]){e='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Conflicts with:")+"</span>";e+='</br><span class="tooltip-icon-bullet"></span>'+f.stats[s].name+"</p></div>",f.tooltip.showHtml(this,e)}else if(s===t){e='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Already present on the item.")+"</span></p></div>";f.tooltip.showHtml(this,e)}else if("_resall"===s){var e='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Conflicts with preset stat:")+'</span></br><span class="tooltip-icon-bullet"></span>'+f.stats.resall.name+"</p></div>";f.tooltip.showHtml(this,e)}}}),this.value.blur(f.validateNumber),this.value2.blur(f.validateNumber),this.value.on("input",function(){var t=!!o.sockets;o.onChangeValue(),t||o.sockets?o.box.updateItem(!0):o.box.updateStats(!0)}),this.value2.on("input",function(){o.box.updateStats(!0)}),this.onChangeStat()}function u(t,s){var e=t.list.val(),i=s.list.val(),a=f.stats[e]?"sockets"===e?4:f.stats[e].secondary?2:0:"secondary"===t.type?3:"socket"===t.type?5:1,o=f.stats[i]?"sockets"===i?4:f.stats[i].secondary?2:0:"secondary"===s.type?3:"socket"===s.type?5:1;return a!=o?a-o:f.stats[e]&&f.stats[i]?f.stats[e].prio-f.stats[i].prio:0}var v=DiabloCalc.locale("ui-equipment.js"),f=DiabloCalc;f.getStatCount=function(t){var s=f.itemById[t],e=4,i=2;return void 0!==s.primary?e=s.primary:["quiver","source","mojo","phylactery"].indexOf(s.type)>=0&&(e=5),void 0!==s.secondary&&(i=s.secondary),[e,i]},f.smartListStats=i,f.getItemPreset=p,f.getItemAffixesById=function(t,s,e){function i(s,e){return f.stats[t]&&f.stats[t].dr?100-(100-s)*(100-e)/100:s+e}if(!e||"only"===e)return h(t,s,e);var a=h(t,s,!1),o=h(t,s,"only"),n={};for(var t in o)t in a&&o[t].noblock?(n[t]=$.extend({},o[t]),a[t].max&&(n[t].max=i(n[t].max,a[t].max)),a[t].max2&&(n[t].max2=i(n[t].max2,a[t].max2))):n[t]=o[t];for(var t in a)t in o||(n[t]=a[t]);return n},f.makeItem=function(t,s,e){function a(t,s){if(!s[t])return[0];var e=[];return s[t].max&&e.push(s[t].max),s[t].max2&&e.push(s[t].max2),s[t].args<0&&e.push("powerhungry"),e}var o={id:t,stats:{},ancient:e||!1},n=p(t),r=f.getItemAffixesById(t,o.ancient,!1),l=f.getItemAffixesById(t,o.ancient,"only");for(var h in l)o.stats[h]="custom"===h&&s||a(h,l);for(var d=0;d<n.length;++d){var m=i(n[d],r,f.charClass);m.length&&!o.stats[m[0]]&&(o.stats[m[0]]=a(m[0],r))}return o.stats.sockets&&(o.gems=[]),o},f.getOffhandTypes=function(t){var s=!f.classes[f.charClass].dualwield,e=!1;if("crusader"!==f.charClass&&(t||f.itemSlots.mainhand.item&&f.itemById[f.itemSlots.mainhand.item.id])){var i=t||f.itemById[f.itemSlots.mainhand.item.id].type;f.itemTypes[i]&&"twohand"==f.itemTypes[i].slot&&(e=!0)}var a=f.itemSlots.offhand.types,o={},n=!1;for(var r in a){var l=a[r];e&&"quiver"!==r||(s&&"onehand"===l.slot&&"handcrossbow"!==r||(o[r]=l,l.classes&&l.classes.indexOf(f.charClass)<0||"customwpn"!==r&&l.weapon&&(n=!0)))}return n||delete o.customwpn,o},f.isItemAllowed=function(t,s,e){if(!s||!f.itemById[s]||f.itemSlots[t].drop.inactive)return!1;var i=f.itemById[s],a=i.type;f.itemTypes[a].slot;if(i.classes&&i.classes.indexOf(f.charClass)<0)return!1;var o=f.itemSlots[t].types;return"offhand"===t&&(o=f.getOffhandTypes(e)),!(!o[a]||o[a].classes&&o[a].classes.indexOf(f.charClass)<0)},f.trimStats=function(t){var s=f.getItemAffixesById(t.id,t.ancient,!0);for(var e in t.stats)if(s[e]){var i=t.stats[e];i.length>=1&&(s[e].min&&(i[0]=Math.max(i[0],s[e].min)),s[e].max&&(i[0]=Math.min(i[0],s[e].max))),i.length>=2&&(s[e].min2&&(i[1]=Math.max(i[1],s[e].min2)),s[e].max2&&(i[1]=Math.min(i[1],s[e].max2))),t.stats[e]=i}else delete t.stats[e]},f.trimItem=function(t,s,e){if(s&&f.itemById[s.id]&&!f.itemSlots[t].drop.inactive){var i=f.itemById[s.id].type,a=f.itemTypes[i].generic;if(f.isItemAllowed(t,a,e)){var o={id:a,stats:$.extend(!0,{},s.stats)};if(f.trimStats(o),s.gems&&o.stats.sockets){o.gems=[];for(var n=0;n<s.gems.length&&n<o.stats.sockets[0];++n)o.gems.push(s.gems[n])}return o}}},DiabloCalc.chosen_addIcons=d,DiabloCalc.chosen_fixSearch=m,c.prototype.enable=function(t){this.list.prop("disabled",!t||!!this.required),this.list.trigger("chosen:updated"),this.value.prop("disabled",!!e(this.value)||!t),this.value2.prop("disabled",!!e(this.value2)||!t)},c.prototype.updateList=function(t){if(this.required){this.list.prop("disabled",!0),this.list.empty();var s='<option value="'+this.required+'">';if("custom"==this.required){var e=this.box.getItemAffixes(!0);e.custom&&(s+=e.custom.name)}else s+=f.stats[this.required].name;this.list.append(s+"</option>")}else{this.list.prop("disabled",!1);var i=t||this.list.val();f.noChosen?this.fillList(t):(this.list.empty(),this.list.append("<option></option>"),f.stats[i]&&this.list.append('<option value="'+i+'" selected="selected">'+f.stats[i].name+"</option>"))}},c.prototype.fillList=function(t){var s=this.box.getItemAffixes(),e=t||this.list.val(),i=f.options.limitStats?this.box.charClass:null;if(!i){(l=this.box.getId())&&!(i=f.itemTypes[f.itemById[l].type].class)&&f.itemById[l].set&&(i=f.itemSets[f.itemById[l].set].class)}if(this.list.empty(),this.list.append('<option value="">'+(f.noChosen?v("Select a Stat"):"")+"</option>"),"socket"!==this.type)if("caldesanns"!==this.type){for(var a in f.statList)if(!("primary"===this.type&&"primary"!==a||"secondary"===this.type&&"secondary"!==a))for(var o in f.statList[a]){var n=o;"secondary"===a&&"secondary"!==this.type&&(n+=v(" (Secondary)"));f.statList[a][o];var r="";$.each(f.extendStats([],f.statList[a][o]),function(a,o){i&&f.stats[o].classes&&f.stats[o].classes.indexOf(i)<0&&o!==t||s.hasOwnProperty(o)&&(r+='<option value="'+o+(o==e?'" selected="selected':"")+'">'+f.stats[o].name+"</option>")}),r&&this.list.append('<optgroup label="'+n+'">'+r+"</optgroup>")}}else for(var l in f.stats)f.stats[l].caldesanns&&s.hasOwnProperty(l)&&this.list.append('<option value="'+l+'"'+(e===l?' selected="selected"':"")+">"+f.stats[l].name+"</option>");else s.sockets&&this.list.append('<option value="sockets"'+("sockets"===e?' selected="selected"':"")+">"+f.stats.sockets.name+"</option>")},c.prototype.generateList=function(){var t=this.box.getId();if(t&&!this.required){for(var s=this.box.getItemAffixes(!0),e={},i=0;i<this.box.stats.length;++i){o=this.box.stats[i].list.val();f.stats[o]&&(s[o]&&s[o].noblock||(e[f.stats[o].group||o]=o))}if(p(t).indexOf("resall")>=0)for(var a=f.extendStats([],"resist"),i=0;i<a.length;++i)e[a[i]]||(e[a[i]]="_resall");var o=this.list.val();this.fillList(o),f.stats[o]&&(o=f.stats[o].group||o),this.conflicts={};var n=this;this.list.find("option").each(function(){var t=$(this).val();if(f.stats[t]){var s=t;t=f.stats[t].group||t,"_resall"===e[s]?($(this).prop("disabled",!0),n.conflicts[s]="_resall"):t==o||!e[t]&&!e[s]?$(this).removeAttr("disabled"):($(this).prop("disabled",!0),n.conflicts[s]=e[t]||e[s])}})}},c.prototype.onRemove=function(){if(!this.required){var t=this.line.index();this.box.removeStat(t,this.merged)}},c.prototype.generatePassives=function(t,s){var e;t&&(e=this.passiveBox.val()),this.passiveBox.empty();var i=f.options.limitStats?this.box.charClass:null;if(i){r=f.passives[i];for(var a in r)this.passiveBox.append('<option value="'+a+(a===e?'" selected="selected':"")+'">'+r[a].name+"</option>"),a===e&&(e=void 0)}else for(var o in f.classes)if(f.passives[o]){var n='<optgroup label="'+f.classes[o].name+'">',r=f.passives[o];for(var a in r)n+='<option value="'+a+(a===e?'" selected="selected':"")+'">'+r[a].name+"</option>",a===e&&(e=void 0);this.passiveBox.append(n+"</optgroup>")}s&&e&&f.allPassives[e]&&this.passiveBox.append('<option value="'+e+'" selected="selected">'+f.allPassives[e].name+"</option>")},c.prototype.onChangeValue=function(){if("sockets"==this.list.val()){this.socketList||(this.socketList=$('<ul class="item-info-gemlist"></ul>'),this.sockets=[],this.line.append(this.socketList));var t=parseInt(this.value.val());for(t=Math.max(t,1),t=Math.min(t,3);this.sockets.length>t;)this.sockets.pop().line.remove();for(;this.sockets.length<t;)!function(t,s){var e={line:$("<li></li>"),type:$('<select class="item-info-gem-type"></select>'),colorSpan:$("<span></span>"),color:$('<select class="item-info-gem-color"></select>'),level:$('<input class="item-info-gem-level" type="number" min="0" max="200"></input>')};e.type.append('<option value="">'+(f.noChosen?v("Empty Socket"):"")+"</option>");var i=s.box.type.val();i=f.itemTypes[i]?f.itemTypes[i].slot:null;var a=0;for(var o in f.legendaryGems)f.legendaryGems[o].types&&f.legendaryGems[o].types.indexOf(i)>=0&&++a;if(a){var n='<optgroup label="'+v("Legendary Gems")+'">';for(var o in f.legendaryGems)f.legendaryGems[o].types&&f.legendaryGems[o].types.indexOf(i)>=0&&(n+='<option class="quality-legendary" value="'+o+'">'+f.legendaryGems[o].name+"</option>");n+='</optgroup><optgroup label="'+v("Normal Gems")+'">';for(l=f.gemQualities.length-1;l>=0;--l)n+='<option value="'+l+'">'+f.gemQualities[l]+"</option>";e.type.append(n+"</optgroup>")}else for(var l=f.gemQualities.length-1;l>=0;--l)e.type.append('<option value="'+l+'">'+f.gemQualities[l]+"</option>");for(var o in f.gemColors)e.color.append('<option value="'+o+'">'+f.gemColors[o].name+"</option>");e.line.append(e.type).append(e.colorSpan.append(e.color)).append(e.level),s.socketList.append(e.line),e.type.chosen({disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,allow_single_deselect:!0,placeholder_text_single:v("Empty Socket")}).change(function(){var t=r(e);t===e.level?t.focus().select():t==e.color&&setTimeout(function(){t.trigger("chosen:open")},0)}).change(function(){s.box.updateItem(!0)}),f.chosenTips(e.type,function(t){f.tooltip&&f.legendaryGems[t]&&f.tooltip.showGem(this,t)}),d(e.type,function(t){if(isNaN(t)){var s=f.legendaryGems[t];if(s&&s.id in f.itemIcons)return'<span style="background: url(css/items/gemleg.png) 0 -'+24*f.itemIcons[s.id][0]+'px no-repeat"></span>'}else if((t=parseInt(t))>=0&&t<f.gemQualities.length)return'<span style="background: url(css/items/gems.png) -'+24*t+'px -120px no-repeat"></span>'}),e.color.chosen({disable_search:!0,inherit_select_classes:!0}).change(function(){if(0===t){for(var e=!0,i=1;i<s.sockets.length;++i)s.sockets[i].type.val()&&(e=!1);if(e)for(var a=s.sockets[0].type.val(),o=$(this).val(),i=1;i<s.sockets.length;++i)s.sockets[i].type.val(a),s.sockets[i].type.trigger("chosen:updated"),r(s.sockets[i]),s.sockets[i].color.val(o),s.sockets[i].color.trigger("chosen:updated")}s.box.updateItem(!0)}),f.chosenTips(e.color,function(t){if(f.tooltip&&f.gemColors[t]){var s=i&&(f.itemSlots[i]||f.metaSlots[i])||{};f.tooltip.showGem(this,[parseInt(e.type.val()),t],void 0,s.socketType||"other")}}),d(e.color,function(t){var s=f.gemColors[t];if(s&&s.id in f.itemIcons){return'<span style="background: url(css/items/gems.png) -'+24*parseInt(e.type.val())+"px -"+24*f.itemIcons[s.id][0]+'px no-repeat"></span>'}}),r(e),e.level.blur(f.validateNumber).blur().on("input",function(){s.box.updateStats(!0)}),s.sockets.push(e)}(this.sockets.length,this)}else this.socketList&&(this.socketList.remove(),delete this.socketList,delete this.sockets);this.box.updateEnchant()},c.prototype.updateLimits=function(t){var e=this.list.val(),i=this,a=this.box.getItemAffixes(!!this.required),o=a[e];if("string"==typeof o){o=(r=this.box.getLimits())[o]}if(this.merged){var n=this.box.getItemAffixes("only")[e];if("string"==typeof n){var r=this.box.getLimits();n=r[n]}o=$.extend({},o),f.stats[e]&&f.stats[e].dr?(o.min=100-.01*(100-(o.min||0))*(100-(n.min||0)),o.max=100-.01*(100-(o.max||0))*(100-(n.max||0)),o.step="any"):(o.min=(o.min||0)+(n.min||0),o.max=(o.max||0)+(n.max||0))}var l=0;"custom"===this.required?l=void 0===a.custom.args?1:a.custom.args:f.stats[e]&&(l=f.stats[e].args);var p=!this.prevStat||!o;this.prevStat&&o&&(this.prevStat.min!==o.min&&(p=!0),this.prevStat.max!==o.max&&(p=!0),this.prevStat.step!==o.step&&(p=!0)),l>=1?(this.value.show(),s(this.value,o?o.min:void 0,o?o.max:void 0,o?o.step:1,p&&!t&&(o&&o.best||"max")),this.value.blur()):this.value.hide(),l>=2?(this.value2.show(),s(this.value2,o?o.min2:void 0,o?o.max2:void 0,o?o.step2:1,p&&!t&&(o&&o.best||"max")),this.value2.blur()):this.value2.hide(),l<0?(this.passive||(this.passiveBox=$('<select class="item-info-stat-passive"><option value=""></option></select>'),f.noChosen&&this.passiveBox.find("option").text(v("Select a Passive Skill")),this.passive=$("<span></span>"),this.passive.append(this.passiveBox),this.inner.append(this.passive),this.passiveBox.chosen({inherit_select_classes:!0,search_contains:!0,placeholder_text_single:v("Select a Passive Skill"),populate_func:function(){i.generatePassives(!0)}}).change(function(){i.box.updateStats(!0)}),f.chosenTips(this.passiveBox,function(t){f.tooltip&&f.passives[f.charClass][t]&&f.tooltip.showSkill(this,f.charClass,t)}),d(this.passiveBox,function(t){var s=f.passives[f.charClass][t];if(s)return'<span style="background: url(css/images/class-'+f.charClass+"-passive.png) "+-20*s.index+'px 0 / auto 40px no-repeat"></div>'})),this.generatePassives(this.prevStat===o,!0),this.passiveBox.trigger("chosen:updated"),this.passive.show()):this.passive&&this.passive.hide(),this.prevStat=o,this.onChangeValue()},c.prototype.onChangeStat=function(t){this.box.getId();var s=this.list.val(),e="";f.stats[s]?"sockets"===s?(e="stat-socket",this.type||(this.type="primary")):f.stats[s].secondary?(e="stat-secondary",this.type||(this.type="secondary")):(e="stat-primary",this.type||(this.type="primary")):("primary"===this.type&&(e="stat-primary"),"secondary"===this.type&&(e="stat-secondary"),"socket"===this.type&&(e="stat-socket")),this.line.attr("class",e);var i=this.box.getItemAffixes("only");if(!this.required&&i[s]){this.merged=s;for(var a=0;a<this.box.stats.length;++a)this.box.stats[a].required===s&&(this.box.stats[a].line.remove(),this.box.stats.splice(a--,1))}else if(this.merged){if(i[this.merged]){this.box.onAddStat(this.merged,this.merged).list.val(this.merged)}delete this.merged}this.box.reorderStats(this.box.stats.indexOf(this)),this.box.updateStatCounts(),this.updateLimits()},f.ItemBox=function(t,s){var e=this;this.doUpdate=function(){delete e.upd_timeout,e.onUpdate(e.upd_itemChanged,e.upd_reason),delete e.upd_itemChanged,delete e.upd_reason},$.extend(this,s),this.type=$('<select class="item-info-type"></select>'),this.item=$('<select class="item-info-item"></select>'),this.transmogs=$('<select class="item-info-item"></select>'),this.dyes=$('<select class="item-info-item item-info-dye"></select>'),this.equipSet=$('<span class="item-info-equipset">'+v("Equip full set")+"</span>").hide(),this.ancientSel=$('<select class="item-info-ancient"><option value="false">'+v("Normal")+'</option><option value="true">'+v("Ancient")+'</option><option value="primal">'+v("Primal Ancient")+"</option></select>"),Object.defineProperty(this,"ancient",{get:function(){var t=this.ancientSel.val();return"primal"===t?t:"true"===t},set:function(t){t="primal"===t?"primal":t?"true":"false",this.ancientSel.val(t)}}),this.statsDiv=$('<ul class="item-info-statlist chosen-noframe"></ul>'),this.typeSpan=$('<span style="display: inline-block; vertical-align: top"></span>'),this.itemSpan=$('<span style="display: inline-block; vertical-align: top"></span>'),this.itemMod=$('<div class="item-mod chosen-noframe"></div>'),this.importDiv=$('<div class="item-info-imported">'+v("Imported item ({0}, {1})").format('<span class="link-like item-imported-reset">'+v("reset")+"</span>",'<span class="link-like item-imported-unlock">'+v("unlock")+"</span>")+"</div>"),this.unimportDiv=$('<div class="item-info-unimport"><span class="link-like item-imported-lock">'+v("Lock item")+"</span></div>"),this.stats=[],this.importReset=this.importDiv.find(".item-imported-reset"),this.importUnlock=this.importDiv.find(".item-imported-unlock"),this.importLock=this.unimportDiv.find(".item-imported-lock"),this.importReset.click(function(){var t=e.getData();t.imported&&(t.enchant=t.imported.enchant,t.stats=$.extend(!0,{},t.imported.stats)),e.setItem(t)}),this.importReset.hover(function(){var t=e.getData();t.imported&&(t.enchant=t.imported.enchant,t.stats=t.imported.stats),f.tooltip.showItem(this,t)},function(){f.tooltip.hide()}),this.importUnlock.click(function(){var t=e.getData();delete t.imported,delete t.enchant,e.setItem(t)}),this.importLock.click(function(){e.lockItem()}),this.div=$('<div class="item-info"></div>'),this.slot&&this.div.append("<h3>"+f.itemSlots[this.slot].name+"</h3>"),this.div.append($("<div></div>").append(this.typeSpan.append(this.type)).append(this.itemSpan.append(this.item))),this.typeSpan.append(this.equipSet),this.itemSpan.append(this.ancientSel),this.div.append(this.importDiv,this.statsDiv),this.equipSet.click(function(){e.onEquipSet()}),f.register("updateSlotItem",function(){e.updateEquipSet()}),f.register("importEnd",function(){e.updateEquipSet()}),t.append(this.div),this.add=$('<div class="item-info-add-stat">'+v("Add stat")+"</div>").click(function(){var t=e.onAddStat();e.updateStats(),setTimeout(function(){t.list.trigger("chosen:open")},0)}),this.div.append(this.add),this.badstats=$('<span class="item-info-badstats"></span>').hide(),this.div.append(this.badstats),this.div.append(this.itemMod.append(this.transmogs,this.dyes)),this.div.append(this.unimportDiv),this.ancientSel.change(function(){e.updateItem(),e.updateLimits()}),this.type.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>"),this.type.change(function(){e.type.val()?(e.onChangeType(),setTimeout(function(){e.item.trigger("chosen:open")},0)):(e.item.val(""),e.onChangeType())}),this.type.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,placeholder_text_single:v("Empty Slot")}),this.item.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>"),this.item.change(function(){e.onChangeItem()}),this.item.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,search_contains:!0,placeholder_text_single:v("Empty Slot"),populate_func:function(){e.populateItems()}}),this.transmogs.append('<option value="">'+(f.noChosen?v("Transmogrification"):"")+"</option>"),this.transmogs.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,search_contains:!0,placeholder_text_single:v("Transmogrification"),populate_func:function(){e.fillTransmogs()}}),this.transmogs.change(function(){e.onUpdate(!0)}),this.dyes.append('<option value="">'+(f.noChosen?v("Dye"):"")+"</option>");for(var i in f.webglDyes)this.dyes.append('<option value="'+i+'" class="item-info-icon">'+f.webglDyes[i].name+"</option>");this.dyes.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,search_contains:!0,placeholder_text_single:v("Dye")}),this.dyes.change(function(){e.onUpdate(!0)}),d(this.item,function(t){var s=this.type.val()||f.itemById[t]&&f.itemById[t].type,e=f.itemIcons[t];if(("custom"===s||"customwpn"==s)&&this.slot){var i=f.getOffhandTypes&&"offhand"===this.slot?f.getOffhandTypes():f.itemSlots[this.slot].types;for(var a in i)if(!(i[a].classes&&i[a].classes.indexOf(f.charClass)<0)){s=a,e=f.itemIcons[f.itemTypes[s].generic];break}}if(void 0!==e)return'<span style="background: url(css/items/'+s+".png) 0 -"+24*e[0]+'px no-repeat"></span>'},this),m(this.item,function(t,s){var e=f.itemById[t];if(e)return!!s(e.name)||(!!(e.required&&e.required.custom&&s(e.required.custom.format))||void 0)},this),d(this.transmogs,function(t){var s=f.itemIcons[t],e=f.itemById[t]||f.webglItems[t];if(void 0!==s&&e&&e.type)return'<span style="background: url(css/items/'+e.type+".png) 0 -"+24*s[0]+'px no-repeat"></span>'},this),d(this.dyes,function(t){var s=f.itemIcons[t];if(void 0!==s)return'<span style="background: url(css/items/dyes.png) 0 -'+24*s[0]+'px no-repeat"></span>'},this),f.chosenTips(this.item,function(t){f.tooltip&&f.itemById[t]&&f.tooltip.showItem(this,t,e.slot)}),f.chosenTips(this.transmogs,function(t){f.tooltip&&f.itemById[t]&&"rare"!==f.itemById[t].quality?f.tooltip.showItem(this,t):f.tooltip&&f.webglItems[t]&&f.tooltip.showExtraItem(this,t)}),f.chosenTips(this.dyes,function(t){f.tooltip&&f.webglDyes[t]&&f.tooltip.showExtraItem(this,t)})},f.ItemBox.prototype.removeStat=function(t,s){var e=this.stats[t].list.val();if(this.stats[t].line.remove(),this.stats.splice(t,1),s){this.onAddStat(s,s).list.val(s)}f.stats[e]?this.updateStatCounts():this.updateWarning(),this.updateItem(!0)},f.ItemBox.prototype.updateItem=function(t){this.suppress||(f.importActive?this.onUpdate(!0,t):(this.upd_itemChanged=this.upd_itemChanged||!0,this.upd_reason=t,this.upd_timeout||(this.upd_timeout=setTimeout(this.doUpdate,0))))},f.ItemBox.prototype.updateStats=function(t){this.suppress||(f.importActive?this.onUpdate(!1,t):(this.upd_itemChanged=this.upd_itemChanged||!1,this.upd_reason=t,this.upd_timeout||(this.upd_timeout=setTimeout(this.doUpdate,0))))},f.ItemBox.prototype.onUpdate=function(t,s){this.slot&&f.trigger(t?"updateSlotItem":"updateSlotStats",this.slot,s)},f.ItemBox.prototype.getLimits=function(){return l(this.item.val(),this.ancient)},f.ItemBox.prototype.getItemAffixes=function(t){return f.getItemAffixesById(this.item.val(),this.ancient,t)},f.ItemBox.prototype.updateStatCounts=function(){if(!this.nonRecursive){this.nonRecursive=!0;var t=this.item.val();if(t&&f.itemById[t]){var s=f.getStatCount(t);if("Unique_Ring_021_x1"===t)for(p=0;p<this.stats.length;++p){"spiritregen"!==(h=this.stats[p].list.val())&&"wrathregen"!==h||(++s[0],--s[1])}for(var e=0,i=0,a=0,o=[],n=[],r=[],l=!1,p=0;p<this.stats.length;++p){var h=this.stats[p].list.val();if(!f.stats[h]||!f.stats[h].base){var d=1;this.stats[p].merged&&++d,f.stats[h]&&f.stats[h].caldesanns&&(d=0,l=!0),(f.stats[h]?f.stats[h].secondary:"secondary"===this.stats[p].type)?i+=d:(f.stats[h]||"socket"!==this.stats[p].type)&&(e+=d),f.stats[h]||("secondary"===this.stats[p].type?n.push(this.stats[p]):"socket"===this.stats[p].type?r.push(this.stats[p]):"primary"===this.stats[p].type&&o.push(this.stats[p])),"sockets"===h&&++a}}var m=this.type.val();if("onehand"===(m=f.itemTypes[m]?f.itemTypes[m].slot:null)||"twohand"===m)a||0!==r.length?e-=a:this.onAddStat("socket");else if(r.length){(c=this.stats.indexOf(r[0]))>=0&&(this.stats[c].line.remove(),this.stats.splice(c,1))}for(this.imported&&this.ancient&&!l&&this.onAddStat("caldesanns");e<s[0];)this.onAddStat("primary"),++e;for(;e>s[0]&&o.length;){(c=this.stats.indexOf(o.pop()))>=0&&(this.stats[c].line.remove(),this.stats.splice(c,1)),--e}for(;i<s[1];)this.onAddStat("secondary"),++i;for(;i>s[0]&&n.length;){var c=this.stats.indexOf(n.pop());c>=0&&(this.stats[c].line.remove(),this.stats.splice(c,1)),--i}this.updateWarning(),this.updateEnchant(),delete this.nonRecursive}}},f.ItemBox.prototype.updateEnchant=function(){if(delete this.enchant,this.imported){for(s=0;s<this.stats.length;++s){e=this.stats[s].list.val();if(!this.stats[s].required&&(!f.stats[e]||!f.stats[e].caldesanns)){if(!(e in this.imported.stats)){this.enchant=e;break}if(this.imported.stats[e].length>=1&&parseFloat(this.stats[s].value.val())!==this.imported.stats[e][0]){this.enchant=e;break}if(this.imported.stats[e].length>=2&&parseFloat(this.stats[s].value2.val())!==this.imported.stats[e][1]){this.enchant=e;break}}}this.enchant||(this.enchant=this.imported.enchant)}var t=!1;"source"!==this.type.val()&&"mojo"!==this.type.val()||!this.ancient||(t="wpnphy");for(var s=0;s<this.stats.length;++s){var e=this.stats[s].list.val();this.stats[s].line.toggleClass("stat-enchanted",e===this.enchant),this.stats[s].line.toggleClass("stat-caldesanns","caldesanns"===this.stats[s].type),this.stats[s].enable(!this.stats[s].required&&e===this.enchant||!this.enchant||this.stats[s].required===t||"caldesanns"===this.stats[s].type)}},f.ItemBox.prototype.updateWarning=function(){var t=this.item.val();if(t&&f.itemById[t]){for(var s=this.getItemAffixes(!0),e=p(t),a=f.getStatCount(t),o={},n=0,r=0,l=0,h=0,d=0;d<this.stats.length;++d){var m=this.stats[d].list.val();if(m?o[m]=!0:h+=1,f.stats[m]&&!f.stats[m].base){var c=1;this.stats[d].merged&&++c,f.stats[m].caldesanns&&(c=0),f.stats[m].secondary?r+=c:n+=c,"sockets"==m&&(l=1)}}var u=this.type.val();"onehand"!=(u=f.itemTypes[u]?f.itemTypes[u].slot:null)&&"twohand"!=u&&(l=0),f.options.moreWarnings&&(h=0);var y="";n+h<a[0]?y+='</br><span class="tooltip-icon-bullet"></span>'+v("Add more primary stats"):n-l>a[0]&&(y+='</br><span class="tooltip-icon-bullet"></span>'+v("Too many primary stats")),r>a[1]?y+='</br><span class="tooltip-icon-bullet"></span>'+v("Too many secondary stats"):f.options.moreWarnings&&r<a[1]&&(y+='</br><span class="tooltip-icon-bullet"></span>'+v("Add more secondary stats"));for(var g=[],d=0;d<e.length;++d){var x=i(e[d],s);if(x.length){for(var b=!1,I=0;I<x.length;++I)if(o[x[I]]){b=!0;break}b||g.push(e[d])}}if(g.length>1){y+='<br/><span class="tooltip-icon-bullet"></span>'+v("More than one preset stat is missing");for(d=0;d<e.length;++d){var S=e[d];f.stats[e[d]]?S=f.stats[e[d]].name:f.statGroupNames[e[d]]?S=f.statGroupNames[e[d]]:0==e[d].indexOf("skill_")&&(S=v("Skill Damage")),y+='<br/><span class="tooltip-icon-nobullet"></span><span class="d3-color-white">',g.indexOf(e[d])>=0?y+="<s>"+S+"</s>":y+=S,y+="</span>"}}y?(y='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+v("Impossible stat combination")+"</span>"+y+"</p></div>",this.badstats.hover(function(){f.tooltip.showHtml(this,y)},function(){f.tooltip.hide()}),this.badstats.show()):this.badstats.hide()}else this.badstats.hide()},f.ItemBox.prototype.reorderStats=function(t){for(var s=t,e=this.stats[t];s<this.stats.length&&u(e,this.stats[s])>=0;)s++;for(;s>0&&u(e,this.stats[s-1])<=0;)s--;t!=s&&t+1!=s&&(s==this.stats.length?this.statsDiv.append(e.line):this.stats[s].line.before(e.line),this.stats.splice(t,1),s>t&&(s-=1),this.stats.splice(s,0,e))},f.ItemBox.prototype.updateLimits=function(){for(var t=this.ancient,s=0;s<this.stats.length;++s){var e=this.stats[s].list.val();!t&&f.stats[e]&&f.stats[e].caldesanns?this.removeStat(s--):this.stats[s].updateLimits()}this.updateStatCounts()},f.ItemBox.prototype.onAddStat=function(t,s,e){if("primary"!==t&&"secondary"!==t&&"socket"!==t&&"caldesanns"!==t&&(s||e)){e=s,s=t,t=void 0;var i=s||e;if(f.stats[i]){var a=this.type.val();t="onehand"!==(a=f.itemTypes[a]?f.itemTypes[a].slot:null)&&"twohand"!==a||"sockets"!==i?f.stats[i].secondary?"secondary":this.imported&&f.stats[i].caldesanns?"caldesanns":"primary":"socket"}}return new c(this,t,s,e)},f.ItemBox.prototype.onEquipSet=function(t){l=this.item.val();if(!l||!f.itemById[l]||!f.itemById[l].set)return!1;var s,e=f.itemById[l],i=f.itemSets[e.set],a={},o={};if(f.itemSlots.mainhand&&f.itemSlots.mainhand.item){var n=f.itemSlots.mainhand.item.id;n&&f.itemById[n]&&(s=f.itemById[n].type)}for(var r in f.itemSlots){var l;(l=f.getSlotId(r))&&(o[l]=r)}for(var p=0;p<i.items.length;++p){var h=i.items[p];if(!o[h.id]){var d=h.type,m=[r=f.itemTypes[d].slot];f.metaSlots[r]&&(m=f.metaSlots[r].slots);for(var c=0;c<m.length;++c)if(!a[m[c]]&&!f.getSlotId(m[c])&&f.isItemAllowed(m[c],h.id,s)){a[m[c]]=h.id;break}}}if($.isEmptyObject(a))return!1;if(t)return!0;var u=this.ancient;for(var r in a)f.setSlot(r,f.makeItem(a[r],void 0,u));return!0},f.ItemBox.prototype.updateEquipSet=function(){this.equipSet.toggle(this.onEquipSet(!0))},f.ItemBox.prototype.onChangeItem=function(){delete this.enchant,delete this.imported,this.div.removeClass("item-imported");var t=this.item.val(),s=f.itemById[t];if(s&&s.type!==this.type.val())return this.type.val(s.type),this.type.trigger("chosen:updated"),void this.onChangeType();t?(this.itemSpan.show(),this.statsDiv.show(),this.add.show(),this.unimportDiv.show()):(this.itemSpan.show(),this.statsDiv.hide(),this.add.hide(),this.unimportDiv.hide());var e=this;if("mainhand"===this.slot&&f.itemSlots.offhand.item&&f.itemById[f.itemSlots.offhand.item.id]){var a=this.type.val(),o=f.itemById[f.itemSlots.offhand.item.id].type;f.itemTypes[a]&&"twohand"==f.itemTypes[a].slot&&"crusader"!=f.charClass&&o&&"quiver"!=o&&f.trigger("updateSlotItem","offhand","twohand")}if(this.updateItem(),this.updateMods(),this.updateEquipSet(),!t)return this.statsDiv.empty(),this.stats=[],this.badstats.hide(),void this.ancientSel.hide();this.nonRecursive=!0;this.getItemAffixes(!1);var n=this.getItemAffixes("only"),r=this.getItemAffixes(!0),l=[];$.each(p(t),function(t,s){l.push({list:i(s,r,e.charClass)})});for(var h in n)l.push({list:[h],required:h});var d=f.getStatCount(t);f.qualities[f.itemById[t].quality].ancient?this.ancientSel.show():this.ancientSel.hide();for(var m=[],c=0;c<this.stats.length;++c){var u=!1,h=this.stats[c].required||this.stats[c].list.val();if(r[h]){for(b=0;b<l.length;++b)if(l[b].list.indexOf(h)>=0){l[b].required?(this.stats[c].required=l[b].required,this.stats[c].remove.hide()):(delete this.stats[c].required,this.stats[c].remove.show()),this.stats[c].updateList(),this.stats[c].list.trigger("chosen:updated"),l.splice(b,1),u=!0;break}u||(this.stats[c].required?r[this.stats[c].required]?(delete this.stats[c].required,this.stats[c].remove.show(),m.push(this.stats[c])):(this.stats[c].line.remove(),this.stats.splice(c--,1)):m.push(this.stats[c]))}else this.stats[c].line.remove(),this.stats.splice(c--,1)}for(var v=0,c=0;c<this.stats.length;++c){h=this.stats[c].required||this.stats[c].list.val();f.stats[h]&&f.stats[h].secondary?d[1]--:f.stats[h]&&f.stats[h].base||d[0]--,"socket"===h&&++v}var y=this.type.val();"onehand"!=(y=f.itemTypes[y]?f.itemTypes[y].slot:null)&&"twohand"!=y&&(d[0]+=v),m.sort(function(t,s){return(t.list.val()||"").length-(s.list.val()||"").length});for(c=0;c<l.length;++c)if(0!=l[c].list.length){var g=h=l[c].list[0];r[I]&&r[I].noblock||(g=f.stats[h].group||h);for(b=0;b<m.length;++b){if((I=m[b].list.val())===g||f.stats[I]&&f.stats[I].group===g){S=this.stats.indexOf(m[b]);m[b].line.remove(),m.splice(b--,1),S>=0&&this.stats.splice(S,1)}}if(f.stats[h]){var x=void 0;if(f.stats[h].secondary?--d[1]<0&&(x=!0):f.stats[h].base||--d[0]<0&&(x=!1),void 0!==x)for(var b=0;b<m.length;++b){var I=m[b].list.val();if(!f.stats[I]||!f.stats[I].base){if(!(!f.stats[I]||!f.stats[I].secondary)===x){var S=this.stats.indexOf(m[b]);m[b].line.remove(),m.splice(b--,1),S>=0&&this.stats.splice(S,1);break}}}}this.onAddStat(l[c].required,h).list.val(h)}for(c=0;c<m.length;++c)m[c].updateList(),m[c].list.trigger("chosen:updated");m=this.stats.slice();for(c=0;c<m.length;++c)m[c].onChangeStat();delete this.nonRecursive,this.updateStatCounts()},f.ItemBox.prototype.setItem=function(t){if(this.updateItem(),this.div.removeClass("item-imported"),!t||!f.itemById[t.id])return this.type.val(""),this.item.val(""),this.type.trigger("chosen:updated"),this.onChangeType(),!1;var s=f.itemById[t.id];if(this.type.val(s.type),this.type.val()!==s.type)return!1;if(this.type.trigger("chosen:updated"),this.onChangeType(t.id),this.item.val(t.id),this.item.val()!==t.id)return!1;this.ancient=t.ancient,f.qualities[s.quality].ancient?this.ancientSel.show():this.ancientSel.hide(),this.item.trigger("chosen:updated"),this.statsDiv.empty(),this.stats=[];var e=this.getItemAffixes(!1),i=this.getItemAffixes(!0),a=this.getItemAffixes("only");a.basearmor&&!t.stats.basearmor&&(t.stats.basearmor=[a.basearmor.max]),a.baseblock&&!t.stats.baseblock&&(t.stats.baseblock=[a.baseblock.max]),a.blockamount&&!t.stats.blockamount&&(t.stats.blockamount=[a.blockamount.max,a.blockamount.max2]),this.nonRecursive=!0;t.empty;this.enchant=t.enchant,this.imported=t.imported;for(var o in t.stats)if(i[o]){var n=a[o]?o:void 0;n&&a[o].noblock&&e[o]&&t.stats[o].length>=1&&"string"!=typeof t.stats[o][0]&&a[o].max&&t.stats[o][0]>a[o].max&&(n=!1);var l=this.onAddStat(n,o);l.list.val(o);f.stats[o];if(t.stats[o].length>=1&&"string"!=typeof t.stats[o][0]&&l.value.val(t.stats[o][0]),t.stats[o].length>=2&&l.value2.val(t.stats[o][1]),l.onChangeStat(!0),t.stats[o].length>=1&&"string"==typeof t.stats[o][0]&&l.passive&&(l.passiveBox.val(t.stats[o][0]),l.passiveBox.trigger("chosen:updated")),"sockets"===o&&t.gems&&l.sockets)for(var p=0;p<t.gems.length&&p<l.sockets.length;++p)l.sockets[p].type.val(t.gems[p][0]),l.sockets[p].type.trigger("chosen:updated"),r(l.sockets[p]),f.legendaryGems[t.gems[p][0]]?l.sockets[p].level.val(t.gems[p][1]):(l.sockets[p].color.val(t.gems[p][1]),l.sockets[p].color.trigger("chosen:updated"))}else 0;return delete this.nonRecursive,this.imported?this.div.addClass("item-imported"):delete this.enchant,this.updateStatCounts(),this.updateMods(t.transmog,t.dye),this.updateEquipSet(),!0},f.ItemBox.prototype.getId=function(){if(f.itemTypes[this.type.val()]){var t=this.item.val();return f.itemById[t]?t:void 0}},f.ItemBox.prototype.getData=function(){if(f.itemTypes[this.type.val()]){var t=this.item.val(),s=f.itemById[t],e=0;if(s){var i={id:t,stats:{}};f.qualities[s.quality].ancient&&(i.ancient=this.ancient);for(var a=0;a<this.stats.length;++a){var o=this.stats[a].list.val();if(o){if(f.stats[o]){i.stats[o]=[];var n=f.stats[o].args;if("custom"==o&&s.required&&s.required.custom&&(n=void 0===s.required.custom.args?1:s.required.custom.args),n>=1&&i.stats[o].push(parseFloat(this.stats[a].value.val())||0),n>=2&&i.stats[o].push(parseFloat(this.stats[a].value2.val())||0),n<0&&this.stats[a].passive&&i.stats[o].push(this.stats[a].passiveBox.val()),"sockets"===o&&this.stats[a].sockets){i.gems=[];for(var r=0;r<this.stats[a].sockets.length;++r){var l=this.stats[a].sockets[r],p=[l.type.val(),0];f.legendaryGems[p[0]]?p[1]=parseInt(l.level.val()):f.gemQualities[p[0]]?(p[0]=parseInt(p[0]),p[1]=l.color.val()):p=null,p&&i.gems.push(p)}}}}else++e}this.enchant&&i.stats[this.enchant]&&(i.enchant=this.enchant),i.imported=this.imported;var h=this.getMods();return h[0]&&this.transmogs.val()&&(i.transmog=this.transmogs.val()),h[1]&&this.dyes.val()&&(i.dye=this.dyes.val()),e&&(i.empty=e),i}}},f.ItemBox.prototype.updateTypes=function(t){var s=this.type.val();this.type.empty(),this.type.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>");var e=this.slot?f.itemSlots[this.slot].types:f.itemTypes;"offhand"===this.slot&&(e=f.getOffhandTypes());var i={};for(var a in e){var o=e[a];this.charClass&&o.classes&&o.classes.indexOf(this.charClass)<0||(i[e[a].slot]||(i[e[a].slot]=[]),i[e[a].slot].push(a))}for(var n in i){var r=this.type;Object.keys(i).length>1&&i[n].length>1&&(r=$("<optgroup></optgroup>"),f.metaSlots[n]?r.attr("label",f.metaSlots[n].name):r.attr("label",f.itemSlots[n].name),this.type.append(r));for(var l=0;l<i[n].length;++l){var p='<option value="'+(a=i[n][l])+(s==a?'" selected="selected':"")+'">'+f.GenderString(e[a].name)+"</option>";r.append(p)}}this.type.children().length>1?this.type.removeAttr("disabled"):this.type.prop("disabled",!0),this.type.trigger("chosen:updated"),!t&&this.type.val()===s&&s||this.onChangeType()},f.ItemBox.prototype.getMods=function(){var t=!1,s=!1,e=this.item.val(),i=(e=e&&f.itemById[e])&&f.itemTypes[e.type];return e&&i&&("head"!==i.slot&&"shoulders"!==i.slot&&"torso"!==i.slot&&"legs"!==i.slot&&"hands"!==i.slot&&"feet"!==i.slot||(t=!0,s=!0),"mainhand"!==i.slot&&"offhand"!==i.slot&&"twohand"!==i.slot&&"onehand"!==i.slot||"quiver"!==e.type&&(t=!0)),[t,s]},f.ItemBox.prototype.updateMods=function(t,s){var e=this.getMods();this.itemMod.toggle(!(!e[0]&&!e[1]));var i=this.transmogs;f.noChosen||(i=i.next()),i.toggle(e[0]);var a=this.dyes;if(f.noChosen||(a=a.next()),a.toggle(e[1]),e[0])if(f.noChosen)this.fillTransmogs(t);else{this.transmogs.empty();var o=t&&(f.itemById[t]||f.webglItems[t]);this.transmogs.append('<option value="'+(t||"")+'" selected="selected">'+(o&&o.name||"")+"</option>"),this.transmogs.trigger("chosen:updated")}e[1]&&(this.dyes.val(s),this.dyes.trigger("chosen:updated"))},f.ItemBox.prototype.fillTransmogs=function(){function t(t,s){if(s.name&&(!s.id||"rare"!==s.quality)){var i=f.itemTypes[s.type];if(i&&!(i.classes&&i.classes.indexOf(f.charClass)<0||s.classes&&s.classes.indexOf(f.charClass)<0||i.slot!=a.slot)){if("offhand"===i.slot&&i!==a){if(i!==f.itemTypes.shield&&i!==f.itemTypes.crusadershield)return;if(a!==f.itemTypes.shield&&a!==f.itemTypes.crusadershield)return}if(!i.weapon||!a.weapon||i.weapon.type===a.weapon.type){if(s.actor){if("object"==typeof(p=s.actor)&&(p=p[l]),r[p]&&e!==t)return;r[p]=!0}if(s.armortype){var p=s.armortype+"_"+s.look;if(r[p]&&e!==t)return;r[p]=!0}(s.promo?n:o).append('<option value="'+(s.id||t)+'" class="item-info-icon quality-'+(s.quality||(s.promo?"legendary":"normal"))+(e==(s.id||t)?'" selected="selected':"")+'">'+s.name+(s.suffix?" ("+s.suffix+")":"")+"</option>")}}}}var s=this.transmogs,e=s.val();arguments.length>0&&(e=arguments[0]),s.empty(),s.append('<option value="">'+(f.noChosen?v("Transmogrification"):"")+"</option>");var i=this.item.val();if(i=i&&f.itemById[i]){var a=f.itemTypes[i.type],o=$('<optgroup label="'+v("Normal Items")+'"></optgroup>'),n=$('<optgroup label="'+v("Promotion Items")+'"></optgroup>');s.append(o);var r={},l=(f.webglClasses[f.charClass]||{})[f.gender||"female"]||0;$.each(f.webglItems,t),o=$('<optgroup label="'+v("Legendary Items")+'"></optgroup>'),s.append(o),$.each(f.items,t),s.append(n)}},f.ItemBox.prototype.addItemToList=function(t,s){if(!(this.charClass&&t.classes&&t.classes.indexOf(this.charClass)<0)){if(!s){if(f.options.hideLegacy&&t.suffix===v("Legacy"))return;if(f.options.hideCrossClass&&this.charClass&&f.itemPowerClasses&&t.required&&t.required.custom&&f.itemPowerClasses[t.required.custom.id]&&f.itemPowerClasses[t.required.custom.id]!==this.charClass)return;if(f.options.hideCrossClass&&this.charClass&&t.set){var e=f.itemSets[t.set];if(e&&e.tclass&&e.tclass!==this.charClass)return}}var i='<option value="'+t.id+'" class="item-info-icon quality-'+(t.quality||"rare")+(s?'" selected="selected':"")+'">'+t.name+(t.suffix?" ("+t.suffix+")":"")+"</option>";this.item.append(i)}},f.ItemBox.prototype.populateItems=function(t){var s=this.type.val(),e=t||this.item.val();if(this.item.empty(),this.item.append('<option value="">'+(f.noChosen?v("Empty Slot"):"")+"</option>"),s&&f.itemTypes[s])for(r=0;r<f.itemTypes[s].items.length;++r){var i=f.itemTypes[s].items[r];this.addItemToList(i,i.id===e)}else{var a=this.slot?f.itemSlots[this.slot].types:f.itemTypes;"offhand"===this.slot&&(a=f.getOffhandTypes());var o=[];for(var s in a){var n=a[s];if("custom"!==s&&"customwpn"!==s&&!(this.charClass&&n.classes&&n.classes.indexOf(this.charClass)<0))for(r=0;r<n.items.length;++r)o.push(n.items[r])}o.sort(function(t,s){var e="rare"===t.quality?"":t.quality,i="rare"===s.quality?"":s.quality;if(e!=i)return e.localeCompare(i);var a=t.name.toLowerCase().replace(/^(?:the|a) /,""),o=s.name.toLowerCase().replace(/^(?:the|a) /,"");return a.localeCompare(o)});for(var r=0;r<o.length;++r)this.addItemToList(o[r],o[r].id===e)}},f.ItemBox.prototype.refreshItems=function(t){this.populateItems(t)},f.ItemBox.prototype.onChangeType=function(t){var s=this.type.val();this.refreshItems(t),this.item.trigger("chosen:updated"),this.onChangeItem(),"mainhand"===this.slot&&f.itemSlots.offhand.drop.updateTypes(void 0,s)},f.ItemBox.prototype.setClass=function(t,s){this.charClass=t,void 0!==s&&(this.slot=s),this.updateTypes(!0)},f.ItemBox.prototype.accept=function(t){if(!t||!f.itemById[t])return!1;var s=f.itemById[t].type,e=(this.slot?f.itemSlots[this.slot].types:f.itemTypes)[s];if(!e)return!1;var i=!1,a="offhand"===this.slot&&this.charClass&&!f.classes[this.charClass].dualwield;if("offhand"===this.slot&&"crusader"!==this.charClass&&f.itemSlots.mainhand.item&&f.itemById[f.itemSlots.mainhand.item.id]){var o=f.itemById[f.itemSlots.mainhand.item.id].type;f.itemTypes[o]&&"twohand"==f.itemTypes[o].slot&&(i=!0)}return(!i||"quiver"==s)&&((!a||"onehand"!=e.slot||"handcrossbow"==s)&&!(this.charClass&&e.classes&&e.classes.indexOf(this.charClass)<0))},f.ItemBox.prototype.lockItem=function(){var t=this,s=this.getData(),e=$('<div class="optimize-dialog"><p><i>'+v("Locking an item allows only one stat to be enchanted, which can be useful for optimizing your gear when you can't import it from your profile.")+"</i></p></div>");e.append("<div>"+v("Enchant: {0}").format("<select></select>")+"</div>");var i=e.find("select");i.append('<option value="">'+v("Not enchanted")+"</option>");var a=f.getItemAffixesById(s.id,s.ancient,!1),o=f.getItemAffixesById(s.id,s.ancient,"only");for(var n in s.stats)!f.stats[n]||f.stats[n].base||f.stats[n].caldesanns||!a[n]||a[n].args<0||o[n]&&(o[n].args<=0||s.stats[n][0]<=o[n].max)||i.append('<option value="'+n+'">'+f.stats[n].name+"</option>");var r=[{text:v("Lock"),click:function(){var e=i.val();e||(e=void 0),s.imported={enchant:e,stats:$.extend(!0,{},s.stats)},s.enchant=e,t.setItem(s),$(this).dialog("close")}}];e.dialog({resizable:!1,title:v("Lock item"),height:"auto",width:350,modal:!0,buttons:r,close:function(){e.remove()},open:function(){e.parent().css("overflow","visible")}})}}();!function(){function e(e,a,t,s){return e?"string"!=typeof e?e:(t?e=e.replace(/\$([1-9])/g,function(e,s){return a.affixes[t]?a.affixes[t].value[parseInt(s)-1]:1===parseInt(s)?a[t]:void 0}):s&&(e=e.replace(/\$([1-9])/g,function(e,a){return s[parseInt(a)-1].val})),a.execString(e)):0}function a(e,a){function t(e){return i(e,o,a.affix,a.params)}var s,n,o=(a=a||{}).stats||r.getStats();if(e.thorns)s={min:n=o.thorns||0,max:n};else if(e.weapon){if(!o.info[e.weapon])return;n=.5*((s=$.extend({},o.info[e.weapon].wpnbase)).min+s.max)}else n=.5*((s=$.extend({},o.info.mainhand.wpnbase)).min+s.max),o.info.offhand&&(s.min=Math.min(s.min,o.info.offhand.wpnbase.min),s.max=Math.max(s.max,o.info.offhand.wpnbase.max),n=.5*n+.25*(o.info.offhand.wpnbase.min+o.info.offhand.wpnbase.max));var f=1,d=0,l=[];if(l.push({name:r.stats[r.classes[r.charClass].primary].name,percent:("bad"===e.thorns?.25:1)*o.info.primary}),e.aps&&l.push({name:"Attack speed",factor:(e.weapon?o.info[e.weapon].speed:o.info.aps)*(!0===e.aps?1:t(e.aps))}),e.coeff||e.addcoeff){var p=e.coeff?t(e.coeff):0,c=p,h=void 0;if(f=p,e.addcoeff){h=[];for(P=0;P<e.addcoeff.length;++P){var m,u=e.addcoeff[P];"object"==typeof u?((u=[t(u[0]),t(u[1])])[0]&&u[1]&&h.push([100*u[0],u[1]]),m=u[0]*u[1]):((u=t(u))&&h.push(100*u),m=u),"number"!=typeof e.total||P<e.total?f+=m:d+=m,p+=m}}l.push({name:"Skill multiplier",factor:p,percent:100*c,extra:h,coeff:!0})}if(e.factors)for(var v in e.factors){1!=(E=t(e.factors[v]))&&l.push({name:v,factor:E})}if(e.divide)for(var v in e.divide){1!=(E=t(e.divide[v]))&&l.push({name:v,factor:1/E,divide:E})}if(e.percent)for(var v in e.percent){(E=t(e.percent[v]))&&l.push({name:v,percent:E})}if(e.passives)for(var b in e.passives)if(o.passives[b]){(E=t(e.passives[b]))&&l.push({name:r.passives[r.charClass][b].name,percent:E})}var w={},g=e.skill||a.skill&&a.skill[0];if(g&&"special"!==e.thorns&&!e.manald){var x=o["skill_"+r.charClass+"_"+g];x&&(w["Skill %"]=x)}if(e.bonuses)for(var _ in e.bonuses){(E=t(e.bonuses[_]))&&(w[_]=E)}if(e.addpassives)for(var b in e.addpassives)if(o.passives[b]){(E=t(e.addpassives[b]))&&(w[r.passives[r.charClass][b].name]=E)}e.pet&&!$.isEmptyObject(w)&&(l.push({name:"Skill damage",percent:w}),w={});var y="max"==e.elem?o.info.maxelem:e.elem,k=("max"==e.srcelem?o.info.maxelem:e.srcelem)||y,M=o.getTotalSpecial("damage",y,e.pet,g,e.exclude);M&&(w.Buffs=M);if((M=o.getTotalSpecial("dmgtaken",y,e.pet,g,e.exclude))&&"normal"!==e.thorns&&"bad"!==e.thorns&&"special"!==e.thorns&&(w.Debuffs=M),$.isEmptyObject(w)||l.push({name:e.pet?"Buffs/debuffs":"Damage increased by skills",percent:w}),!M||"normal"!==e.thorns&&"bad"!==e.thorns&&"special"!==e.thorns||l.push({name:r.stats.dmgtaken.name,percent:M}),"normal"!==e.thorns&&"bad"!==e.thorns||!o.thorns_taken||l.push({name:r.itemById.Unique_Shield_104_x1.name,percent:o.thorns_taken}),(k&&o["dmg"+k]||e.pet&&o.petdamage)&&!e.manald){w={};k&&o["dmg"+k]&&(w[r.elements[k]]=o["dmg"+k]),e.pet&&o.petdamage&&(w.Pets=o.petdamage),l.push({name:"Elemental damage",percent:w})}if(r.options.showElites&&o.edmg){var S=o.edmg;e.manald&&(S-=o.leg_thefurnace||0,o.gem_powerful_25&&(S-=15)),S&&l.push({name:r.stats.edmg.name,percent:S})}r.options.targetBoss&&r.options.showElites&&o.bossdmg&&l.push({name:r.stats.bossdmg.name,percent:o.bossdmg});var F=r.options.targetType;F&&o["damage_"+F]&&l.push({name:r.stats["damage_"+F].name,percent:o["damage_"+F]}),$.each(o.getSpecial("dmgmul",y,e.pet,g,e.exclude),function(e,a){l.push({name:a[0],percent:a[1]})});for(var A=1,P=0;P<l.length;++P){if(!l[P].factor){var N=0;if("number"==typeof l[P].percent)N=l[P].percent;else for(var C in l[P].percent)N+=l[P].percent[C];l[P].factor=1+.01*N}A*=l[P].factor}var j=t(e.chc),D=t(e.chd),B=Math.min(1,.01*(o.final.chc+j*(1+.01*(o.chctaken_percent||0)))),I=.01*(o.chd+D);e.thorns&&(B=I=j=0);var E=n*A*(1+B*I);return{factors:l,total_factor:A*f/(f+d),extra_factor:A*d/(f+d),value:E,base:s,chc:B,chd:I,bonus_chc:j}}function t(e,a){this.header_="",this.body_="",e&&this.header(e,a)}function s(e,a,t,s){var n=(""+parseFloat(e.toFixed(a||0))).split(".");return Math.abs(parseFloat(e))>=1e4&&(n[0]=n[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")),e=n.join("."),s&&s.indexOf("+")>=0&&(e>0&&(e="+"+e),s=s.replace("+","")),'<span class="d3-color-'+(t||"green")+'">'+e+(s||"")+"</span>"}function n(e,a,t){return e=Math.floor(e),a=Math.floor(a),s(e,0,t)+(e==a?"":"-"+s(a,0,t))}var r=DiabloCalc,o=r.locale("ui-skills.js","skilldata");r.getSkillBonus=function(e,a,t){if(e){t=t||"buffs";var s=r.skills[r.charClass][e[0]],n=null;return s&&s[t]&&(n="function"==typeof s[t]?s[t](e[1],a):s[t][e[1]]),n}},r.getPassiveBonus=function(e,a){var t=r.passives[r.charClass][e],s=null;return t&&t.buffs&&(s="function"==typeof t.buffs?t.buffs(a):t.buffs),s},r.execString=e;var i=e;r.calcFramesFull=function(e,a,t,s,n,o){!0!==t&&!1!==t&&(n=s,s=t,t=void 0);var i="up"===n?1:0,o=o||r.getStats(),f={fpa:e,dspeed:s||1,fpadelta:i};return!a&&o.info.offhand?t?(f.basespeed=Math.min(o.info.mainhand.speed,o.info.offhand.speed),f.frames=Math.floor(e/(f.dspeed*f.basespeed))+i):(f.framesmh=Math.floor(e/(f.dspeed*o.info.mainhand.speed))+i,f.framesoh=Math.floor(e/(f.dspeed*o.info.offhand.speed))+i,f.frames=.5*(f.framesmh+f.framesoh)):(f.basespeed=o.info[a||"mainhand"].speed,f.frames=Math.floor(e/(f.dspeed*f.basespeed))+i),f},r.calcFrames=function(e,a,t,s,n,o){return r.calcFramesFull.apply(r,arguments).frames},t.prototype.html=function(){return'<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p>'+this.header_+this.body_+"</p></div>"},t.prototype.empty=function(){return 0==this.body_.length},t.prototype.header=function(e,a){return e=o(e),void 0!==a&&(e+=': <span class="d3-color-green">'+a+"</span>"),this.header_='<span class="d3-color-gold">'+e+"</span>",this},t.prototype.line=function(e,a){var t=2,s=a;return!0!==e&&!1!==e&&(s=e,e=!0,t=1),this.body_+='<br/><span class="tooltip-icon-'+(!1===e?"nobullet":"bullet")+'"></span>'+String.prototype.format.apply(o(s),Array.prototype.slice.call(arguments,t)),this},t.prototype.add=function(e){if(!e)return this;if("string"==typeof e){var a=!0;"@"===e[0]&&(e=e.substring(1),a=!1),this.line(a,e)}else if(e instanceof Array)for(var s=0;s<e.length;++s)this.add(e[s]);else e instanceof t&&(this.body_+=e.body_);return this},t.prototype.breakpoints=function(e,a){function t(e,t){var s;return(s=a.framesmh&&a.framesoh?.5*(Math.floor(a.fpa/(a.dspeed*e))+Math.floor(a.fpa/(a.dspeed*t)))+a.fpadelta:Math.floor(a.fpa/(a.dspeed*e))+a.fpadelta)<a.frames?'<span class="d3-color-green">+'+r.formatNumber(100*(a.frames/s-1),1)+"%</span>":s>a.frames?'<span class="d3-color-red">-'+r.formatNumber(100*(1-a.frames/s),1)+"%</span>":'<span class="d3-color-gray">+0%</span>'}function s(e){var a=e[0]===b||e[0]===w?' class="current"':"";return"<td"+a+">"+e[0]+"</td><td"+a+">"+e[1]+"</td>"}if(a.pet){if(a.frames>6){var n=e.info.mainhand.speed/(1+.01*(e.ias||0)),i=a.fpa/(a.frames-5)/a.speed,f=Math.ceil(10*(100*i/n-100-(e.ias||0)))/10;this.line(!1,"IAS to next breakpoint: {0}",'<span class="d3-color-white">'+f+"%</span>")}this.body_+="</p><table><tr><th>"+["FPA","APS","Pet APS","Delta"].map(o).join("</th><th>")+"</th></tr>";for(_=6*Math.ceil(Math.floor(a.fpa)/6);_>=6;_-=6){y=Math.max(1,a.fpa/(_+1)/a.speed+51e-6);if(a.speed/(_+1)>5)break;this.body_+="<tr"+(_===a.frames?' class="current"':"")+"><td>"+_+"</td>",this.body_+="<td>"+y.toFixed(4)+"</td><td>"+Math.max(1,a.fpa/(_+1)+51e-6).toFixed(4)+"</td>";var d=100*(a.frames/_-1);this.body_+='<td class="'+(d<0?"d3-color-red":d>0?"d3-color-green":"d3-color-gray")+'">',this.body_+=(d<0?d.toFixed(1):"+"+d.toFixed(1))+"%</td></tr>"}this.body_+="</table><p>"}else{if(a.framesmh&&a.framesoh){if(a.framesmh>1&&a.framesoh>1){var l=a.fpa/(a.framesmh-a.fpadelta)/a.dspeed+51e-6,p=a.fpa/(a.framesoh-a.fpadelta)/a.dspeed+51e-6;l=(m=Math.min(l/e.info.mainhand.speed,p/e.info.offhand.speed))*e.info.mainhand.speed,p=m*e.info.offhand.speed;f=Math.ceil(10*(m*(100+(e.ias||0))-100-(e.ias||0)))/10;this.line(!1,"Next breakpoint: {0} APS ({1} IAS)"+(!1!==a.dps?", {2} DPS":""),'<span class="d3-color-white">'+r.formatNumber(l,4,1e4)+'</span>/<span class="d3-color-white">'+r.formatNumber(p,4,1e4)+"</span>",'<span class="d3-color-white">+'+f+"%</span>",t(l,p))}var c=a.fpa/(a.framesmh+1-a.fpadelta)/a.dspeed-51e-6,h=a.fpa/(a.framesoh+1-a.fpadelta)/a.dspeed-51e-6;c=(u=Math.max(c/e.info.mainhand.speed,h/e.info.offhand.speed))*e.info.mainhand.speed,h=u*e.info.offhand.speed;f=Math.ceil(10*(u*(100+(e.ias||0))-100-(e.ias||0)))/10;this.line(!1,"Previous breakpoint: {0} APS ({1} IAS)"+(!1!==a.dps?", {2} DPS":""),'<span class="d3-color-white">'+r.formatNumber(c,4,1e4)+'</span>/<span class="d3-color-white">'+r.formatNumber(h,4,1e4)+"</span>",'<span class="d3-color-white">'+f+"%</span>",t(c,h))}else{if(a.frames>1){var m=a.fpa/(a.frames-a.fpadelta)/a.dspeed+51e-6,n=a.basespeed/(1+.01*(e.ias||0)),f=Math.ceil(10*(100*m/n-100-(e.ias||0)))/10;this.line(!1,"Next breakpoint: {0} APS ({1} IAS)"+(!1!==a.dps?", {2} DPS":""),'<span class="d3-color-white">'+r.formatNumber(m,4,1e4)+"</span>",'<span class="d3-color-white">+'+f+"%</span>",t(m))}var u=a.fpa/(a.frames+1-a.fpadelta)/a.dspeed-51e-6,n=a.basespeed/(1+.01*(e.ias||0)),f=Math.ceil(10*(100*u/n-100-(e.ias||0)))/10;this.line(!1,"Previous breakpoint: {0} APS ({1} IAS)"+(!1!==a.dps?", {2} DPS":""),'<span class="d3-color-white">'+r.formatNumber(u,4,1e4)+"</span>",'<span class="d3-color-white">'+f+"%</span>",t(u))}if(!a.sequence){var v="<th>"+o("FPA")+"</th><th>"+o("APS")+"</th>";this.body_+='</p><table class="col2"><tr>'+v+"<th></th>"+v+"<th></th>"+v+"</tr>";var b=a.frames,w=a.frames;a.framesmh&&a.framesoh&&(b=a.framesmh,w=a.framesoh);var g=[],x=Math.max(3,e.info.mainhand.speed);a.framesoh&&(x=Math.max(x,e.info.offhand.speed)),x=Math.max(1.2*x,x+.5);for(var _=Math.floor(a.fpa)+a.fpadelta;_>=1;_-=1){var y;if((y=Math.max(1,a.fpa/(_+1-a.fpadelta)/a.dspeed+51e-6))>x&&g.length%3==0)break;g.push([_,y.toFixed(4)])}for(var k=Math.ceil(g.length/3),M=0;M<k;++M)this.body_+="<tr>"+s(g[M]),M+k<g.length&&(this.body_+="<td></td>"+s(g[M+k])),M+k+k<g.length&&(this.body_+="<td></td>"+s(g[M+k+k])),this.body_+="</tr>";this.body_+="</table><p>"}}},r.skill_formatObject=a,r.skill_processInfo=function(e,f){function d(e){return i(e,h,f.affix,f.params)}var l={},p=[],c=(f=f||{}).notip,h=f.stats||r.getStats(),m=new t,u=[];$.each(e,function(e,i){function v(e,a){return a?v(a,e%a):e}if(i)if(l[e]={},"object"!=typeof i)"number"==typeof i?results[e].value=i:c||(l[e].text=i);else if(i.sum)p.push(e);else if(void 0!==i.cooldown&&void 0!==i.duration){var b=d(i.duration),w=d(i.cooldown);(F=i.skill||f.skill&&f.skill[0])&&(w-=h["skill_"+r.charClass+"_"+F+"_cooldown"]||0),w-=h.cdrint||0,i.cdr&&(w*=1-.01*d(i.cdr)),S=(w=Math.max(.5,w*(1-.01*(h.cdr||0))))<=.01?100:Math.min(100,100*b/(w+(i.after?b:0))),l[e].value=S,c||(l[e].text=r.formatNumber(S,0,1e4)+"%",(O=new t(e,l[e].text)).add(i.tip),O.line("Duration: {0} seconds",s(b,0,"white")),O.line("Cooldown: {0} seconds",s(w,2,"white")),i.after?(O.line("Downtime: {0}",s(100-S,2,"white","%")),O.line("Cooldown does not start until the effect expires.")):O.line("Downtime: {0} ({1} seconds)",s(100-S,2,"white","%"),s(Math.max(0,w-b),2,"white")),l[e].tip=O.html())}else if(void 0!==i.cooldown){if(!(w=d(i.cooldown)))return void delete l[e];(F=i.skill||f.skill&&f.skill[0])&&(w-=h["skill_"+r.charClass+"_"+F+"_cooldown"]||0),w-=h.cdrint||0,i.cdr&&(w*=1-.01*d(i.cdr)),w=Math.max(.5,w*(1-.01*(h.cdr||0))),l[e].value=w,c||(l[e].text=o("{0} seconds").format(parseFloat(w.toFixed(2))))}else if(void 0!==i.duration)b=d(i.duration),l[e].value=b,c||(l[e].text=o("{0} seconds").format(parseFloat(b.toFixed(2))));else if(void 0!==i.cost){var g=i.resource||r.classes[r.charClass].resources[0],x=d(i.cost),_=x,y={},k={};if(x*=1-.01*(h["rcr_"+g]||0),i.rcr)if("object"==typeof i.rcr)for(var M in i.rcr)(S=d(i.rcr[M]))&&(x*=1-.01*S,c||(h.affixes[M]&&(M=h.getAffixSource(M)),y[r.sourceNames[M]||M]=S));else{var S;(S=d(i.rcr))&&(x*=1-.01*S,c||(y[o("Unknown")]=S))}if(f.skill&&f.skill[0]){var F=r.skilltips[r.charClass][f.skill[0]];F&&"fir"===F.elements[f.skill[1]]&&(x*=1-.01*(h.leg_cindercoat||0),!c&&h.leg_cindercoat&&h.affixes.leg_cindercoat&&(y[r.sourceNames[h.getAffixSource("leg_cindercoat")]]=h.leg_cindercoat))}var A=i.skill||f.skill&&f.skill[0];if(A&&(M="skill_"+r.charClass+"_"+A+"_cost",h[M]&&(x=Math.max(0,x-(h[M]||0)),!c&&h[M]&&(k[r.sourceNames[M]||M]=h[M]))),x=Math.max(0,x-(h.rcrint||0)),!c&&h.sources.rcrint)for(var M in h.sources.rcrint)r.sourceNames[M]&&(k[r.sourceNames[M]]=h.sources.rcrint[M]);if(0===x)return void delete l[e];if(!c){var P=[s(_,2,"white")],N=[o("Base cost: {0}").format(s(_,2,"white"))];if(h["rcr_"+g]){j=h["rcr_"+g]>0?"green":"red",P.push(s(1-.01*h["rcr_"+g],4,j));var C=h["rcr_"+g]===h.rcr?"rcr":"rcr_"+g;N.push("{0}: {1}".format(r.stats[C].name,s(-h["rcr_"+g],2,j,"+%")))}for(var M in y)j=y[M]>0?"green":"red",P.push(s(1-.01*y[M],4,j)),N.push("{0}: {1}".format(M,s(-y[M],2,j,"+%")));P=P.join(" &#215; ");for(var M in k){var j=k[M]>0?"green":"red";P+=(k[M]>0?" - ":" + ")+s(Math.abs(k[M]),2,j),N.push("{0}: {1}".format(M,s(-k[M],2,j,"+")))}}if(i.speed||i.fpa){var D,B,I=(d(i.speed)||1)*(1+.01*d(i.ias));if(i.fpa?(D=60/(B=i.slowest?r.calcFramesFull(i.fpa,i.weapon,!0,I,i.round,h):r.calcFramesFull(i.fpa,i.weapon,I,i.round,void 0,h)).frames,x*=i.fpa/60):D=I*(i.weapon?h.info[i.weapon].speed:h.info.aps),l[e].value=x*D,!c&&(l[e].text=o("{0} {1} per second").format(parseFloat((x*D).toFixed(2)),r.resources[g]),i.fpa)){(O=new t(e,l[e].text)).add(i.tip),O.line("Cost per tick: {0} {1}",s(x,2,"white"),r.resources[g]);var $=v(60,i.fpa);Object.keys(k).length&&(P="("+P+")"),i.fpa>$&&(P+=" &#215; "+s(i.fpa/$,0,"white")),P+=" / "+s(60/$,0,"white"),O.line("Formula: {0}",P),N.forEach(function(e){O.line(!1,e)}),O.line(!1,"Base tick rate factor: {0}",s(i.fpa/$,0,"white")+" / "+s(60/$,0,"white")),O.line("Breakpoint: {0} frames ({1} APS)",B.frames,s(D,2,"white")),l[e].tip=O.html(),i.bp&&(m.line("{0}: {1} frames ({2} APS)",o("Tick rate"),s(B.frames,0,"white"),s(D,2,"white")),B.dps=!1,m.breakpoints(h,B),u.push(B.frames))}}else l[e].value=x,c||(l[e].text=o(i.persecond?"{0} {1} per second":"{0} {1}").format(parseFloat(x.toFixed(2)),r.resources[g]),(O=new t(e,l[e].text)).add(i.tip),O.line("Formula: {0}",P),N.forEach(function(e){O.line(!1,e)}),l[e].tip=O.html())}else if(void 0!==i.value)"number"==typeof i.value?(l[e].value=i.value,c||(l[e].text=r.formatNumber(i.value,0,1e4))):c||(l[e].text=o(i.value)),i.tip&&!c&&(l[e].tip=new t(e,l[e].text).add(i.tip).html());else{var E=a(i,f);if(!E)return void delete l[e];if(l[e].value=E.value,!c){l[e].text=r.formatNumber(E.value,0,1e4);var O=new t(!0===i.total?e:o("Average {0}").format(o(e)),l[e].text);O.add(i.tip),!i.weapon&&h.info.mainhand&&h.info.offhand&&O.line("Alternates weapons"),i.thorns||!0===i.total||(i.nocrit?O.line("Damage range: {0}",n(E.base.min*E.total_factor*(1+E.chc*E.chd),E.base.max*E.total_factor*(1+E.chc*E.chd),"white")):!i.weapon&&h.info.mainhand&&h.info.offhand?(O.line("Mainhand white damage: {0}",n(h.info.mainhand.wpnbase.min*E.total_factor,h.info.mainhand.wpnbase.max*E.total_factor,"white")),O.line("Offhand white damage: {0}",n(h.info.offhand.wpnbase.min*E.total_factor,h.info.offhand.wpnbase.max*E.total_factor,"white")),E.bonus_chc&&O.line("Critical chance: {0}",s(100*E.chc,2,"green","%")),O.line("Mainhand critical damage: {0}",n(h.info.mainhand.wpnbase.min*E.total_factor*(1+E.chd),h.info.mainhand.wpnbase.max*E.total_factor*(1+E.chd),"white")),O.line("Offhand critical damage: {0}",n(h.info.offhand.wpnbase.min*E.total_factor*(1+E.chd),h.info.offhand.wpnbase.max*E.total_factor*(1+E.chd),"white"))):(O.line("White damage: {0}",n(E.base.min*E.total_factor,E.base.max*E.total_factor,"white")),E.bonus_chc&&O.line("Critical chance: {0}",s(100*E.chc,2,"green","%")),O.line("Critical damage: {0}",n(E.base.min*E.total_factor*(1+E.chd),E.base.max*E.total_factor*(1+E.chd),"white")))),"number"==typeof i.total&&O.line("Extra damage: {0}",s(.5*(E.base.min+E.base.max)*E.extra_factor*(1+E.chc*E.chd),0,"white")),O.line(o("Formula: ")+'<span class="d3-color-gray">'+o(i.thorns?"[Thorns]":"[Weapon]")+"</span>"+(i.nocrit||i.total?" &#215; "+s(1+E.chc*E.chd,2):"")+E.factors.map(function(e){return e.divide?" / "+s(e.divide):" &#215; "+s(e.factor,2)}).join("")),i.thorns?O.line(!1,"Thorns damage: {0}",s(h.thorns||0,0,"white")):("offhand"!==i.weapon&&(i.avg?O.line(!1,"Average main hand damage: {0}",s(.5*(h.info.mainhand.wpnbase.min+h.info.mainhand.wpnbase.max),0,"white")):O.line(!1,"Main hand damage: {0}",n(h.info.mainhand.wpnbase.min,h.info.mainhand.wpnbase.max,"white"))),"mainhand"!==i.weapon&&h.info.offhand&&O.line(!1,"Off hand damage: {0}",n(h.info.offhand.wpnbase.min,h.info.offhand.wpnbase.max,"white"))),E.chd&&(i.nocrit||i.total?O.line(!1,"Critical multiplier: {0}",s(1,0,"white")+" + "+s(E.chc,2,"green")+" &#215; "+s(E.chd,2,"green")):O.line(!1,"Critical damage: {0}",s(100*E.chd,1,"white","%"))),E.factors.forEach(function(e){var a=[];if(e.divide)a.push(s(1,0,"white")+" / "+s(e.divide));else if(void 0!==e.percent)if("number"==typeof e.percent)e.percent&&a.push(s(e.percent,2,"green","%"));else for(var t in e.percent)a.push(s(e.percent[t],2,"green","%")+' <span class="d3-color-gray">('+o(t)+")</span>");else a.push(s(e.factor,2));if(e.extra)for(var n=0;n<e.extra.length;++n)"object"==typeof e.extra[n]?a.push(s(e.extra[n][0],2,"green","%")+" &#215; "+s(e.extra[n][1],2,"green")):a.push(s(e.extra[n],2,"green","%"));O.line(!1,o(e.name)+": "+a.join(" + "))}),l[e].tip=O.html()}}});for(var v={};p.length;){for(var b=[],w=0;w<p.length;++w){var g=p[w],x=!0,_=0,y=new t,k=new t,M=[],S="sequence"===e[g].sum,F=0;if($.each(e[g],function(a,t){if(l[a]||"object"==typeof t&&"tip"!=a){var n=a;if("object"==typeof t&&"tip"!=a&&(n=t.src||a),l[n]&&void 0!==l[n].value||"object"==typeof t&&t.value){t="object"==typeof t?$.extend({},t):{speed:t};var i=o(t.name||a)+": ",f=1;t.count&&(t.count=d(t.count),t.count&&1!=t.count&&(f*=t.count,i+=parseFloat(t.count.toFixed(2))+"x "));var p=t.value?d(t.value):l[n].value;if(i+=s(p,0,"white"),t.factor&&(t.factor=d(t.factor),1!=t.factor&&(f*=t.factor,i+=" &#215; "+s(t.factor,2,"white"))),t.divide&&(t.divide=d(t.divide),1!=t.divide&&(f/=t.divide,i+=" / "+s(t.divide,0,"white"))),y.line(i),t.cd&&(t.cd=d(t.cd),!1!==t.cdr&&(t.cd-=h.cdrint||0,t.cd*=1-.01*(h.cdr||0)),t.cd=Math.max(.5,t.cd),y.line(!1,"Cooldown: {0} seconds",s(t.cd,2,"white")),f/=t.cd),t.pet){var m=void 0,u=t.speed?d(t.speed)*h.info.mainhand.speed:t.aps?d(t.aps):1,b=h.petias||0;!1===t.area&&(b=h.leg_taskerandtheo||0);var w=1+.01*d(t.ias)+.01*b;u*=w,"number"==typeof t.pet&&(u=60/(m=6*Math.ceil(Math.floor(t.pet/u)/6))),c||(N='<span class="d3-color-white">'+r.formatNumber(u,2,1e4)+"</span>",m?(y.line(!1,"Speed: {0} ({1} frames)",N,s(m,0,"white")),t.nobp||(M.push(m),k.line("{0}: {1} frames ({2} APS)",o(t.name||a),s(m,0,"white"),N),t.speed&&k.breakpoints(h,{pet:!0,fpa:t.pet,frames:m,speed:w*d(t.speed)}))):y.line(!1,"Speed: {0}",N)),S?F+=1/u:t.cd?f*=Math.min(1,t.cd*u):f*=u}else if(t.speed||t.aps||t.fpa){var g,u=1;if(t.speed?(g="object"==typeof e[n]&&e[n].weapon,dspeed=d(t.speed),u=dspeed*(g?h.info[g].speed:h.info.aps)):t.aps&&(u=d(t.aps)),t.ias){var A=1+.01*d(t.ias);u*=A,dspeed&&(dspeed*=A)}var P=void 0;if(t.fpa&&(u=60/(P=t.speed?r.calcFramesFull(t.fpa,g,!!t.slowest,dspeed,t.round,h):{frames:Math.floor(t.fpa/u)+("up"===t.round?1:0)}).frames),!c){var N='<span class="d3-color-white">'+r.formatNumber(u,2,1e4)+"</span>";if(P){if(y.line(!1,"Speed: {0} ({1} frames)",N,s(P.frames,1,"white")),!t.nobp&&(M.push(P.frames),k.line("{0}: {1} frames ({2} APS)",o(t.name||a),s(P.frames,0,"white"),N),t.speed&&(P.sequence=S,k.breakpoints(h,P)),t.total)){var C;if(P.framesmh&&P.framesoh){var j=Math.floor(t.total/(P.framesmh+P.framesoh)),D=t.total-j*(P.framesmh+P.framesoh);C=2*j,D&&(C+=(D>P.framesmh?1:.5)+(D>P.framesoh?1:.5))}else C=Math.ceil(t.total/P.frames);y.line(!1,"Total ticks: {0} ({1} damage)",s(C,1,"white"),'<span class="d3-color-green">'+r.formatNumber(p*(f*(t.cd||1))*C,0,1e4)+"</span>")}}else y.line(!1,"Speed: {0}",N)}S?F+=1/u:t.cd?f*=Math.min(1,t.cd*u):f*=u}else t.refspeed&&(void 0===v[t.refspeed]?x=!1:(t.cd?f*=Math.min(1,t.cd/v[t.refspeed]):f/=v[t.refspeed],y.line(!1,"Speed: {0}",s(1/v[t.refspeed],2,"white"))));_+=p*f}else x=!1}}),S&&x&&(F>.1?(_/=F,v[g]=F,(A=new t).line("Sequence length: {0} seconds",s(F,2,"white")),y=A.add(y)):x=!1),x){if(l[g].value=_,!c){l[g].text=r.formatNumber(_,0,1e4);var A=new t(o(g).replace("DPS",o("Damage Per Second")),l[g].text);A.add(e[g].tip),A.add(y),l[g].tip=A.html(),e[g].nobp||(m.add(k),u=u.concat(M))}}else b.push(g)}if(b.length>=p.length)break;p=b}for(w=0;w<p.length;++w)delete l[p[w]];if(u.length&&!c){for(var P=[],N=0;N<u.length;++N)P.push(o("{0} frames").format(u[N]));var C="Breakpoint"+(P.length>1?"s":""),P=P.join(" / ");m.header(C,P),l[C]={value:u,text:P,tip:m.html()}}return l}}();!function(){function i(i,s){var e=s.constructor;e||(e=function(){this.parent.apply(this,arguments)}),delete s.constructor;var t=function(){};t.prototype=i.prototype,e.prototype=new t,e.prototype.uber=i;for(var a in s)e.prototype[a]=s[a];return e}function s(i){function s(i,s,a,n,o){i.data("box",t);var l=!1;i.draggable({zIndex:100,cursor:"-webkit-grabbing",appendTo:"body",tolerance:o||"intersect",distance:4,helper:a,start:function(i,s){if(!t[t.type])return setTimeout(function(){$("body").css("cursor","")}),!1;n(!0),e.tooltip&&e.tooltip.disable()},revert:function(i){return e.tooltip&&e.tooltip.enable(),!i},stop:function(){if(l)return!1;setTimeout(function(){n(!1)},0)}}),s.droppable({hoverClass:"selected",accept:function(i){var s=i.data("box");return!(!s||s.type!==t.type||!s[s.type]||s===t)&&(t.accept(s[s.type])&&s.accept(t[t.type]))},drop:function(i,s){var a=s.draggable.data("box");if(!a||a.type!==t.type||a===t)return!1;var n=a[a.type];n&&t.accept(n)&&a.accept(t[t.type])&&(a._set(t[t.type]),t._set(n),e.trigger("updateSkills",!0))}})}if(this.paramList=[],this.line=$('<div class="skill-line"></div>'),i&&i.append(this.line),this.initHeader(),this.readonly&&this.header.addClass("readonly"),this.level&&this.icon.append('<span class="skill-text">'+this.level+"</span>"),this.desc=$('<span class="skill-description"></span>'),this.line.append(this.header.append(this.icon,this.desc)),this.applybox=$('<input type="checkbox"></input>'),this.params=$('<ul class="skill-info"></ul>').hide(),this.initName(),this.apply.prepend(this.applybox),this.init&&this.init(),this.header.mouseleave(function(){e.tooltip.hide()}),this.apply.click(function(i){i.stopPropagation()}),this.updateParams(),!this.readonly){var t=this;this.accept=function(i){if(!i)return!0;if("skill"===this.type&&0===this.index){var s=e.skills[e.charClass][i[0]];if(!s||s.nolmb)return!1}return!0},s(this.header,this.line,function(){return t.header.clone().addClass("class-"+e.charClass)},function(i){t.header.css("visibility",i?"hidden":"")});var a="skill"===this.type?e.getDollSkill:e.getDollPassive;a&&(a=a(this.index)),a&&s(a,a,function(){return $('<div class="class-'+e.charClass+'" style="width: 42px; height: 42px; position: absolute"></div>').append(a.clone().css("left",0))},function(i){a.toggleClass("empty",i||!t[t.type])},"pointer")}e.enableTouch(this.header)}var e=DiabloCalc,t=e.locale("ui-skills.js","skilldata"),a={weapon:{name:t("Weapon"),filter:function(i){var s=e.itemTypes[i]&&e.itemTypes[i].slot;return"onehand"===s||"twohand"===s||"offhand"===s}},armor:{name:t("Armor"),filter:function(i){return!a.weapon.filter(i)&&!a.jewelry.filter(i)}},jewelry:{name:t("Jewelry"),filter:function(i){return"ring"===i||"amulet"===i}}};e.getKanaiType=function(i){var s=e.itemById[i];if(s)for(var i in a)if(a[i].filter(s.type))return i};var n={};s.prototype.initHeader=function(){this.header=$('<span class="passive-header readonly"></span>'),this.icon=$('<span class="item-icon"></span>')},s.prototype.initName=function(){this.name=$('<span class="skill-name"></span>'),this.desc.append(this.name,'<span class="skill-separator"></span>'),this.apply=$('<label class="passive-apply">'+t("Include in stats")+"</label>"),this.desc.append(this.apply),this.desc.append(this.params)},s.prototype.updateParams=function(){this.params.empty(),this.paramList=[];var i=this.getInfo();if(i&&i.params){var s=this;$.each(i.params,function(a,n){n=i.params[a];if(!("skill"===s.type&&n.rune&&n.rune.indexOf(s.skill[1])<0)){var o=$('<span class="param-value"></span>').text(n.val+(n.percent?"%":"")),l=$("<div></div>").slider({value:n.val,min:n.min,max:n.max,step:n.step||1,slide:function(i,t){n.val=t.value,o.text(t.value+(n.percent?"%":"")),e.trigger("updateSkills"),s.onChangeParam&&s.onChangeParam()}}).click(function(i){i.stopPropagation(!0)}),r=(n.max-n.min)/(n.step||1);r<=5?l.css("width",40*r):l.css("width","");var h=$("<li></li>");h.append('<span class="param-name"><b>'+t(n.name)+":</b></span>",o,$('<div class="param-slider"></div>').append(l)),s.paramList.push({param:n,value:o,slider:l,line:h}),s.params.append(h)}})}},s.prototype.getCurInfo=function(i,s){var t=this.getCurInfo_&&this.getCurInfo_(i,s),a=e.options.showElites?1+.01*(s.edmg||0):1;if("function"==typeof i.info){if(t){t=$.extend({},t);for(var n in t)"number"==typeof t[n]&&(t[n]=e.formatNumber(t[n]*a,0,1e4))}}else if(i.info&&t){t=$.extend({},t);for(var n in t)if("string"==typeof t[n]){var o=t[n],l=void 0;"@"!=o[0]&&"%"!=o[0]||(l=o[0],o=o.substring(1)),"number"==typeof(o=e.execString(o,s,i.affixid||this.affix,i.params))?(l||(o*=a),t[n]="%"==l?Math.floor(o)+"%":e.formatNumber(o,0,1e4)):t[n]=o}}return t},s.prototype.update=function(){var i=this.getInfo();if(!i)return this.apply.hide(),void(this.info&&(this.info.remove(),this.info=void 0));var s=e.getStats(),a=!1;this.updateBox&&!0===this.updateBox(i,s)&&(a=!0),this.apply[0].lastChild.nodeValue=t(i.activetip)||t("Include in stats");var n=!1,o=this;$.each(this.paramList,function(e,t){var l={min:t.param.min,max:t.param.max,val:t.param.val};t.value.text(l.val+(t.param.percent?"%":"")),t.slider.slider({value:l.val,min:l.min,max:l.max});var r=(l.max-l.min)/(t.param.step||1);r<=5?t.slider.css("width",40*r):t.slider.css("width","");var h=l.min!==l.max&&(!1!==i.active||!1===t.param.buffs)&&!a;n=n||h,h&&t.param.show&&(h="skill"===o.type?t.param.show.call(i,o.skill[1],s):t.param.show.call(i,s)),t.line.toggle(!!h)}),this.params.toggle(n);var l;if(l=this.getCurInfo(i,s)){var r=e.skill_processInfo(l,{affix:i.affixid||this.affix,params:i.params,skill:this.skill});this.skillData=r,this.info||(this.info=$("<ul></ul>").addClass("skill-info"),"skill"===this.type&&this.skill?this.line.append(this.info):this.desc.append(this.info),this.info.click(function(){return!1})),this.info.empty(),$.each(r,function(i,s){var a=$("<span><b>"+t(i)+":</b> "+s.text+"</span>");s.tip&&a.mouseover(function(){return e.tooltip.showHtml(this,s.tip),!1}).mouseleave(function(){e.tooltip.hide()}),o.info.append($("<li></li>").append(a))})}else this.info&&(this.info.remove(),delete this.info,delete this.skillData)},e.SkillBox={},e.SkillBox.skill=i(s,{constructor:function(i,s){this.type="skill",this.index=s,this.level=[1,2,4,9,14,19][s],this.uber(i)},initHeader:function(){void 0!==this.index&&this.line.append('<span class="skill-key skill-key-'+this.index+'"></span>'),this.header=$('<span class="skill-header"></span>'),this.icon=$('<span class="skill-icon"></span>'),this.icon.append('<span class="skill-frame"></span>')},initName:function(){this.apply=$('<label class="skill-bonus">'+t("Include in stats")+"</label>"),this.header.after(this.apply),this.line.append(this.params)},init:function(){this.setSkill();var i=this;this.header.mouseover(function(){if(i.skill&&e.skills[e.charClass][i.skill[0]])e.tooltip.showSkill(this,e.charClass,i.skill[0],i.skill[1]);else{var s=i.getInfo();s&&e.tooltip.showAttack(this,s)}}),this.applybox.change(function(){var s=i.skill&&e.skills[e.charClass][i.skill[0]];s&&(s.active=this.checked,e.trigger("updateSkills"))})},getInfo:function(){if(!this.skill&&void 0!==this.index&&this.index<=1){var i=e.itemSlots.mainhand.item;return i=i&&e.itemById[i.id]&&e.itemById[i.id].type,i=i&&e.itemTypes[i].attack||"hand",e.skills.attack[i]}return this.skill&&e.skills[e.charClass][this.skill[0]]},setSkill:function(i){this.skill=i,this.desc.empty();var s=this.getInfo();this.info&&this.line.append(this.info),s?(this.icon.removeClass("empty"),void 0!==s.row?(this.icon.removeClass("skill-icon-attack"),this.icon.css("background-position",42*-s.col+"px "+84*-s.row+"px")):(this.icon.addClass("skill-icon-attack").addClass(s.id),this.icon.css("background-position","")),this.desc.append('<span class="skill-name">'+s.name+"</span>"),this.desc.append('<span class="skill-separator"></span>'),i?this.desc.append('<span class="skill-rune"><span class="skill-rune-'+i[1]+'"></span> '+("x"===i[1]?t("No Rune"):s.runes[i[1]])+"</span>"):this.desc.append(this.info)):(this.icon.addClass("empty"),this.icon.removeClass("skill-icon-attack"),this.desc.append('<span class="skill-none">'+t("Choose Skill")+"</span>"),this.desc.append('<span class="skill-separator"></span>')),this.updateParams()},_set:function(i){this.setSkill(i)},updateBox:function(i,s){this.applybox.prop("checked",!1!==i.active),this.apply.toggle(!!(i.activeshow?i.activeshow(this.skill[1],s):e.getSkillBonus(this.skill,s)))},getCurInfo_:function(i,s){if("function"==typeof i.info)return i.info(this.skill[1],s);if(i.info&&this.skill){var e=i.info[this.skill[1]];return i.info["*"]&&(e=$.extend({},i.info["*"],e)),e}return i.info?i.info:void 0}}),e.SkillBox.passive=i(s,{constructor:function(i,s){this.type="passive",this.index=s,s>=0?this.level=[10,20,30,70][s]:this.readonly=!0,this.uber(i)},initHeader:function(){this.header=$('<span class="passive-header"></span>'),this.icon=$('<span class="passive-icon"></span>'),this.icon.append('<span class="passive-frame"></span>')},init:function(){this.setPassive();var i=this;this.header.mouseover(function(){i.passive&&e.passives[e.charClass][i.passive]&&e.tooltip.showSkill(this,e.charClass,i.passive)}),this.applybox.click(function(s){var t=i.passive&&e.passives[e.charClass][i.passive];t&&(t.active=this.checked,e.trigger("updateSkills")),s.stopPropagation()})},getInfo:function(){return this.passive&&e.passives[e.charClass][this.passive]},setPassive:function(i){this.passive=i;var s=i&&e.passives[e.charClass][i];s?(this.applybox.prop("checked",!1!==s.active),this.icon.removeClass("empty"),this.icon.css("background-position",42*-s.index+"px 0"),this.name.removeClass().addClass("skill-name").text(s.name)):(this.icon.addClass("empty"),this.name.removeClass().addClass("skill-none").text(t("Choose Skill"))),this.updateParams()},_set:function(i){this.setPassive(i)},updateBox:function(i,s){var t=e.getPassiveBonus(this.passive,s);this.apply.toggleClass("always",void 0===i.active),this.applybox.prop("disabled",void 0===i.active),this.applybox.prop("checked",!1!==i.active),this.apply.toggle(!!t)},getCurInfo_:function(i,s){return"function"==typeof i.info?i.info(s):i.info}}),e.SkillBox.gem=i(s,{constructor:function(i,s){this.type="gem",this.gem=s,this.readonly=!0,this.uber(i)},getInfo:function(){return this.gem&&e.legendaryGems[this.gem]},init:function(){var i=e.legendaryGems[this.gem];this.applybox.prop("disabled",!!i.always),this.apply.toggleClass("always",!!i.always),this.apply.toggle(i.always||void 0!==i.active),this.icon.css("background-image","url("+e.getItemIcon(this.gem)+")");var s=this;this.header.mouseover(function(){s.gem&&e.tooltip.showGem(this,s.gem,e.getStats().gems[s.gem])}),this.applybox.click(function(i){var t=s.gem&&e.legendaryGems[s.gem];t&&(t.active=this.checked,e.trigger("updateSkills")),i.stopPropagation()})},updateBox:function(i,s){var e=!1;if(i.check&&"function"==typeof i.buffs){var a=i.buffs(s.gems[this.gem]||0,s);this.apply.toggle(!!a),a||(e=!0)}else{var n=!!i.effects[0].stat;s.gems[this.gem]&&s.gems[this.gem]>=25&&(n=n||!!i.effects[1].stat),this.apply.toggle(n)}return this.applybox.prop("checked",!(!i.always&&!i.active)),this.name.html(i.name+(s.gems[this.gem]?' <span class="gem-rank">&#x2013; '+t("Rank {0}").format(s.gems[this.gem])+"</span>":"")),e},getCurInfo_:function(i,s){return"function"==typeof i.info?i.info(s.gems[this.gem],s):i.info}}),e.SkillBox.affix=i(s,{constructor:function(i,s){this.type="affix",this.affix=s,this.readonly=!0,this.uber(i)},init:function(){var i=e.itemaffixes[this.affix];this.apply.toggle(void 0!==i.active);var s=this;if(this.header.mouseover(function(){var i=e.getStats();i.affixes[s.affix]&&e.tooltip.showItem(this,i.affixes[s.affix].slot)}),this.applybox.click(function(i){var t=s.affix&&e.itemaffixes[s.affix];t&&(t.active=this.checked,e.trigger("updateSkills")),i.stopPropagation()}),i.boxnames){this.boxes=[],this.boxlabels=[];for(var a=0;a<i.boxnames.length;++a){var n=$('<input type="checkbox"></input>'),o=$('<label class="passive-apply">'+t(i.boxnames[a])+"</label>").prepend(n);this.boxes.push(n),this.boxlabels.push(o),this.params.before(o),o.toggle(!1!==i.active),n.click(function(s){return function(){i.boxvals[s]=$(this).prop("checked"),e.trigger("updateSkills")}}(a))}}},getInfo:function(){return this.affix&&e.itemaffixes[this.affix]},updateBox:function(i,s){this.applybox.prop("checked",!0===i.active);var a=e.getSlotId(s.affixes[this.affix].slot),n=e.itemById[a];if(n&&this.icon.css("background-image","url("+e.getItemIcon(n.id)+")"),s.affixes[this.affix].set){var o=e.itemSets[s.affixes[this.affix].set].name;s.affixes[this.affix].pieces&&(o+=' <span class="gem-rank">&#x2013; '+t("{0} pieces").format(s.affixes[this.affix].pieces)+"</span>"),this.name.html(o)}else n&&this.name.text(n.name);if(this.boxlabels)for(var l=0;l<this.boxlabels.length;++l)this.boxlabels[l].toggle(!1!==i.active)},getCurInfo_:function(i,s){return"function"==typeof i.info?i.info(s.affixes[this.affix].value,s):i.info}}),e.SkillBox.kanai=i(s,{constructor:function(i,s){this.type="kanai",this.kanai=s,this.readonly=!0,this.uber(i)},init:function(){var i=this;this.onInner=!1,this.namebox=$('<select class="skill-namelist empty"></select>'),this.fillnames(),this.desc.addClass("chosen-noframe"),this.name.replaceWith(this.namebox),this.namebox.chosen({disable_search_threshold:10,inherit_select_classes:!0,allow_single_deselect:!0,search_contains:!0,placeholder_text_single:t("Choose {0}").format(a[this.kanai].name),populate_func:function(){i.fillnames()}}).change().change(function(){i.onChangeItem(),e.trigger("updateSkills")}),e.chosenTips(this.namebox,function(s){if(e.itemById[s]){i.onInner=!0;var t=e.itemById[s],a=t.required.custom.args;void 0===a&&(a=1),a=1===a?"min"===t.required.custom.best?[t.required.custom.min||1]:[t.required.custom.max||1]:void 0,e.tooltip.showItem(this,s,a)}}),e.chosen_addIcons(this.namebox,function(i){var s=e.itemById[i];if(s){var t=e.itemIcons,a=t?t[i]:void 0;return void 0!==a?'<span style="background: url(css/items/'+s.type+".png) 0 -"+24*a[0]+'px no-repeat"></span>':void 0}}),e.chosen_fixSearch(this.namebox,function(i,s){var t=e.itemById[i];if(t)return!!s(t.name)||(!!(t.required&&t.required.custom&&s(t.required.custom.format))||void 0)}),this.setItemEffect(),this.header.mouseover(function(){if(i.onInner)return i.onInner=!1,!0;var s=i.namebox.val();if(e.itemById[s]){var t=e.itemById[s],a=t.required.custom.args;void 0===a&&(a=1),a=1===a?"min"===t.required.custom.best?[t.required.custom.min||1]:[t.required.custom.max||1]:void 0,e.tooltip.showItem(this,s,a)}}),this.applybox.click(function(s){var t=i.getInfo();t&&(t.active=this.checked,e.trigger("updateSkills")),s.stopPropagation()})},fillnames:function(){var i=this,s=this.namebox.val();this.namebox.empty(),this.namebox.append('<option value="">'+(e.noChosen?t("Choose {0}").format(a[this.kanai].name):"")+"</option>");var n={};$.each(e.items,function(s,o){if(o.required&&o.required.custom&&!1!==o.required.custom.cube&&(!e.options.hideLegacy||o.suffix!==t("Legacy"))){var l=o.required.custom.id;if(!(o.classes&&o.classes.indexOf(e.charClass)<0)){var r=e.itemTypes[o.type];r.classes&&r.classes.indexOf(e.charClass)<0||e.itemPowerClasses&&e.itemPowerClasses[l]&&e.itemPowerClasses[l]!==e.charClass||a[i.kanai].filter(o.type)&&(o.required.custom.args<0||(n[o.type]||(n[o.type]=[]),n[o.type].push(o)))}}});for(var o in n){var l='<optgroup label="'+e.itemTypes[o].name+'">';n[o].sort(function(i,s){return i.name.localeCompare(s.name)});for(var r=0;r<n[o].length;++r){var h=n[o][r],p="";h.id===s&&(p='" selected="selected'),l+='<option class="item-info-icon quality-'+(h.quality||"rare")+'" value="'+h.id+p+'">'+h.name+(h.suffix?" ("+h.suffix+")":"")+"</option>"}this.namebox.append(l+"</optgroup")}},getInfo:function(){return n[this.namebox.val()]},onChangeItem:function(){if(this.boxlabels){for(r=0;r<this.boxlabels.length;++r)this.boxlabels[r].remove();delete this.boxlabels}var i=this.namebox.val(),s=e.itemById[i],a=this.namebox;if(e.noChosen||(a=a.next()),a.toggleClass("empty",!s),!s)return this.icon.hide(),this.apply.hide(),void this.updateParams();this.icon.css("background-image","url("+e.getItemIcon(i)+")"),this.icon.show();var o=s.required&&s.required.custom;o&&e.itemaffixes[o.id]&&this.apply.toggle(void 0!==e.itemaffixes[o.id].active);var l=n[i];if(l||(l={},o&&e.itemaffixes[o.id]&&((l=e.itemaffixes[o.id]).affixid=o.id),n[i]=l),l.boxnames){this.boxes=[],this.boxlabels=[];for(var r=0;r<l.boxnames.length;++r){var a=$('<input type="checkbox"></input>'),h=$('<label class="passive-apply">'+t(l.boxnames[r])+"</label>").prepend(a);this.boxes.push(a),this.boxlabels.push(h),this.params.before(h),h.toggle(!1!==l.active),a.click(function(i){return function(){l.boxvals[i]=$(this).prop("checked"),e.trigger("updateSkills")}}(r))}}this.updateParams()},setItemEffect:function(i){this.namebox.val(i),this.namebox.trigger("chosen:updated"),this.onChangeItem()},getItemPair:function(){var i=this.namebox.val();if(e.itemById[i])return i},setItemPair:function(i){i instanceof Array?this.setItemEffect(i[0]):this.setItemEffect(i)},getItemAffix:function(){var i=e.itemById[this.namebox.val()];return i&&i.required&&i.required.custom&&i.required.custom.id},getItemAffixValue:function(){var i=e.itemById[this.namebox.val()],s=i.required.custom.args;return void 0===s&&(s=1),1===s?"min"===i.required.custom.best?i.required.custom.min||1:i.required.custom.max||1:1},updateBox:function(i,s){if(this.applybox.prop("checked",!0===i.active),this.shown=!0,i.info||void 0!==i.active||i.params||(this.shown=!1),i.check){this.shown=!1;var e=[this.getItemAffixValue()];"function"==typeof i.info?i.info(e,s)&&(this.shown=!0):i.info&&(this.shown=!0),(void 0!==i.active||i.params)&&("function"==typeof i.buffs?i.buffs(e,s)&&(this.shown=!0):i.buffs&&(this.shown=!0))}if(this.apply.toggle(this.shown&&void 0!==i.active),!this.shown)return this.params.hide(),void(this.info&&(this.info.remove(),delete this.info));if(this.boxlabels)for(var t=0;t<this.boxlabels.length;++t)this.boxlabels[t].toggle(!1!==i.active)},getCurInfo_:function(i,s){return"function"==typeof i.info?i.info(s[i.affixid],s):i.info}}),e.SkillBox.buff=i(s,{constructor:function(i,s){this.type="buff",this.buff=s,this.readonly=!0,this.uber(i)},initHeader:function(){"skill"===this.buff.type||"custom"===this.buff.type?e.SkillBox.skill.prototype.initHeader.call(this):"passive"===this.buff.type?e.SkillBox.passive.prototype.initHeader.call(this):this.uber.prototype.initHeader.call(this)},initName:function(){"skill"===this.buff.type?e.SkillBox.skill.prototype.initName.call(this):this.uber.prototype.initName.call(this)},init:function(){var i=!1,s=this;if("skill"===this.buff.type){o=e.skills[this.buff.charClass][this.buff.id];if(this.icon.removeClass("empty"),this.icon.css("background-position",42*-o.col+"px "+84*-o.row+"px"),this.desc.append('<span class="skill-name">'+o.name+"</span>"),this.desc.append('<span class="skill-separator"></span>'),this.buff.multiple){this.header.removeClass("skill-header").addClass("passive-header"),this.runebox={};for(var a in this.buff.runes)this.runebox[a]=$('<input type="checkbox"></input>').click(function(i){return function(){s.buff.runevals[i]=$(this).prop("checked"),e.trigger("updateSkills")}}(a)),this.desc.append($('<label class="rune-box"></label>').append(this.runebox[a],'<span class="skill-rune"><span class="skill-rune-'+this.buff.runelist+'"></span> '+this.buff.runes[a]+"</span>").mouseover(function(i){return function(){return e.tooltip.showSkill(this,s.buff.charClass,s.buff.id,i,!0),!1}}(a)).mouseleave(function(){e.tooltip.hide()}));this.apply.hide()}else if(this.buff.runelist.length>1||"*"===this.buff.runelist){this.runebox=$('<select class="skill-runelist"></select>');for(var a in this.buff.runes)this.runebox.append('<option class="skill-rune-option rune-'+a+'" value="'+a+'">'+this.buff.runes[a]+"</option>");this.desc.addClass("chosen-noframe"),this.desc.append(this.runebox);var n=void 0;this.runebox.chosen({disable_search:!0,inherit_select_classes:!0}).change(function(){var i=$(this).next().find("span").first();n&&i.removeClass(n),n="rune-"+$(this).val(),i.addClass("skill-rune-option "+n)}).change().change(function(){s.buff.runevals=$(this).val(),e.trigger("updateSkills")}),e.chosenTips(this.runebox,function(t){"*"!=t&&(i=!0,e.tooltip.showSkill(this,s.buff.charClass,s.buff.id,t,!0))})}else this.desc.append('<span class="skill-rune"><span class="skill-rune-'+this.buff.runelist+'"></span> '+this.buff.runes[this.buff.runelist]+"</span>");this.header.mouseover(function(){if(s.buff.multiple)e.tooltip.showSkill(this,s.buff.charClass,s.buff.id);else{if(i)return i=!1,!0;e.tooltip.showSkill(this,s.buff.charClass,s.buff.id,s.runebox?s.runebox.val():s.buff.runelist)}})}else if("passive"===this.buff.type){var o=e.passives[this.buff.charClass][this.buff.id];this.icon.removeClass("empty"),this.icon.css("background-position",42*-o.index+"px 0"),this.name.removeClass().addClass("skill-name").text(o.name),this.header.mouseover(function(){e.tooltip.showSkill(this,s.buff.charClass,s.buff.id)})}else if("affix"===this.buff.type){var l=e.itemById[this.buff.item];l&&(this.icon.css("background-image","url("+e.getItemIcon(l.id)+")"),this.name.text(l.name),this.header.mouseover(function(){var i=void 0;s.buff.params&&(i=[s.buff.params[0].val]),e.tooltip.showItem(this,l.id,i)}))}else"gem"===this.buff.type?(this.icon.css("background-image","url("+e.getItemIcon(this.buff.id)+")"),this.name.text(e.legendaryGems[this.buff.id].name),this.header.mouseover(function(){e.tooltip.showGem(this,s.buff.id,25)})):"custom"===this.buff.type&&(this.icon.removeClass("empty"),this.icon.css("background-position",42*-this.buff.icon+"px 0"),this.name.removeClass().addClass("skill-name").text(this.buff.name),this.header.mouseover(function(){e.tooltip.showCustomSkill(this,s.buff)}));if(this.applybox.prop("checked",this.buff.active),this.applybox.change(function(){if(s.buff.active=this.checked,s.boxlabels)for(var i=0;i<s.boxlabels.length;++i)s.boxlabels[i].toggle(this.checked);s.buff.params&&s.params.toggle(this.checked),e.trigger("updateSkills")}),this.buff.boxnames){this.boxes=[],this.boxlabels=[];for(var r=0;r<this.buff.boxnames.length;++r){var h=$('<input type="checkbox"></input>'),p=$('<label class="'+("skill"===this.buff.type?"skill-bonus":"passive-apply")+'">'+t(this.buff.boxnames[r])+"</label>").prepend(h);this.boxes.push(h),this.boxlabels.push(p),this.params.before(p),p.toggle(!1!==this.buff.active||this.buff.multiple),h.click(function(i){return function(){s.buff.boxvals[i]=$(this).prop("checked"),e.trigger("updateSkills")}}(r))}}this.updateBoxes()},updateBoxes:function(){if(this.apply.toggle(!this.buff.multiple&&void 0!==this.buff.active),this.buff.multiple)for(var i in this.runebox)this.runebox[i].prop("checked",!!this.buff.runevals[i]);else this.applybox.prop("checked",!!this.buff.active),this.runebox&&this.runebox.val(this.buff.runevals).trigger("chosen:updated");if(this.boxlabels)for(s=0;s<this.boxlabels.length;++s)this.boxlabels[s].toggle(!1!==this.buff.active||!!this.buff.multiple);if(this.boxes)for(var s=0;s<this.boxes.length;++s)this.boxes[s].prop("checked",!(!this.buff.boxvals||!this.buff.boxvals[s]));this.buff.params&&this.params.toggle(!1!==this.buff.active||!!this.buff.multiple),this.updateParams()},getInfo:function(){return this.buff},onChangeParam:function(){this.buff&&"affix"===this.buff.type&&e.tooltip.getNode()===this.header[0]&&e.tooltip.showItem(this.header[0],this.buff.item,[this.buff.params[0].val])}})}();!function(){function e(e){e.signin=void 0,e.signout=void 0,e.register=void 0,e.options=void 0,$.cookie("user_name")?(e.signout=$("<span>"+t("sign&nbsp;out")+"</span>"),e.signout.click(function(){$.ajax({url:"account",data:{action:"signout"},type:"POST",dataType:"json",success:function(e){s()},error:function(e){s()}})}),e.options=$("<span>"+t("settings")+"</span>"),e.options.click(function(){i.open("options")}),e.div.empty().append(t("Welcome, {0}").format($.cookie("user_name"))+" (",e.signout,", ",e.options,")"),e.updater&&e.updater.call(e.div,!0)):(e.signin=$("<span>"+t("Sign in")+"</span>"),e.signin.click(function(){i.open("signin")}),e.register=$("<span>"+t("register")+"</span>"),e.register.click(function(){i.open("register")}),e.div.empty().append(e.signin,t(" or "),e.register,(e.suffix||"")+"."),e.updater&&e.updater.call(e.div,!1))}function s(){$("body").toggleClass("logged-in",!!$.cookie("user_name")),$.cookie("user_name")&&(DiabloCalc.session.signedin=!0);for(var s=0;s<a.length;++s)e(a[s])}var t=DiabloCalc.locale("account.js"),i=new function(){this.div=$('<div class="signin-dialog"></div>'),this.tip=$('<p class="tip"></p>'),this.name=$('<input type="text" name="user_name" class="text"></input>'),this.email=$('<input type="text" name="user_email" class="text"></input>'),this.reset_code=$('<input type="text" name="user_reset_code" class="text"></input>'),this.password=$('<input type="password" name="user_password" class="text"></input>'),this.password_old=$('<input type="password" name="user_password_old" class="text"></input>'),this.password_repeat=$('<input type="password" name="user_password_repeat" class="text"></input>'),this.remember=$('<input type="checkbox" name="user_remember" class="checkbox"></input>'),this.div.append(this.tip),this.fieldset=$("<fieldset></fieldset>"),this.form=$("<form></form>").append(this.fieldset),this.div.append(this.form);var e=DiabloCalc.localeTable.account,i=this;this.reset_fields=function(e){this.name.val(""),this.email.val("options"===this.mode?$.cookie("user_email")||"":""),this.reset_code.val("reset"===this.mode?e:""),this.password.val(""),this.password_old.val(""),this.password_repeat.val("")},this.open=function(s,t){this.mode=s,this.reset_fields(t),this.fieldset.empty();var a=210;for(var n in e[s].fields){var o=$("<label>"+e[s].fields[n]+"</label>");"checkbox"===this[n].attr("type")?(o.prepend(this[n]),a+=5):(o.append(this[n]),a+=55),this.fieldset.append(o)}this.fieldset.append('<input type="submit" tabindex="-1" style="position:absolute; top:-1000px"></input>'),this.tip.text(e[s].tip);var r={};for(var d in e[s].buttons)r[e[s].buttons[d]]=function(e){return function(){i.handlers[e].call(i)}}(d);this.div.dialog({height:a,title:e[s].title,buttons:r}).dialog("open")},this.all_fields=$([]).add(this.name).add(this.email).add(this.reset_code).add(this.password).add(this.password_repeat).add(this.password_old),this.all_fields.focus(function(){$(this).removeClass("error")}),this.set_tip=function(e){this.tip.text(e).addClass("highlight"),setTimeout(function(){i.tip.removeClass("highlight",1500)},500)},this.check_length=function(e,s,i,a){return!(e.val().length<i||e.val().length>a)||(e.addClass("error"),this.set_tip(t("Length of {0} must be between {1} and {2}.").format(s,i,a)),!1)},this.check_regexp=function(e,s,t){return!!t.test(e.val())||(e.addClass("error"),this.set_tip(s),!1)},this.validate=function(){var s=!0;this.all_fields.removeClass("error");var i=e[this.mode].fields;if(i.name&&(s=(s=s&&this.check_length(this.name,"username",2,16))&&this.check_regexp(this.name,t("Username may only consist of a-z and 0-9."),/^[a-z0-9._]+$/i)),i.reset_code&&(s=s&&this.check_regexp(this.reset_code,t("Invalid reset code"),/^[0-9a-f]{32}$/)),i.email&&(this.email.val()||"recover"===this.mode)&&(s=(s=s&&this.check_length(this.email,"e-mail",4,128))&&this.check_regexp(this.email,t("Specify a valid e-mail address"),/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/)),i.password&&(this.password.val()||"options"!==this.mode)&&(s=s&&this.check_length(this.password,"password",6,64),i.password_repeat&&s&&this.password.val()!==this.password_repeat.val()&&(this.password_repeat.addClass("error"),this.set_tip(t("Passwords do not match.")),s=!1)),i.password_old&&(s=s&&this.check_length(this.password_old,"password",6,64)),s){var a={action:this.mode};return i.name&&(a.user_name=this.name.val()),i.email&&this.email.val()&&(a.user_email=this.email.val()),i.reset_code&&(a.reset_code=this.reset_code.val()),i.password&&(this.password.val()||"options"!==this.mode)&&(a.password_hash=MD5("SmartSalt"+this.password.val())),i.password_old&&(a.password_old_hash=MD5("SmartSalt"+this.password_old.val())),i.remember&&this.remember.prop("checked")&&(a.user_remember=!0),i.password_old&&(a.user_name=$.cookie("user_name")),a}},this.hostname="",this.handlers={},this.default_handler=function(){var e=this.validate();e&&$.ajax({url:"account",data:e,type:"POST",dataType:"json",success:function(e){"OK"===e.code?(s(),"options"===i.mode||"recover"===i.mode?("recover"===i.mode?i.set_tip(t("Password reset link sent.")):i.set_tip(t("Settings updated.")),i.reset_fields()):i.div.dialog("close")):e.errors&&e.errors.length?i.set_tip(e.errors[0]):i.set_tip(t("Unknown error."))},error:function(e){i.set_tip(t("Unknown error."))}})},this.handlers.register=this.default_handler,this.handlers.signin=this.default_handler,this.handlers.cancel=function(){this.div.dialog("close")},this.handlers.lostpassword=function(){setTimeout(function(){i.open("recover")},0)},this.handlers.already=function(){setTimeout(function(){i.open("reset")},0)},this.handlers.recover=this.default_handler,this.handlers.reset=this.default_handler,this.handlers.update=this.default_handler,this.form.on("submit",function(e){e.preventDefault(),i.default_handler()}),this.div.dialog({autoOpen:!1,height:400,width:400,modal:!0,close:function(){i.form[0].reset(),i.all_fields.removeClass("error")}})},a=[];DiabloCalc.account={makeLine:function(s,t){var i={div:$('<div class="signin-line"></div>'),suffix:s,updater:t};return e(i),a.push(i),i.div},reset:function(e){i.open("reset",e)},userName:function(){return $.cookie("user_name")}}}();!function(){function t(t){var e=[];if(t.max){var s=t.min,i=t.max;"min"===t.best&&(s=t.max,i=t.min);(a=Math.round((s+(i-s)*p.Optimizer.perfection)/(t.step||1))*(t.step||1))<t.min&&(a=t.min),a>t.max&&(a=t.max),e.push(a)}if(t.max2){var a=Math.round(t.min2+(t.max2-t.min2)*p.Optimizer.perfection);a<t.min2&&(a=t.min2),a>t.max2&&(a=t.max2),e.push(a)}if(t.args<0)for(var o in p.passives[p.charClass]){e.push(o);break}return e}function e(t,e,s){if(!t.affixes.all[e])return!1;var i=p.stats[e];if(!i)return!1;if(i.secondary&&t.state.secondary>=t.affixes.secondary)return!1;if(!i.secondary&&t.state.primary>=t.affixes.primary)return!1;if(t.state.groups[i.group||e])return!1;i.secondary?t.state.secondary+=1:t.state.primary+=1,t.state.groups[i.group||e]=!0;var a=s||t.affixes.all[e];if(t.imported&&t.imported.stats&&t.imported.stats[e]){for(var o=!1,n=0;n<a.length;++n)a[n]>t.imported.stats[e][n]&&(o=!0);o||(a=$.extend([],t.imported.stats[e]))}if(t.stats[e])if(i.dr)for(n=0;n<a.length;++n)t.stats[e][n]=100-(100-(t.stats[e][n]||0))*(100-a[n])/100;else for(n=0;n<a.length;++n)t.stats[e][n]=(t.stats[e][n]||0)+a[n];else t.stats[e]=a;return!0}function s(s){function i(e,s){var i={};for(var a in e){var n=p.stats[n];n&&o&&n.classes&&n.classes.indexOf(o)<0||(s&&s[a]?i[a]=s[a]:i[a]="sockets"===a?[e[a].max]:t(e[a]))}return i}var a=p.getSlot(s);if(a){(a=$.extend(!0,{},a)).info=p.itemById[a.id];var o=p.itemTypes[a.info.type].class;!o&&a.info.set&&(o=p.itemSets[a.info.set].class);var n=p.getStatCount(a.id);a.affixes={primary:n[0],secondary:n[1],all:i(p.getItemAffixesById(a.id,a.ancient,!1))},a.state={primary:0,secondary:0,groups:{}};for(var r=p.getItemPreset(a.id),l=0;l<r.length;++l)r[l]=p.smartListStats(r[l],a.affixes.all,o);a.affixes.preset=r;var c=p.getItemAffixesById(a.id,a.ancient,"only"),f=a.stats;a.stats=i(c,f);for(var d in c){(h=p.stats[d])&&(h.secondary?a.state.secondary+=1:h.base||(a.state.primary+=1),c[d].noblock||(a.state.groups[h.group||d]=!0))}if(p.Optimizer.unlock&&(delete a.enchant,delete a.imported),a.affixes.all.sockets){a.gems=[];if("onehand"===(s=p.itemTypes[a.info.type].slot)||"twohand"===s){var m=p.Optimizer.useGift;if(!m&&a.imported&&f.sockets){var u=0;for(var d in f)!p.stats[d]||p.stats[d].secondary||p.stats[d].caldesanns||p.stats[d].base||(u+=1);u>a.affixes.primary&&(m=!0)}m&&(a.stats.sockets=a.affixes.all.sockets,a.state.groups.sockets=!0)}}a.imported&&(a.enchant?a.affixes.preset=[[a.enchant]]:a.affixes.preset=[]);for(var d in f){var h=p.stats[d];h&&(h.caldesanns?a.stats[d]=f[d]:!a.imported||h.base||c[d]||"sockets"===d&&a.stats.sockets||(a.enchant&&a.enchant!==d?e(a,d,f[d]):a.enchant||a.affixes.preset.push([d])))}return a}}function i(t,e){var s=p.getSlot(t);if(s){if(s=$.extend(!0,{},s),s.stats={},Object.keys(e.stats).sort(function(t,e){return(p.stats[t]&&p.stats[t].prio||0)-(p.stats[e]&&p.stats[e].prio||0)}).forEach(function(t){s.stats[t]=e.stats[t]}),s.gems&&s.stats.sockets&&s.stats.sockets[0]){e.gems||(e.gems=[]);for(var i=0;i<s.gems.length&&e.gems.length<s.stats.sockets[0];++i)s.gems[i]&&p.legendaryGems[s.gems[i][0]]&&e.gems.push(s.gems[i])}if(s.gems=e.gems,s.imported=e.imported,s.imported){for(var a in s.stats)if(e.affixes.all[a]&&(!p.stats[a]||!p.stats[a].caldesanns)){if(!(a in s.imported.stats)){s.enchant=a;break}if(s.imported.stats[a].length>=1&&s.stats[a][0]!==s.imported.stats[a][0]){s.enchant=a;break}if(s.imported.stats[a].length>=2&&s.stats[a][1]!==s.imported.stats[a][1]){s.enchant=a;break}}s.enchant||(s.enchant=s.imported.enchant)}else delete s.enchant;p.setSlot(t,s)}}function a(t){return t=$.extend({},t),t.stats=$.extend(!0,{},t.stats),t.state=$.extend(!0,{},t.state),t.gems&&(t.gems=$.extend(!0,[],t.gems)),t}function o(t){t=a(t);for(var s=0,i=0;i<t.affixes.preset.length;++i){var o=t.affixes.preset[i];if(o.length){for(var n=!1,r=void 0,l=0;l<o.length;++l){if(t.stats[o[l]]){if(t.imported&&t.imported.stats&&t.imported.stats[o[l]]){n=!0;for(var c=0;c<t.stats[o[l]].length;++c)t.stats[o[l]][c]!==t.imported.stats[o[l]][c]&&(n=!1)}else n=!0;if(n)break}r||p.stats[o[l]].classes&&!(p.stats[o[l]].classes.indexOf(p.charClass)>=0)||(r=o[l])}if(!n&&!e(t,r||o[0],t.imported&&t.imported.stats&&t.imported.stats[r||o[0]])&&++s>1)return!1}}return t}function n(t){return t.finishLoad(),p.addSkillBonuses&&p.addSkillBonuses(t),t.finalize(),t}function r(t,s,i,r,l){function c(t,i,l){if(t=a(t),e(t,i,l)&&o(t)){var p=u.clone();p.addItem(s,t),n(p);return(l=d.value(r,p))>k&&(k=l,y=t),t}}var d=f[i],m=t[s],u=new p.Stats(p.charClass);u.startLoad();for(var h in t)h!==s&&u.addItem(h,t[h]);if(l)d.stats(r,m).forEach(function(t){var s=a(m);e(s,t)&&(m=s)}),t[s]=m;else{for(var v=d.stats(r,m).filter(function(t){return e(a(m),t)}),g={0:m},k=0,y=m,x=1;x<1<<v.length;++x){var b=-1;if(m.imported&&!m.enchant)for(j=0;j<v.length;++j)x&1<<j&&!m.imported.stats[v[j]]&&(b=j);if(b<0)for(b=0;!(x&1<<b);)++b;var S=x-(1<<b);if(g[S])if(m.imported&&!m.enchant&&m.imported.stats[v[b]]){g[x]=c(g[S],v[b],m.imported.stats[v[b]]);for(j=0;j<v.length;++j)x&1<<j&&g[S=x-(1<<j)]&&c(g[S],v[j])}else{var z=c(g[S],v[b]);m.imported&&!m.enchant||(g[x]=z)}}m=t[s]=y}if(m.stats.sockets&&m.gems.length<m.stats.sockets[0]){var $=p.itemTypes[m.info.type].slot,C=$&&(p.itemSlots[$]||p.metaSlots[$])||{};if("jewelry"!==C.socketType){var O="weapon"===C.socketType||"head"===C.socketType?C.socketType:"other",_=m.gems.length,I=m.stats.sockets[0],T=void 0;for(var w in p.gemColors){for(j=_;j<I;++j)m.gems[j]=[p.gemColors[w][O].amount.length-1,w];var E=u.clone();E.addItem(s,m),n(E);var B=d.value(r,E);B>k&&(k=B,T=w)}if(T)for(var j=_;j<I;++j)m.gems[j]=[p.gemColors[T][O].amount.length-1,T];else m.gems.length=_}}return m}function l(t,s,i,n){var r=t[s],l=a(t[s]);if(e(l,i)&&o(l)&&(r=t[s]=l),r.stats.sockets&&r.gems.length<r.stats.sockets[0]){var c=p.itemTypes[r.info.type].slot,f=c&&(p.itemSlots[c]||p.metaSlots[c])||{};if("jewelry"!==f.socketType){var d="weapon"===f.socketType||"head"===f.socketType?f.socketType:"other",m=void 0;for(var u in p.gemColors)if(p.gemColors[u][d].stat===i){m=u;break}if(m)for(;r.gems.length<r.stats.sockets[0];)r.gems.push([p.gemColors[m][d].amount.length-1,m])}}return r}var p=DiabloCalc,c=DiabloCalc.locale("ui-equipment.js","ui-skills.js","skilldata");p.Optimizer={perfection:1,useGift:!0,unlock:!1};var f={dps:{name:c("Damage"),options:{speed:{type:"checkbox",name:c("Attack speed")},elem:{type:"select",options:function(){var t={"":c("No Element")};for(var e in{phy:1,fir:1,col:1,psn:1,arc:1,lit:1,hol:1})(!p.stats["dmg"+e].classes||p.stats["dmg"+e].classes.indexOf(p.charClass)>=0)&&(t["dmg"+e]=p.elements[e]);return t}},skill:{type:"select",options:function(){var t={"":c("No Skill")},e=p.extendStats([],"skill_"+p.charClass);for(var s in p.skills[p.charClass])e.indexOf("skill_"+p.charClass+"_"+s)>=0&&(t["skill_"+p.charClass+"_"+s]=p.skills[p.charClass][s].name);return t}},elite:{type:"checkbox",name:c("vs Elites")}},stats:function(t,e){var s=["wpnphy","damage","chc","chd",p.classes[p.charClass].primary];if(t.elem&&s.push(t.elem),t.skill&&s.push(t.skill),e){for(var i=void 0,a=0;a<e.affixes.preset.length&&!i;++a)for(var o=0;o<e.affixes.preset[a].length;++o){var n=e.affixes.preset[a][o];if(p.stats[n]&&p.stats[n].damage){i=n;break}}i&&(s[0]=i)}var r=e&&p.itemTypes[e.info.type].slot;return t.speed&&s.push("onehand"===r||"twohand"===r?"weaponias":"ias"),t.elite&&s.push("edmg"),s},value:function(t,e){var s=t.speed?e.info.dps:e.info.dph;return t.elem&&(s*=1+.01*(e[t.elem]||0)),t.elite&&(s*=1+.01*(e.edmg||0)),t.skill&&(s*=(1+.01*((e.damage||0)+(e[t.skill]||0)))/(1+.01*(e.damage||0))),s}},toughness:{name:c("Toughness"),options:{},stats:function(t,e){return["vit","life","resall","armor","resphy","resfir","rescol","respsn","resarc","reslit","edef","meleedef","rangedef"]},value:function(t,e){return e.info.toughnessmin}},healing:{name:c("Healing"),options:{},stats:function(t,e){var s=e&&p.itemTypes[e.info.type].slot,i=["regen","lph","laek","healbonus"];return t.speed&&i.push("onehand"===s||"twohand"===s?"weaponias":"ias"),i},value:function(t,e){return e.info.recoverymin}}},d=$.extend({},f);p.Optimizer.priority=[{stat:"sockets",options:{}},{stat:"dps",options:{}},{stat:"toughness",options:{}}],p.Optimizer.getOptions=function(t){for(var e=0;e<this.priority.length;++e)if(this.priority[e].stat===t)return this.priority[e].options},p.Optimizer.optimizeAll=function(){p.importStart();var t={};for(var e in p.itemSlots){var a=s(e);a&&(t[e]=a)}p.Optimizer.priority.forEach(function(e){s=$.extend({},t);if(f[e.stat]){for(var s=$.extend({},t),i=0;i<2;++i)for(var a in t)s[a]=t[a],r(s,a,e.stat,e.options,0==i);t=s}else for(var a in t)"sockets"===e.stat&&"offhand"===p.itemTypes[t[a].info.type].slot||l(t,a,e.stat,e.options)});for(var n in t)t[n]=o(t[n])||t[n];for(var n in t)i(n,t[n]);DiabloCalc.importEnd("global")},p.Optimizer.dialog=function(){function t(){p.Optimizer.priority=[],a.find(".optimize-priority-item").each(function(){p.Optimizer.priority.push($(this).data("item"))}),p.trigger("updateStatPriority")}function e(t,e){t.empty();var s="";$.each(d,function(t,e){s+='<option value="'+t+'">'+e.name+"</option>"}),t.append('<optgroup label="'+c("Composite Stats")+'">'+s+"</optgroup>"),p.getSkills&&(s="",p.getSkills().skills.forEach(function(t){if(t){var e="skillinfo_"+p.charClass+"_"+t[0];f[e]||(f[e]=function(t,e){function s(t){var s={stats:t,skill:[e,t.skills[e]||"x"],affix:i.affixid,params:i.params,getCurInfo_:p.SkillBox.skill.prototype.getCurInfo_,notip:!0},a=p.SkillBox.skill.prototype.getCurInfo.call(s,i,t),o=p.skill_processInfo(a,s),n={};for(var r in o)(!a[r]||"object"==typeof a[r]&&void 0===a[r].cooldown&&void 0===a[r].duration&&void 0===a[r].cost&&void 0===a[r].value)&&void 0!==o[r].value&&(n[r]=o[r].value);return n}var i=p.skills[t][e];return{name:i.name,options:{value:{type:"select",options:function(){var t=s(p.getStats()),e={};for(var i in t)e[i]=c(i);return e}}},stats:function(s,a){function o(t){d.indexOf(t)<0&&d.push(t)}function n(s){if(s&&"object"==typeof s)if(s.sum)for(var i in s)n(c[i]);else o("skill_"+t+"_"+(s&&s.skill||e)),s&&s.elem&&o("max"===s.elem?"dmg"+(r.info.maxelem||"fir"):"dmg"+s.elem)}if(!a)return[];var r=p.getStats(),l={skill:[e,r.skills[e]||"x"],affix:i.affixid,params:i.params,getCurInfo_:p.SkillBox.skill.prototype.getCurInfo_,notip:!0},c=p.SkillBox.skill.prototype.getCurInfo.call(l,i,r),d=f.dps.stats({speed:!0,elite:!0},a);return n(c[s.value]),d.push("cdr","rcr"),d},value:function(t,e){return s(e)[t.value]||0}}}(p.charClass,t[0])),s+='<option value="'+e+'">'+f[e].name+"</option>"}}),s.length&&t.append('<optgroup label="'+c("Skill Values")+'">'+s+"</optgroup>"));var i=p.options.limitStats?p.charClass:null;$.each(p.statList,function(s,a){$.each(a,function(a,o){"secondary"===s&&(a+=c(" (Secondary)"));var n="";p.extendStats([],o).forEach(function(t){p.stats[t].caldesanns||i&&p.stats[t].classes&&p.stats[t].classes.indexOf(i)<0&&t!==e||(n+='<option value="'+t+'">'+p.stats[t].name+"</option>")}),n&&t.append('<optgroup label="'+a+'">'+n+"</optgroup>")})}),t.val(e)}function s(t){var s=$('<li class="optimize-priority-item"></li>');s.data("item",t),a.find(".optimize-priority-list").append(s),s.append('<div class="header"><span class="btn-remove"></span><select class="optimize-stat"></select></div>');var i=$("<div></div>");s.append(i);var o=s.find("select");return e(o,t.stat),o.change(function(){t.stat=$(this).val(),i.empty(),f[t.stat]&&$.each(f[t.stat].options,function(e,s){if("checkbox"===s.type){(a=$('<label class="option-box"><input type="checkbox"></input>'+s.name+"</label>")).find("input").prop("checked",!!t.options[e]).click(function(){t.options[e]=!!$(this).prop("checked"),p.trigger("updateStatPriority")}),i.append(a)}else{var a=$('<select class="option-drop"></select>'),o=s.options();$.each(o,function(t,e){a.append('<option value="'+t+'">'+e+"</option>")}),(t.options[e]||"")in o||(t.options[e]=Object.keys(o)[0]||""),a.val(t.options[e]).change(function(){t.options[e]=$(this).val(),p.trigger("updateStatPriority")}),i.append(a)}})}).change().change(function(){p.trigger("updateStatPriority")}),o.chosen({width:"300px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:c("Choose Stat")}),s.on("mouseenter",".optimize-stat",function(){if(p.tooltip&&f[t.stat]){var e=f[t.stat].stats(t.options);if(e.length){var s=f[t.stat].name,i='<span class="d3-color-gold">'+c("Optimize {0} based on the following stats:").format(s)+"</span>";e.forEach(function(t){i+='<br/><span class="tooltip-icon-bullet"></span>'+p.stats[t].name}),p.tooltip.showHtml(this,i)}}}).on("mouseleave",".optimize-stat",function(){p.tooltip&&p.tooltip.hide()}),o}var i=$('<div class="optimize-dialog"><p><i>'+c("For best results, assign paragon, Caldesanns enchants and skills/passives before using the optimizer.")+"</i></p></div>");i.append('<div><label class="option-box"><input type="checkbox" class="option-unlock"></input>'+c("Unlock imported items")+"</label></div>"),i.find(".option-unlock").prop("checked",!!p.Optimizer.unlock).click(function(){p.Optimizer.unlock=!!$(this).prop("checked")}),i.append('<div><label class="option-box"><input type="checkbox" class="option-gift"></input>'+c("Use Ramaladni's Gift")+"</label></div>"),i.find(".option-gift").prop("checked",!!p.Optimizer.useGift).click(function(){p.Optimizer.useGift=!!$(this).prop("checked")}),i.append("<div>"+c("Set stat values to {0}%").format('<input class="option-perfection" type="number" min="0" max="100"></input>')+"</label></div>"),i.find(".option-perfection").val(Math.round(100*p.Optimizer.perfection)).change(function(){var t=parseInt($(this).val())||0;t<0&&(t=0),t>100&&(t=100),$(this).val(t),p.Optimizer.perfection=.01*t});var a=$('<div class="optimize-priority"><ul class="optimize-priority-list"></ul></div>');a.append('<div class="btn-add">'+c("Add stat")+"</div>"),i.append(a);var o=!1;return p.register("updateSkills",function(){a.find(".header select").each(function(){var t=$(this);e(t,t.val()),t.trigger("chosen:updated")})}),p.register("updateSlotItem",function(){o=!1;for(var t in p.itemSlots){var s=p.getSlot(t);s&&(s.imported&&(o=!0))}$(".option-unlock").closest("div").toggle(o),a.find(".header select").each(function(){var t=$(this);e(t,t.val()),t.trigger("chosen:updated")})}),a.find(".btn-add").click(function(){var e=s({stat:"",options:{}});t(),setTimeout(function(){e.trigger("chosen:open")},0)}),a.on("click",".btn-remove",function(){$(this).closest("li").remove(),t()}),a.find(".optimize-priority-list").sortable({handle:".header",distance:4,axis:"y",placeholder:"drop-ph",forcePlaceholderSize:!0,start:function(){a.find("select").trigger("chosen:close")},stop:function(e,s){s.item.css({position:"",left:"",top:""}),setTimeout(t,0)}}),p.Optimizer.updatePriority=function(){a.find(".optimize-priority-list").empty(),p.Optimizer.priority.forEach(s)},i}}();!function(){function a(a,l){if("custom"==l.id||"customwpn"==l.id){var s="offhand"===a?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[a].types;for(var e in s)if(!(s[e].classes&&s[e].classes.indexOf(DiabloCalc.charClass)<0)&&("customwpn"===l.id||!DiabloCalc.itemTypes[e].weapon)&&("customwpn"!==l.id||DiabloCalc.itemTypes[e].weapon))return DiabloCalc.getItemIcon(DiabloCalc.itemTypes[e].generic)}return DiabloCalc.getItemIcon(l.id)}function l(){for(var a=$(".char-class").val(),l=DiabloCalc.getSkills(),s=0;s<6;++s){var e=l.skills[s];if(e){i=DiabloCalc.skills[a][e[0]];c[s].removeClass("empty"),c[s].css("background-position",-42*i.col+"px "+-84*i.row+"px")}else c[s].addClass("empty")}for(s=0;s<4;++s){var o=l.passives[s];if(o){var i=DiabloCalc.passives[a][o];n[s].removeClass("empty"),n[s].css("background-position",-42*i.index+"px 0")}else n[s].addClass("empty")}for(var t in d)l.kanai[t]?(d[t].removeClass("empty"),d[t].find(".icon").css("background-image","url("+DiabloCalc.getItemIcon(l.kanai[t])+")")):d[t].addClass("empty")}function s(a){a.removeClass("empty-slot disabled-offhand");for(var l in DiabloCalc.qualities)a.removeClass("quality-"+l);return a}function e(l){$(".char-class").val();var o=DiabloCalc.itemSlots[l],i=DiabloCalc.getSlot(l);if(o.flourish&&o.flourish.removeClass(),!i||!DiabloCalc.itemById[i.id])return s(o.dollFrame).addClass("doll-slot").addClass("slot-"+l).addClass("empty-slot"),o.dollImage.hide(),o.dollSockets&&o.dollSockets.empty(),void(i||"offhand"!=l||(i=DiabloCalc.getSlot("mainhand"))&&DiabloCalc.itemById[i.id]&&"twohand"==DiabloCalc.itemTypes[DiabloCalc.itemById[i.id].type].slot&&(o.dollFrame.addClass("disabled-offhand"),o.dollImage.attr("src",a("mainhand",i)).show()));var t=DiabloCalc.itemById[i.id];if(s(o.dollFrame).addClass("doll-slot").addClass("slot-"+l).addClass("quality-"+t.quality),o.dollImage.attr("src",a(l,i)).show(),o.dollImage.toggleClass("ancient",!!i.ancient),o.flourish){var c=null;for(var n in i.stats)if(DiabloCalc.stats[n].elemental){c=DiabloCalc.stats[n].elemental;break}c&&o.flourish.addClass("weapon-flourish").addClass(l+"-flourish").addClass("elemental-"+c)}if(o.dollSockets){o.dollSockets.empty();for(var d=i.stats.sockets&&i.stats.sockets[0]||0,r=0;r<d;++r){var p=$("<span></span>").addClass("socket");if(i.gems&&r<i.gems.length){var C;DiabloCalc.legendaryGems[i.gems[r][0]]?C=DiabloCalc.getItemIcon(i.gems[r][0],"small"):DiabloCalc.gemQualities[i.gems[r][0]]&&(C=DiabloCalc.getItemIcon(i.gems[r],"small")),C&&p.append($("<img></img>").attr("src",C))}o.dollSockets.append(p).append($("<br></br>"))}}"mainhand"==l&&"twohand"==DiabloCalc.itemTypes[t.type].slot&&e("offhand")}function o(){var a=$(".char-class").val();$(".paperdoll-background").parent().removeClass().addClass("paperdoll-container").addClass("class-"+a).addClass(DiabloCalc.gender||"female"),$(".paperdoll-background").removeClass().addClass("paperdoll-background").addClass(DiabloCalc.classes[a].follower?"class-follower":"class-character"),i.toggleClass("selected","male"===DiabloCalc.gender),t.toggleClass("selected","male"!==DiabloCalc.gender)}var i,t,c=[],n=[],d={};DiabloCalc.getDollSkill=function(a){return c[a]},DiabloCalc.getDollPassive=function(a){return n[a]};var r=$(".paperdoll-background");DiabloCalc.itemSlots.mainhand.flourish=$('<span class="weapon-flourish mainhand-flourish"></span>'),DiabloCalc.itemSlots.offhand.flourish=$('<span class="weapon-flourish offhand-flourish"></span>'),r.append(DiabloCalc.itemSlots.mainhand.flourish).append(DiabloCalc.itemSlots.offhand.flourish);for(var p in DiabloCalc.itemSlots){var C=DiabloCalc.itemSlots[p];if(C.dollFrame=$("<div></div>").addClass("doll-slot").addClass("slot-"+p).addClass("empty-slot").append('<span class="item-gradient"><span class="item-glow"></span></span>'),C.dollImage=$("<img></img>").hide(),C.dollFrame.append(C.dollImage),C.sockets){var m=$("<span></span>").addClass("sockets-wrapper");C.dollSockets=$("<span></span>").addClass("sockets-align"),C.dollFrame.append(m.append(C.dollSockets))}!function(a){C.dollFrame.hover(function(){DiabloCalc.tooltip&&DiabloCalc.tooltip.showItem(this,a)},function(){DiabloCalc.tooltip&&DiabloCalc.tooltip.hide()})}(p),r.append(C.dollFrame)}for(var b=$("<div></div>").addClass("paperdoll-skills"),f=$("<div></div>").addClass("paperdoll-skills"),D=0;D<6;++D){(g=$("<span></span>").addClass("skill-icon").addClass("empty")).append('<span class="skill-frame"></span>'),g.css("left",14+(D<2?218+52*D:52*(D-2))),g.append('<span class="skill-text">'+[1,2,4,9,14,19][D]+"</span>"),function(a){g.hover(function(){if(DiabloCalc.getSkill&&DiabloCalc.tooltip){var l=DiabloCalc.getSkill(a);l&&DiabloCalc.tooltip.showSkill(this,$(".char-class").val(),l[0],l[1])}},function(){DiabloCalc.tooltip&&DiabloCalc.tooltip.hide()}),g.click(function(){var l=DiabloCalc.getSkill(a);if(l&&DiabloCalc.d3gl&&DiabloCalc.d3gl.character&&DiabloCalc.d3gl.enabled()){DiabloCalc.tooltip.hide();var s=DiabloCalc.webglSkills&&l&&DiabloCalc.webglSkills[l[0]];s&&"object"==typeof s&&"x"in s&&(s=s[l[1]]),s&&DiabloCalc.d3gl.character.animate(s)}else DiabloCalc.trigger("editSkill",a)})}(D),b.append(g),c.push(g)}for(D=0;D<4;++D){var g=$("<span></span>").addClass("passive-icon").addClass("empty");g.append('<span class="passive-frame fancy"></span>'),g.css("left",50+66*D),g.append('<span class="skill-text">'+[10,20,30,70][D]+"</span>"),function(a){g.hover(function(){if(DiabloCalc.getPassive&&DiabloCalc.tooltip){var l=DiabloCalc.getPassive(a);l&&DiabloCalc.tooltip.showSkill(this,$(".char-class").val(),l)}},function(){DiabloCalc.tooltip&&DiabloCalc.tooltip.hide()}),g.click(function(){DiabloCalc.trigger("editPassive",a)})}(D),f.append(g),n.push(g)}r.parent().append(b).append(f);var u=$("<div></div>").addClass("paperdoll-cube");d.weapon=$('<span class="cube-item weapon empty"><span class="icon"></span></span>'),d.armor=$('<span class="cube-item armor empty"><span class="icon"></span></span>'),d.jewelry=$('<span class="cube-item jewelry empty"><span class="icon"></span></span>'),u.append(d.weapon,d.armor,d.jewelry),r.parent().append(u),$.each(d,function(a,l){l.hover(function(){if(DiabloCalc.getSkills){var l=DiabloCalc.getSkills();l.kanai[a]&&DiabloCalc.tooltip.showItem(this,l.kanai[a])}},function(){DiabloCalc.tooltip.hide()}),l.click(function(){DiabloCalc.trigger("editKanai",a)})}),i=$('<span class="d3gl-button-male"></span>').click(function(){DiabloCalc.gender="male",i.addClass("selected"),t.removeClass("selected"),DiabloCalc.updateClassIcon&&DiabloCalc.updateClassIcon(),DiabloCalc.trigger("changeGender")}),t=$('<span class="d3gl-button-female selected"></span>').click(function(){DiabloCalc.gender="female",i.removeClass("selected"),t.addClass("selected"),DiabloCalc.updateClassIcon&&DiabloCalc.updateClassIcon(),DiabloCalc.trigger("changeGender")}),$(".paperdoll-container").append(i,t),DiabloCalc.register("changeClass",o),DiabloCalc.register("changeGender",function(){o();for(var a in DiabloCalc.itemSlots)e(a)}),o(),DiabloCalc.register("updateSlotStats",function(a){DiabloCalc.tooltip&&DiabloCalc.tooltip.getNode()==DiabloCalc.itemSlots[a].dollFrame[0]&&DiabloCalc.tooltip.showItem(DiabloCalc.itemSlots[a].dollFrame[0],a)}),DiabloCalc.register("updateSlotItem",e),DiabloCalc.register("updateSkills",l),DiabloCalc.register("importEnd",function(){for(var a in DiabloCalc.itemSlots)e(a);l()})}();!function(){function t(t){b.setSlot(t),DiabloCalc.tooltip.hide(),setTimeout(function(){var t=b.slot;if(DiabloCalc.itemSlots[t].item)b.itemBox.type.trigger("chosen:activate");else{var e,i="offhand"===t?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[t].types,a=0;for(var l in i)i[l].classes&&i[l].classes.indexOf(DiabloCalc.charClass)<0||"custom"!==l&&(a+=1,e=l);1===a?(b.itemBox.type.val(e),b.itemBox.type.trigger("chosen:updated"),b.itemBox.onChangeType(),setTimeout(function(){b.itemBox.item.trigger("chosen:open")},0)):b.itemBox.type.trigger("chosen:open")}},0)}function e(e){var i=this;this.slot=e,this.slotData=DiabloCalc.itemSlots[e],this.accept=function(t){if(!t||!DiabloCalc.itemById[t])return!1;if(this.inactive)return!1;var e=DiabloCalc.itemById[t].type,i=(this.slot?DiabloCalc.itemSlots[this.slot].types:DiabloCalc.itemTypes)[e];if(!i)return!1;var a=!1,l="offhand"===this.slot&&!DiabloCalc.classes[DiabloCalc.charClass].dualwield;if("offhand"===this.slot&&"crusader"!==DiabloCalc.charClass&&DiabloCalc.itemSlots.mainhand.item){var o=DiabloCalc.itemById[DiabloCalc.itemSlots.mainhand.item.id],s=o&&o.type;DiabloCalc.itemTypes[s]&&"twohand"==DiabloCalc.itemTypes[s].slot&&(a=!0)}return(!a||"quiver"==e)&&((!l||"onehand"!=i.slot||"handcrossbow"==e)&&!(i.classes&&i.classes.indexOf(DiabloCalc.charClass)<0))},this.setItem=function(t,e){if(!this.inactive){if("mainhand"===this.slot&&t&&DiabloCalc.itemById[t.id]&&DiabloCalc.itemSlots.offhand.item&&DiabloCalc.itemById[DiabloCalc.itemSlots.offhand.item.id]){var i=DiabloCalc.itemById[t.id].type,a=DiabloCalc.itemById[DiabloCalc.itemSlots.offhand.item.id].type;if(DiabloCalc.itemTypes[i]&&"twohand"==DiabloCalc.itemTypes[i].slot&&"crusader"!=DiabloCalc.charClass&&a&&"quiver"!=a&&("mainhand"!==b.slot&&DiabloCalc.trigger("updateSlotItem","offhand","twohand"),"stash"===e)){var l=s(DiabloCalc.itemSlots.offhand.item);l&&l.setItem(DiabloCalc.itemSlots.offhand.item)}}b.slot===this.slot?b.setItem(t):(this.slotData.item=t,"mainhand"===this.slot&&DiabloCalc.itemSlots.offhand.drop.updateTypes(),DiabloCalc.trigger("updateSlotItem",this.slot))}},this.getId=function(){return this.slotData.item?this.slotData.item.id:void 0},this.getData=function(){return this.slotData.item},this.updateTypes=function(t,e){this.inactive||(b.slot===this.slot?b.itemBox.updateTypes(t):DiabloCalc.itemSlots[this.slot].item&&!DiabloCalc.isItemAllowed(this.slot,DiabloCalc.itemSlots[this.slot].item.id,e)&&this.setItem(DiabloCalc.trimItem(this.slot,DiabloCalc.itemSlots[this.slot].item,e)))};var a="clone";"neck"===e&&(a=function(){return $('<img style="width: 52px; height: 52px;"></img>').attr("src",DiabloCalc.itemSlots.neck.dollImage.attr("src")).toggleClass("ancient",!(!DiabloCalc.itemSlots.neck.item||!DiabloCalc.itemSlots.neck.item.ancient))}),this.slotData.dollImage.data("slot",this),this.reverting=!1,this.slotData.dollImage.draggable({zIndex:100,cursor:"-webkit-grabbing",appendTo:"body",distance:4,helper:a,start:function(t,e){if(!i.slotData.item||0!=$(".editframe").tabs("option","active"))return setTimeout(function(){$("body").css("cursor","")}),!1;u=i.slotData.dollImage,t.shiftKey||(i.slotData.dollImage.hide(),i.slotData.dollSockets&&i.slotData.dollSockets.hide()),DiabloCalc.tooltip&&DiabloCalc.tooltip.disable()},revert:function(t){if(u=void 0,DiabloCalc.tooltip&&DiabloCalc.tooltip.enable(),!t){if(!window.event)return!0;i.reverting=!0,DiabloCalc.popupMenu(window.event,c.fixkey({Delete:function(){var t=i.slotData.dollImage.draggable("instance");i.reverting=!1,t&&!1!==t._trigger("stop",event)&&t._clear(),i.setItem()}}),function(){var t=i.slotData.dollImage.draggable("instance");i.reverting=!1,t&&$(t.helper).animate(t.originalPosition,parseInt(t.options.revertDuration,10),function(){!1!==t._trigger("stop",event)&&t._clear()})})}return!1},stop:function(){if(i.reverting)return!1;setTimeout(function(){i.slotData.item&&(i.slotData.dollImage.show(),i.slotData.dollSockets&&i.slotData.dollSockets.show())},0)}}).draggable("instance")._adjustOffsetFromHelper=function(){this.offset.click.left=this.margins.left+this.helper.width()/2,this.offset.click.top=this.margins.top+this.helper.height()/2},i.slotData.dollFrame.droppable({hoverClass:"highlight",accept:function(t){var e=t.data("slot");if(!e||e===i)return!1;var a=e.getId();if(!i.accept(a))return!1;if(DiabloCalc.shiftKey)return!0;var l=i.getId();return!l||e.accept(l)},drop:function(t,e){if(!i.inactive){var a=e.draggable.data("slot");if(a&&a!==i){var l=a.getData();if(l&&i.accept(l.id)){var o=i.getId();if(t.shiftKey)o?DiabloCalc.popupMenu(t,c.fixkey({Replace:function(){i.setItem(l,"stash")},Cancel:function(){}})):i.setItem(l,"stash");else{if(o){if(!a.accept(o))return;a.setItem(i.getData(),"stash")}else a.setItem();i.setItem(l,"stash")}}}}}}),i.slotData.dollFrame.click(function(){$(".editframe").tabs("option","active",0),d.animate({scrollTop:0},"fast"),t(e)}),i.slotData.dollFrame.contextmenu(function(t){if(0==$(".editframe").tabs("option","active")){if(i.slotData.item){var e={};s()&&(e[c("Unequip")]=function(){var t=s();i.slotData.item&&t&&(t.setItem(i.slotData.item),i.setItem())}),e[c("Delete")]=function(){i.setItem()},DiabloCalc.tooltip.hide(),DiabloCalc.popupMenu(t,e)}return!1}}),DiabloCalc.enableTouch(i.slotData.dollFrame)}function i(t){this.setItem=function(t,i){if(this.box.removeClass().addClass("stash-slot").addClass("ui-droppable"),k.slot===this&&this.box.addClass("edit"),this.dollSlot||"loading"===i||f||(x.hide(),f=setTimeout(a,5e3)),"editing"!==i&&k.slot===e&&k.setItem(t,i),!t||!t.id)return this.item=void 0,void this.box.addClass("empty-slot");var l=DiabloCalc.itemById[t.id]||DiabloCalc.itemById.custom,s=l.type,n=DiabloCalc.itemTypes[s].slot,c=l.id;if("custom"===n&&this.dollSlot){var d="offhand"===this.dollSlot?DiabloCalc.getOffhandTypes():DiabloCalc.itemSlots[this.dollSlot].types;for(var r in d)if(!(d[r].classes&&d[r].classes.indexOf(DiabloCalc.charClass)<0)){n=DiabloCalc.itemTypes[r].slot,c=DiabloCalc.itemTypes[r].generic;break}}this.item=t,this.box.addClass("quality-"+l.quality),this.icon.removeClass().addClass("stash-icon").addClass("slot-"+n),this.icon.css("background-image","url("+DiabloCalc.getItemIcon(c)+")").show(),this.icon.toggleClass("ancient",!!t.ancient),DiabloCalc.tooltip&&DiabloCalc.tooltip.getNode()==this.box[0]&&DiabloCalc.tooltip.showItem(this.box[0],this.item),this.dollSlot||function(){if(100==B.length)return;for(var t=0,e=0;e<B.length;++e)B[e].item||++t;t<3&&o(5*(Math.floor(B.length/5)+1))}()},this.accept=function(t){return this.dollSlot?DiabloCalc.itemSlots[this.dollSlot].drop&&DiabloCalc.itemSlots[this.dollSlot].drop.accept(t):!!t},this.getId=function(){return this.item&&this.item.id},this.getData=function(){return this.item};var e=this;this.box=$('<div class="stash-slot empty-slot"></div>'),this.icon=$('<div class="stash-icon"></div>'),this.box.append('<div class="item-gradient"><div class="item-glow"></div></div><div class="hover-glow"></div>').append(this.icon),this.box.append('<div class="edit-border"><div class="edit-gradient"></div></div>'),this.box.droppable({hoverClass:"slot-hover",accept:function(t){var i=t.data("slot");return!(!i||i===e)&&(!!DiabloCalc.shiftKey||(!e.item||i.accept(e.item.id)))},drop:function(t,i){var a=i.draggable.data("slot");if(a&&a!==e){var l=a.getData();if(l&&e.accept(l.id))if(t.shiftKey)e.item?DiabloCalc.popupMenu(t,c.fixkey({Replace:function(){e.setItem(l,"stash")},Cancel:function(){}})):e.setItem(l,"stash");else{if(e.item){if(!a.accept(e.item.id))return;a.setItem(e.item,"stash")}else a.setItem();e.setItem(l,"stash")}}}}),this.box.hover(function(){if(e.dollSlot)DiabloCalc.tooltip.showItem(this,e.dollSlot);else if(e.item&&DiabloCalc.tooltip)if(DiabloCalc.itemById[e.item.id])DiabloCalc.tooltip.showItem(this,e.item);else{var t='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+c("Unknown Item")+'</span><br/><span class="d3-color-gray">'+e.item.id+"</span></p></div>";DiabloCalc.tooltip.showHtml(this,t)}},function(){DiabloCalc.tooltip&&DiabloCalc.tooltip.hide()}).click(function(){e.dollSlot||k.setSlot(k.slot===e?void 0:e)}).contextmenu(function(t){DiabloCalc.tooltip.hide();var i={};return e.dollSlot||k.slot===e||e.item&&!DiabloCalc.itemById[e.item]||(i[c("Edit")]=function(){k.setSlot(e)}),e.item&&(e.dollSlot?s()&&(i[c("Unequip")]=function(){var t=s();e.item&&t&&(t.setItem(e.item),e.setItem())}):$.each(DiabloCalc.itemSlots,function(t,a){a.drop.accept(e.item.id)&&(i[c("Equip {0}").format(a.name)]=function(){if(a.drop.accept(e.item.id)){var t=a.drop.getData();a.drop.setItem(e.item,"stash"),e.setItem(t,"stash")}})}),i[c("Delete")]=function(){e.setItem()}),DiabloCalc.popupMenu(t,i),!1}),this.icon.data("slot",this),this.reverting=!1,this.icon.draggable({zIndex:100,appendTo:"body",cursor:"-webkit-grabbing",distance:4,cursorAt:{},helper:function(){var t=$("<img></img>").attr("src",e.item?DiabloCalc.getItemIcon(e.item.id):"");return t.toggleClass("ancient",!(!e.item||!e.item.ancient)),e.item&&DiabloCalc.itemById[e.item.id]&&"amulet"===DiabloCalc.itemById[e.item.id].type&&t.css("width",52).css("height",52),t},start:function(){if(!e.item)return setTimeout(function(){$("body").css("cursor","")}),!1;u=e.icon,DiabloCalc.shiftKey||e.icon.hide(),DiabloCalc.tooltip&&DiabloCalc.tooltip.disable()},revert:function(t){if(u=void 0,DiabloCalc.tooltip&&DiabloCalc.tooltip.enable(),!t){if(!window.event)return!0;e.reverting=!0,DiabloCalc.popupMenu(window.event,c.fixkey({Delete:function(){var t=e.icon.draggable("instance");e.reverting=!1,t&&!1!==t._trigger("stop",event)&&t._clear(),e.setItem()}}),function(){var t=e.icon.draggable("instance");e.reverting=!1,t&&$(t.helper).animate(t.originalPosition,parseInt(t.options.revertDuration,10),function(){!1!==t._trigger("stop",event)&&t._clear()})})}return!1},stop:function(){if(e.reverting)return!1;setTimeout(function(){e.icon.show()},0)}}).draggable("instance")._adjustOffsetFromHelper=function(){var t=40-this.helper.width()/2,e=40-this.helper.height()/2;this.originalPosition.left+=t,this.originalPosition.top+=e,this.position.left+=t,this.position.top+=e,this.offset.click.left-=t,this.offset.click.top-=e},DiabloCalc.enableTouch(this.icon),this.line=t,t.append(this.box)}function a(){if(DiabloCalc.activity("stash"),clearTimeout(f),f=void 0,DiabloCalc.account.userName()){x.addClass("loading").text(c("Saving...")).show();for(var t=[],e=0;e<B.length;++e)t.push(B[e].item||null);$.ajax({url:"savestash",data:JSON.stringify(t),type:"POST",global:!1,processData:!1,contentType:"application/json",dataType:"json",success:function(t){"OK"===t.code?x.removeClass("loading").text(c("Saved.")):t.errors&&t.errors.length?x.removeClass("loading").text(t.errors[0]):x.removeClass("loading").text(c("Failed to save!"))},error:function(t){x.removeClass("loading").text(c("Failed to save!"))}})}}function l(){var t=!1;for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.getSlot(e);if(i&&i.imported){t=!0;break}}D.toggle(t)}function o(t){for(;B.length<50&&B.length<t;)B.length%5||(w.push($('<div class="stash-row"></div>')),d.append(w[w.length-1])),B.push(new i(w[w.length-1]))}function s(t){for(var e=0;e<B.length;++e)if(!B[e].item)return B[e]}function n(){var t;$.each(DiabloCalc.itemSlots,function(e,i){i.classes&&i.classes.indexOf(DiabloCalc.charClass)<0?(i.drop.inactive=!0,i.item&&(i.item=void 0,DiabloCalc.trigger("updateSlotItem",e))):(i.drop.inactive=!1,t||(t=e))}),!b.slot||DiabloCalc.itemSlots[b.slot].drop.inactive?b.setSlot(t):b.setSlot(b.slot);for(var e in DiabloCalc.itemSlots)DiabloCalc.itemSlots[e].drop.inactive||e===b.slot||DiabloCalc.itemSlots[e].drop.updateTypes(!0)}var c=DiabloCalc.locale("ui-equipment.js"),d=$("#tab-equipment");d=DiabloCalc.addScroll(d,"y");var r=$("<input></input>").attr("type","checkbox").prop("checked",!1).change(function(){b.itemBox.updateWarning(),k.itemBox.updateWarning()});DiabloCalc.addOption("moreWarnings",function(){return r.prop("checked")},function(t){r.prop("checked",t),b.itemBox.updateWarning(),k.itemBox.updateWarning()});var m=$("<input></input>").attr("type","checkbox").prop("checked",!0);DiabloCalc.addOption("limitStats",function(){return m.prop("checked")},function(t){m.prop("checked",t)});var p=$("<input></input>").attr("type","checkbox").prop("checked",!0);DiabloCalc.addOption("hideCrossClass",function(){return p.prop("checked")},function(t){p.prop("checked",t),b.itemBox.populateItems(),k.itemBox.populateItems()});var h=$("<input></input>").attr("type","checkbox").prop("checked",!0);DiabloCalc.addOption("hideLegacy",function(){return h.prop("checked")},function(t){h.prop("checked",t),b.itemBox.populateItems(),k.itemBox.populateItems()}),d.append($('<label class="option-box top-options"></label>').append(r).append(c("Show all warnings"))),d.append($('<label class="option-box top-options"></label>').append(p).append(c("Hide items for other classes"))),d.append($('<label class="option-box top-options"></label>').append(m).append(c("Only list class-specific stats"))),d.append($('<label class="option-box top-options"></label>').append(h).append(c("Hide legacy items"))),DiabloCalc.addTip(r,c("Show warnings for incomplete items and missing secondary stats.")),DiabloCalc.addTip(p,c("Do not list items with affixes that do not apply to your class.")),DiabloCalc.addTip(m,c("Only list stats useful to your class.")),DiabloCalc.addTip(h,c("Do not list legacy items."));var u;$("body").keydown(function(t){16==t.which&&u&&u.show()}).keyup(function(t){16==t.which&&u&&u.hide()});var b=new function(){this.div=$('<div class="current-slot"></div>'),d.append(this.div),this.slotBox=new i(this.div),this.prevSlot=$('<span class="left"></span>'),this.nextSlot=$('<span class="right"></span>'),this.slotName=$('<span class="current-slot chosen-noframe"></span>'),this.slotDrop=$('<select class="current-slot-name"></select>'),this.slotItem=$("<span></span>"),this.div.append($('<div class="current-header"><span class="current-tip">'+c("Click on a paperdoll slot to edit items.")+"</span></div>").append(this.slotName,"<br/>",this.slotItem));var e=this;this.slotName.append(this.prevSlot,this.slotDrop,this.nextSlot),this.listSlots=function(t){this.slotDrop.empty();for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.itemSlots[e];i.drop&&i.drop.inactive||this.slotDrop.append('<option value="'+e+(e===t?'" selected="selected':"")+'">'+i.name+"</option>")}},this.listSlots(),this.slotDrop.chosen({disable_search:!0,inherit_select_classes:!0}).change(function(){e.doSetSlot($(this).val())}),this.slotBox.veryOldSetItem=this.slotBox.setItem,this.slotBox.oldSetItem=function(t,i){if(e.slotItem.removeClass(),t&&DiabloCalc.itemById[t.id]){var a=DiabloCalc.itemById[t.id];e.slotItem.addClass("quality-"+a.quality).text(a.name)}else e.slotItem.addClass("empty-slot").text(c("Empty Slot"));this.veryOldSetItem(t,i)},this.slotBox.setItem=function(t,i){"editing"!==i&&(e.itemBox.suppress=!0,e.itemBox.setItem(t),e.itemBox.suppress=!1),e.slotBox.oldSetItem(t,i),DiabloCalc.itemSlots[e.slot].item=t,DiabloCalc.trigger("updateSlotItem",e.slot)},this.setItem=function(t,e){this.slotBox.setItem(t,e)},this.itemBox=new DiabloCalc.ItemBox(d,{onUpdate:function(t,i){if(!DiabloCalc.itemSlots[e.slot].drop.inactive){var a=e.itemBox.getData();e.slotBox.oldSetItem(a,"editing"),DiabloCalc.itemSlots[e.slot].item=a,DiabloCalc.trigger(t?"updateSlotItem":"updateSlotStats",e.slot,i)}}}),this.getPrevSlot=function(){var t=void 0;for(var e in DiabloCalc.itemSlots)if(!DiabloCalc.itemSlots[e].drop.inactive){if(e===this.slot)break;t=e}return t},this.getNextSlot=function(){var t=!1;for(var e in DiabloCalc.itemSlots)if(!DiabloCalc.itemSlots[e].drop.inactive)if(e===this.slot)t=!0;else if(t)return e},$(".editframe").on("tabsactivate",function(){e.slot&&(0!=$(".editframe").tabs("option","active")?DiabloCalc.itemSlots[e.slot].dollFrame.removeClass("editing"):DiabloCalc.itemSlots[e.slot].dollFrame.addClass("editing"))}),this.prevSlot.click(function(){var i=e.getPrevSlot();i&&t(i)}),this.nextSlot.click(function(){var i=e.getNextSlot();i&&t(i)}),this.setSlot=function(t){this.listSlots(t),this.slotDrop.trigger("chosen:updated"),this.doSetSlot(t)},this.doSetSlot=function(t){this.slot&&DiabloCalc.itemSlots[this.slot].dollFrame.removeClass("editing"),this.slot=t,this.slot&&0==$(".editframe").tabs("option","active")&&DiabloCalc.itemSlots[this.slot].dollFrame.addClass("editing"),this.slotBox.dollSlot=t,this.getPrevSlot()?this.prevSlot.removeClass("disabled"):this.prevSlot.addClass("disabled"),this.getNextSlot()?this.nextSlot.removeClass("disabled"):this.nextSlot.addClass("disabled"),this.itemBox.suppress=!0;var i=DiabloCalc.itemSlots[t].item;this.itemBox.setClass(DiabloCalc.charClass,t),this.itemBox.setItem(i),this.itemBox.suppress=!1,i=this.itemBox.getData(),this.slotBox.oldSetItem(i,"editing"),DiabloCalc.itemSlots[e.slot].item=i,DiabloCalc.trigger("updateSlotItem",e.slot)},this.updateIcon=function(){this.slotBox.oldSetItem(this.itemBox.getData(),"editing")}};DiabloCalc.onHighlight=function(t){b.slot&&0==$(".editframe").tabs("option","active")&&DiabloCalc.itemSlots[b.slot].dollFrame.toggleClass("editing",!t)};var f;window.onbeforeunload=function(t){f&&a()},d.append('<h3 class="skill-category collapse-header collapsed">'+c("Global equipment modifications")+"</h3>");var C=$("<ul></ul>");d.append(C);var v='<select class="eqmod-ancient-type">';v+='<option value="false">'+c("Normal")+"</option>",v+='<option value="true">'+c("Ancient")+"</option>",v+='<option value="primal">'+c("Primal Ancient")+"</option>",v+="</select>";var D=$('<li><span class="link-like eqmod-unlock">'+c("Unlock imported items")+"</span></li>");C.append(D),C.append('<li><span class="link-like eqmod-ancient">'+c("Make all items {0}").format(v)+"</span></li>"),C.append('<li><span class="link-like eqmod-maxstat">'+c("Change all stats to {0}%").format('<input class="eqmod-maxstat-value" type="number" min="0" max="100" value="100"/>')+"</span></li>");var g='<select class="eqmod-enchant-type">';for(var S in{str:!0,dex:!0,int:!0,vit:!0})g+='<option value="'+S+'">'+DiabloCalc.stats[S].name+"</option>";g+="</select>",C.append('<li><span class="link-like eqmod-enchant">'+c("Add level {0} {1} Caldessan's Despair").format('<input class="eqmod-enchant-level" type="number" min="0" max="200" value="100"/>',g)+"</span></li>"),DiabloCalc.register("changeClass",function(){$(".eqmod-enchant-type").val(DiabloCalc.classes[DiabloCalc.charClass].primary)}),$(".eqmod-enchant-type").val(DiabloCalc.classes[DiabloCalc.charClass].primary),d.append('<h3 class="skill-category collapse-header collapsed second">'+c("Stat priority")+"</h3>");var y=DiabloCalc.Optimizer.dialog();d.append(y),DiabloCalc.Optimizer.updatePriority(),y.append('<div><span class="link-like eqmod-optimize">'+c("Optimize stats")+"</span></div>"),$(".collapse-header").click(function(){$(this).toggleClass("collapsed"),$(this).hasClass("collapsed")?$(this).next().slideUp():$(this).next().slideDown()}).next().hide(),DiabloCalc.register("updateSlotItem",l),DiabloCalc.register("importEnd",l),$(".eqmod-unlock").click(function(){DiabloCalc.activity("modunlock"),DiabloCalc.importStart();for(var t in DiabloCalc.itemSlots){var e=DiabloCalc.getSlot(t);e&&(e.imported&&(delete(e=$.extend(!0,{},e)).enchant,delete e.imported,DiabloCalc.setSlot(t,e)))}DiabloCalc.importEnd("global")}),$(".eqmod-ancient").click(function(){DiabloCalc.activity("modancient"),DiabloCalc.importStart();var t=$(".eqmod-ancient-type").val();"true"===t?t=!0:"primal"!==t&&(t=!1);for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.getSlot(e);i&&((i.ancient||!1)!==t&&((i=$.extend(!0,{},i)).ancient=t,delete i.enchant,delete i.imported,DiabloCalc.trimStats(i),DiabloCalc.setSlot(e,i)))}DiabloCalc.importEnd("global")}),$(".eqmod-maxstat").click(function(t){function e(t){DiabloCalc.importStart();var e=.01*(parseInt($(".eqmod-maxstat-value").val())||0);for(var i in DiabloCalc.itemSlots){var a=DiabloCalc.getSlot(i);if(a){a=$.extend(!0,{},a),t&&(delete a.enchant,delete a.imported);var l=DiabloCalc.getItemAffixesById(a.id,a.ancient,!0);for(var o in a.stats)if(l[o]&&!(a.imported&&a.enchant!==o||DiabloCalc.stats[o]&&DiabloCalc.stats[o].caldesanns)){if(a.stats[o].length>=1){var s=l[o].best||"max",n="max"===s?"min":"max";if(l[o].min&&l[o].max&&(a.stats[o][0]=l[o][n]+(l[o][s]-l[o][n])*e,"any"!==l[o].step)){c=l[o].step||1;a.stats[o][0]=Math.round(a.stats[o][0]/c)*c}}if(a.stats[o].length>=2&&l[o].min2&&l[o].max2&&(a.stats[o][1]=l[o].min2+(l[o].max2-l[o].min2)*e,"any"!==l[o].step2)){var c=l[o].step2||1;a.stats[o][1]=Math.round(a.stats[o][1]/c)*c}}DiabloCalc.setSlot(i,a)}}DiabloCalc.importEnd("global")}DiabloCalc.activity("modmaxstat");var i=!1;for(var a in DiabloCalc.itemSlots){var l=DiabloCalc.getSlot(a);if(l&&l.imported){i=!0;break}}i?DiabloCalc.simpleDialog({title:c("Modify equipment"),text:c("Profile contains imported items. Only enchanted stats will be modified."),buttons:[c("Ok"),c("Unlock"),c("Cancel")],callback:function(t){0!==t&&1!==t||e(t>0)}}):e(!0)}),$(".eqmod-enchant").click(function(){DiabloCalc.activity("modenchant"),DiabloCalc.importStart();var t=5*(parseInt($(".eqmod-enchant-level").val())||1),e="caldesanns_"+$(".eqmod-enchant-type").val();for(var i in DiabloCalc.itemSlots){var a=DiabloCalc.getSlot(i);a&&(t?a.stats[e]&&a.stats[e][0]===t||(delete(a=$.extend(!0,{},a)).stats.caldesanns_str,delete a.stats.caldesanns_dex,delete a.stats.caldesanns_int,delete a.stats.caldesanns_vit,a.stats[e]=[t],DiabloCalc.setSlot(i,a)):(a.stats.caldesanns_str||a.stats.caldesanns_dex||a.stats.caldesanns_int||a.stats.caldesanns_vit)&&(delete(a=$.extend(!0,{},a)).stats.caldesanns_str,delete a.stats.caldesanns_dex,delete a.stats.caldesanns_int,delete a.stats.caldesanns_vit,a.stats[e]=[t],DiabloCalc.setSlot(i,a)))}DiabloCalc.importEnd("global")}),$(".eqmod-optimize").click(function(){DiabloCalc.activity("modoptimize"),DiabloCalc.Optimizer.optimizeAll()}),$(".eqmod-ancient-type, .eqmod-maxstat-value, .eqmod-enchant-level, .eqmod-enchant-type").click(function(t){t.stopPropagation()}),$(".eqmod-ancient-type").change(function(){$(".eqmod-ancient").click()}),$(".eqmod-maxstat-value").change(function(){var t=!1;for(var e in DiabloCalc.itemSlots){var i=DiabloCalc.getSlot(e);if(i&&i.imported){t=!0;break}}t||$(".eqmod-maxstat").click()});var x=$('<span class="status"></span>').hide(),I=$('<div class="stash-header">'+c("Drag items between paperdoll and stash.<br/>Hold shift to clone items.")+"</div>");DiabloCalc.stashHeader=I,d.append(I.prepend(x)),I.append(DiabloCalc.account.makeLine(c(" to access your personal stash"),function(t){t?(x.addClass("loading").text(c("Loading...")).show(),$.ajax({url:"loadstash",data:{},type:"POST",dataType:"json",success:function(t){for(x.hide();t.length&&!t[t.length-1];)t.pop();o(t.length);for(var e=0;e<t.length&&e<B.length;++e)t[e]&&DiabloCalc.itemById[t[e].id]&&(t[e].id=DiabloCalc.itemById[t[e].id].id),B[e].setItem(t[e],"loading")},error:function(t){x.removeClass("loading").text(c("Failed to load!"))}}),this.hide()):this.show()}));var k={};k.line=$('<div class="stash-edit"><div class="top-left"></div><div class="top-right"></div><div class="bottom"></div></div>').hide(),k.line.append('<div class="left"></div><div class="right"></div>'),k.save=$("<button>"+c("Save")+"</button>").button({icons:{primary:"ui-icon-check"}}),k.del=$("<button>"+c("Delete")+"</button>").button({icons:{primary:"ui-icon-trash"}}),k.line.append(k.save).append(k.del),d.append(k.line),k.updateItem=function(t,e){var i=k.itemBox.getData();k.slot&&k.slot.setItem(i,"editing"),k.line.removeClass().addClass("stash-edit"),i&&i.id&&DiabloCalc.itemById[i.id]&&k.line.addClass("quality-"+DiabloCalc.itemById[i.id].quality)},k.itemBox=new DiabloCalc.ItemBox(k.line,{onUpdate:k.updateItem}),k.itemBox.setClass(),k.setItem=function(t,e){this.itemBox.setItem(t,e),this.line.removeClass().addClass("stash-edit"),t&&t.id&&DiabloCalc.itemById[t.id]&&this.line.addClass("quality-"+DiabloCalc.itemById[t.id].quality)},k.setSlot=function(t){if(t&&t.item&&!DiabloCalc.itemById[t.item.id]&&(t=void 0),this.slot&&this.slot.box.removeClass("edit"),t&&t.box.addClass("edit"),this.slot=t,!t)return this.setItem(),this.line.hide(),void DiabloCalc.hidePopup(this);this.setItem(t.item),t.line.after(this.line);var e=t.box.index();this.line.find(".top-left").css("width",21+84*e),this.line.find(".top-right").css("left",122+84*e),this.line.show(),DiabloCalc.showPopup(this)},k.hide=function(){this.setSlot()},k.contains=function(t){return!(!this.slot.box.is(t)&&!this.slot.box.has(t).length)||!(!this.line.is(t)&&!this.line.has(t).length)},k.save.click(function(){var t=k.itemBox.getData();k.slot&&k.slot.setItem(t,"editing"),k.setSlot(),a()}),k.del.click(function(t){DiabloCalc.popupMenu(t,c.fixkey({"Confirm delete?":function(){k.slot&&k.slot.setItem(void 0,"editing"),k.setSlot()}}))});var B=[],w=[];o(25);for(var q in DiabloCalc.itemSlots)DiabloCalc.itemSlots[q].drop=new e(q);DiabloCalc.getItemAffixes=function(t,e){var i=DiabloCalc.itemSlots[t].item;return i?DiabloCalc.getItemAffixesById(i.id,i.ancient,e):{}},DiabloCalc.setSlot=function(t,e){if(e)if(DiabloCalc.itemById[e.id]){if(e.id=DiabloCalc.itemById[e.id].id,e.gems&&e.gems.length){for(var i=0;i<e.gems.length;++i)"number"==typeof e.gems[i][0]&&e.gems[i][0]>=DiabloCalc.gemQualities.length&&(e.gems[i][0]=DiabloCalc.oldGemQualities[e.gems[i][0]]);(!e.stats.sockets||e.stats.sockets[0]<e.gems.length)&&(e.stats.sockets=[e.gems.length])}}else e=void 0;DiabloCalc.itemSlots[t].drop.setItem(e)},DiabloCalc.getSlotId=function(t){var e=DiabloCalc.itemSlots[t].item;return e?e.id:void 0},DiabloCalc.getSlotData=function(t){return DiabloCalc.itemSlots[t].item},DiabloCalc.register("changeClass",n),DiabloCalc.register("changeGender",function(){b.updateIcon()}),n()}();!function(){function e(){DiabloCalc.account.userName()?(f.results.div.show(),f.results.search()):f.results.div.hide()}function a(e,a,l,t){var s={region:e,tag:a,id:l};t&&(s.dead=1),$.ajax({url:"proxy",data:s,type:"POST",dataType:"json",success:function(e){!function(e,a){var l=DiabloCalc.classMap[a.class]||a.class,t={};t.class=l,0===a.gender&&(t.gender="male"),1===a.gender&&(t.gender="female"),t.gender,t.items={};for(var s in a.items)t.items[DiabloCalc.slotMap[s]||s]=DiabloCalc.parseItemData(a.items[s],l);if(a.skills&&a.skills.active){var o=a.skills.active;for(t.skills=[],p=0;p<o.length;++p)if(o[p].skill){var i=o[p].skill.slug,n="x";o[p].rune&&(n=o[p].rune.type),t.skills.push([DiabloCalc.skillById[l][i],n])}else t.skills.push(null)}if(a.skills&&a.skills.passive){var r=a.skills.passive;for(t.passives=[],p=0;p<r.length;++p)r[p].skill?(i=r[p].skill.slug,t.passives.push(DiabloCalc.skillById[l][i])):t.passives.push(null)}if(t.paragon={level:0},a.paragonLevel&&(t.paragon.level=a.paragonLevel,a.paragonLevel>=800&&(t.paragon.data=[[0,0,0,0],[50,50,50,50],[50,50,50,50],[50,50,50,50]])),a.legendaryPowers){t.kanai={};for(var p=0;p<a.legendaryPowers.length;++p){var c=a.legendaryPowers[p],d=c&&DiabloCalc.getKanaiType(c.id);c&&d&&(t.kanai[d]=c.id)}}DiabloCalc.setProfile(t,"import"),$(".editframe").tabs("option","active",1)}(0,e)}})}function l(e,l,t,s,o){DiabloCalc.activity("importchar"),DiabloCalc.isModified&&DiabloCalc.isModified()?DiabloCalc.popupMenu(e,c.fixkey({"Discard current profile?":function(){a(l,t,s,o)}})):a(l,t,s,o)}function t(e,a){DiabloCalc.activity("importprofile"),a=a.replace("#","-"),d.results.empty(),$.ajax({url:"proxy",data:{region:e,tag:a},type:"POST",dataType:"json",success:function(t){d.results.empty(),t.heroes||t.fallenHeroes||(t.reason?d.results.text(t.reason):d.results.text(c("Profile not found.")));for(var s=0;s<2;++s){var o=s?t.fallenHeroes:t.heroes;if(o){s&&d.results.append("<p>"+c("Fallen Heroes")+"</p>");for(var i=0;i<o.length;++i){var n=o[i],r=$("<li></li>"),p=DiabloCalc.classMap[n.class]||n.class,u="";0===n.gender&&(u+=" male"),1===n.gender&&(u+=" female"),d.results.append(r),r.append('<span class="class-icon class-'+p+u+'">&nbsp;</span>'),r.click(function(t,s){return function(o){l(o,e,a,t,s)}}(n.id,s));var v=new Date(1e3*(n.death?n.death.time:n["last-updated"])).toLocaleDateString(),f="",h="",m="";n.hardcore&&(f=" hero-hardcore"),n.seasonal&&(h=' <span class="hero-seasonal" title="'+c("Seasonal")+'">&nbsp;</span>'),(n.dead||s)&&(m=' <span class="hero-dead">'+c("(Died {0})").format(v)+"</span>",r.addClass("hero-dead")),r.append('<span class="hero-name">'+n.name+"</span>"),r.append(' <span class="hero-desc'+f+'">'+c("Level {0} {1}").format(n.level,DiabloCalc.classes[p].name)+"</span>"+h+m),n.dead||r.append('  <span class="hero-updated">'+c("(updated {0})").format(v)+"</span>")}}}},error:function(){d.results.text(c("Profile not found."))}})}function s(a,l){DiabloCalc.activity("saveprofile"),void 0===l&&(l=u.allsets.prop("checked"));var t,s=l?DiabloCalc.getAllProfiles():DiabloCalc.getProfile();a?(s.id=a,t=f.response):(s.name=u.name.val(),s.public=u.public.prop("checked"),t=u.response),t.hide(),void 0!==a&&(s.id=a),$.ajax({url:"save",data:JSON.stringify(s),type:"POST",processData:!1,contentType:"application/json",dataType:"json",success:function(a){if(a.id){var l=location.protocol+"//"+location.hostname+DiabloCalc.relPath+a.id;DiabloCalc.session.profile=a.id,window.history&&window.history.replaceState&&window.history.replaceState({},"",l),t.val(l),e()}else a.errors&&a.errors.length?t.val(a.errors[0]):t.val(c("Failed to save profile."));t.slideDown()},error:function(e){t.val(c("Failed to save profile.")),t.slideDown()}})}function o(e,a,l){for(var t in e)if(e.hasOwnProperty(t)){var s=(a?a+".":"")+t;if("string"==typeof e[t]){if(l&&s.match(l))continue;e[t]=e[t].replace(/[^a-zA-Z0-9_\-+\. ]/g,"")}else"object"==typeof e[t]&&o(e[t],s,l)}}function i(e,a){var l={id:e};a&&(l.error=1),$.ajax({url:"load",data:l,type:"POST",dataType:"json",success:function(l){DiabloCalc.session.profile=e,window.history&&window.history.replaceState&&window.history.replaceState({},"",location.protocol+"//"+location.hostname+DiabloCalc.relPath+(a?"e":"")+e),o(l,"",/profiles\.[0-9]+\.name/),DiabloCalc.setAllProfiles(l,"load"),$(".editframe").tabs("option","active",0)},error:function(e){}})}function n(e,a,l){DiabloCalc.activity("loadprofile"),e&&DiabloCalc.isModified&&DiabloCalc.isModified()?DiabloCalc.popupMenu(e,c.fixkey({"Discard current profile?":function(){i(a,l)}})):i(a,l)}function r(a,l){var t=l.id,o=$("<li></li>");return l.views&&o.attr("title",c("{0} recent views").format(l.views)),o.append('<span class="class-icon class-'+l.class+(l.gender?" "+l.gender:"")+'">&nbsp;</span>'),o.click(function(e){n(e,t)}),o.append('<span class="profile-name'+(l.value?"":" unnamed")+'">'+(l.value||c("Unnamed profile"))+"</span>"),l.author&&l.value&&o.find(".profile-name").append('<span class="profile-author">'+c(" by {0}").format(l.author)+"</span>"),a.user&&(o.append($('<span class="profile-overwrite" title="'+c("Update profile")+'"></span>').click(function(e){e.stopPropagation(),DiabloCalc.popupMenu(e,c.fixkey({"Save current set":function(){s(t,!1)},"Save all sets and settings":function(){s(t,!0)}}))})),o.append($('<span class="profile-delete" title="'+c("Delete profile")+'"></span>').click(function(a){a.stopPropagation(),DiabloCalc.popupMenu(a,c.fixkey({"Confirm delete?":function(){$.ajax({url:"delete",data:{id:t},type:"POST",dataType:"json",success:function(a){"OK"===a.code?(f.response.val(c("Deleted.")),e()):a.errors&&a.errors.length?f.response.val(a.errors[0]):f.response.val(c("Failed to delete profile.")),f.response.slideDown()},error:function(e){f.response.val(c("Failed to delete profile.")),f.response.slideDown()}})}}))}))),o.append('<span class="date-saved"><span>'+new Date(1e3*l.date).toLocaleString()+"</span></span>"),o}var p,c=DiabloCalc.locale("ui-import.js"),d={},u={},v={},f={};(p=DiabloCalc.addScroll($("#tab-import"),"y")).append("<h3>"+c("Import")+"</h3>");var h=$("<div></div>");p.append(h),h.append("<p>"+c("BNImportNotice")+"</p>"),d.region=$("<select></select>").addClass("import-region"),d.region.append('<option value="eu">EU</option>'),d.region.append('<option value="us">US</option>'),d.region.append('<option value="tw">TW</option>'),d.region.append('<option value="kr">KR</option>'),d.region.append('<option value="cn">CN</option>'),d.battletag=$("<input></input>").addClass("import-battletag").addClass("tooltip-active").val("Tag#1234").attr("name","battletag"),d.button=$("<input></input>").attr("type","submit").val(c("Search")).click(function(){var e=d.region.val(),a=d.battletag.val();if(!d.battletag.hasClass("tooltip-active")){var l=DiabloCalc.getStorage("battletag")||{};l[e]||(l[e]=[]),l[e].indexOf(a)<0&&l[e].push(a),DiabloCalc.setStorage("region",e),DiabloCalc.setStorage("battletag",l),t(e,a)}}),d.battletag.focus(function(){$(this).hasClass("tooltip-active")&&($(this).removeClass("tooltip-active"),$(this).val("")),$(this).autocomplete("search")}).blur(function(){""===$(this).val()&&($(this).addClass("tooltip-active"),$(this).val("Tag#1234"))}).autocomplete({delay:0,minLength:0,select:function(e,a){t(d.region.val(),a.item.value)},source:function(e,a){var l=d.region.val(),t=(DiabloCalc.getStorage("battletag")||{})[l]||[];t.sort();var s=new RegExp($.ui.autocomplete.escapeRegex(e.term.toLowerCase()));a($.grep(t,function(e){return e&&s.test(e.toLowerCase())}))}}).keypress(function(e){13==e.which&&($(this).blur(),d.button.click())}),d.region.val(DiabloCalc.getStorage("region")||"us"),h.append(d.region).append(d.battletag).append(d.button),d.results=$('<ul class="import-results"></ul>'),h.append(d.results),p.append("<h3>"+c("Save")+"</h3>");var m=$("<div></div>");p.append(m),m.append("<p>"+c("Enter a name or a short description for your profile. Unnamed profiles do not come up in search results.")+"</p>"),u.public=$('<input type="checkbox"></input>'),u.allsets=$('<input type="checkbox"></input>');var b=$('<label title="'+c("This profile will come up in search results, and might appear in future Popular Builds listings.")+'">'+c("Public profile")+"</label>").prepend(u.public).css("margin-bottom",-6);m.append(b),m.append($("<label>"+c("Save all sets and settings")+"</label>").prepend(u.allsets)),u.name=$('<input class="import-savename"></input>'),u.button=$('<input type="button" value="'+c("Save")+'"></input>').click(function(){s()}),u.response=$('<input class="import-saveresult" readonly="readonly"></input>').focus(function(){this.select()}).mouseup(function(e){e.preventDefault()}).hide(),m.append(u.name,"<br/>",u.button,u.response),p.append("<h3>"+c("Search")+"</h3>");var g=$("<div></div>");p.append(g),v.cls=$('<select class="import-loadclass"><option value="">'+c("Any Class")+"</option></select>");for(var C in DiabloCalc.classes)DiabloCalc.classes[C].follower||v.cls.append('<option value="'+C+'">'+DiabloCalc.classes[C].name+"</option>");v.mainset=$('<select class="import-mainset"><option value="">'+c("Any Set")+"</option></select>"),v.order=$('<select class="import-loadorder"></select>'),v.order.append('<option selected="selected" value="popularity">'+c("Most popular first")+"</option>"),v.order.append('<option value="date">'+c("Most recent first")+"</option>"),v.name=$('<input class="import-loadname" placeholder="'+c("Profile name")+'"></input>'),v.button=$('<input type="button" value="'+c("Search")+'"></input>').click(function(){DiabloCalc.activity("search"),v.results.search({term:v.name.val(),cls:v.cls.val(),mainset:v.mainset.val(),order:v.order.val()})}),v.results=new DiabloCalc.SearchResults("search",r),g.append($('<div class="searchrow searchrow-1"></div>').append(v.cls,v.mainset,v.button),$('<div class="searchrow"></div>').append(v.name,v.order),v.results.div),v.cls.change(function(){v.mainset.val();v.mainset.empty(),v.mainset.append('<option value="">'+c("Any Set")+"</option>"),v.mainset.append('<option value="none">'+c("None ({0})").format(DiabloCalc.itemSets.nightmares.name)+"</option>");var e=v.cls.val();for(var a in DiabloCalc.itemSets){var l=DiabloCalc.itemSets[a];l.class!==e&&l.tclass!==e||!l.bonuses[6]||v.mainset.append('<option value="'+a+'">'+l.name+"</option>")}}),DiabloCalc.register("changeClass",function(){v.cls.val(DiabloCalc.charClass).change()}),v.cls.val(DiabloCalc.charClass).change(),v.name.autocomplete({minLength:2,select:function(e,a){DiabloCalc.activity("search"),n(e,a.item.id)}});var y=v.name.autocomplete("instance");y._renderItem=function(e,a){return $("<li></li>").addClass("search-tip").append('<a class="class-icon class-'+a.class+'">'+a.value+(a.author?' <span class="profile-author">'+c(" by {0}").format(a.author)+"</span>":"")+"</a>").appendTo(e)},v.name.autocomplete({source:function(e,a){y.xhr&&y.xhr.abort(),y.xhr=$.ajax({url:"search",data:{term:e.term,cls:v.cls.val(),mainset:v.mainset.val(),order:v.order.val()},dataType:"json",global:!1,success:function(e){a(e.results||[])},error:function(){a([])}})}}),v.name.on("keypress",function(e){13===e.which&&(v.button.click(),v.name.autocomplete("close"),y.xhr&&(y.xhr.abort(),delete y.xhr),setTimeout(function(){y.searching&&(clearTimeout(y.searching),delete y.searching)},1))}),p.append("<h3>"+c("My Profiles")+"</h3>");var D=$("<div></div>");p.append(D),f.results=new DiabloCalc.SearchResults("search",r),f.response=$('<input class="import-saveresult" readonly="readonly"></input>').focus(function(){this.select()}).mouseup(function(e){e.preventDefault()}).hide(),D.append(f.results.div,f.response),D.prepend(DiabloCalc.account.makeLine(c(" to track your saved profiles"),function(a){e(),this.toggle(!a)})),p.accordion({collapsible:!0,heightStyle:"content",activate:function(e,a){a.newPanel.removeClass("sliding"),a.oldPanel.removeClass("sliding")},beforeActivate:function(e,a){a.newPanel.addClass("sliding"),a.oldPanel.addClass("sliding")}}),DiabloCalc.loadProfile=n}();!function(){function a(a){var t=parseInt(a.input.val())||0;a.limit&&t>=a.limit?a.line.addClass("paragon-capped"):a.line.removeClass("paragon-capped"),a.tipvalue.text("+"+DiabloCalc.formatNumber(t*a.amount,a.decimal,1e3)+(a.percent?"%":""))}function t(){for(var a=0,t=0;t<v.length;++t)a+=v[t].spent;0==a?c.hide():c.show()}function n(a,t,n){v[a].unspent.text(m("{0} unspent points").format(t)),t?v[a].header.removeClass("paragon-spent"):v[a].header.addClass("paragon-spent"),0==n?v[a].reset.hide():v[a].reset.show(),v[a].spent=n}function e(a,t){return Math.floor((Math.min(a,800)-t+3)/4)+(0==t?Math.max(0,a-800):0)}function s(s){for(var i=parseInt(p.val())||0,r=0;r<v.length;++r){var l=e(i,r),o=0;if(!s&&r>0&&l>=50*v[r].stats.length){for(var c=0,m=0;m<v[r].stats.length;++m){(g=parseInt(v[r].stats[m].input.val())||0)<50&&(c+=50-g,v[r].stats[m].input.val(50),a(v[r].stats[m])),o+=50}c&&(u=void 0,d=void 0,DiabloCalc.trigger("updateParagon"))}else{for(m=0;m<v[r].stats.length;++m)o+=parseInt(v[r].stats[m].input.val())||0;if(l<o){for(m=v[r].stats.length-1;m>=0;--m){var g=parseInt(v[r].stats[m].input.val())||0,c=Math.min(g,o-l);v[r].stats[m].input.val(g-c),o-=c,a(v[r].stats[m])}u=void 0,d=void 0,DiabloCalc.trigger("updateParagon")}}n(r,l-o,o)}t()}function i(t){if(void 0===t)for(var n=0;n<v.length;++n)for(e=0;e<v[n].stats.length;++e)v[n].stats[e].input.val(0),a(v[n].stats[e]);else for(var e=0;e<v[t].stats.length;++e)v[t].stats[e].input.val(0),a(v[t].stats[e]);s(),DiabloCalc.trigger("updateParagon")}function r(i,r){for(var l=v[i].stats[r],o=0,c=0;c<v[i].stats.length;++c)o+=parseInt(v[i].stats[c].input.val())||0;var m=e(parseInt(p.val())||0,i);o>m?(i>0&&o>200?l.input.val(Math.max(0,(parseInt(l.input.val())||0)-(o-m))):p.val(function(a,t){return a<=200?4*a+t-3:a+600}(o,i)),s()):(n(i,m-o,o),t()),a(l),u=void 0,d=void 0,DiabloCalc.trigger("updateParagon")}function l(s,i,r){for(var l=v[s].stats[i],o=0,c=0;c<v[s].stats.length;++c)o+=parseInt(v[s].stats[c].input.val())||0;var m=e(parseInt(p.val())||0,s),g=parseInt(l.input.val())||0,f=Math.min(r,m-o);l.limit&&(f=Math.min(f,l.limit-g)),l.input.val(g+f),n(s,m-o-f,o+f),t(),a(l),u=void 0,d=void 0,DiabloCalc.trigger("updateParagon")}function o(){for(var t=$(".char-class").val(),n=0;n<v.length;++n)for(var e=0;e<v[n].stats.length;++e){var s=v[n].stats[e];if(s.stats)for(var i=0;i<s.stats.length;++i){var r=s.stats[i];if(!DiabloCalc.stats[r].classes||DiabloCalc.stats[r].classes.indexOf(t)>=0){s.stat=r,s.icons&&(s.icon=s.icons[i]),s.tipicon.css("background-position",24*-s.icon+"px 0"),s.tipname.text(DiabloCalc.stats[r].name),s.amounts&&(s.amount=s.amounts[i]),a(s);break}}}u=void 0,d=void 0,DiabloCalc.trigger("updateParagon")}var p,c,u,m=DiabloCalc.locale("ui-paragon.js"),v=[{name:m("Core"),stats:[{stats:["int","str","dex"],icons:[2,0,1],amount:5},{stat:"vit",icon:3,amount:5},{stat:"ms",icon:4,amount:.5,decimal:2,limit:50,percent:!0},{stats:["maxap","maxhatred","maxfury","maxmana","maxspirit","maxwrath","maxessence"],icons:[9,7,6,5,8,10,5],amounts:[.5,.5,1,4,1,.5,1],decimal:2,limit:50}]},{name:m("Offense"),stats:[{stat:"ias",icon:11,amount:.2,decimal:2,limit:50,percent:!0},{stat:"cdr",icon:12,amount:.2,decimal:2,limit:50,percent:!0},{stat:"chc",icon:13,amount:.1,decimal:2,limit:50,percent:!0},{stat:"chd",icon:14,amount:1,decimal:2,limit:50,percent:!0}]},{name:m("Defense"),stats:[{stat:"life",icon:15,amount:.5,decimal:2,limit:50,percent:!0},{stat:"armor_percent",icon:16,amount:.5,decimal:2,limit:50,percent:!0},{stat:"resall",icon:17,amount:5,limit:50},{stat:"regen",icon:18,amount:214.5684,decimal:1,limit:50}]},{name:m("Utility"),stats:[{stat:"area",icon:19,amount:1,limit:50,decimal:2,percent:!0},{stat:"rcr",icon:20,amount:.2,decimal:2,limit:50,percent:!0},{stat:"lph",icon:21,amount:160.926,decimal:1,limit:50},{stat:"gf",icon:22,amount:1,decimal:2,limit:50,percent:!0}]}];DiabloCalc.getParagon=function(){if(void 0!==u)return u;u={};for(var a=0;a<v.length;++a)for(var t=0;t<v[a].stats.length;++t){var n=v[a].stats[t];u[n.stat]=[n.amount*(parseInt(n.input.val())||0)]}return u};var d;DiabloCalc.getParagonLevels=function(){if(void 0!==d)return d;for(var a={level:parseInt(p.val())||0,data:[]},t=0;t<v.length;++t){for(var n=[],e=0;e<v[t].stats.length;++e){var s=v[t].stats[e];n.push(parseInt(s.input.val())||0)}a.data.push(n)}return d=a,a},DiabloCalc.setParagon=function(t){p.val(t.level);for(var n=0;n<v.length;++n)for(var e=0;e<v[n].stats.length;++e){var i=v[n].stats[e];i.input.val(t.data?t.data[n][e]:0),a(i)}s(!0),u=void 0,d=void 0,DiabloCalc.trigger("updateParagon")};var g=$("#tab-paragon");g=DiabloCalc.addScroll(g,"y"),(c=$('<span class="reset-link reset-all">'+m("Reset all")+"</span>").hide()).click(function(){i()});var f=$('<div class="paragon-header"></div>'),h=$('<span class="paragon-level"></span>').text(m("Paragon level"));(p=$("<input></input>").attr("type","number").attr("min","0").val(0)).blur(DiabloCalc.validateNumber).change(function(){s()}),h.append(p),f.append(c).append(h),g.append(f);for(var b=0;b<v.length;++b){v[b].header=$("<h3></h3>").text(v[b].name+" ").addClass("paragon-spent"),v[b].unspent=$('<span class="paragon-unspent"></span>').text(m("{0} unspent points").format(0)),v[b].reset=$('<span class="reset-link reset-tab">'+m("(reset)")+"</span>").hide(),g.append(v[b].header.append(v[b].reset).append(v[b].unspent)),v[b].category=$("<ul></ul>"),g.append(v[b].category),v[b].reset.click(function(a){return function(){i(a)}}(b));for(var C=0;C<v[b].stats.length;++C){var x=v[b].stats[C];x.stats&&(x.stat=x.stats[0]),x.icons&&(x.icon=x.icons[0]),x.amounts&&(x.amount=x.amounts[0]),x.line=$("<li></li>"),x.tipicon=$('<span class="icon"></span>').css("background-position",24*-x.icon+"px 0"),x.tipname=$("<span></span>").text(DiabloCalc.stats[x.stat].name),x.tipvalue=$('<span class="paragon-effect"></span>').text(0),x.add=$('<span class="paragon-add">&nbsp;</span>'),x.input=$('<input type="number" min="0"></input>').val(0),x.percent&&x.tipvalue.addClass("paragon-percent"),x.limit&&x.input.attr("max",x.limit),x.input.blur(DiabloCalc.validateNumber),x.input.on("input",function(a,t){return function(){r(a,t)}}(b,C)),x.add.click(function(a,t){return function(n){n.preventDefault(),n.stopPropagation(),l(a,t,n.ctrlKey?100:n.shiftKey?10:1)}}(b,C)),x.line.append(x.tipicon,x.tipname,x.input,x.add,x.tipvalue),v[b].category.append(x.line),a(x)}}DiabloCalc.register("changeClass",o),o()}();!function(){function a(a,l,e){var s=e.getValue(l.stat);return a=a.replace(/{([^};]*)(?:;(\+)?([0-9])?(\%)?(x)?)?}/g,function(a,l,t,i,o,n){return l=l.replace(/\$([1-9])/g,function(a,l){return"number"==typeof s?s:s[["min","max"][parseInt(l)-1]]}),l=e.execString(l),l="number"==typeof l?DiabloCalc.formatNumber(l,i,1e3):DiabloCalc.formatNumber(l.min,i,1e3)+"-"+DiabloCalc.formatNumber(l.max,i,1e3),'<span class="d3-color-green">'+(t||"")+l+(o||"")+(n||"")+"</span>"}),(a=a.replace(/\$([1-9])/g,function(a,e){return'<span class="d3-color-green">'+(l.plus?"+":"")+DiabloCalc.formatNumber("number"==typeof s?s:s[["min","max"][parseInt(e)-1]],l.decimal,1e3)+(l.percent?"%":"")+"</span>"})).replace(/<\/span>-<span class="d3-color-green">/g,"-")}function l(l,e){function s(a){return DiabloCalc.formatNumber(a,d,1e3)+f}function t(a){return'<span class="d3-color-'+(a>=0?"green":"red")+'">'+s(a)+"</span>"}var o=a(l.tooltip,l,e),n="</span>";o=o.replace(/\n( ?\* )?/g,function(a,l){var e=n+'<br/><span class="tooltip-icon-'+(l?"bullet":"nobullet")+'"></span>';return n="",e}),l.suffix&&(o+=n+'<br/><span class="tooltip-icon-bullet"></span>'+a(l.suffix,l,e),n="");var c=l.sourcestat||l.stat;if(DiabloCalc.stats[c]){var r={},p={};if("damage"!=c&&(!DiabloCalc.stats[c].classes||DiabloCalc.stats[c].classes.indexOf(DiabloCalc.charClass)>=0)&&DiabloCalc.getItemAffixes)for(var u in DiabloCalc.itemSlots){(m=DiabloCalc.getItemAffixes(u,!0))&&m[c]&&m[c].min&&m[c].max&&(r[u]=0,p[u]=m[c])}if(DiabloCalc.stats[c]&&DiabloCalc.stats[c].resist&&e.sources.resall){r=$.extend(r,e.sources.resall);for(var u in e.sources.resall)if(DiabloCalc.itemSlots[u]&&DiabloCalc.getItemAffixes){var m=DiabloCalc.getItemAffixes(u,!0);m&&m.resall&&m.resall.min&&m.resall.max&&(p[u]=m.resall)}}e.sources[c]&&(r=$.extend(r,e.sources[c]));var b=[];if(DiabloCalc.stats[c]&&DiabloCalc.stats[c].special&&(b=e.getSpecial(c,null,!1,null)),!$.isEmptyObject(r)||!$.isEmptyObject(b)){o+=n,o+='<br/><span class="tooltip-icon-bullet"></span>'+(l.sourcename||i("Increased by"))+":",n="";var d=void 0===l.sourcedecimal?l.decimal:l.sourcedecimal,f=(void 0===l.sourcepercent?l.percent:l.sourcepercent)?"%":"";for(var C in r)DiabloCalc.sourceNames[C]&&(o+='<br/><span class="tooltip-icon-nobullet"></span><span class="d3-color-'+(r[C]?"gold":"gray")+'">'+DiabloCalc.sourceNames[C]+"</span>: ",r[C]?(o+=t(r[C]),p[C]&&(o+=' <span class="d3-color-gray">('+s(p[C].min)+"-"+s(p[C].max)+")</span>")):p[C]&&(o+='<span class="d3-color-gray">'+s(p[C].min)+"-"+s(p[C].max)+"</span>"));for(var h=0;h<b.length;++h)o+='<br/><span class="tooltip-icon-nobullet"></span><span class="d3-color-gold">'+b[h][0]+"</span>: ",o+=t(b[h][1])}}return'<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+o+n+"</p></div>"}function e(a,l){var e=l.sources[a]||{};DiabloCalc.onHighlight&&DiabloCalc.onHighlight(!0),DiabloCalc.stats[a]&&DiabloCalc.stats[a].resist&&l.sources.resall&&(e=$.extend(e,l.sources.resall));for(var s in DiabloCalc.itemSlots)(e[s]||DiabloCalc.itemSlots[s].item&&e[DiabloCalc.itemSlots[s].item.id])&&DiabloCalc.itemSlots[s].dollFrame.addClass("highlight")}function s(){DiabloCalc.onHighlight&&DiabloCalc.onHighlight(!1);for(var a in DiabloCalc.itemSlots)DiabloCalc.itemSlots[a].dollFrame&&DiabloCalc.itemSlots[a].dollFrame.removeClass("highlight")}function t(){for(var a=r.find("input").val().toLowerCase(),l=DiabloCalc.getStats(),e=$(".char-class").val(),s=0;s<o.length;++s)for(var t=0;t<o[s].stats.length;++t){var i=o[s].stats[t];if(i.line&&!i.separator)if(i.classes&&i.classes.indexOf(e)<0)i.line.hide();else if(a&&i.name.toLowerCase().indexOf(a)<0)i.line.hide();else{var n=l.getValue(i.stat);!i.collapse||n?("number"==typeof n?(i.line.toggleClass("zero",!n),n=DiabloCalc.formatNumber(n,i.decimal,1e3)):(i.line.toggleClass("zero",!n.min&&!n.max),n=DiabloCalc.formatNumber(n.min,i.decimal,1e3)+"-"+DiabloCalc.formatNumber(n.max,i.decimal,1e3)),i.value.text((i.plus?"+":"")+n+(i.percent?"%":"")),i.line.show()):i.line.hide()}}}var i=DiabloCalc.locale("ui-stats.js"),o=DiabloCalc.localeTable.uiStats,n=$(".col.statsframe .statsframe-list"),c=$(".col.statsframe");n=DiabloCalc.addScroll(n,"y");var r=$('<div class="statsframe-search empty"><input placeholder="'+i("Search")+'"></input><span class="clear"></span></div>');c.prepend(DiabloCalc.account.makeLine(),r),r.find("input").focus(function(){$(this).attr("placeholder","")}).blur(function(){$(this).attr("placeholder",i("Search"))}).on("input",function(){t(),n.toggleClass("search",$(this).val().length>0),r.toggleClass("empty",0===$(this).val().length)}),r.find(".clear").click(function(){r.find("input").val("").trigger("input")});for(var p=o[1].stats,u=0;u<p.length&&!p[u].separator;)u++;for(var m in DiabloCalc.stats)DiabloCalc.stats[m].skill&&p.splice(u,0,{name:i("{0} Damage Increase").format(DiabloCalc.stats[m].skill),stat:m,decimal:2,percent:!0,classes:DiabloCalc.stats[m].classes,collapse:!0,tooltip:i("{0} Damage Increase: $1\n* Increases Damage dealt by this skill.").format(DiabloCalc.stats[m].skill)});var b=$('<div class="col-container"></div>');n.append(b);var d=$('<div class="column"></div>');b.append(d);for(var f={},C=0;C<o.length;++C){var h=$('<div class="stat-section"></div>');d.append(h),h.append("<h3>"+o[C].name+"</h3>");var g=$('<ul class="flex"></ul>');h.append(g);for(var v=0;v<o[C].stats.length;++v){var D=o[C].stats[v];(!D.stat||D.name||DiabloCalc.stats[D.stat])&&(D.line=$("<li></li>"),f[D.stat]=D,g.append(D.line),D.separator?D.line.addClass("stat-separator"):(D.name||(D.name=DiabloCalc.stats[D.stat].name),D.line.append("<span>"+D.name+"</span>"),D.value=$("<span></span>"),D.line.append(D.value),D.line.hover(function(a){return function(){if(DiabloCalc.getStats&&DiabloCalc.tooltip){var s=DiabloCalc.getStats();DiabloCalc.tooltip.showHtml(this,l(a,s),"left");e(a.sourcestat||a.stat,s)}}}(D),function(){DiabloCalc.tooltip&&(DiabloCalc.tooltip.hide(),s())})))}}var x=$('<div class="stat-section export"><h3>'+i("Export")+"</h3><ul></ul></div>");d.append(x);var S=document.createElement("a");x.find("ul").append($('<li><span class="link-like">'+i("Export CSV")+"</span></li>").on("click","span",function(){for(var a=DiabloCalc.getProfile(),l=[],e=[DiabloCalc.classes[a.class].name],s=[i("LMB"),i("RMB"),"1","2","3","4"],t=DiabloCalc.locale("ui-skills.js")("No rune"),o=0;o<a.skills.length;++o){c=(n=a.skills[o])&&DiabloCalc.skills[a.class][n[0]];n&&c&&l.push(s[o]+","+c.name+","+("x"===n[1]?t:c.runes[n[1]]))}l.length&&(e.push(l.join("\n")),l.length=0);for(o=0;o<a.passives.length;++o){var n=a.passives[o],c=n&&DiabloCalc.passives[DiabloCalc.charClass][n];n&&c&&l.push(c.name)}l.length&&(e.push(l.join("\n")),l.length=0);var r=DiabloCalc.locale("ui-equipment.js");for(var o in a.items){var p=[DiabloCalc.itemSlots[o].name],c=(g=a.items[o])&&DiabloCalc.itemById[g.id];if(g&&c){p.push(c.name),p.push(g.ancient?r("Ancient"):"");for(var u in g.stats){var m="custom"===u&&c.required&&c.required.custom&&c.required.custom.name||DiabloCalc.stats[u]&&DiabloCalc.stats[u].name;m&&p.push(g.stats[u].join("-")+" "+m)}}else p.push(r("Empty slot"));if(l.push(p.join(",")),g&&g.gems)for(var b=0;b<g.gems.length;++b){if((C=g.gems[b])&&C instanceof Array){var d=DiabloCalc.legendaryGems[C[0]],f=DiabloCalc.gemColors[C[1]];d?l.push(","+d.name+","+C[1]):f&&l.push(","+f.names[C[0]])}}}l.length&&(e.push(l.join("\n")),l.length=0);for(var C in a.kanai){var h=a.kanai[C],g=h&&DiabloCalc.itemById[h];g&&l.push(g.name)}l.length&&(l.unshift(DiabloCalc.locale("ui-skills.js")("Kanai's Cube")),e.push(l.join("\n")),l.length=0);var v=window.URL.createObjectURL(new Blob([e.join("\n\n")],{type:"text/csv"}));S.href=v,S.download="profile.csv",document.body.appendChild(S),S.click(),setTimeout(function(){document.body.removeChild(S),window.URL.revokeObjectURL(v)},100)})),DiabloCalc.isKnownStat=function(a){return!!f[a]},DiabloCalc.showStatTip=function(a,e){f[e]&&DiabloCalc.tooltip.showHtml(a,l(f[e],DiabloCalc.getStats()))};var y=$('<div class="column"></div>');b.append(y),b.find(".column").sortable({containment:b,connectWith:".col.statsframe .column",items:".stat-section",handle:"h3",distance:4,placeholder:"drop-ph",forcePlaceholderSize:!0,start:function(){c.addClass("two-column")},stop:function(){setTimeout(function(){y.is(":empty")&&c.removeClass("two-column")},0)}}),$(".col.statsframe h3").click(function(){$(this).next().slideToggle()}),DiabloCalc.register("updateStats",t)}();!function(){function s(){S.hide(),y.hide(),g=c.scrollTop();var s=DiabloCalc.charClass;u.empty(),u.removeClass().addClass("class-"+s),k=[],D=[];for(var i in DiabloCalc.legendaryGems)delete DiabloCalc.legendaryGems[i].line;for(var l in DiabloCalc.itemaffixes)delete DiabloCalc.itemaffixes[l].line;for(a=0;a<6;++a)k.push(new DiabloCalc.SkillBox.skill(u,a)),k[a].header.click(function(s){return function(i){S.show(s,i)}}(k[a])).contextmenu(function(s){return function(){return s.setSkill(),DiabloCalc.trigger("updateSkills",!0),!1}}(k[a]));u.append('<h3 class="skill-category">'+n("Passives")+"</h3>");for(var a=0;a<4;++a)D.push(new DiabloCalc.SkillBox.passive(u,a)),D[a].header.click(function(s){return function(i){y.show(s,i)}}(D[a])).contextmenu(function(s){return function(){return s.setPassive(),DiabloCalc.trigger("updateSkills",!0),!1}}(D[a]));var e=$('<div><h3 class="skill-category" style="margin-top: 10px">'+n("Granted by Hellfire Amulet")+"</h3></div>").hide();u.append(e),(b=new DiabloCalc.SkillBox.passive(e,-1)).section=e,v=$('<div><h3 class="skill-category">'+n("Legendary Gems")+"</h3></div>").hide(),u.append(v),C=$('<div><h3 class="skill-category">'+n("Item Effects")+"</h3></div>").hide(),u.append(C),d.empty(),d.append('<h3 class="skill-category">'+n("Kanai's Cube")+"</h3>"),m={weapon:new DiabloCalc.SkillBox.kanai(d,"weapon"),armor:new DiabloCalc.SkillBox.kanai(d,"armor"),jewelry:new DiabloCalc.SkillBox.kanai(d,"jewelry")},S.setClass(s),y.setClass(s),DiabloCalc.trigger("updateSkills")}function i(s){if(!s||DiabloCalc.skills[DiabloCalc.charClass][s[0]])return s;var i=DiabloCalc.skills[DiabloCalc.charClass];for(var l in i)if(i[l].oldid===s[0])return[l,s[1]]}function l(s){if(!s||DiabloCalc.passives[DiabloCalc.charClass][s])return s;var i=DiabloCalc.passives[DiabloCalc.charClass];for(var l in i)if(i[l].oldid===s)return l}function a(s,i,l){if(s)for(var a in s)i.add(a,s[a],1,l)}function e(s){if("followers"!==s.type&&"shrines"!==s.type){var i=DiabloCalc.partybuffs[s.index].class;for(var l in DiabloCalc.classes)s.header.toggleClass("class-"+l,l===i),s.tab.toggleClass("class-"+l,l===i);if(s.header.toggleClass("class-icon",!!i),s.header.toggleClass("icon-coop",!i),s.tab.children().detach(),s.class){if(s.tab.append(s.class,s.clsChosen),!DiabloCalc.noChosen){var a=s.clsChosen.find("span").first();for(var l in DiabloCalc.classes)a.toggleClass("class-"+l,l===i);a.toggleClass("class-icon",!!i)}s.class.val(i),s.class.trigger("chosen:updated")}else{s.class=$('<select class="buff-class"><option value="">'+(DiabloCalc.noChosen?n("Select Class"):"")+"</option></select>");for(var l in DiabloCalc.classes)DiabloCalc.classes[l].follower||s.class.append('<option value="'+l+'" class="class-icon class-'+l+'">'+DiabloCalc.classes[l].name+"</option>");s.tab.append(s.class),s.class.chosen({allow_single_deselect:!0,disable_search:!0,inherit_select_classes:!0,placeholder_text_single:n("Select Class")}).change(function(){var i=s.class.val();if(!DiabloCalc.noChosen){var l=s.clsChosen.find("span").first();for(var a in DiabloCalc.classes)l.toggleClass("class-"+a,a===i);l.toggleClass("class-icon",!!i)}DiabloCalc.partybuffs[s.index].class=i,e(s),DiabloCalc.trigger("updateSkills",!0)}),DiabloCalc.noChosen||(s.clsChosen=s.class.next())}$.each(DiabloCalc.partybuffs[s.index].items,function(l,a){(!a.classes||a.classes.indexOf(i)>=0)&&(a.skillbox?s.tab.append(a.skillbox.line):a.skillbox=new DiabloCalc.SkillBox.buff(s.tab,a),a.skillbox.updateBoxes())}),i&&$.each(DiabloCalc.partybuffs[s.index][i],function(i,l){l.skillbox?s.tab.append(l.skillbox.line):l.skillbox=new DiabloCalc.SkillBox.buff(s.tab,l),l.skillbox.updateBoxes()})}else{var t;$.each("followers"===s.type?DiabloCalc.followerbuffs:DiabloCalc.shrinebuffs,function(i,l){l.skillbox||(t!=l.category&&(t=l.category,s.tab.append("<h3>"+t+"</h3>")),l.skillbox=new DiabloCalc.SkillBox.buff(s.tab,l)),l.skillbox.updateBoxes()})}}function t(){for(var s=0;s<x.length;++s)e(x[s])}function o(s,i){if(s.deltaY||s.deltaFactor){var l=$(this),a=l.scrollTop()-s.deltaY*s.deltaFactor;if(this.scrollHeight<=l.outerHeight()+1||a>this.scrollHeight-l.outerHeight())return;if(c.is(this)&&a<0)return;return l.scrollTop(a),s.stopPropagation(),!1}}var n=DiabloCalc.locale("ui-skills.js"),c=$("#tab-skills");c=DiabloCalc.addScroll(c,"y");var r=$("<input></input>").attr("type","checkbox").change(function(){f.toggle(!!this.checked),DiabloCalc.trigger("updateStats")}),p=$("<input></input>").attr("type","checkbox").change(function(){DiabloCalc.trigger("updateStats")}),h=$("<select></select>");h.append('<option value="">'+n("Generic")+"</option>"),h.append('<option value="demons">'+n("Demon")+"</option>"),h.append('<option value="beasts">'+n("Beast")+"</option>"),h.append('<option value="humans">'+n("Human")+"</option>"),h.append('<option value="undead">'+n("Undead")+"</option>");var f=$('<label style="margin-left: 8px">'+n("Boss")+"</label>").prepend(p).hide();DiabloCalc.addOption("showElites",function(){return r.prop("checked")},function(s){r.prop("checked",s),f.toggle(!!s)}),DiabloCalc.addOption("targetBoss",function(){return p.prop("checked")},function(s){p.prop("checked",s),DiabloCalc.trigger("updateStats")}),DiabloCalc.addOption("targetType",function(){return h.val()},function(s){h.val(s),h.trigger("chosen:updated"),DiabloCalc.trigger("updateStats")}),c.append($('<span class="option-box">'+n("Target: ")+"</span>").append(h,$('<label style="margin-left: 8px">'+n("Elite")+"</label>").prepend(r),f)),h.change(function(){DiabloCalc.trigger("updateStats")});var u,d,b,v,C,g,k=[],D=[],x=[],m={},S=new function(){this.enable=function(s,i){var l=DiabloCalc.skills[DiabloCalc.charClass][s];this.skills[s].css("background-position",-42*l.col+"px "+(-84*l.row-(i?0:42))+"px")},this.selectRune=function(s){this.rune&&this.runes[this.rune].removeClass("selected"),this.selRune=s,this.rune&&this.runes[this.rune].addClass("selected")},this.onRuneClicked=function(s){this.slot&&this.rune!==s&&(this.slot.setSkill([this.skill,s]),DiabloCalc.trigger("updateSkills",!0)),this.hide()},this.selectSkill=function(s){if(this.popup.toggleClass("expanded",!!s),this.skill&&(this.skills[this.skill].removeClass("selected"),this.enable(this.skill,!0)),this.skill=s,this.skill&&(this.skills[this.skill].addClass("selected"),this.enable(this.skill,!1)),this.runeList&&(this.selectRune(),this.runeList.empty(),this.runes={},s)){var i=this,l=DiabloCalc.skills[DiabloCalc.charClass][s];this.runes.x=$('<span class="skill-popup-rune-line"><span class="skill-popup-rune-x"></span>'+n("No Rune")+"</span>"),this.runes.x.hover(function(){DiabloCalc.tooltip.showSkill(this,DiabloCalc.charClass,s)},function(){DiabloCalc.tooltip.hide()}).click(function(){i.onRuneClicked("x")}),this.runeList.append(this.runes.x),$.each(l.runes,function(l,a){i.runes[l]=$('<span class="skill-popup-rune-line"><span class="skill-popup-rune-'+l+'"></span>'+a+"</span>"),i.runes[l].hover(function(){DiabloCalc.tooltip.showSkill(this,DiabloCalc.charClass,s,l,!0)},function(){DiabloCalc.tooltip.hide()}).click(function(){i.onRuneClicked(l)}),i.runeList.append(i.runes[l])}),i.selectRune("x")}},this.onSkillClicked=function(s){this.skill!=s&&this.slot&&!this.disabled[s]&&(this.selectSkill(s),this.slot.setSkill([this.skill,"x"]),DiabloCalc.trigger("updateSkills",!0))},this.hide=function(){this.selectSkill(),this.slot&&(this.slot.line.removeClass("selected"),this.prevSlot=this.slot,setTimeout(function(s){setTimeout(function(s){s.prevSlot=void 0},0,s)},0,this)),this.slot=void 0,this.popup.removeClass("expanded"),this.popup.hide(),DiabloCalc.tooltip.hide(),DiabloCalc.hidePopup(this)},this.show=function(s,i){if(s!==this.prevSlot){if(this.hide(),this.slot=s,s.line.addClass("selected"),i)this.popup.css("left",i.pageX+20),this.popup.css("top",Math.max(60,i.pageY-300));else{var l=s.header.offset();this.popup.css("left",l.left+s.header.width()-250),this.popup.css("top",Math.max(60,l.top+s.header.height()-300))}this.disabled={};for(var a={},e=0;e<k.length;++e)k[e]!==s&&k[e].skill&&(this.disabled[k[e].skill[0]]=!0,(o=DiabloCalc.skills[DiabloCalc.charClass][k[e].skill[0]])&&o.exclusive&&(a[o.exclusive]=k[e].skill[0]));for(var t in this.skills){var o=DiabloCalc.skills[DiabloCalc.charClass][t];s===k[0]&&o&&o.nolmb&&(this.disabled[t]=!0),o&&o.exclusive&&a[o.exclusive]&&a[o.exclusive]!==t&&(this.disabled[t]=!0),this.enable(t,!this.disabled[t])}s.skill&&(this.selectSkill(s.skill[0]),this.selectRune(s.skill[1])),this.popup.show(),this.popup.focus(),DiabloCalc.showPopup(this,!0)}else this.hide()},this.setClass=function(s){this.popup.empty(),this.skills={},this.popup.removeClass().addClass("skill-popup class-"+s);var i=this;$.each(DiabloCalc.skills[s],function(l,a){i.skills[l]=$('<span class="skill-icon skill-button"><span class="skill-frame"></span></span>').css({"background-position":-42*a.col+"px "+-84*a.row+"px",left:10+48*a.col,top:10+48*a.row}).click(function(){i.onSkillClicked(l)}).hover(function(){DiabloCalc.tooltip.showSkill(this,s,l)},function(){DiabloCalc.tooltip.hide()}),DiabloCalc.enableTouch(i.skills[l]),i.popup.append(i.skills[l])}),this.runeList=$('<div class="rune-list"></div>'),this.popup.append(this.runeList)},this.contains=function(s){return!(!this.popup.is(s)&&!this.popup.has(s).length)},this.popup=$('<div class="skill-popup" tabIndex="-1"></div>').hide(),this.skills={},this.disabled={},this.runes={},$("body").append(this.popup)},y=new function(){this.hide=function(){this.slot&&(this.slot.line.removeClass("selected"),this.prevSlot=this.slot,setTimeout(function(s){setTimeout(function(s){s.prevSlot=void 0},0,s)},0,this)),this.slot=void 0,this.popup.hide(),DiabloCalc.tooltip.hide(),DiabloCalc.hidePopup(this)},this.show=function(s,i){if(s!==this.prevSlot){if(this.hide(),this.slot=s,s.line.addClass("selected"),i)this.popup.css("left",i.pageX+20),this.popup.css("top",Math.max(60,i.pageY-this.height));else{var l=s.header.offset();this.popup.css("left",l.left+s.header.width()-185),this.popup.css("top",Math.max(60,l.top+s.header.height()-this.height))}this.disabled={};for(var a=0;a<D.length;++a)D[a].passive&&(this.disabled[D[a].passive]=!0);for(var e in this.passives){var t=-42*DiabloCalc.passives[DiabloCalc.charClass][e].index;this.passives[e].toggleClass("selected",!!this.disabled[e]),this.passives[e].css("background-position",t+"px "+(this.disabled[e]?-42:0)+"px")}this.popup.show(),this.popup.focus(),DiabloCalc.showPopup(this,!0)}else this.hide()},this.onClick=function(s){this.slot&&!this.disabled[s]&&(this.slot.setPassive(s),DiabloCalc.trigger("updateSkills",!0),this.hide())},this.setClass=function(s){this.popup.empty(),this.passives={},this.popup.removeClass().addClass("passive-popup class-"+s);var i=Object.keys(DiabloCalc.passives[s]).length;this.height=59*Math.ceil(i/3)+12,this.popup.css("height",this.height);var l=this;$.each(DiabloCalc.passives[s],function(a,e){var t=$('<span class="passive-icon passive-button"><span class="passive-frame"></span></span>').css("background-position",-42*e.index+"px 0");e.index>=3*Math.floor(i/3)?1==i%3?t.css("left",74):t.css("left",45+e.index%3*59):t.css("left",15+e.index%3*59),t.css("top",15+59*Math.floor(e.index/3)),t.click(function(){l.onClick(a)}).hover(function(){DiabloCalc.tooltip.showSkill(this,s,a)},function(){DiabloCalc.tooltip.hide()}),l.passives[a]=t,DiabloCalc.enableTouch(t),l.popup.append(t)})},this.contains=function(s){return!(!this.popup.is(s)&&!this.popup.has(s).length)},this.popup=$('<div class="passive-popup" tabIndex="-1"></div>').hide(),this.passives={},this.disabled={},$("body").append(this.popup)};DiabloCalc.register("editSkill",function(s){$(".editframe").tabs("option","active",2),k[s].line.get(0).scrollIntoView(),setTimeout(function(){S.show(k[s])},0)}),DiabloCalc.register("editPassive",function(s){$(".editframe").tabs("option","active",2),D[s].line.get(0).scrollIntoView(),setTimeout(function(){y.show(D[s])},0)}),DiabloCalc.register("editKanai",function(s){var i=$(".editframe").tabs("option","active");0!==i&&2!==i&&$(".editframe").tabs("option","active",2),m[s].line.get(0).scrollIntoView(),setTimeout(function(){m[s].namebox.trigger("chosen:open")},0)}),DiabloCalc.setSkill=function(s,l){s>=0&&s<k.length&&(k[s].setSkill(i(l)),DiabloCalc.trigger("updateSkills"))},DiabloCalc.getSkill=function(s){return s>=0&&s<k.length?k[s].skill:null},DiabloCalc.setPassive=function(s,i){s>=0&&s<D.length&&(D[s].setPassive(l(i)),DiabloCalc.trigger("updateSkills"))},DiabloCalc.getPassive=function(s){return s>=0&&s<D.length?D[s].passive:null},DiabloCalc.getSkills=function(){var s={};s.skills=[];for(i=0;i<k.length;++i)s.skills.push(k[i].skill);s.passives=[];for(var i=0;i<D.length;++i)s.passives.push(D[i].passive);s.kanai={};for(var l in m){var a=m[l].getItemPair();a&&(s.kanai[l]=a)}return s},DiabloCalc.setSkills=function(s){if(s.skills){for(a=0;a<k.length&&a<s.skills.length;++a)k[a].setSkill(i(s.skills[a]));for(a=s.skills.length;a<k.length;++a)k[a].setSkill()}if(s.passives){for(a=0;a<D.length&&a<s.passives.length;++a)D[a].setPassive(l(s.passives[a]));for(var a=s.passives.length;a<D.length;++a)D[a].setPassive()}if(s.kanai)for(var e in s.kanai)m[e]&&m[e].setItemPair(s.kanai[e])},DiabloCalc.isSkillActive=function(s){for(i=0;i<k.length;i++)if(k[i].skill&&k[i].skill[0]===s)return DiabloCalc.skills[DiabloCalc.charClass][s].active;for(var i=0;i<D.length;i++)if(s===D[i].passive)return!1!==DiabloCalc.passives[DiabloCalc.charClass][s].active;return s===b.passive&&!1!==DiabloCalc.passives[DiabloCalc.charClass][s].active},DiabloCalc.addSkillList=function(s){for(i=0;i<k.length;i++)k[i].skill&&(s.skills[k[i].skill[0]]=k[i].skill[1]);for(var i=0;i<D.length;i++)D[i].passive&&(s.passives[D[i].passive]=!0);s.extra_passive&&DiabloCalc.passives[DiabloCalc.charClass][s.extra_passive]&&(s.passives[s.extra_passive]=!0)},DiabloCalc.addExtraAffixes=function(s){for(var i in m){var l=m[i].getItemAffix();l&&(s[l]=m[i].getItemAffixValue())}},DiabloCalc.addSkillBonuses=function(s){DiabloCalc.addSkillList(s);for(var i=["mantraofsalvation","mantraofretribution","mantraofhealing","mantraofconviction"],l=0;l<k.length;++l)k[l].skill&&(DiabloCalc.skills[DiabloCalc.charClass][k[l].skill[0]].active&&a(DiabloCalc.getSkillBonus(k[l].skill,s),s,k[l].skill[0]),i.indexOf(k[l].skill[0])<0&&a(DiabloCalc.getSkillBonus(k[l].skill,s,"passive"),s,k[l].skill[0]));for(var e={},l=0;l<D.length;++l)D[l].passive&&!1!==DiabloCalc.passives[DiabloCalc.charClass][D[l].passive].active&&(e[D[l].passive]=!0,a(DiabloCalc.getPassiveBonus(D[l].passive,s),s,D[l].passive));if("monk"==DiabloCalc.charClass)for(var t=0;t<4;t++){var o=i[t];!s.skills[o]&&s.set_inna_4pc&&(s.skills[o]="x"),s.skills[o]&&a(DiabloCalc.getSkillBonus([o,s.skills[o]],s,"passive"),s,o)}s.extra_passive&&!e[s.extra_passive]&&DiabloCalc.passives[DiabloCalc.charClass][s.extra_passive]&&!1!==DiabloCalc.passives[DiabloCalc.charClass][s.extra_passive].active&&a(DiabloCalc.getPassiveBonus(s.extra_passive,s),s,s.extra_passive);var n=[];for(var c in m){if(h=m[c].getItemAffix()){var r=m[c].getItemAffixValue();s.affixes[h]={kanai:c,value:r};if(f=m[c].getInfo()){if(f[u="buffs"]&&!1!==f.active||(u="inactive"),u){if("function"==typeof f[u]){var p=[];void 0!==r&&p.push(r),d=f[u](p,s)}else d=f[u];a(d,s,m[c].getItemPair()),n.push(h)}}}}for(var h in s.affixes)if(!(n.indexOf(h)>=0)){var f=DiabloCalc.itemaffixes[h];if(f){var u="buffs";if(f[u]&&!1!==f.active||(u="inactive"),u){var d;a(d="function"==typeof f[u]?f[u](s.affixes[h].value,s):f[u],s,s.getAffixSource(h))}}}DiabloCalc.addPartyBuffs(s)},DiabloCalc.addPartyBuffs=function(s){function i(i,l){if(!1!==l.active||l.multiple){a(l.buffs(s),s,i)}}for(var l=0;l<DiabloCalc.partybuffs.length;++l)$.each(DiabloCalc.partybuffs[l].items,i),DiabloCalc.partybuffs[l].class&&$.each(DiabloCalc.partybuffs[l][DiabloCalc.partybuffs[l].class],i);$.each(DiabloCalc.followerbuffs,i),$.each(DiabloCalc.shrinebuffs,i)},DiabloCalc.isGemActive=function(s){return!1!==DiabloCalc.legendaryGems[s].active},u=$("<div></div>"),c.append(u),d=$('<div style="margin: 0 47px"></div>'),DiabloCalc.stashHeader.before(d),$(".editframe").on("tabsactivate",function(s,i){var l=i.newPanel.attr("id");"tab-skills"==l?(u.after(d),d.css("margin","0")):"tab-equipment"==l&&(DiabloCalc.stashHeader.before(d),d.css("margin","0 47px"))}),c.append('<h3 class="skill-category" style="margin-bottom: 5px">'+n("Group Buffs")+"</h3>"),c.append('<p class="change-note"><i>'+n("The calculator does not check for correct buff stacking.")+"</i></p>");var w=$('<div class="buff-tabs ui-helper-clearfix"></div>');c.append(w);var B=$("<ul></ul>");w.append(B);for(_=0;_<DiabloCalc.partybuffs.length;++_){P=$('<a href="#buff-'+_+'" class="icon-coop"></a>');B.append($("<li></li>").append(P));I=$('<div id="buff-'+_+'"></div>');w.append(I),x.push({index:_,header:P,tab:I,type:"party"})}P=$('<a href="#buff-followers" class="icon-followers"></a>');B.append($("<li></li>").append(P));I=$('<div id="buff-followers" class="class-miscbuffs"></div>');w.append(I),x.push({header:P,tab:I,type:"followers"});var P=$('<a href="#buff-shrines" class="icon-shrines"></a>');B.append($("<li></li>").append(P));var I=$('<div id="buff-shrines" class="class-miscbuffs"></div>');w.append(I),x.push({header:P,tab:I,type:"shrines"}),w.tabs(),w.find("li").removeClass("ui-corner-top").addClass("ui-corner-left");for(_=0;_<x.length;++_)x[_].tab=DiabloCalc.addScroll(x[_].tab,"y");w.find(".ui-tabs-panel"),t(),s(),c.mwheelIntent(o);for(var _=0;_<x.length;++_)x[_].tab.mwheelIntent(o);DiabloCalc.register("changeClass",s),DiabloCalc.register("updateStats",function(){function s(s){var i=s.getInfo();if(s.skillData&&i){var l={data:{}};t[i.name]=l;for(var a in s.skillData)"number"==typeof s.skillData[a].value&&(l.data[a]=s.skillData[a].value);return l}}function i(s){if(r.indexOf(s)>=0)return!1;if(!a.affixes.hasOwnProperty(s))return!1;var i=DiabloCalc.itemaffixes[s];if(!i.info&&void 0===i.active&&!i.params)return!1;if(!i.check)return!0;if("function"==typeof i.info){if(i.info(a.affixes[s].value,a))return!0}else if(i.info)return!0;if(void 0!==i.active||i.params)if("function"==typeof i.buffs){if(i.buffs(a.affixes[s].value,a))return!0}else if(i.buffs)return!0;return!1}for(var l,a=DiabloCalc.getStats(),e=DiabloCalc.charClass,t={},o=0;o<k.length;++o)k[o].update(),k[o].skill&&(l=s(k[o]))&&(l.skill=k[o].skill);for(o=0;o<D.length;++o)D[o].update(),(l=s(D[o]))&&(l.passive=D[o].passive);var n=DiabloCalc.getStats().extra_passive;if(n&&!DiabloCalc.passives[e][n]&&(n=null),n)for(o=0;o<D.length;o++)if(n==D[o].passive){n=null;break}b.setPassive(n),b.section.toggle(!!n),b.update(),(l=s(b))&&(l.passive=b.passive);var r=[];for(var p in m)m[p].update(),r.push(m[p].getItemAffix()),(l=s(m[p]))&&(l.kanai=m[p].getItemAffix());for(var h in DiabloCalc.legendaryGems)DiabloCalc.legendaryGems[h].line&&!a.gems.hasOwnProperty(h)&&(DiabloCalc.legendaryGems[h].line.line.remove(),delete DiabloCalc.legendaryGems[h].line);for(var f in a.gems)(h=DiabloCalc.legendaryGems[f]).line||(h.line=new DiabloCalc.SkillBox.gem(v,f)),h.line.update(),(l=s(h.line))&&(l.gem=f);v.toggle(!$.isEmptyObject(a.gems));for(var u in DiabloCalc.itemaffixes)DiabloCalc.itemaffixes[u].line&&!i(u)&&(DiabloCalc.itemaffixes[u].line.line.remove(),delete DiabloCalc.itemaffixes[u].line);var d=!1;for(var f in a.affixes)(u=DiabloCalc.itemaffixes[f])&&(u.kanai||(!u.line&&i(f)&&(u.line=new DiabloCalc.SkillBox.affix(C,f)),u.line&&(d=!0,u.line.update(),(l=s(u.line))&&(l.gem=f))));C.toggle(d),DiabloCalc.trigger("skillData",t),void 0!==g&&(c.scrollTop(g),g=void 0)}),DiabloCalc.register("updateParams",t),DiabloCalc.register("importEnd",t),DiabloCalc.register("updateSlotItem",function(s){"mainhand"===s&&(k.length>=1&&!k[0].skill&&k[0].setSkill(),k.length>=2&&!k[1].skill&&k[1].setSkill())})}();!function(){function t(t,s){var a={};if(t)for(var e in u)a[e]=u[e].stat?Math.floor(t.getValue(u[e].stat)):s&&s[e]||0;else for(var e in u)a[e]=s&&s[e]||0;return a}function s(s,a){return{label:s,values:t(null,a&&a.values)}}function a(s,a,e,i){return{slot:s,label:p("Change {0}").format(DiabloCalc.itemSlots[s].name),pre:a,offhand:e,undo:function(){this.post=DiabloCalc.getSlot(this.slot),DiabloCalc.setSlot(this.slot,this.pre),this.offhand&&DiabloCalc.setSlot("offhand",this.offhand)},redo:function(){"mainhand"==this.slot?(this.offhand=DiabloCalc.getSlot("offhand"),DiabloCalc.setSlot(this.slot,this.post),DiabloCalc.getSlot("offhand")&&(this.offhand=void 0)):DiabloCalc.setSlot(this.slot,this.post)},values:t(DiabloCalc.getStats(),i&&i.values)}}function e(t,a,e){var i={index:t,name:p("Set {0}").format(t+1),line:$('<li class="profiles-set"></li>'),icon:$('<span class="class-icon"></span>'),label:$('<span class="label"></span>'),value:$('<span class="value"></span>'),edit:$('<span class="edit"></span>').attr("title",p("Rename")),del:$('<span class="delete"></span>').attr("title",p("Delete")),pos:0,points:[s(a,e)]};return i.label.text(i.name),i.line.append(i.icon,i.label,i.del,i.edit,i.value),i.line.attr("tabIndex",-1),i.rename=function(t){i.name=t,i.label&&i.label.text(i.name)},i.startedit=function(){i.label&&(i.input=$("<input></input>"),i.input.val(i.name),i.label.replaceWith(i.input),i.label=null,i.input.focus().select(),i.input.focusout(function(t){var s=i.input.val();s.length&&(i.name=s),i.label=$("<span></span>").addClass("label").text(i.name),i.input.replaceWith(i.label),i.input=null}),i.input.click(function(t){t.stopPropagation()}),i.input.keyup(function(t){if(13==t.keyCode||27==t.keyCode){var s=i.input.val();13==t.keyCode&&s.length&&(i.name=s),i.label=$("<span></span>").addClass("label").text(i.name),i.input.replaceWith(i.label),i.input=null}}))},i.line.click(function(){d.changeset(i.index),i.line.focus()}),i.edit.click(function(){return i.startedit(),!1}),i.del.click(function(t){return $(this).hasClass("disabled")||DiabloCalc.popupMenu(t,p.fixkey({"Confirm delete?":function(){d.delset(i.index)}})),!1}),i}function i(t,s){if(t===s)return!0;if(!(t instanceof Object&&s instanceof Object))return!1;for(var a in t){if(t.hasOwnProperty(a)!==s.hasOwnProperty(a))return!1;if(typeof t[a]!=typeof s[a])return!1}for(var a in s){if(t.hasOwnProperty(a)!==s.hasOwnProperty(a))return!1;if(typeof t[a]!=typeof s[a])return!1;if(t[a]instanceof Object){if(!i(t[a],s[a]))return!1}else if(t[a]!==s[a])return!1}return!0}function l(t,s){var e=b[t];if(e||(e=null),b[t]=DiabloCalc.getSlot(t),(e||b[t])&&!i(e,b[t])){var l=d.last();"twohand"==s&&e?d.add(a("mainhand",void 0,e,l)):"offhand"===t&&l.offhand&&!b[t]||(l.slot!==t?d.add(a(t,e,void 0,l)):void 0===l.pre&&(l.pre=e))}}var o,n,r,c,h,p=DiabloCalc.locale("ui-timeline.js"),u=DiabloCalc.localeTable.statList,d={dataOptionsLight:{strokeColor:"#66d",pointColor:"#66d",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"#66d",disabledColor:"#bbb"},dataOptionsDark:{strokeColor:"#aaf",pointColor:"#aaf",pointStrokeColor:"#121212",pointHighlightFill:"#121212",pointHighlightStroke:"#aaf",disabledColor:"#222"},setTheme:function(){if(this.dataOptions=this.dataOptionsLight,$("body").hasClass("theme-light")||(this.dataOptions=this.dataOptionsDark),this.line){for(var t in this.dataOptions)this.line.datasets[0][t]=this.dataOptions[t];for(var s=0;s<this.line.datasets[0].points.length;++s)this.line.datasets[0].points[s].strokeColor=this.dataOptions.pointStrokeColor,this.line.datasets[0].points[s].highlightFill=this.dataOptions.pointHighlightFill,s<=this.curset.pos?(this.line.datasets[0].points[s].fillColor=this.dataOptions.pointColor,this.line.datasets[0].points[s].highlightStroke=this.dataOptions.pointHighlightStroke):(this.line.datasets[0].points[s].fillColor=this.dataOptions.disabledColor,this.line.datasets[0].points[s].highlightStroke=this.dataOptions.disabledColor);this.line.update()}},globalOptions:{showScale:!1,scaleShowLabels:!1,datasetFill:!1,responsive:!0,maintainAspectRatio:!1,pointHitDetectionRadius:15,customTooltips:function(t){if(t){var s=d.line.getIndexAtPoint(t.x,t.y);if(s.length>0){s=s[0];var a=d.curset.points[s].label;if(d.curstatEx&&d.curset.points[s].skillData){var e=d.curstatEx.split("$"),t=d.curset.points[s].skillData[e[0]],i=e[0]+" &mdash; "+e[1]+': <span class="d3-color-green">'+DiabloCalc.formatNumber(t&&t.data[e[1]]||0,0,1e3)+"</span>";if(s!=d.curset.pos){var l=t&&t.data[e[1]]||0,o=d.curset.points[d.curset.pos].skillData[e[0]];if((n=o&&o.data[e[1]]||0)>1){i+=' (<span class="d3-color-green">'+((r=(l-n)/n*100)>=0?"+":"")+DiabloCalc.formatNumber(r,2)+"%</span>)"}}}else{i=u[d.curstat].name+': <span class="d3-color-green">'+DiabloCalc[u[d.curstat].func||"formatNumber"](d.curset.points[s].values[d.curstat],0,1e3)+"</span>";if(s!=d.curset.pos){var l=d.curset.points[s].values[d.curstat],n=d.curset.points[d.curset.pos].values[d.curstat];if(n>1){var r=(l-n)/n*100;i+=' (<span class="d3-color-green">'+(r>=0?"+":"")+DiabloCalc.formatNumber(r,2)+"%</span>)"}}}var c='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">'+a+"</span><br/>"+i;s<d.curset.pos?c+='<br/><span class="d3-color-gray">'+p("Click to undo")+"</span>":s>d.curset.pos&&(c+='<br/><span class="d3-color-gray">'+p("Click to redo")+"</span>"),c+="</p></div>",DiabloCalc.tooltip.showHtml(d.parent[0],c,t.x,t.y)}}else DiabloCalc.tooltip.hide()}},update:function(){this.line&&this.line.destroy();var t=[],s=[];this.parent.width(50*(this.curset.points.length-1)+10),c.scrollLeft(c.get(0).scrollWidth);for(a=0;a<this.curset.points.length;++a)t.push(this.curset.points[a].values[this.curstat]),s.push(this.curset.points[a].label);this.line=this.chart.Line({labels:s,datasets:[$.extend({data:t},this.dataOptions)]},this.globalOptions);for(a=0;a<this.curset.points.length;++a)this.line.datasets[0].points[a].index=a;for(var a=this.curset.pos+1;a<this.curset.points.length;++a)this.line.datasets[0].points[a].fillColor=this.dataOptions.disabledColor,this.line.datasets[0].points[a].highlightStroke=this.dataOptions.disabledColor;this.line.update()},init:function(t,s){this.setTheme(),this.parent=t,this.canvas=$("<canvas></canvas>"),t.append(this.canvas),this.datasets=[e(0,p("New Profile"))],r.before(this.datasets[0].line.addClass("selected")),this.datasets[0].del.addClass("disabled"),this.curset=this.datasets[0],this.curstat=s,this.ctx=this.canvas.get(0).getContext("2d"),this.chart=new Chart(this.ctx),this.update();var a=this;t.click(function(t){var s=a.line.getIndexAtEvent(t);s.length&&a.undo(s[0])})},add:function(t){this.curset.pos<this.curset.points.length-1&&(this.curset.points=this.curset.points.slice(0,this.curset.pos+1),this.update()),this.curset.pos=this.curset.points.length,this.curset.points.push(t),this.line.addData([t.values[this.curstat]],t.label),this.line.datasets[0].points[this.curset.pos].index=this.curset.pos,this.parent.width(50*(this.curset.points.length-1)+10),c.scrollLeft(c.get(0).scrollWidth),this.line.resize(this.line.render,!0)},addset:function(s,a){var i=e(this.datasets.length,s,this.last());r.before(i.line),a&&(i.profile={items:{},skills:[],passives:[],paragon:{level:0}},i.points[0].values=t(DiabloCalc.getStats())),this.datasets.push(i);for(var l=0;l<this.datasets.length;++l)this.datasets[l].del.removeClass("disabled");this.changeset(i.index),setTimeout(this.curset.startedit,0)},delset:function(t){if(!(t<0||t>=this.datasets.length||this.datasets.length<=1)){this.curset==this.datasets[t]&&(t<this.datasets.length-1?this.changeset(t+1):this.changeset(t-1)),this.datasets[t].line.remove(),this.datasets.splice(t,1);for(var s=t;s<this.datasets.length;++s)this.datasets[s].index=s;1==this.datasets.length&&this.datasets[0].del.addClass("disabled")}},clear:function(){for(var t=0;t<this.datasets.length;++t)this.datasets[t]!==this.curset&&this.datasets[t].line.remove();this.datasets=[this.curset],this.curset.del.addClass("disabled")},addprofile:function(t){var s=e(this.datasets.length,p("Load Profile"),t);r.before(s.line),s.profile=t,s.values=t.values,s.rename(t.name),s.icon.removeClass().addClass("class-icon class-"+t.class+" "+(t.gender||"female")),s.value.text((u[this.curstat].shortName||u[this.curstat].name)+": "+DiabloCalc[u[this.curstat].func||"formatNumber"](s.values[this.curstat]||0,0,1e3)),this.datasets.push(s);for(var a=0;a<this.datasets.length;++a)this.datasets[a].del.removeClass("disabled")},changeset:function(t){this.curset!=this.datasets[t]&&(this.curset.line.removeClass("selected"),this.curset.profile=$.extend(!0,{},DiabloCalc.getProfile()),this.curset=this.datasets[t],this.curset.line.addClass("selected"),this.curset.profile&&(DiabloCalc.setProfile(this.curset.profile,"set"),this.curset.profile=void 0),this.update(),this.fixval())},changestat:function(t){var s=t;u[t]?this.curstat=t:(this.curstatEx=t,t=this.curstat);for(var a=0;a<this.datasets.length;++a)this.datasets[a].values&&this.datasets[a].value.text((u[t].shortName||u[t].name)+": "+DiabloCalc[u[t].func||"formatNumber"](this.datasets[a].values[t],0,1e3));if(this.update(),!u[s]){var e=s.split("$");if(2===e.length)return e[0]+" &mdash; "+e[1]}},fixval:function(){var s=this.curset.pos;this.curset.points[s].values=this.curset.values=t(DiabloCalc.getStats(),this.curset.points[s].values);var a=this.curset.values[this.curstat];this.curset.icon.removeClass().addClass("class-icon class-"+DiabloCalc.charClass+" "+(DiabloCalc.gender||"female")),this.curset.value.text((u[this.curstat].shortName||u[this.curstat].name)+": "+DiabloCalc[u[this.curstat].func||"formatNumber"](a||0,0,1e3)),this.curstatEx||(this.line.datasets[0].points[s].value=a,this.line.update())},fixdata:function(t){var s=this.curset.pos;if(this.curset.points[s].skillData=t,this.curstatEx){var a=this.curstatEx.split("$");2===a.length&&t[a[0]]&&a[1]in t[a[0]].data?(this.line.datasets[0].points[s].value=t[a[0]].data[a[1]],this.line.update()):(delete this.curstatEx,this.fixval())}},generateList:function(t){var s=t.val();t.empty();for(var a in u)t.append('<option value="'+a+(s===a?'" selected="selected':"")+'">'+u[a].name+"</option>");var e=this.last().skillData;if(e)for(var i in e)if(!$.isEmptyObject(e[i].data)){var l='<optgroup label="'+i+'">';for(var o in e[i].data)l+='<option value="'+i+"$"+o+(s===i+"$"+o?'" selected="selected':"")+'">'+o+"</option>";t.append(l+"</optgroup>")}},last:function(){return this.curset.points[this.curset.pos]},reset:function(t,a){this.curset.points=[s(t,{values:a})],this.curset.values=a,this.curset.pos=0,this.update()},undo:function(t){for(DiabloCalc.importStart(),this.line.update();this.curset.pos>t;)this.curset.points[this.curset.pos].undo(),this.line.datasets[0].points[this.curset.pos].fillColor=this.dataOptions.disabledColor,this.line.datasets[0].points[this.curset.pos]._saved.fillColor=this.dataOptions.disabledColor,this.line.datasets[0].points[this.curset.pos].highlightStroke=this.dataOptions.disabledColor,--this.curset.pos;for(;this.curset.pos<t;)++this.curset.pos,this.curset.points[this.curset.pos].redo(),this.line.datasets[0].points[this.curset.pos].fillColor=this.dataOptions.pointColor,this.line.datasets[0].points[this.curset.pos]._saved.fillColor=this.dataOptions.pointColor,this.line.datasets[0].points[this.curset.pos].highlightStroke=this.dataOptions.pointHighlightStroke;this.line.update(),DiabloCalc.importEnd("undo",this.curset.points[this.curset.pos].values)},getProfiles:function(){var t=[],s=$.extend([],this.datasets);s.sort(function(t,s){return t.line.index()-s.line.index()});for(var a=0;a<s.length;++a)if(s[a]===this.curset||s[a].profile){var e={name:s[a].name};(e=s[a]===this.curset?$.extend(e,DiabloCalc.getProfile()):$.extend(e,s[a].profile)).values=s[a].values,t.push(e)}return t}};DiabloCalc.getAllProfiles=function(){var t={};return t.profiles=d.getProfiles(),t.profiles.length?(t.curstat=d.curstat,t.class=t.profiles[0].class,t.mainset=t.profiles[0].mainset,t.active=DiabloCalc.getActive("global"),t):DiabloCalc.getProfile()},DiabloCalc.setAllProfiles=function(t,s){if(t.profiles){if(DiabloCalc.importStart(),d.clear(),t.curstat&&(h.val(t.curstat),h.trigger("chosen:updated"),d.curstat=t.curstat),t.active){DiabloCalc.setActive("global",t.active);for(e=0;e<t.profiles.length;++e)if(!t.profiles[e].active){t.profiles[e].active={};for(var a in t.active)0===a.indexOf("buff")&&(t.active[a]instanceof Object?t.profiles[e].active[a]=$.extend([],t.active[a]):t.profiles[e].active[a]=t.active[a])}}d.curset.rename(t.profiles[0].name),DiabloCalc.setProfile(t.profiles[0],s);for(var e=1;e<t.profiles.length;++e)d.addprofile(t.profiles[e]);DiabloCalc.importEnd(t,s)}else DiabloCalc.setProfile(t,s)},DiabloCalc.isModified=function(){return d.curset.pos>0},DiabloCalc.recordDPS=function(t){d.last().values.simdps=t,d.fixval()},DiabloCalc.register("changeGender",function(){d.fixval()});var f,v,b={},g=$(".profiles-frame");o=$('<ul class="profiles-list"></ul>'),g.append(o),n=$(".timeline-frame"),g.resizable({handles:"n",minHeight:120,maxHeight:400,resize:function(t,s){g.css("top","")}}),(r=$('<li class="profiles-set newset"><b>'+p("New set")+"</b></li>")).click(function(t){DiabloCalc.popupMenu(t,p.fixkey({"Blank set":function(){d.addset(p("New Set"),!0)},"Clone current set":function(){d.addset(p("New Set"))}}))}),o.append(r),o.sortable({items:"li:not(.newset)",distance:4,containment:"parent",axis:"y"}),h=$("<select></select>").addClass("timeline-stat");for(var C in u)h.append('<option value="'+C+'">'+u[C].name+"</option>");n.append(h),h.chosen({disable_search:!0,inherit_select_classes:!0,populate_func:function(){d.generateList(h)}}).change(function(){var t=d.changestat($(this).val());t&&h.next().find(".chosen-single span").html(t)}),c=$("<div></div>").addClass("canvas-frame"),n.append(c);var m=$("<div></div>").addClass("canvas-container");c.append(m),d.init(m,"damage"),DiabloCalc.register("updateStats",function(){d.fixval()}),DiabloCalc.register("skillData",function(t){d.fixdata(t)}),DiabloCalc.register("importEnd",function(s,a){var e=b;b={};for(var i in DiabloCalc.itemSlots)b[i]=DiabloCalc.getSlot(i);switch(f=DiabloCalc.getSkills(),v=DiabloCalc.getParagonLevels(),s){case"import":d.reset(p("Import Profile"),a);break;case"class":d.reset(p("Change Class"));break;case"load":d.reset(p("Load Profile"),a);break;case"global":d.add(function(s,a){return{label:p("Global operation"),pre:s,undo:function(){this.post={};for(var t in DiabloCalc.itemSlots)this.post[t]=DiabloCalc.getSlot(t),DiabloCalc.setSlot(t,this.pre[t])},redo:function(){this.pre={};for(var t in DiabloCalc.itemSlots)this.pre[t]=DiabloCalc.getSlot(t),DiabloCalc.setSlot(t,this.post[t])},values:t(DiabloCalc.getStats(),a&&a.values)}}(e,d.last()))}}),DiabloCalc.register("updateSlotItem",l),DiabloCalc.register("updateSlotStats",l),DiabloCalc.register("updateSkills",function(s){if(s){var a=f;f=DiabloCalc.getSkills();var e=d.last();!0!==e.skills&&d.add(function(s,a){return{skills:!0,label:p("Change Skills"),pre:s,undo:function(){this.post=DiabloCalc.getSkills(),DiabloCalc.setSkills(this.pre)},redo:function(){this.pre=DiabloCalc.getSkills(),DiabloCalc.setSkills(this.post)},values:t(DiabloCalc.getStats(),a&&a.values)}}(a,e))}}),DiabloCalc.register("updateParagon",function(){var s=v;v=DiabloCalc.getParagonLevels();var a=d.last();!0!==a.paragon&&d.add(function(s,a){return{paragon:!0,label:p("Change Paragon"),pre:s,undo:function(){this.post=DiabloCalc.getParagonLevels(),DiabloCalc.setParagon(this.pre)},redo:function(){this.pre=DiabloCalc.getParagonLevels(),DiabloCalc.setParagon(this.post)},values:t(DiabloCalc.getStats(),a&&a.values)}}(s,a))}),DiabloCalc.register("changeTheme",function(){d.setTheme()}),DiabloCalc.tipStatList=u}();!function(){function s(s){if(s.classes&&s.classes.indexOf(x.charClass)<0)return!1;var t=x.itemTypes[s.type];return!(t.classes&&t.classes.indexOf(x.charClass)<0)}function t(t,e){var a=t.val();t.children().detach().remove();var i,n,l={},r=x.getStats();return $.each(x.simMapping.buffs,function(o,p){if(!(p.classes&&p.classes.indexOf(x.charClass)<0)){if(x.options.filterBuffs&&o!==a){var c=0,h=0;if(p.skill&&(++c,r.skills[p.skill[0]]&&(p.skill.length<2||p.skill[1].indexOf(r.skills[p.skill[0]])>=0)&&++h),p.skills){++c;for(d=0;d<p.skills.length;++d){if(r.skills[p.skills[d]]){++h;break}if(x.extraskills[x.charClass]&&x.extraskills[x.charClass][p.skills[d]]&&x.extraskills[x.charClass][p.skills[d]].required(r)){++h;break}}}if(p.passive&&(++c,r.passives[p.passive]&&++h),p.gem&&(++c,void 0!==r.gems[p.gem[0]]&&(p.gem.length<2||r.gems[p.gem[0]]>=p.gem[1])&&++h),p.set&&(++c,r["set_"+p.set[0]+"_"+p.set[1]+"pc"]&&++h),p.stat)if(++c,p.stat instanceof Array){for(var d=0;d<p.stat.length;++d)if(r[p.stat[d]]){++h;break}}else r[p.stat]&&++h;if(c&&h<(p.min||1))return}if(!(p.set&&(void 0===l[p.set[0]]&&(l[p.set[0]]=function(t){if((t=x.itemSets[t]).tclass&&t.tclass!==x.charClass)return 0;if(t.classes&&t.classes.indexOf(x.charClass)<0)return 0;for(var e=0,a=0;a<t.items.length;++a)s(t.items[a])&&++e;return e}(p.set[0])),l[p.set[0]]<p.set[1]))){if(p.category!==i&&(i=p.category,n=$('<optgroup label="'+i+'"></optgroup>'),t.append(n)),a||(a=o),e)return!1;n.append('<option value="'+o+(o===a?'" selected="selected':"")+'">'+p.name+"</option>")}}}),a}function e(s){var t=x.simMapping.buffs[s];if(t)if(t.skill)DiabloCalc.tooltip.showSkill(this,x.charClass,t.skill[0],t.skill[1]);else if(t.passive)DiabloCalc.tooltip.showSkill(this,x.charClass,t.passive);else if(t.gem)DiabloCalc.tooltip.showGem(this,t.gem[0],x.getStats().gems[t.gem[0]]);else if(t.set){var e="set_"+t.set[0]+"_"+t.set[1]+"pc",a=x.getStats().affixes[e];if(a&&a.slot)DiabloCalc.tooltip.showItem(this,a.slot);else{s=DiabloCalc.itemSets[t.set[0]].items[0].id;DiabloCalc.tooltip.showItem(this,s)}}}function a(s,t){var e=s.val();s.children().detach().remove();var a=function(){var s={};if(x.options.filterBuffs)for(var t=x.getSkills().skills,e=0;e<t.length;++e)t[e]&&x.skills[x.charClass][t[e][0]]&&(s[t[e][0]]=x.skills[x.charClass][t[e][0]]);else $.extend(s,x.skills[x.charClass]);if(x.extraskills&&x.extraskills[x.charClass]){var a=x.getStats();$.each(x.extraskills[x.charClass],function(t,e){x.options.filterBuffs&&e.required&&!e.required.call(e,a)||(e.category=x.skills[x.charClass][e.skill].name,s[t]=e)})}return s}();x.skills[x.charClass][e]&&!a[e]&&(a[e]=x.skills[x.charClass][e]);var i,n=s;return $.each(a,function(a,l){if(x.options.filterBuffs||l.category===i||(i=l.category,n=$('<optgroup label="'+(x.skillcat[x.charClass][i]||i)+'"></optgroup>'),s.append(n)),e||(e=a),t)return!1;n.append('<option value="'+a+(a===e?'" selected="selected':"")+'">'+l.name+"</option>")}),e}function i(s,t){t=t||x.charClass;var e=x.skills[t][s];if(e||(e=x.extraskills&&x.extraskills[t]&&x.extraskills[t][s]),e)return'<span style="background: url(css/images/class-'+t+".png) "+-24*e.col+"px "+-48*e.row+'px / 120px no-repeat"></span>'}function n(s){var t=x.skills[x.charClass][s];t||(t=x.extraskills&&x.extraskills[x.charClass]&&x.extraskills[x.charClass][s]),t&&DiabloCalc.tooltip.showSkill(this,x.charClass,s)}function l(s,t){var e=$('<select class="arg-skill"></select>'),l=x.extraskills&&x.extraskills[x.charClass]||{};t&&(x.skills[x.charClass][t]||l[t])||(t=a(e,!0)),!t||x.skills[x.charClass][t]||l[t]||(t=void 0),t&&(x.skills[x.charClass][t]||l[t])?e.append('<option value="'+t+'" selected="selected">'+(x.skills[x.charClass][t]||l[t]).name+"</option>"):e.prop("disabled",!0),s.append(e),x.noChosen?a(e):(e.chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:b("Choose Skill"),populate_func:function(){a(e)}}),x.chosenTips(e,n),function(s,t){var e=s.data("chosen");if(e){var a=e.result_add_option;e.result_add_option=function(s){var e=t.call(self,s.value);return e&&((s=$.extend({},s)).search_text='<div class="icon-wrap">'+e+"</div>"+s.search_text),a.call(this,s)}}}(e,i));var r=e;return x.noChosen||(r=r.next()),r.hover(function(){if(x.tooltip&&e.val()){var s=x.getStats().skills[e.val()];x.tooltip.showSkill(this,x.charClass,e.val(),s)}},function(){x.tooltip&&x.tooltip.hide()}),e.setval=function(s){if(x.noChosen)e.val(s);else{e.empty();var t=x.extraskills&&x.extraskills[x.charClass]||{};s&&(x.skills[x.charClass][s]||t[s])&&(e.removeAttr("disabled"),e.append('<option value="'+s+'" selected="selected">'+(x.skills[x.charClass][s]||t[s]).name+"</option>")),e.trigger("chosen:updated")}return this},e}function r(s){var t=s.val();s.children().detach().remove(),$.each(x.classes[x.charClass].resources,function(e,a){s.append('<option value="'+a+(a===t?'" selected="selected':"")+'">'+x.resources[a]+"</option>")})}function o(s,t,e){var a="";for(var i in t.opts)a+='<option value="'+i+(e===i?'" selected="selected':"")+'">'+t.opts[i]+"</option>";var n=$('<select class="'+t.class+'">'+a+"</select>");return s.append(n),n.chosen({disable_search:!0,inherit_select_classes:!0}),n.setval=function(s){return n.val(s),n.trigger("chosen:updated"),this},n}function p(s){this.parent=s,this.box=$('<li class="sim-condition"></li>'),this.box.data("condition",this),this.line=$('<div class="header chosen-noframe"></div>'),this.remove=$('<span class="btn-remove"></span>'),s.list.append(this.box.append(this.line.append(this.remove))),this.type=o(this.line,D);var t=this;this.type.change(function(){t.onChangeType(),t.lhs&&setTimeout(function(){t.lhs.trigger("chosen:open")},0)}),this.remove.click(function(){t.box.remove()}),this.vardiv=$('<div class="arg-params"></div>'),this.line.append(this.vardiv),this.onChangeType()}function c(s){this.list=$('<ul class="sim-condition-list"></ul>'),this.add=$('<div class="btn-add">'+b("Add condition")+"</div>"),s.append(this.list,this.add);var t=this;this.add.click(function(){var s=new p(t);setTimeout(function(){s.type.trigger("chosen:open")},0)}),this.list.sortable({handle:".header",distance:4,placeholder:"drop-ph",forcePlaceholderSize:!0,connectWith:".sim-condition-list",start:function(){t.list.find("select").trigger("chosen:close")},end:function(){x.trigger("updatePriority")}})}function h(s){this.parent=s,this.box=$('<li class="sim-priority-line"></li>'),this.box.data("priority",this),this.line=$('<div class="header prio-header"></div>'),this.remove=$('<span class="btn-remove"></span>'),s.list.append(this.box.append(this.line.append(this.remove))),this.skill=l(this.line);var t=this;x.noChosen||(this.icon=$('<span class="drop-skill-icon"></span>'),this.skill.next().find("span").before(this.icon),this.skill.change(function(){var s=$(this).val(),e=x.skills[x.charClass][s];e||(e=x.extraskills&&x.extraskills[x.charClass]&&x.extraskills[x.charClass][s]),e?(t.icon.css("background","url(css/images/class-"+x.charClass+".png) "+-24*e.col+"px "+-48*e.row+"px / 120px no-repeat"),t.icon.show()):t.icon.hide()}).change()),this.conditions=new c(this.box),this.remove.click(function(){t.box.remove()})}function d(s){this.box=$('<div class="sim-priority"></div>'),this.list=$('<ul class="sim-priority-list"></ul>'),this.add=$('<div class="btn-add">'+b("Add skill")+"</div>"),this.box.append(this.list,this.add),s.append(this.box);var t=this;this.add.click(function(){var s=new h(t);setTimeout(function(){s.skill.trigger("chosen:open")},0)}),this.list.sortable({handle:".prio-header",distance:4,axis:"y",placeholder:"drop-ph",forcePlaceholderSize:!0,start:function(){t.list.find("select").trigger("chosen:close")},stop:function(){ui.item.css({position:"",left:"",top:""}),x.trigger("updatePriority")}}),this.box.on("click",".btn-remove, .btn-add",function(){x.trigger("updatePriority")}),this.box.on("change",function(){x.trigger("updatePriority")}),x.register("updateSkills",function(){t.list.find("select.arg-skill").each(function(){!function(s){var t=s.val(),e=x.extraskills&&x.extraskills[x.charClass]||{};t&&(x.skills[x.charClass][t]||e[t])||(t=a(s,!0)),!t||x.skills[x.charClass][t]||e[t]||(t=void 0),s.empty(),t&&(x.skills[x.charClass][t]||e[t])?(s.removeAttr("disabled"),s.append('<option value="'+t+'" selected="selected">'+(x.skills[x.charClass][t]||e[t]).name+"</option>")):s.prop("disabled",!0),x.noChosen?a(s):s.trigger("chosen:updated").change()}($(this))})})}function u(s,t){var e={name:s,class:x.charClass,data:x.priority.getData()};t&&(e.id=t),$.ajax({url:"priority",data:JSON.stringify(e),type:"POST",processData:!1,contentType:"application/json",dataType:"json",success:function(s){s.id?(I.slideUp(),v()):s.errors&&s.errors.length?(I.val(s.errors[0]),I.slideDown()):(I.val(b("Failed to save priority list.")),I.slideDown())},error:function(s){I.text(b("Failed to save priority list.")),I.slideDown()}})}function f(s){$.ajax({url:"priority",data:{load:s},type:"GET",dataType:"json",success:function(s){s instanceof Array&&x.priority.setData(s)},error:function(s){}})}function v(){M.toggle(!!x.account.userName()),T.search({class:x.charClass})}function m(){G.empty(),$.each(x.itemSlots,function(s,t){var e=x.getSlotId(s);if(e&&x.simMapping.nyi[e]){var a=$("<li>"+x.itemById[e].name+"</li>");a.addClass("quality-"+x.itemById[e].quality),a.hover(function(){x.tooltip.showItem(this,s)},function(){x.tooltip.hide()}),G.append(a)}}),q.toggle(!!G.children().length)}function g(){z.empty();for(var s=x.priority.getData(),t={},e={},a=0;a<6;++a){var i=x.getSkill(a);i&&(e[i[0]]=i[1])}var n=x.options.targetDistance-x.options.targetRadius-x.options.targetSize;$.each(s,function(s,a){var i=a.skill;if(i&&!t[i]){t[i]=!0;var l=x.skills[x.charClass][i]||x.extraskills[x.charClass]&&x.extraskills[x.charClass][i];if(l&&l.range){var r="object"==typeof l.range?l.range[e[i]||"x"]:l.range;if("function"==typeof r&&(r=r(e[i]||"x",x.getStats())),r&&n>r){var o=$("<li>"+l.name+"</li>");o.hover(function(){x.tooltip.showSkill(this,x.charClass,i,e[i])},function(){x.tooltip.hide()}),z.append(o)}}}}),H.toggle(!!z.children().length)}function k(s){for(var t=(s%60).toFixed(0);t.length<2;)t="0"+t;return Math.floor(s/60)+":"+t}var b=DiabloCalc.locale("ui-simulator.js"),x=DiabloCalc,y=$("#tab-simulator"),C={opts:{eq:"=",ne:"&#x2260;",lt:"<",le:"&#x2264;",gt:">",ge:"&#x2265;"},class:"arg-op"},D={opts:x.simMapping.opts,width:"150px",class:"arg-type"},w={buff:"buff",buffmin:"buff",buffmax:"buff",bufftgt:"buff",ticks:"buff",resource:"resource",resourcepct:"resource",cooldown:"skill",charges:"skill",channeled:"skill",interval:"skill",health:"none",any:"sub",all:"sub",count:"subcount"};p.prototype.onChangeType=function(){var s=w[this.type.val()];if(this.typeval!==s){var a;switch(this.op&&(a=this.op.val(),x.noChosen||this.op.next().remove(),this.op.remove(),delete this.op),this.vardiv.children().detach(),this.typeval=s,this.lhs&&this.lhs.remove(),s){case"buff":this.lhs=function(s,a){var i=$('<select class="arg-buff"></select>');return a&&x.simMapping.buffs[a]||(a=t(i,!0)),a&&x.simMapping.buffs[a]&&i.append('<option value="'+a+'" selected="selected">'+x.simMapping.buffs[a].name+"</option>"),s.append(i),x.noChosen?t(i):(i.chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:b("Choose Buff"),populate_func:function(){t(i)}}),x.chosenTips(i,e)),x.addTip(i,function(){if(x.simMapping.buffs[this.val()])return x.simMapping.buffs[this.val()].name}),i.setval=function(s){return x.noChosen?i.val(s):(i.empty(),s&&x.simMapping.buffs[s]&&i.append('<option value="'+s+'" selected="selected">'+x.simMapping.buffs[s].name+"</option>"),i.trigger("chosen:updated")),this},i}(this.vardiv),this.vardiv.append('<span class="arg-ph"></span>');break;case"skill":this.lhs=l(this.vardiv),this.vardiv.append('<span class="arg-ph"></span>');break;case"resource":this.lhs=function(s,t){(!t||x.classes[x.charClass].resources.indexOf(t)<0)&&(t=x.classes[x.charClass].resources[0]);var e=$('<select class="arg-resource"></select>');return t&&x.resources[t]&&e.append('<option value="'+t+'" selected="selected">'+x.resources[t]+"</option>"),s.append(e),x.noChosen?r(e):e.chosen({width:"200px",disable_search_threshold:10,inherit_select_classes:!0,search_contains:!0,placeholder_text_single:b("Choose Resource"),populate_func:function(){r(e)}}),e.setval=function(s){return x.noChosen?e.val(s):(e.empty(),s&&x.resources[s]&&e.append('<option value="'+s+'" selected="selected">'+x.resources[s]+"</option>"),e.trigger("chosen:updated")),this},e}(this.vardiv),this.vardiv.append('<span class="arg-ph"></span>')}"sub"!==s?(this.op=o(this.vardiv,C,a),this.rhs?this.vardiv.append(this.rhs):(this.rhs=$('<input class="arg-rhs" type="number" step="any"></input>'),this.vardiv.append(this.rhs))):(this.op&&this.op.remove(),this.rhs&&this.rhs.remove()),"sub"===s||"subcount"===s?this.clist||(this.clist=new c(this.box)):this.clist&&(this.clist.list.remove(),delete this.clist)}},p.prototype.getData=function(){var s={type:this.type.val()};return this.lhs&&(s.lhs=this.lhs.val()),this.op&&(s.op=this.op.val()),this.rhs&&(s.rhs=parseFloat(this.rhs.val())),this.clist&&(s.sub=this.clist.getData()),s},c.prototype.getData=function(){var s=[];return this.list.children("li").each(function(){var t=$(this).data("condition");t&&s.push(t.getData())}),s},h.prototype.getData=function(){return{skill:this.skill.val(),conditions:this.conditions.getData()}},d.prototype.getData=function(){var s=[];return this.list.children("li").each(function(){var t=$(this).data("priority");t&&s.push(t.getData())}),s},p.prototype.setData=function(s){this.type.val(s.type),this.type.trigger("chosen:updated"),this.onChangeType(),this.lhs&&this.lhs.setval(s.lhs),this.op&&this.op.setval(s.op),this.rhs&&this.rhs.val(s.rhs),this.clist&&this.clist.setData(s.sub)},c.prototype.setData=function(s){this.list.empty(),this.items=[];for(var t=0;t<s.length;++t){var e=new p(this);e.setData(s[t]),this.items.push(e)}},h.prototype.setData=function(s){this.skill.setval(s.skill).change(),this.conditions.setData(s.conditions)},d.prototype.setData=function(s){if(this.list.empty(),this.items=[],s)for(var t=x.extraskills&&x.extraskills[x.charClass]||{},e=0;e<s.length;++e)if(x.skills[x.charClass][s[e].skill]||t[s[e].skill]){var a=new h(this);a.setData(s[e]),this.items.push(a)}};var S=$("<div></div>");y.append("<h3>"+b("Skill Priority")+"</h3>",S),S.append("<p><i>"+b("The priority list is evaluated from top to bottom to determine the next skill to use. Skill availability checks (cooldown and resources) are implicit.")+"</i></p>");var _=$("<input></input>").attr("type","checkbox").prop("checked",!0).click(function(){x.trigger("updateSkills")});x.addOption("filterBuffs",function(){return _.prop("checked")},function(s){_.prop("checked",s),x.trigger("updateSkills")}),S.append($("<label></label>").addClass("option-box").append(_).append(b("Only show applicable buffs/skills."))),x.addTip(_,b("Only show buffs that can be activated with current skills and equipment.")),x.priority=new d(S);var T=new x.SearchResults("priority",function(s,t){var e=t.id,a=$("<li></li>");return a.append('<span class="class-icon class-'+t.class+'">&nbsp;</span>'),a.click(function(s){!function(s,t){s&&x.priority.getData().length?DiabloCalc.popupMenu(s,b.fixkey({"Discard current list?":function(){f(t)}})):f(t)}(s,e)}),a.append('<span class="profile-name'+(t.value?"":" unnamed")+'">'+(t.value||b("Unnamed list"))+"</span>"),parseInt(t.user)&&(a.append($('<span class="profile-overwrite" title="'+b("Update list")+'"></span>').click(function(s){s.stopPropagation(),x.popupMenu(s,b.fixkey({"Confirm overwrite":function(){u("",e)}}))})),a.append($('<span class="profile-delete" title="'+b("Delete list")+'"></span>').click(function(s){s.stopPropagation(),DiabloCalc.popupMenu(s,b.fixkey({"Confirm delete?":function(){$.ajax({url:"priority",data:{delete:e},type:"GET",dataType:"json",success:function(s){"OK"===s.code?(I.slideUp(),v()):s.errors&&s.errors.length?(I.val(s.errors[0]),I.slideDown()):(I.val(b("Failed to delete list.")),I.slideDown())},error:function(s){I.val(b("Failed to delete list.")),I.slideDown()}})}}))})),a.append('<span class="date-saved"><span>'+new Date(1e3*t.date).toLocaleString()+"</span></span>")),a},b("No preset lists found.")),M=$('<div class="prio-save"><div><input></input></div></div>'),P=$('<input type="button" value="'+b("Save")+'" disabled="disabled"></input>').click(function(){var s=M.find("div input").val();s&&u(s)});M.on("input","div input",function(){P.prop("disabled",!$(this).val())});var I=$("<div></div>");S.append(x.account.makeLine(b(" to save skill priorities"),function(s){v(),this.toggle(!s)})),S.append(M.append(P),I),S.append(T.div.css("margin-top",6)),y.append("<h3>"+b("Simulate")+"</h3>"),S=$("<div></div>"),y.append(S);var N=$("<select></select>");N.append('<option value="">'+b("Generic")+"</option>"),N.append('<option value="demons">'+b("Demon")+"</option>"),N.append('<option value="beasts">'+b("Beast")+"</option>"),N.append('<option value="humans">'+b("Human")+"</option>"),N.append('<option value="undead">'+b("Undead")+"</option>"),N.change(function(){x.options.targetType=$(this).val()}),x.register("updateStats",function(){N.val(x.options.targetType),N.trigger("chosen:updated")}),S.append($('<span class="option-box">'+b("Target: ")+"</span>").append(N));var A=$('<select class="target-status" multiple="multiple"></select>');for(var L in x.simMapping.status)A.append('<option value="'+L+'">'+x.simMapping.status[L]+"</option>");S.append(A),A.chosen({inherit_select_classes:!0,placeholder_text_multiple:b("Target status debuffs (from group)")}),x.addOption("targetStatus",function(){return A.val()},function(s){A.val(s),A.trigger("chosen:updated")});var F=x.simMapping.targetOptions,O=$("<div></div>");S.append(O),x.register("changeClass",function(){O.removeClass().addClass("table-"+x.charClass)});var B=$('<div class="target-options"></div>');B.css("margin-top",8),O.append(B);var U={},j=0;$.each(F,function(s,t){if(!t.hidden){var e=$('<div class="option-row"></div>');if(t.class&&e.addClass("option-"+t.class),t.category&&!U[t.category]){B=$('<div class="target-options"></div>'),O.append(B),U[t.category]=++j;var a=$('<span class="option-category">'+t.category+"</span>");a.click(function(){$(this).parent().toggleClass("collapsed")}),B.append($('<div class="option-row collapsed"></div>').append(a))}B.append(e),e.append('<span class="option-name">'+t.name+":</span>"),e.append('<span class="option-setting"><span class="option-subtable"></span></span>');var i=e.find(".option-subtable");if(t.health){var n=$('<span class="option-box"><label><input type="checkbox" checked="checked"></input>'+b("Adaptive")+"</label></span>");x.addTip(n.find("label"),b("Total health equals to 10 times the damage dealt in the first minute."));var l=$('<input type="text" class="option-health" value="1,000,000,000,000"></input>').hide(),r="1,000,000,000,000";l.on("input",function(){var s=$(this).val();if(s){var e=parseInt(s.replace(/,/g,""));isNaN(e)?$(this).val(r):($(this).val(r=x.formatNumber(e,0,1e4)),t.val=e)}else r=s}),x.addTip(l,t.tip),i.append(n,$('<span class="option-slider"></span>').append(l)),n.find("input").click(function(){l.toggle(!$(this).prop("checked")),$(this).prop("checked")?t.val=-1:t.val=parseInt(l.val().replace(/,/g,""))}),x.addOption(t.var,function(){return t.val},function(s){t.val=s,s<0?(n.find("input").prop("checked",!0),l.hide()):(n.find("input").prop("checked",!1),l.show().val(prevVal=x.formatNumber(s,0,1e4)))},t.profile)}else{var o=$('<span class="option-value">'+(t.val<0?b("Auto"):t.val)+"</span>");i.append(o);var p=$("<div></div>").slider({value:t.val,min:t.min,max:t.max,step:t.step||1,slide:function(s,e){if(t.resource){var a=!0===t.resource?x.classes[x.charClass].resources[0]:t.resource,i=x.getStats()["max"+a]||100;e.value>=i?t.val="max":t.val=e.value}else t.val=e.value;t.val=e.value,o.text(e.value<0?b("Auto"):e.value),g()}});x.addTip(p,t.tip),i.append($('<span class="option-slider"></span>').append(p)),x.addOption(t.var,function(){return t.val},function(s){if(t.resource){var e=!0===t.resource?x.classes[x.charClass].resources[0]:t.resource,a=x.getStats()["max"+e]||100;"max"===s||s>=a?(s=a,t.val="max"):t.val=s}else t.val=s;o.text(s<0?b("Auto"):s),p.slider("value",s)},t.profile),t.resource&&x.register("updateStats",function(){var s=!0===t.resource?x.classes[x.charClass].resources[0]:t.resource,e=x.getStats()["max"+s]||100,a={max:e};("max"===t.val||t.val>=e)&&(t.val="max",a.value=e,o.text(e<0?b("Auto"):e)),p.slider(a)})}}}),B.css("margin-bottom",8);var q=$('<div class="nyi-section"><p>'+b("The following equipped items are not implemented in the simulation:")+"</p></div>"),G=$('<ul class="nyi-list"></ul>');S.append(q.append(G)),q.hide();var H=$('<div class="nyi-section"><p>'+b("The character might not be in range to use the following skills:")+"</p></div>"),z=$('<ul class="nyi-list"></ul>');S.append(H.append(z)),H.hide();var E=$('<button class="button-start">'+b("Start")+"</button>").button({icons:{primary:"ui-icon-play"}});S.append(E);var R=x.formatDamage,V=new function(){this.dps=$('<span class="dps-meter">'+b("DPS: ")+"<span></span></span>").hide(),this.hps=$('<span class="dps-meter inactive">'+b("HPS: ")+"<span></span></span>").hide(),this.graph=$('<div class="sim-graph"></div>').hide(),this.section=$('<div class="sim-results statsframe"></div>').hide(),this.chartData=[],this.damageData=[],this.healingData=[],this.chartMode="dps",S.append(this.dps,this.hps,this.graph,this.section);s=this;this.dps.click(function(){if("dps"!==s.chartMode){s.chartMode="dps",s.dps.removeClass("inactive"),s.hps.addClass("inactive"),s.chartData.length=0,s.chart.render();for(var t=0;t<s.damageData.length;++t)s.chartData.push(s.damageData[t]);s.chart.render()}}),this.hps.click(function(){if("hps"!==s.chartMode){s.chartMode="hps",s.hps.removeClass("inactive"),s.dps.addClass("inactive"),s.chartData.length=0,s.chart.render();for(var t=0;t<s.healingData.length;++t)s.chartData.push(s.healingData[t]);s.chart.render()}}),this.sourceName=function(t){if(x.skills[this.charClass][t])return x.skills[this.charClass][t].name;if(x.extraskills&&x.extraskills[this.charClass]&&x.extraskills[this.charClass][t])return x.extraskills[this.charClass][t].name;if(x.passives[this.charClass][t])return x.passives[this.charClass][t].name;if(x.legendaryGems[t])return x.legendaryGems[t].name;if(!s.initData.stats.affixes[t])return x.stats[t]&&x.stats[t].name?x.stats[t].name:x.itemFromAffix[t]?x.itemFromAffix[t].name:t;var e=s.initData.stats.affixes[t];if(e.set)return"("+e.pieces+") "+x.itemSets[e.set].name;var a=x.getSlotId(e.slot);return a&&x.itemById[a]?x.itemById[a].name:void 0},this.sampleLines={},this.updateSample=function(){if(this.sectSample&&this.chart&&this.sampleData){var s=this.chart._chart.sessionVariables.axisX.internalMinimum,t=this.chart._chart.sessionVariables.axisX.internalMaximum;s||(s=0);var e=0,a=void 0,n=this;$.each(this.sampleData,function(l,r){var o=1e3*r[0]/60>=s;if(o||(e=l),!t&&l>e+50&&(o=!1),l>e+100&&(o=!1),t&&1e3*r[0]/60>t&&(o=!1),o){if(!n.sampleLines[l]){var p=x.skills[n.charClass][r[1]];if(p||(p=x.extraskills&&x.extraskills[n.charClass]&&x.extraskills[n.charClass][r[1]]),p){var c=Math.floor(r[0]/3600),h=r[0]/60-60*c,d=(c?c+":"+(h<10?"0":""):"")+h.toFixed(2),u=i(r[1],n.charClass),f=$("<li><span><span>"+d+"</span>"+u+"<span>"+p.name+"</span></span><span>"+r[2].toFixed(0)+"</span></li>");f.hover(function(){var s='<div xmlns="http://www.w3.org/1999/xhtml" class="profile-tooltip"><p><span class="d3-color-gold">';r[3]||!r[6]?(s+=b("Damage")+': <span class="d3-color-green">'+x.formatNumber(r[3],0,1e4)+"</span></span>",r[6]&&(s+='<br/><span class="tooltip-icon-bullet"></span>'+b("Healing")+': <span class="d3-color-green">'+x.formatNumber(r[6],0,1e4)+"</span>")):r[6]&&(s+=b("Healing")+': <span class="d3-color-green">'+x.formatNumber(r[6],0,1e4)+"</span></span>");for(var t in r[4]){(i=n.sourceName(t))&&(s+='<br/><span class="tooltip-icon-bullet"></span>'+i+': <span class="d3-color-green">'+x.formatNumber(r[4][t],0,1e4)+"</span>")}if(r.length>5&&!$.isEmptyObject(r[5])){s+='<br/><span class="tooltip-icon-bullet"></span>Buffs:';var e=[];for(var t in r[5])e.push([t,x.simMapping.buffs[t]&&x.simMapping.buffs[t].name||t]);e.sort(function(s,t){return s[1].localeCompare(t[1])});for(var a=0;a<e.length;++a){var t=e[a][0],i=x.simMapping.buffs[t]&&x.simMapping.buffs[t].name;s+='<br/><span class="tooltip-icon-nobullet"></span><span class="d3-color-'+(i?"gold":"gray")+'">'+(i||t)+'</span>: <span class="d3-color-white">'+r[5][t]+"</span>"}}s+="</p></div>",x.tooltip.showHtml(this,s)},function(){x.tooltip.hide()}),n.sampleLines[l]=f}a?a.after(n.sampleLines[l]):n.sectSample.prepend(n.sampleLines[l])}n.sampleLines[l]&&(a=n.sampleLines[l])}else n.sampleLines[l]&&(n.sampleLines[l].remove(),delete n.sampleLines[l])})}},this.chartInit=function(){this.graph.empty(),this.chart=new CanvasJS.Chart(this.graph[0],{backgroundColor:$("body").hasClass("theme-light")?"#fff":"#121212",height:200,axisY:{valueFormatString:" ",lineThickness:1,tickThickness:0,gridThickness:1},axisX:{lineThickness:1,gridThickness:1,tickThickness:1,labelFormatter:function(s){return k(s.value/1e3)}},data:[{type:"area",xValueType:"dateTime",dataPoints:this.chartData}],zoomEnabled:!0,toolTip:{contentFormatter:function(s){var t=s.entries[0].dataPoint;return"<b>"+k(t.x/1e3)+"</b> - "+R(t.y)}}}),this.graph.append('<div class="comment">'+b("Drag to zoom/pan (affects Sample output)")+"</div>");var s=this.chart._chart.render,t=this;this.chart._chart.render=function(){s.apply(this,arguments),t.updateSample()},this.chart.render()},this.chartInit();var s=this;x.register("changeTheme",function(){s.chartInit()}),this.sectCounters=$('<ul class="flex"></ul>'),this.sectUptimes=$('<ul class="flex"></ul>'),this.sectSample=$('<ul class="flex2 flex"></ul>');var t=$('<div class="column"></div>');t.append($("<div></div>").append("<h3>"+b("Breakdown")+"</h3>",this.sectCounters)),t.append($("<div></div>").append("<h3>"+b("Uptimes")+"</h3>",this.sectUptimes)),this.section.append(t),(t=$('<div class="column"></div>')).append($("<div></div>").append("<h3>"+b("Sample")+"</h3>",this.sectSample)),this.section.append(t),this.section.find(".column").sortable({connectWith:".sim-results .column",handle:"h3",distance:4,placeholder:"drop-ph",forcePlaceholderSize:!0,start:function(){s.section.find(".column").addClass("dragging")},stop:function(){s.section.find(".column").removeClass("dragging")}}),this.finish=function(s){function t(s,t){if(!t){if(!x.itemById[s])return"";t=x.itemById[s].type}var e=x.itemIcons[s];return'<div style="background: url(css/items/'+t+".png) 0 "+-24*(e&&e[0]||0)+'px no-repeat"></div>'}E.button({icons:{primary:"ui-icon-play"},label:b("Start")}),this.worker.terminate(),delete this.worker,x.recordDPS(this.results.damage/this.results.time*60);var e=this.initData.stats.charClass;this.charClass=e;var a=this,n=[];$.each(s.counters,function(s,t){var e=a.sourceName(s);e&&n.push([e,s,t])}),n.sort(function(s,t){return s[0].toLowerCase().localeCompare(t[0].toLowerCase())}),this.sectCounters.empty();var l=x.extraskills&&x.extraskills[e]||{};$.each(n,function(s,n){var r=n[0],o=n[1],p=n[2],c=$('<li class="bigger"><span>'+r+"</span></li>");if(x.skills[e][o]||l[o]){d=i(o,e).replace(/span/g,"div");c.prepend(d),c.hover(function(){x.tooltip.showSkill(this,e,o,a.initData.stats.skills[o])},function(){x.tooltip.hide()})}else if(x.passives[e][o]){var h=x.passives[e][o],d='<div style="background: url(css/images/class-'+e+"-passive.png) "+-24*h.index+'px 0 / auto 48px no-repeat"></div>';c.prepend(d),c.hover(function(){x.tooltip.showSkill(this,e,o)},function(){x.tooltip.hide()})}else if(x.legendaryGems[o]){d=t(x.legendaryGems[o].id,"gemleg");c.prepend(d),c.hover(function(){x.tooltip.showGem(this,o,a.initData.stats.gems[o])},function(){x.tooltip.hide()})}else if(a.initData.stats.affixes[o]){var u=a.initData.stats.affixes[o],f=x.getSlotId(u.slot);f&&c.prepend(t(f)),c.hover(function(){x.tooltip.showItem(this,u.slot)},function(){x.tooltip.hide()})}else x.isKnownStat(o)?c.hover(function(){x.showStatTip(this,o)},function(){x.tooltip.hide()}):x.itemFromAffix[o]&&(c.prepend(t(x.itemFromAffix[o].id)),c.hover(function(){var s=[],t=x.itemFromAffix[o].required.custom;1!==t.args&&void 0!==t.args||s.push(("min"===t.best?t.min:t.max)||0),x.tooltip.showItem(this,x.itemFromAffix[o].id,s)},function(){x.tooltip.hide()}));if(a.sectCounters.append(c),p.count){a.sectCounters.append("<li><span>"+b("Uses")+"</span><span>"+p.count+"</span></li>");var v=p.count/a.results.time*3600;v>60?a.sectCounters.append("<li><span>"+b("Uses/second")+"</span><span>"+x.formatNumber(v/60,2)+"</span></li>"):a.sectCounters.append("<li><span>"+b("Uses/minute")+"</span><span>"+x.formatNumber(v,2)+"</span></li>")}if(p.damage&&(a.sectCounters.append("<li><span>"+b("Damage")+"</span><span>"+R(p.damage)+"</span></li>"),a.sectCounters.append("<li><span>"+b("DPS")+"</span><span>"+R(p.damage/a.results.time*60)+"</span></li>"),a.sectCounters.append("<li><span>"+b("% Damage")+"</span><span>"+x.formatNumber(100*p.damage/a.results.damage,2)+"%</span></li>")),p.healing&&(a.sectCounters.append("<li><span>"+b("Healing")+"</span><span>"+R(p.healing)+"</span></li>"),a.sectCounters.append("<li><span>"+b("HPS")+"</span><span>"+R(p.healing/a.results.time*60)+"</span></li>"),a.sectCounters.append("<li><span>"+b("% Healing")+"</span><span>"+x.formatNumber(100*p.healing/a.results.healing,2)+"%</span></li>")),p.rc)for(var m in p.rc)x.resources[m]&&a.sectCounters.append("<li><span>"+b("Gained {0}").format(x.resources[m])+"</span><span>"+x.formatNumber(p.rc[m],0,1e4)+"</span></li>")});n=[];$.each(s.uptimes,function(s,t){var e=x.simMapping.buffs[s]&&x.simMapping.buffs[s].name||s;n.push([e,t])}),n.sort(function(s,t){return s[0].toLowerCase().localeCompare(t[0].toLowerCase())}),this.sectUptimes.empty();for(var r=0;r<n.length;++r){var o=x.formatNumber(100*n[r][1],2)+"%",p=$("<li><span>"+n[r][0]+"</span><span>"+o+"</span></li>"),c=n[r][0]+': <span class="d3-color-green">'+o+"</span>";n[r][1]>1&&(c+='</span><br/><span class="tooltip-icon-bullet"></span>Average stacks: <span class="d3-color-green">'+x.formatNumber(n[r][1],2)),x.addTip(p,c),this.sectUptimes.append(p)}this.sectSample.empty(),this.sampleLines={},this.sampleData=s.sample,this.updateSample(),this.section.show()},this.section.on("click","h3",function(){$(this).next().slideToggle()}),this.onMessage=function(s){this.results&&(this.results.time=s.time,"report"===s.type?(this.results.damage=s.damage,this.results.healing=s.healing,this.finish(s)):(this.results.damage+=s.damage,this.results.healing+=s.healing,this.damageData.push({x:1e3*s.time/60,y:s.damage/3}),this.healingData.push({x:1e3*s.time/60,y:s.healing/3}),"dps"===this.chartMode?this.chartData.push(this.damageData[this.damageData.length-1]):this.chartData.push(this.healingData[this.healingData.length-1]),this.chart.render()),this.dps.find("span").text(R(this.results.damage/this.results.time*60)),this.hps.find("span").text(R(this.results.healing/this.results.time*60)),this.hps.toggle(this.results.healing>0))},this.start=function(s){x.activity("simulate"),s.type="start",delete this.sampleData,this.initData=s,this.worker=new Worker("sim");var t=this;this.worker.onmessage=function(s){t.onMessage(s.data)},this.results={damage:0,healing:0,time:1},this.dps.show(),this.dps.find("span").text("0"),this.hps.hide(),this.section.hide(),this.chartData.length=0,this.damageData.length=0,this.healingData.length=0,this.graph.show(),this.dps.click(),this.chart.render(),this.worker.postMessage(s),E.button({icons:{primary:"ui-icon-stop"},label:b("Stop")})},this.abort=function(){this.dps.hide(),this.hps.hide(),this.section.hide(),this.graph.hide(),this.worker.terminate(),delete this.worker,delete this.results,delete this.sampleData,E.button({icons:{primary:"ui-icon-play"},label:b("Start")})},this.running=function(){return!!this.worker}};x.SimResults=V,x.exportStats=function(){var s=new x.Stats;s.loadItems(void 0,!0),x.addSkillList(s),x.addPartyBuffs(s);var t=A.val();if(t)for(var e=0;e<t.length;++e)s[t[e]]=1;return s.flatten(),s},x.exportProfile=function(){return{stats:x.exportStats(),params:x.getActive("global+"),priority:x.priority.getData()}},E.click(function(){V.running()?V.abort():V.start(x.exportProfile())});var W=location.pathname.match(/^\/e?([0-9]+)$/);y.accordion({active:W?1:0,collapsible:!0,heightStyle:"content",activate:function(s,t){t.newPanel.removeClass("sliding"),t.oldPanel.removeClass("sliding"),t.newPanel.is(S)&&g()},beforeActivate:function(s,t){t.newPanel.addClass("sliding"),t.oldPanel.addClass("sliding")}}),x.register("changeClass",function(){x.priority.setData(x.priority.getData()),v()}),x.register("updateSlotItem",m),x.register("importEnd",m)}();!function(){function t(t,e,i){var s=t[0],o=t[1],a=t[2];if(Math.abs(s)>Math.abs(o)){var c=1/Math.sqrt(s*s+a*a);i[0]=a*c,i[1]=0,i[2]=-s*c,e[0]=o*i[2],e[1]=a*i[0]-s*i[2],e[2]=-o*i[0]}else{var c=1/Math.sqrt(o*o+a*a);i[0]=0,i[1]=-a*c,i[2]=o*c,e[0]=o*i[2]-a*i[1],e[1]=-s*i[2],e[2]=s*i[1]}}function e(t,e,i){var s=t[0],o=t[1],a=t[2],c=t[3],r=e[0]*i*.5,n=e[1]*i*.5,h=e[2]*i*.5;t[0]+=c*r+a*n-o*h,t[1]+=s*h+c*n-a*r,t[2]+=o*r-s*n+c*h,t[3]-=s*r+o*n+a*h,quat.normalize(t,t)}function i(t,e,i){var s=e[0]-i[12],o=e[1]-i[13],a=e[2]-i[14];return t[0]=i[0]*s+i[1]*o+i[2]*a,t[1]=i[4]*s+i[5]*o+i[6]*a,t[2]=i[8]*s+i[9]*o+i[10]*a,t}function s(t,e){t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],t[4]+=e[4],t[5]+=e[5],t[6]+=e[6],t[7]+=e[7],t[8]+=e[8]}function o(t,e){this.normal=t,this.offset=e,this.friction=1}function a(t,e,i){this.body=t,this.localCenter=e,this.radius=i,this.center=vec3.clone(e),this.friction=1}function c(t,e,i,s){this.body=t,this.localStart=e,this.localEnd=i,this.radius=s,this.start=vec3.clone(e),this.end=vec3.clone(i),this.friction=1}function r(e,i){if(this.name=e.name,e.capsule){this.center=vec3.lerp(vec3.create(),e.capsule.start,e.capsule.end,.5);var s=e.capsule.radius,o=vec3.distance(e.capsule.start,e.capsule.end),a=Math.PI*o*s,r=2*Math.PI*s*e.capsule.radius/3,n=s*a*.5,h=.5*n+a*o*o/12,v=h,l=r*s*.4;n+=2*l;var d=.5*o,u=l+r*(d*d+3*o*e.capsule.radius/8);h+=2*u,v+=2*u,this.mass=a+2*r;var y=mat3.create(),m=y.subarray(0,3),f=y.subarray(3,6),p=y.subarray(6,9);vec3.subtract(f,e.capsule.end,e.capsule.start),vec3.scale(f,f,1/o),t(f,m,p),this.localInvInertia=mat3.clone(y);var b=1/h,A=1/n,g=1/v,M=this.localInvInertia;M[0]*=b,M[1]*=b,M[2]*=b,M[3]*=A,M[4]*=A,M[5]*=A,M[6]*=g,M[7]*=g,M[8]*=g,mat3.multiply(M,M,mat3.transpose(y,y)),this.shape=new c(this,e.capsule.start,e.capsule.end,e.capsule.radius)}else this.center=vec3.create(),this.mass=1,this.localInvInertia=mat3.create();this.moves=i,this.moves||this.localInvInertia.set([0,0,0,0,0,0,0,0,0]),this.invMass=i?1/this.mass:0,this.transform=e.localTransform,this.moves||(this.prevTransform=mat4.clone(this.transform)),this.position=vec3.transformMat4(vec3.create(),this.center,this.transform),this.orientation=quat.fromMat3(quat.create(),mat3.fromMat4(mat3.create(),this.transform)),quat.normalize(this.orientation,this.orientation),this.velocity=vec3.create(),this.angMomentum=vec3.create(),this.angVelocity=vec3.create(),this.invInertia=mat3.create(),this.acceleration=vec3.create(),this.forceAccum=vec3.create(),this.torqueAccum=vec3.create(),this.gravity=vec3.fromValues(0,0,-25),this.linDamping=.25,this.angDamping=.2}function n(t,e,i,s,o,a,c){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.normal=o,this.restitution=a||0,this.friction=c||0,this.velocity=vec3.create(),this.calculateVelocity(),this.calculatePenetration()}function h(t,e,i,s){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.velocity=vec3.create(),this.normal=vec3.create(),this.calculateVelocity(),this.calculatePenetration()}function v(t){function e(t,e,i,s){vec3.subtract(n,e,t.position),vec3.cross(n,s,n),vec3.add(e,e,i),vec3.add(e,e,n)}for(var i=Math.max(2*t.length,10);i--;){for(var s=null,o=1e-4,a=0;a<t.length;++a)t[a].deltaVelocity>o&&(s=t[a],o=s.deltaVelocity);if(!s)break;s.resolveVelocity();for(var a=0;a<t.length;++a){var c=t[a];(c.body1==s.body1||c.body1==s.body2||c.body2==s.body1||c.body2==s.body1)&&c.calculateVelocity()}}for(var r={pos1:vec3.create(),pos2:vec3.create(),rot1:vec3.create(),rot2:vec3.create()},n=vec3.create(),i=Math.max(2*t.length,10);i--;){for(var s=null,h=1e-4,a=0;a<t.length;++a)t[a].penetration>h&&(s=t[a],h=s.penetration);if(!s)break;if(s.resolvePosition(r)!==!1){for(var a=0;a<t.length;++a){var c=t[a];(c.body1==s.body1||c.body2==s.body1)&&(e(s.body1,c.body1==s.body1?c.pos1:c.pos2,r.pos1,r.rot1),c.calculatePenetration()),!s.body2||c.body1!=s.body2&&c.body2!=s.body2||(e(s.body2,c.body1==s.body2?c.pos1:c.pos2,r.pos2,r.rot2),c.calculatePenetration())}s.body1.move(r.pos1,r.rot1),s.body2&&s.body2.move(r.pos2,r.rot2)}}}function l(t,e,i,s,o,a,c,r){var h=p(i,s,a,c),v=vec3.subtract(vec3.create(),h[0],h[1]),l=vec3.length(v);return l>o+r+1e-4?void 0:(l>1e-4?vec3.scale(v,v,1/l):vec3.set(v,1,0,0),new n(t,e,vec3.scaleAndAdd(vec3.create(),h[0],v,-o),vec3.scaleAndAdd(vec3.create(),h[1],v,r),v))}function d(t,e,i){for(var s=0;s<t.length;++s)for(var r=s+1;r<t.length;++r){var h=t[s],v=t[r];if((h.body&&v.body.moves||v.body||v.body.moves)&&h.body!==v.body&&!(h.body&&v.body&&(h.body.parent===v.body||v.body.parent===h.body)||h.body&&v.body&&h.body.parent===v.body.parent)){if(v instanceof o){var d=h;h=v,v=d}var u=void 0;if(h instanceof o){if(v instanceof a){var y=vec3.dot(h.normal,v.center)-h.offset;y<v.radius+1e-4&&(u=new n(v.body,h.body,vec3.scaleAndAdd(vec3.create(),v.center,h.normal,-v.radius),vec3.scaleAndAdd(vec3.create(),v.center,h.normal,-y),h.normal))}else if(v instanceof c){var m=vec3.dot(h.normal,v.start)-h.offset,f=vec3.dot(h.normal,v.end)-h.offset;m<v.radius+i&&(u=new n(v.body,h.body,vec3.scaleAndAdd(vec3.create(),v.start,h.normal,-v.radius),vec3.scaleAndAdd(vec3.create(),v.start,h.normal,-m),h.normal),u.friction=(h.friction||1)*(v.friction||1),u.restitution=.3,e.push(u)),f<v.radius+i&&(u=new n(v.body,h.body,vec3.scaleAndAdd(vec3.create(),v.end,h.normal,-v.radius),vec3.scaleAndAdd(vec3.create(),v.end,h.normal,-f),h.normal),u.friction=(h.friction||1)*(v.friction||1),u.restitution=.3,e.push(u)),u=void 0}}else{if(v instanceof c){var d=h;h=v,v=d}h instanceof c?v instanceof c?u=l(h.body,v.body,h.start,h.end,h.radius,v.start,v.end,v.radius):v instanceof a&&(u=l(h.body,v.body,h.start,h.end,h.radius,v.center,v.center,v.radius)):h instanceof a&&v instanceof a&&(u=l(h.body,v.body,h.center,h.center,h.radius,v.center,v.center,v.radius))}u&&(u.friction=(h.friction||1)*(v.friction||1),u.restitution=.3,e.push(u))}}}function u(t,e,i,s,o,a){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.restLength=o,this.stiffness=a}function y(t,e,i,s){this.body1=t,this.body2=e,this.pos1=i,this.pos2=s,this.contact=new h(this.body1,this.body2,vec3.create(),vec3.create())}function m(t){this.gl=t}var f=DiabloCalc,p=function(){function t(t,e,i){if(e>-1e-6)return 0;if(1e-6>i)return 1;var s=-e/t;return s>1&&(s=.5),s}var e=vec3.create(),i=vec3.create(),s=vec3.create(),o=[vec3.create(),vec3.create()];return function(a,c,r,n){var h,v,l,d,u,y,m,f,p,b,A,g,M,I,V,T,w,F,q,P,L,D,W,x,z,S,C,k,E,Q;return vec3.subtract(e,c,a),vec3.subtract(i,n,r),vec3.subtract(s,a,r),h=vec3.dot(e,e),v=vec3.dot(e,i),l=vec3.dot(i,i),d=vec3.dot(e,s),u=vec3.dot(i,s),y=d,m=y+h,f=y-v,p=m-v,b=-u,A=b-v,g=b+l,M=A+l,h>1e-6&&l>1e-6?(T=t(h,y,m),w=t(h,f,p),F=1e-6>T?-1:T>1-1e-6?1:0,q=1e-6>w?-1:w>1-1e-6?1:0,-1==F&&-1==q?(I=0,V=t(l,b,g)):1==F&&1==q?(I=1,V=t(l,A,M)):(0>F?(P=0,D=0,W=y/v,(0>W||W>1)&&(W=.5)):0==F?(P=2,D=T,W=0):(P=1,D=1,W=m/v,(0>W||W>1)&&(W=.5)),0>q?(L=0,x=0,z=y/v,(0>z||z>1)&&(z=.5)):0==q?(L=3,x=w,z=1):(L=1,x=1,z=m/v,(0>z||z>1)&&(z=.5)),S=z-W,C=S*(l*W-v*D-u),C>-1e-6?0==P?(I=0,V=t(l,b,g)):1==P?(I=1,V=t(l,A,M)):(I=D,V=W):(k=S*(l*z-v*x-u),1e-6>k?0==L?(I=0,V=t(l,b,g)):1==L?(I=1,V=t(l,A,M)):(I=x,V=z):(E=Math.min(Math.max(C/(C-k),0),1),Q=1-E,I=Q*D+E*x,V=Q*W+E*z)))):h>1e-6?(I=t(h,y,m),V=0):l>1e-6?(I=0,V=t(l,b,g)):(I=0,V=0),vec3.lerp(o[0],a,c,I),vec3.lerp(o[1],r,n,V),o}}();o.prototype.update=function(){},a.prototype.update=function(){this.body&&vec3.transformMat4(this.center,this.localCenter,this.body.transform)},c.prototype.update=function(){this.body&&(vec3.transformMat4(this.start,this.localStart,this.body.transform),vec3.transformMat4(this.end,this.localEnd,this.body.transform))},r.prototype={setTransform:function(t,e){e>1e-6&&(mat4.copy(this.prevTransform,this.transform),this.invTime=1/e),mat4.copy(this.transform,t),this.position=vec3.transformMat4(vec3.create(),this.center,t),this.orientation=quat.fromMat3(quat.create(),mat3.fromMat4(mat3.create(),t)),quat.normalize(this.orientation,this.orientation),this.calculateInertia()},getShapes:function(t){this.shape&&(this.shape.update(),t.push(this.shape))},addForce:function(t){vec3.add(this.forceAccum,this.forceAccum,t)},addForceAt:function(){var t=vec3.create();return function(e,i){var s=vec3.subtract(t,i,this.position);vec3.cross(s,s,e),vec3.add(this.forceAccum,this.forceAccum,e),vec3.add(this.torqueAccum,this.torqueAccum,s)}}(),addImpulse:function(t){vec3.scaleAndAdd(this.velocity,this.velocity,t,this.invMass)},addImpulseAt:function(){var t=vec3.create();return function(e,i){var s=vec3.subtract(t,i,this.position);vec3.cross(s,s,e),vec3.scaleAndAdd(this.velocity,this.velocity,e,this.invMass),vec3.add(this.angMomentum,this.angMomentum,s),vec3.transformMat3(this.angVelocity,this.angMomentum,this.invInertia)}}(),localToWorld:function(t,e){return vec3.transformMat4(t,e,this.transform)},addForceAtLocal:function(t,e){this.addForceAt(t,this.localToWorld(vec3.create(),e))},addImpulseAtLocal:function(t,e){this.addImpulseAt(t,this.localToWorld(vec3.create(),e))},velocityAt:function(t,e){if(this.moves){var s=vec3.subtract(t,e,this.position);return vec3.cross(s,this.angVelocity,s),vec3.add(s,s,this.velocity)}if(this.invTime){var o=i(t,e,this.transform);vec3.transformMat4(o,o,this.prevTransform),vec3.subtract(o,e,o),vec3.scale(o,o,this.invTime);var a=vec3.length(o);return a>2&&vec3.scale(o,o,2/a),o}return vec3.set(t,0,0,0)},move:function(t,i){this.moves&&(vec3.add(this.position,this.position,t),e(this.orientation,i,1))},startFrame:function(t){vec3.scaleAndAdd(this.forceAccum,this.forceAccum,this.gravity,this.mass),vec3.scale(this.acceleration,this.forceAccum,this.invMass*t),vec3.add(this.velocity,this.velocity,this.acceleration),vec3.scale(this.velocity,this.velocity,Math.pow(this.linDamping,t)),vec3.scaleAndAdd(this.angMomentum,this.angMomentum,this.torqueAccum,t),vec3.scale(this.angMomentum,this.angMomentum,Math.pow(this.angDamping,t)),vec3.transformMat3(this.angVelocity,this.angMomentum,this.invInertia),vec3.set(this.forceAccum,0,0,0),vec3.set(this.torqueAccum,0,0,0)},calculateInertia:function(){mat3.fromQuat(this.invInertia,this.orientation);var t=mat3.transpose(mat3.create(),this.invInertia);mat3.multiply(this.invInertia,this.invInertia,this.localInvInertia),mat3.multiply(this.invInertia,this.invInertia,t)},calculateDerived:function(){if(this.moves){mat4.fromQuat(this.transform,this.orientation);var t=vec3.transformMat4(vec3.create(),this.center,this.transform);vec3.subtract(t,this.position,t),this.transform[12]=t[0],this.transform[13]=t[1],this.transform[14]=t[2],this.calculateInertia()}},integrate:function(t){this.moves&&(vec3.scaleAndAdd(this.position,this.position,this.velocity,t),e(this.orientation,this.angVelocity,t),this.calculateDerived())}},h.prototype.reset=function(){this.calculateVelocity(),this.calculatePenetration()},function(){function t(t,e,i){var s=e.invInertia,o=e.invMass,a=i[0]-e.position[0],c=i[1]-e.position[1],r=i[2]-e.position[2],n=s[0],h=s[1],v=s[2],l=s[3],d=s[4],u=s[5],y=s[6],m=s[7],f=s[8],p=r*l-c*y,b=r*d-c*m,A=r*u-c*f,g=a*y-r*n,M=a*m-r*h,I=a*f-r*v,V=c*n-a*l,T=c*h-a*d,w=c*v-a*u;t[0]=b*r-A*c+o,t[1]=A*a-p*r,t[2]=p*c-b*a,t[3]=M*r-I*c,t[4]=I*a-g*r+o,t[5]=g*c-M*a,t[6]=T*r-w*c,t[7]=w*a-V*r,t[8]=V*c-T*a+o}function e(t,e,s,o,a,c,r,n,h){var v=a*r,l=c*r;vec3.scaleAndAdd(i,e,s,-vec3.dot(e,s));var d=.2*vec3.length(i);-d>l?(v+=l+d,l=-d):l>d&&(v+=l-d,l=d),vec3.scale(n,s,v),c>1e-4?vec3.scale(h,o,l/c):vec3.set(h,0,0,0)}var i=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3),c=new Float32Array(3),r=new Float32Array(3),v=new Float32Array(3),l=new Float32Array(9),d=new Float32Array(9);n.prototype.calculateVelocity=function(){this.body1.velocityAt(this.velocity,this.pos1),this.body2&&vec3.subtract(this.velocity,this.velocity,this.body2.velocityAt(i,this.pos2));var t=vec3.dot(this.body1.acceleration,this.normal);this.body2&&(t-=vec3.dot(this.body2.acceleration,this.normal)),this.deltaVelocity=-vec3.dot(this.velocity,this.normal)*(this.restitution+1),this.fromAccel<0&&(this.deltaVelocity+=t*this.restitution)},h.prototype.calculateVelocity=function(){this.body1.velocityAt(this.velocity,this.pos1),vec3.subtract(this.velocity,this.velocity,this.body2.velocityAt(i,this.pos2)),this.deltaVelocity=vec3.length(this.velocity)},n.prototype.calculatePenetration=function(){this.penetration=vec3.dot(this.normal,vec3.subtract(i,this.pos2,this.pos1))},h.prototype.calculatePenetration=function(){this.penetration=vec3.length(vec3.subtract(this.normal,this.pos2,this.pos1)),this.penetration>1e-6&&vec3.scale(this.normal,this.normal,1/this.penetration)},n.prototype.resolveVelocity=function(){if(this.friction){t(l,this.body1,this.pos1),this.body2&&(t(d,this.body2,this.pos2),s(l,d)),mat3.invert(d,l),vec3.negate(r,this.velocity),vec3.scaleAndAdd(r,r,this.normal,vec3.dot(this.normal,this.velocity)),vec3.scaleAndAdd(i,r,this.normal,this.deltaVelocity),vec3.transformMat3(i,i,d);var e=vec3.dot(i,this.normal);vec3.scaleAndAdd(o,i,this.normal,-e);var n=vec3.length(o);if(n>e*this.friction){vec3.normalize(r,r),vec3.scaleAndAdd(i,this.normal,r,this.friction),vec3.transformMat3(o,i,l);var h=vec3.dot(o,this.normal);if(Math.abs(h)<1e-4)return;vec3.scale(i,i,this.deltaVelocity/h)}}else{vec3.subtract(a,this.pos1,this.body1.position),vec3.cross(i,a,this.normal),vec3.transformMat3(r,i,this.body1.invInertia);var u=vec3.dot(i,r)+this.body1.invMass;this.body2&&(vec3.subtract(c,this.pos2,this.body2.position),vec3.cross(i,c,this.normal),vec3.transformMat3(v,i,this.body2.invInertia),u+=vec3.dot(i,v)+this.body2.invMass),u=1/u,vec3.scale(i,this.normal,this.deltaVelocity*u)}this.body1.addImpulseAt(i,this.pos1),this.body2&&(vec3.negate(i,i),this.body2.addImpulseAt(i,this.pos2))},h.prototype.resolveVelocity=function(){t(l,this.body1,this.pos1),t(d,this.body2,this.pos2),s(l,d),mat3.invert(l,l),vec3.transformMat3(i,this.velocity,l),this.body2.addImpulseAt(i,this.pos2),vec3.negate(i,i),this.body1.addImpulseAt(i,this.pos1)},n.prototype.resolvePosition=function(t){vec3.subtract(a,this.pos1,this.body1.position),vec3.cross(i,a,this.normal),vec3.transformMat3(r,i,this.body1.invInertia);var s=vec3.dot(i,r),o=this.body1.invMass,n=0,h=0;this.body2&&(vec3.subtract(c,this.pos2,this.body2.position),vec3.cross(i,c,this.normal),vec3.transformMat3(v,i,this.body2.invInertia),n=vec3.dot(i,v),h=this.body2.invMass);var l=s+o+n+h;return 1e-4>l?!1:(l=this.penetration/l,e(this.body1,a,this.normal,r,s,o,l,t.pos1,t.rot1),void(this.body2&&e(this.body2,c,this.normal,v,n,h,-l,t.pos2,t.rot2)))},h.prototype.resolvePosition=n.prototype.resolvePosition}(),function(){var t=vec3.create(),e=vec3.create(),i=vec3.create();u.prototype.resolve=function(){var s=this.body1.localToWorld(t,this.pos1),o=this.body2.localToWorld(e,this.pos2),a=vec3.subtract(i,o,s),c=vec3.length(a);c>1e-4?vec3.scale(a,a,(this.restLength-c)*this.stiffness/c):vec3.set(a,(this.restLength-c)*this.stiffness,0,0),this.body2.addForceAt(a,o),vec3.negate(a,a),this.body1.addForceAt(a,s)}}(),y.prototype.resolve=function(t,e){this.body1.localToWorld(this.contact.pos1,this.pos1),this.body2.localToWorld(this.contact.pos2,this.pos2);var i=vec3.squaredDistance(this.contact.pos1,this.contact.pos2);1e-7>i||(this.contact.reset(),e.push(this.contact))},m.prototype.init=function(t,e){if(t.boneList){if(!t.animated){for(var i=0;i<t.boneList.length;++i){var s=t.boneList[i];mat4.multiply(s.localTransform,e,s.localTransform)}t.animated=!0}this.bodies=[],this.constraints=[];for(var i=0;i<t.boneList.length;++i){var s=t.boneList[i];s.body=new r(s,!!s.parent),s.parent&&(s.body.parent=s.parent.body),this.bodies.push(s.body),s.parent&&s.constraint&&this.constraints.push(new y(s.parent.body,s.body,s.constraint.parent.translate,s.constraint.local.translate))}}},m.prototype.update=function(t,e,i){if(this.bodies||this.init(t,i),this.bodies){void 0===this.time&&(this.time=e);var s=vec3.create();vec3.transformMat4(s,s,f.d3gl.mvMatrix);var a=new o(vec3.fromValues(0,0,1),s[2]);a.friction=3,this.bodies[0].setTransform(i,e-this.time);{Math.min(e-this.time,.5)}this.time<e-.5&&(this.time=e-.5);for(var c=1/60;this.time<e-c;){this.time+=c;for(var r=[a],n=[],h=0;h<this.bodies.length;++h)this.bodies[h].startFrame(c),this.bodies[h].getShapes(r);d(r,n,.1);for(var h=0;h<this.constraints.length;++h)this.constraints[h].resolve(c,n);v(n);for(var h=0;h<this.bodies.length;++h)this.bodies[h].integrate(c)}for(var h=0;h<t.boneList.length;++h){var l=t.boneList[h];mat4.multiply(l.transform,l.localTransform,l.invTransform)}}},f.D3Ragdoll=m}();$.ajaxTransport("+binary",function(t,e,r){if(window.FormData&&(t.dataType&&"binary"==t.dataType||t.data&&(window.ArrayBuffer&&t.data instanceof ArrayBuffer||window.Blob&&t.data instanceof Blob)))return{send:function(e,r){var a=new XMLHttpRequest,i=t.url,n=t.type,s=t.async||!0,o=t.responseType||"blob",h=t.data||null,l=t.username||null,u=t.password||null;a.addEventListener("load",function(){var e={};e[t.dataType]=a.response,r(a.status,a.statusText,e,a.getAllResponseHeaders())}),a.open(n,i,s,l,u);for(var c in e)a.setRequestHeader(c,e[c]);a.responseType=o,a.send(h)},abort:function(){r.abort()}}}),function(){function t(t,e,r){for(var a=[],i=0;i<r;++i){var n=t.getUint8(e+i);if(!n)break;a.push(n)}return String.fromCharCode.apply(null,a).toLowerCase()}function e(t,e){if(0===e)return null;if(e in U)return U[e].texture;var r={};return U[e]=r,r.texture=null,r.image=new Image,r.image.onload=function(){r.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,r.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r.image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.bindTexture(t.TEXTURE_2D,null)},r.image.src="webgl/textures/"+e,r.texture}function r(t,e){if(!x[t]){r={callbacks:[]};x[t]=r,$.ajax({url:"webgl/"+t,type:"GET",dataType:"binary",responseType:"arraybuffer",processData:!1}).done(function(t){r.data=t;for(var e=0;e<r.callbacks.length;++e)r.callbacks[e](t);delete r.callbacks})}var r;(r=x[t]).data?e(r.data):r.callbacks&&r.callbacks.push(e)}function a(t,e){this.raw=t,this.gl=e}function i(t){var e=this;r("animations/"+t,function(t){e.load(t)})}function n(t,e){this.list=[],this.cache={},this.flagCallback=e,this.rigged=0;for(var r=0;r<t.length;++r)this.list.push(new i(t[r][0])),this.list[r].flag=t[r][1],this.list[r].weight=0==r?.95:.05/(t.length-1)}function s(t){var e=this;r("animsets/"+t,function(t){e.load(t)})}function o(t,e){this.material=t,this.gl=e,this.groups=[]}function h(t,e){this.gl=t,this.renderChain=[],this.subObjects=[];var a=this;r("models/"+e,function(t){a.load(t)})}function l(t,e){this.actor=e,this.model=new h(t,e),this.animset=new s(e),this.animations=[427776,426960,410112,410113,410115,410116,410117,410118,410119,86272,86273,86274,86275],this.data=y.webglCharacters[e]||{},this.slots={head:{},shoulders:{},torso:{},hands:{},legs:{},feet:{},mainhand:{},offhand:{}};var r=this;setTimeout(function(){r.data.beard&&r.model.enable(r.data.beard,0,10,!0);for(var t in y.itemSlots)T(t)},0)}function u(t,e){var r=t&&y.itemTypes[t]&&y.itemTypes[t].weapon&&y.itemTypes[t].weapon.type,a=e&&y.itemTypes[e]&&y.itemTypes[e].weapon&&y.itemTypes[e].weapon.type;if("source"===e||"mojo"===e||"phylactery"===e||"quiver"===e)switch(r){case void 0:return 11;case"swing":return 12;case"thrust":return 13;case"wand":return 19;default:return u(t,void 0)}if("shield"===e||"crusadershield"===e){if("flail2h"===t)return 27;switch(r){case"swing":return 20;case"thrust":return 21;case void 0:return 22;case"fist":return 16;case"swing2h":return 23;case"thrust2h":return 24;case"staff":return 25;default:return u(t,void 0)}}if(a)return"fist"===a?"fist"===r?15:14:10;if("flail2h"===t)return 26;if("axe2h"===t||"mace2h"===t)return 17;switch(r){case"swing":return 2;case"thrust":return 3;case"swing2h":return 4;case"thrust2h":return 5;case"staff":return 6;case"bow":return 7;case"crossbow":return 8;case"wand":return 9;case"fist":return 16;case"handcrossbow":return 18;default:return 1}}function c(t,e,r){var a=t.createShader(e);if(!a)return null;t.shaderSource(a,r),t.compileShader(a);if(!t.getShaderParameter(a,t.COMPILE_STATUS)){var i=t.getShaderInfoLog(a);return t.console.log("*** Error compiling shader: "+i),t.deleteShader(a),null}return a}function f(){var t=this.canvas.width,e=this.canvas.height,r=this.character&&this.character.data.fov||12;t===this.width&&e===this.height&&r==this.prevFov||(this.width=t,this.height=e,this.prevFov=r,this.viewport(0,0,t,e),this.perspectiveMatrix=mat4.perspective(mat4.create(),.7,t/e,1,50),mat4.multiply(this.perspectiveMatrix,this.perspectiveMatrix,[0,0,1,0,1,0,0,0,0,1,0,0,0,0,-r,1]),this.uniformMatrix4fv(this.u_projMatrixLoc,!1,this.perspectiveMatrix))}function d(t){var e=this;if(R&&!0!==document.hidden){e.reshape(),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT),mat4.fromZRotation(e.mvMatrix,e.viewAngle);var r=e.character&&e.character.model.center;if(r){var a=e.character&&e.character.data.y||.75;mat4.translate(e.mvMatrix,e.mvMatrix,vec3.fromValues(-r[0],-r[1],-r[2]+a))}e.ground&&e.ground.render(e.mvMatrix),e.character&&e.character.model.render(.001*t,e.mvMatrix),e.flush()}window.requestAnimationFrame(function(t){e.render(t)})}function p(t,e){if(e)return t.dragPos=[e.clientX,e.clientY],t.dragStart=[e.clientX,e.clientY],e.preventDefault(),!1}function m(t,e){if(e&&t.dragPos&&1&e.buttons)return t.viewAngle+=.005*(e.clientX-t.dragPos[0]),t.dragPos=[e.clientX,e.clientY],e.preventDefault(),!1}function g(t,e){if(t.dragPos)return Math.abs(t.dragPos[0]-t.dragStart[0])<2&&Math.abs(t.dragPos[1]-t.dragStart[1])<2&&t.character&&t.character.model&&t.character.model.animation&&t.character.model.animation.choose&&t.character.model.animation.choose(),delete t.dragPos,delete t.dragStart,e.preventDefault(),!1}function v(t){if(!(t.originalEvent.touches.length>1)){var e=$.extend({buttons:1,clientX:0,clientY:0},t.originalEvent.touches[0]);return e.preventDefault=function(){t.preventDefault()},e}}function b(){if(y.webglClasses[y.charClass]){var t=y.webglClasses[y.charClass][DiabloCalc.gender||"female"];y.d3gl.character=new l(y.d3gl,t)}else y.d3gl.character=void 0}function T(t){if(y.d3gl.character){var e=y.getSlot(t),r=e&&(e.transmog||e.rwbase&&(e.rwbase.transmog||e.rwbase.id)||e.id),a=e&&(e.rwbase&&e.rwbase.dye||e.dye);y.d3gl.character.equip(t,r,a)}}function _(){if(w[0]&&w[1]){_=function(){};var t=function(t){var e=t.getContext("webgl");return e?(e.canvas=t,e.consoleDiv=$("#console"),e.console={log:function(){console.log.apply(console,arguments)}},e.program=function(t,r){var a=c(e,e.VERTEX_SHADER,t),i=c(e,e.FRAGMENT_SHADER,r);if(!a||!i)return null;var n=e.createProgram();if(!n)return null;e.attachShader(n,a),e.attachShader(n,i);var s=["vPosition","vNormal","vTexture","vBoneIndex","vBoneWeight"];for(var o in s)e.bindAttribLocation(n,o,s[o]);if(e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS)){var h=e.getProgramInfoLog(n);return e.console.log("Error in program linking:"+h),e.deleteProgram(n),e.deleteShader(i),e.deleteShader(a),null}return n}(w[0],w[1]),e.program?(e.useProgram(e.program),e.clearColor(0,0,0,0),e.clearDepth(50),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.enable(e.CULL_FACE),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA),e):null):null}(E.find("canvas")[0]);if(!t)return void E.append('<div class="d3gl-error"><b>'+_L("Failed to load WebGL")+"</b><br/>"+_L("Visit {0} for more information.").format('<a target="_blank" href="http://get.webgl.org/">http://get.webgl.org/</a>')+"</div>");y.d3gl=t;var e=vec3.normalize(vec3.create(),vec3.fromValues(1,.4,.4));t.uniform3f(t.getUniformLocation(t.program,"lightDir"),e[0],e[1],e[2]),t.mvMatrix=mat4.create(),t.u_projMatrixLoc=t.getUniformLocation(t.program,"u_projMatrix"),t.BonesLoc=t.getUniformLocation(t.program,"Bones"),t.u_alphaLoc=t.getUniformLocation(t.program,"u_alpha"),t.uniform1f(t.u_alphaLoc,1),t.u_TintLoc=t.getUniformLocation(t.program,"u_Tint"),t.mvpMatrix=mat4.create(),t.reshape=f,t.render=d,t.viewAngle=0;var r=t.getUniformLocation(t.program,"sampler");t.uniform1i(r,0),r=t.getUniformLocation(t.program,"sampler_tint"),t.uniform1i(r,1),(r=t.getUniformLocation(t.program,"sampler_spec"))&&t.uniform1i(r,2),t.enabled=function(){return R},t.character=new l(t,6526),$(E).mousedown(function(e){p(t,e)}).on("touchstart",function(e){return p(t,v(e))}),$(window).mousemove(function(e){m(t,e)}).mouseup(function(e){g(t,e)}).on("touchmove",function(e){return m(t,v(e))}).on("touchend",function(e){return g(t,v(e))}),window.requestAnimationFrame(function(e){t.render(e)}),b(),DiabloCalc.register("changeClass",b),DiabloCalc.register("changeGender",b),DiabloCalc.register("updateSlotItem",T),DiabloCalc.register("importEnd",function(){for(var t in y.itemSlots)T(t)})}}var E,A,y=DiabloCalc,R=!1,w=new Array(2),U={},x={};a.prototype.diffuse=function(t){return e(this.gl,this.raw.getUint32(16*t,!0))},a.prototype.specular=function(t){return e(this.gl,this.raw.getUint32(16*t+4,!0))},a.prototype.tintbase=function(t){return e(this.gl,this.raw.getUint32(16*t+8,!0))},a.prototype.tintmask=function(t){return e(this.gl,this.raw.getUint32(16*t+12,!0))},i.prototype.loaded=function(){return!!this.bones},i.prototype.duration=function(){if(!this.bones)return 0;var t=(this.frames-1)/this.velocity/60;if(this.queued){var e=y.getStats();e.info.aps&&(t/=e.info.aps)}return t},i.prototype.load=function(e){var r=new DataView(e);this.frames=r.getUint32(0,!0),this.velocity=r.getFloat32(4,!0);var a=r.getUint32(8,!0),i=r.getUint32(12,!0);this.bones=[];for(var n=0;n<a;++n){var s=i+88*n,o={};o.name=t(r,s,64);var h=r.getUint32(s+64,!0),l=r.getUint32(s+68,!0),u=r.getUint32(s+72,!0),c=r.getUint32(s+76,!0),f=r.getUint32(s+80,!0),d=r.getUint32(s+84,!0);o.translations=[];for(p=0;p<h;++p){s=l+16*p;o.translations.push({frame:r.getUint32(s,!0),value:new Float32Array(e,s+4,3)})}o.rotations=[];for(p=0;p<u;++p){s=c+20*p;o.rotations.push({frame:r.getUint32(s,!0),value:new Float32Array(e,s+4,4)})}o.scales=[];for(var p=0;p<f;++p){s=d+8*p;o.scales.push({frame:r.getUint32(s,!0),value:r.getFloat32(s+4,!0)})}this.bones.push(o)}},function(){function t(t,e,r,a){mat4.translate(t,t,vec3.lerp(n,e,r,a))}function e(t,e,r,a){mat4.multiply(t,t,mat4.fromQuat(s,quat.slerp(o,e,r,a)))}function r(t,e,r,a){var i=e*(1-a)+r*a;mat4.scale(t,t,vec3.set(n,i,i,i))}function a(t,e,r,a){if(r.length){var i=function(t,e){for(var r=0,a=e.length;a-r>1;){var i=Math.floor((r+a)/2);e[i].frame<t?r=i:a=i}return r}(e,r);i<r.length-1?a(t,r[i].value,r[i+1].value,(e-r[i].frame)/(r[i+1].frame-r[i].frame)):a(t,r[i].value,r[i].value,0)}}var n=vec3.create(),s=mat4.create(),o=quat.create();i.prototype.update=function(i,n,s){if(this.bones){var o=60*n*this.velocity;if(this.queued){var h=y.getStats();h.info.aps&&(o*=h.info.aps)}o-=(this.frames-1)*Math.floor(o/(this.frames-1));for(u=0;u<i.boneList.length;++u)mat4.identity(i.boneList[u].localTransform);for(u=0;u<this.bones.length;++u){var l=this.bones[u];(c=i.bones[l.name])&&(a(c.localTransform,o,l.translations,t),a(c.localTransform,o,l.rotations,e),a(c.localTransform,o,l.scales,r))}for(var u=0;u<i.boneList.length;++u){var c=i.boneList[u];c.parent?mat4.multiply(c.localTransform,c.parent.localTransform,c.localTransform):mat4.multiply(c.localTransform,s,c.localTransform),mat4.multiply(c.transform,c.localTransform,c.invTransform)}i.animated=!0}}}(),n.prototype._fetch=function(t){return this.cache[t]?this.cache[t]:this.cache[t]=new i(t)},n.prototype.__choose=function(t){for(var e=0,r=t||0;r<this.list.length;++r)this.list[r].loaded()&&(e+=this.list[r].weight);if(e){e*=Math.random();for(r=t||0;r<this.list.length;++r)if(this.list[r].loaded()){if(e<this.list[r].weight)return this.list[r];e-=this.list[r].weight}for(r=t||0;r<this.list.length;++r)if(this.list[r].loaded())return this.list[r]}else if(t)return this._choose()},n.prototype._choose=function(t){if(this.queued&&this.queued.length&&this.queued[0].loaded())return this.rigged=5,this.queued.shift();if(this.rigged>0&&this.list[0].loaded())return this.rigged-=1,this.list[0];var e=this.__choose();return e!=this.list[0]&&(this.rigged=5),e},n.prototype.choose=function(){this.time=this.lastTime,this.current=this.__choose(1),this.rigged=5},n.prototype.update=function(t,e,r){for(void 0===this.time&&(this.time=e),this.current&&this.current.queued||!this.queued||!this.queued.length||!this.queued[0].loaded||(this.time=e,this.current=this._choose()),this.lastTime=e,this.current||(this.current=this._choose());this.current&&e>this.time+this.current.duration();)this.time+=this.current.duration(),this.current=this._choose();this.current&&(this.current.flag!==this.flag&&this.flagCallback(this.flag=this.current.flag),this.current.update(t,e-this.time,r))},n.prototype.queue=function(t){this.queued=[];for(var e=0;e<t.length;++e)this.queued.push(this._fetch(t[e][0])),this.queued[e].flag=t[e][1],this.queued[e].queued=!0},n.prototype.prepare=function(t){for(var e=0;e<t.length;++e)this._fetch(t[e][0])};var F=[-1,0,0,0,0,0,4,0,0,0,0,1,2,3,10,10,1,4,0,9,2,3,1,4,5,6,4,26,0];s.prototype.load=function(t){this.data=[];for(var e=new Int32Array(t),r=0,a=0;a<29;++a){for(var i={},n=e[r++];n--;){i[e[r++]]=e[r++]}this.data.push(i)}this.request&&(this.doGet(this.request.callback,this.request.id,this.request.type),delete this.request)},s.prototype._doGet=function(t,e){for(var r=e;e>=0;){if(t in this.data[e])return-1==this.data[e][t]?[this.data[0][t],!0]:[this.data[e][t],0===e];e=F[e]}return 427776===t?[void 0,!0]:this._doGet(427776,r)},s.prototype.doGet=function(t,e,r){if("object"==typeof e&&"length"in e){for(var a=[],i=0;i<e.length;++i)a.push(this._doGet(e[i],r));t(a)}else t(this._doGet(e,r))},s.prototype.get=function(t,e,r){this.data?this.doGet(t,e,r):this.request={callback:t,id:e,type:r}},o.prototype.addGroup=function(t,e,r){var a={},i=this.gl;a.bones=t,a.vertices=i.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,a.vertices),i.bufferData(i.ARRAY_BUFFER,e,i.STATIC_DRAW),a.indices=i.createBuffer(),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,a.indices),i.bufferData(i.ELEMENT_ARRAY_BUFFER,r,i.STATIC_DRAW),a.numIndices=r.length,this.groups.push(a)},o.prototype.render=function(t,r,a,i,n){var s=this.gl;this.material&&(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,this.material.diffuse(r)),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,i&&this.material.tintmask(r)||e(s,0)),i&&s.uniform3f(s.u_TintLoc,i.r,i.g,i.b),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,this.material.specular(r))),s.enableVertexAttribArray(0),s.enableVertexAttribArray(1),s.enableVertexAttribArray(2),s.enableVertexAttribArray(3),s.enableVertexAttribArray(4);for(var o=0;o<this.groups.length;++o){var h=this.groups[o];if(a.length){for(var l=new Float32Array(16*h.bones.length),u=0;u<h.bones.length;++u)mat4.copy(l.subarray(16*u,16*u+16),a[h.bones[u]].transform);this.gl.uniformMatrix4fv(this.gl.BonesLoc,!1,l)}else this.gl.uniformMatrix4fv(this.gl.BonesLoc,!1,t);s.bindBuffer(s.ARRAY_BUFFER,h.vertices),s.vertexAttribPointer(0,3,s.FLOAT,!1,36,0),s.vertexAttribPointer(1,4,s.BYTE,!0,36,12),s.vertexAttribPointer(2,2,s.SHORT,!1,36,16),s.vertexAttribPointer(3,4,s.UNSIGNED_BYTE,!1,36,20),s.vertexAttribPointer(4,3,s.FLOAT,!1,36,24),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,h.indices),s.depthFunc(s.LESS),s.depthMask(!n),s.blendFuncSeparate(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA,s.ONE,s.ONE_MINUS_SRC_ALPHA),s.drawElements(s.TRIANGLES,h.numIndices,s.UNSIGNED_SHORT,0),s.depthFunc(s.GREATER),s.depthMask(!1),s.blendFuncSeparate(s.ONE_MINUS_DST_ALPHA,s.DST_ALPHA,s.ONE_MINUS_DST_ALPHA,s.ONE),s.drawElements(s.TRIANGLES,h.numIndices,s.UNSIGNED_SHORT,0)}s.bindBuffer(s.ARRAY_BUFFER,null),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),this.material&&(s.uniform1f(s.u_alphaLoc,1),s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE1),s.bindTexture(s.TEXTURE_2D,null),s.activeTexture(s.TEXTURE2),s.bindTexture(s.TEXTURE_2D,null))},h.prototype.load=function(e){var r=new DataView(e),i=r.getUint32(0,!0),n=r.getUint32(4,!0),s=r.getUint32(8,!0),h=r.getUint32(12,!0),l=r.getUint32(16,!0),u=r.getUint32(20,!0),c=r.getUint32(24,!0),f=r.getUint32(28,!0),d=r.getUint32(32,!0);this.center=new Float32Array(e,36,3),this.boneList=[],this.bones={};for(E=0;E<i;++E){var p=n+108*E,m=r.getUint32(p+100,!0),g=r.getUint32(p+104,!0),v={};v.name=t(r,p,64);-1!=(_=r.getInt32(p+64,!0))&&(v.parent=this.boneList[_]),v.prsTransform={rotate:new Float32Array(e,p+68,4),translate:new Float32Array(e,p+84,3),scale:r.getFloat32(p+96,!0)};var b=v.prsTransform.scale;v.localTransform=mat4.fromRotationTranslationScale(mat4.create(),v.prsTransform.rotate,v.prsTransform.translate,vec3.fromValues(b,b,b)),v.invTransform=mat4.invert(mat4.create(),v.localTransform),v.transform=mat4.create(),m&&(v.capsule={start:new Float32Array(e,m,3),end:new Float32Array(e,m+12,3),radius:r.getFloat32(m+24,!0)}),g&&(v.constraint={parent:{rotate:new Float32Array(e,g,4),translate:new Float32Array(e,g+16,3)},local:{rotate:new Float32Array(e,g+28,4),translate:new Float32Array(e,g+44,3)},values:new Float32Array(e,g+56,5)}),this.boneList.push(v),this.bones[v.name]=v}this.hardpoints={};for(E=0;E<s;++E){var p=h+132*E,T={};T.name=t(r,p,64);var _=r.getInt32(p+64,!0);-1!=_&&(T.parent=this.boneList[_]),T.relTransform=new Float32Array(e,p+68,16),T.transform=mat4.clone(T.relTransform),this.hardpoints[T.name]=T}this.materials=[];for(E=0;E<c;++E){p=d+16*E*f;this.materials.push(new a(new DataView(e,p,16*f),this.gl))}this.objects=[];for(var E=0;E<l;++E){var p=u+12*E,A=r.getUint32(p,!0),y=new o(this.materials[A],this.gl);this.objects.push(y);for(var R=r.getUint32(p+4,!0),w=r.getUint32(p+8,!0),U=0;U<R;++U){var p=w+24*U,i=r.getUint32(p,!0),n=r.getUint32(p+4,!0),x=r.getUint32(p+8,!0),F=r.getUint32(p+12,!0),L=r.getUint32(p+16,!0),S=r.getUint32(p+20,!0);y.addGroup(new Uint32Array(e,n,i),new Uint8Array(e,F,36*x),new Uint16Array(e,S,L))}}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null)},h.prototype.enable=function(t,e,r,a,i){if("object"==typeof t)for(var n=0;n<t.length;++n)this.enable(t[n],e,r,a,i);else this.renderChain.push({index:t,appearance:e,prio:r,nodepth:a,tint:i});return this},h.prototype.disable=function(t){if("object"==typeof t)for(e=0;e<t.length;++e)this.disable(t[e]);else for(var e=0;e<this.renderChain.length;++e)this.renderChain[e].index===t&&this.renderChain.splice(e--,1);return this},h.prototype.animate=function(t){return"number"==typeof t&&(t=new i(t)),this.animation=t},h.prototype.setRagdoll=function(t){this.animation=new y.D3Ragdoll(this.gl)},h.prototype.attach=function(t,e){"number"==typeof e&&(e=new h(this.gl,e));var r={hp:t,model:e};return this.subObjects.push(r),r},h.prototype.detach=function(t){var e=this.subObjects.indexOf(t);e>=0&&this.subObjects.splice(e,1)},h.prototype.update=function(t,e){if(this.objects&&this.animation){this.animation.update(this,t,e);for(var r in this.hardpoints){var a=this.hardpoints[r];a.parent?mat4.multiply(a.transform,a.parent.localTransform,a.relTransform):mat4.multiply(a.transform,e,a.relTransform)}}},h.prototype.render=function(t,e){if(this.objects){this.scale&&(e=mat4.scale(mat4.create(),e,[this.scale,this.scale,this.scale])),void 0!==t&&this.update(t,e),this.renderChain.sort(function(t,e){return(t.prio||0)-(e.prio||0)});for(i=0;i<this.renderChain.length;++i){(n=this.renderChain[i]).index>=this.objects.length||n.prio>=10||this.objects[n.index].render(e,n.appearance,this.boneList,n.tint,n.nodepth)}for(i=0;i<this.subObjects.length;++i){var r=this.subObjects[i],a=this.hardpoints[r.hp];a&&r.model.render(t,a.transform)}for(var i=0;i<this.renderChain.length;++i){var n=this.renderChain[i];n.index>=this.objects.length||n.prio<10||this.objects[n.index].render(e,n.appearance,this.boneList,n.tint,n.nodepth)}}},l.prototype.animType=function(){return u(this.slots.mainhand.item&&this.slots.mainhand.item.type,this.slots.offhand.item&&this.slots.offhand.item.type)},l.prototype._mhpoint=function(){return this.isNoneType?"hp_sheath_right_hip":"hp_rightweapon"},l.prototype._ohpoint=function(){var t=this.slots.offhand.item.type;return this.isNoneType?"shield"===t||"crusadershield"===t?"hp_sheath_shield":"quiver"===t?"hp_sheath_left_back":y.itemTypes[t]&&y.itemTypes[t].weapon?"hp_sheath_left_hip":"hp_none":"shield"===t||"crusadershield"===t?"hp_shield":"quiver"===t?"hp_sheath_left_back":"hp_leftweapon"},l.prototype.updateAnimation=function(){var t=this;this.animset.get(function(e){t.model.animate(new n(e,function(e){t.isNoneType=e,t.slots.mainhand.item&&t.slots.mainhand.att&&(t.slots.mainhand.att.hp=t._mhpoint()),t.slots.offhand.item&&t.slots.offhand.att&&(t.slots.offhand.att.hp=t._ohpoint())}))},this.animations,this.animType())},l.prototype.animate=function(t){var e=this;t instanceof Array||(t=[t]),this.animset.get(function(t){e.model.animation&&e.model.animation.queue(t)},t,this.animType())},l.prototype.prepare=function(t){var e=this;t instanceof Array||(t=[t]),this.animset.get(function(t){e.model.animation&&e.model.animation.prepare(t)},t,this.animType())},l.prototype._attach=function(t,e,r){if("object"==typeof e&&(e=e[this.actor]),e){var a=this.model.attach(t,e),i=y.webglActors[e];if(i){void 0!==i.hair&&this._enable("hair",i.hair,0,12,!0),i.animation&&a.model.animate(i.animation),i.physics&&a.model.setRagdoll(i.physics),i.scale&&(a.model.scale=i.scale);for(var n in i.enable)a.model.enable(n,i.enable[n],0,!1,r)}return a}},l.prototype._enable=function(t,e,r,a,i,n){var s=this.data[t];for(var o in s)this.model.disable(s[o]);e in s&&this.model.enable(s[e],r,a,i,n)};var L={legs:0,hands:1,torso:2,feet:3};l.prototype.equip=function(t,e,r){if(t in this.slots){(r=r&&y.webglDyes[r])&&21===r.type&&(e=void 0);var a=e&&(y.itemById[e]||y.webglItems[e]);if(a&&"quiver"===a.type&&(e=void 0,a=void 0),r=r&&r.color,"id"in this.slots[t]&&this.slots[t].id===e){if(this.slots[t].tint===r)return;if(this.slots[t].tint=r,this.slots[t].att)return $.each(this.slots[t].att.model.renderChain,function(t,e){e.tint=r}),void(this.slots[t].att_r&&$.each(this.slots[t].att_r.model.renderChain,function(t,e){e.tint=r}))}this.slots[t].id=e,this.slots[t].tint=r,this.slots[t].item=a;var i=e&&y.webglItems[e];if(this.slots[t].att&&(this.model.detach(this.slots[t].att),delete this.slots[t].att),this.slots[t].att_r&&(this.model.detach(this.slots[t].att_r),delete this.slots[t].att_r),a&&i)switch(t){case"head":this.slots.head.att=this._attach("hp_helm",i.actor,r);break;case"shoulders":this.slots.shoulders.att=this._attach("hp_left_shoulderpad",i.actor,r),this.slots.shoulders.att_r=this._attach("hp_right_shoulderpad",i.actor_r,r);break;case"mainhand":this.slots.mainhand.att=this._attach(this._mhpoint(),i.actor,r);break;case"offhand":this.slots.offhand.att=this._attach(this._ohpoint(),i.actor,r)}switch(t){case"head":a||this._enable("hair",-1,0,12,!0);break;case"feet":case"hands":case"legs":case"torso":this._enable(t,i&&i.armortype||-1,i&&this.data.looks[i.look]||0,L[t],!1,r)}this.updateAnimation()}},function(t,e){this.gl=t,this.vertices=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.vertices);var r=new ArrayBuffer(144),a=new Float32Array(r,0),i=new Int8Array(r,12),n=new Int16Array(r,16),s=(new Uint8Array(r,20),new Float32Array(r,24));a.set([e,e,0],0),i.set([0,0,127],0),n.set([512,512],0),a.set([-e,e,0],9),i.set([0,0,127],36),n.set([512,0],18),a.set([-e,-e,0],18),i.set([0,0,127],72),n.set([0,0],36),a.set([e,-e,0],27),i.set([0,0,127],108),n.set([0,512],54),s[0]=1,s[9]=1,s[18]=1,s[27]=1,t.bufferData(t.ARRAY_BUFFER,r,t.STATIC_DRAW),this.indices=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indices),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3]),t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,null)}.prototype.render=function(t){var r=this.gl;r.bindBuffer(r.ARRAY_BUFFER,this.vertices),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,this.indices),r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,e(r,43673)),r.activeTexture(r.TEXTURE1),r.bindTexture(r.TEXTURE_2D,null),r.activeTexture(r.TEXTURE2),r.bindTexture(r.TEXTURE_2D,null),r.enableVertexAttribArray(0),r.enableVertexAttribArray(1),r.enableVertexAttribArray(2),r.enableVertexAttribArray(3),r.enableVertexAttribArray(4),r.vertexAttribPointer(0,3,r.FLOAT,!1,36,0),r.vertexAttribPointer(1,4,r.BYTE,!0,36,12),r.vertexAttribPointer(2,2,r.SHORT,!1,36,16),r.vertexAttribPointer(3,4,r.UNSIGNED_BYTE,!1,36,20),r.vertexAttribPointer(4,3,r.FLOAT,!1,36,24),r.uniformMatrix4fv(r.BonesLoc,!1,t),r.depthFunc(r.LESS),r.depthMask(!0),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.ONE,r.ONE_MINUS_SRC_ALPHA),r.drawElements(r.TRIANGLES,6,r.UNSIGNED_SHORT,0),r.bindBuffer(r.ARRAY_BUFFER,null),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)};var S=$('<span class="d3gl-toggle"></span>').click(function(){function t(t,e){$.ajax({url:"webgl/"+t+"?"+Math.floor(1e6*Math.random()),type:"GET",dataType:"text"}).done(function(t){w[e]=t,_()})}if(DiabloCalc.activity("modelview"),!E)return E=$('<div class="d3gl-container"><canvas width="520" height="510"></canvas></div>'),A=$(".paperdoll-background"),S.after(E),A.hide(),t("shader.vsh",0),t("shader.psh",1),void(R=!0);R=!R,E.toggle(R),A.toggle(!R)});$(".paperdoll-container").prepend(S)}();DiabloCalc.onLoaded();